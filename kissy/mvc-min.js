/*
Copyright 2011, KISSY UI Library v1.20dev
MIT Licensed
build time: Nov 14 18:16
*/
KISSY.add("mvc/base",function(g,m){return{sync:m}},{requires:["./sync"]});
KISSY.add("mvc/collection",function(g,m,o,k,l){function b(){b.superclass.constructor.apply(this,arguments)}b.ATTRS={model:{value:o},models:{setter:function(a){this.remove(this.get("models"),{silent:1});this.add(a,{silent:1});return this.get("models")},value:[]},url:{value:g.noop},comparator:{},sync:{value:function(){k.sync.apply(this,arguments)}},parse:{value:function(a){return a}}};g.extend(b,l,{sort:function(){var a=this.get("comparator");a&&this.get("models").sort(function(c,d){return a(c)-a(d)})},
toJSON:function(){return g.map(this.get("models"),function(a){return a.toJSON()})},add:function(a,c){var d=this,f=true;if(g.isArray(a)){var i=[].concat(a);g.each(i,function(r){f=f&&d._add(r,c)})}else f=d._add(a,c);return f},remove:function(a,c){var d=this;if(g.isArray(a)){var f=[].concat(a);g.each(f,function(i){d._remove(i,c)})}else a&&d._remove(a,c)},at:function(a){return this.get("models")[a]},_normModel:function(a){var c=true;if(!(a instanceof o)){c=a;a=new (this.get("model"));c=a.set(c,{silent:1})}return c&&
a},load:function(a){var c=this;a=a||{};var d=a.success;a.success=function(f){if(f){var i=c.get("parse").call(c,f);i&&c.set("models",i,a)}d&&d.apply(this,arguments)};c.get("sync").call(c,c,"read",a);return c},create:function(a,c){var d=this;c=c||{};if(a=this._normModel(a)){a.addToCollection(d);var f=c.success;c.success=function(){d.add(a,c);f&&f()};a.save(c)}return a},_add:function(a,c){if(a=this._normModel(a)){c=c||{};var d;d=this.get("models");var f=this.get("comparator"),i=d.length;if(f){var r=
f(a);for(i=0;i<d.length;i++){var n=f(d[i]);if(r<n)break}}d=i;this.get("models").splice(d,0,a);a.addToCollection(this);c.silent||this.fire("add",{model:a})}return a},_remove:function(a,c){c=c||{};var d=g.indexOf(a,this.get("models"));if(d!=-1){this.get("models").splice(d,1);a.removeFromCollection(this)}c.silent||this.fire("remove",{model:a})},getById:function(a){for(var c=this.get("models"),d=0;d<c.length;d++){var f=c[d];if(f.getId()===a)return f}return null},getByCid:function(a){for(var c=this.get("models"),
d=0;d<c.length;d++){var f=c[d];if(f.get("clientId")===a)return f}return null}});return b},{requires:["event","./model","./base","base"]});
KISSY.add("mvc/model",function(g,m,o){function k(){k.superclass.constructor.apply(this,arguments);this.publish("*Change",{bubbles:1});this.collections={}}var l=["idAttribute","clientId","urlRoot","url","parse","sync"];g.extend(k,m,{addToCollection:function(b){this.collections[g.stamp(b)]=b;this.addTarget(b)},removeFromCollection:function(b){delete this.collections[g.stamp(b)];this.removeTarget(b)},getId:function(){return this.get(this.get("idAttribute"))},setId:function(b){return this.set(this.get("idAttribute"),
b)},__set:function(){this.__isModified=1;return k.superclass.__set.apply(this,arguments)},isNew:function(){return!this.getId()},isModified:function(){return!!(this.isNew()||this.__isModified)},destroy:function(b){var a=this;b=b||{};var c=b.success;b.success=function(d){var f=a.collections;d&&a.set(d,b);for(var i in f){f[i].remove(a,b);a.removeFromCollection(f[i])}a.fire("destroy");c&&c.apply(this,arguments)};if(!a.isNew()&&b["delete"])a.get("sync").call(a,a,"delete",b);else{b.success();b.complete&&
b.complete()}return a},load:function(b){var a=this;b=b||{};var c=b.success;b.success=function(d){if(d){var f=a.get("parse").call(a,d);f&&a.set(f,b)}a.__isModified=0;c&&c.apply(this,arguments)};a.get("sync").call(a,a,"read",b);return a},save:function(b){var a=this;b=b||{};var c=b.success;b.success=function(d){if(d){var f=a.get("parse").call(a,d);f&&a.set(f,b)}a.__isModified=0;c&&c.apply(this,arguments)};a.get("sync").call(a,a,a.isNew()?"create":"update",b);return a},toJSON:function(){var b=this.getAttrVals();
g.each(l,function(a){delete b[a]});return b}},{ATTRS:{idAttribute:{value:"id"},clientId:{valueFn:function(){return g.guid("mvc-client")}},url:{value:function(){var b,a,c=this.collections;for(b in c)if(c.hasOwnProperty(b)){a=c[b];break}b=a;var d;b=b&&(d=b.get("url"))?g.isString(d)?d:d.call(b):d;d=b||this.get("urlRoot");if(this.isNew())return d;d+=d.charAt(d.length-1)=="/"?"":"/";return d+encodeURIComponent(this.getId())+"/"}},urlRoot:{value:""},sync:{value:function(){o.sync.apply(this,arguments)}},
parse:{value:function(b){return b}}}});return k},{requires:["base","./base"]});
KISSY.add("mvc/router",function(g,m,o){function k(e){var h,j;for(j=0;j<e.length;j++){h=e.charAt(j);if(h=="\\")j++;else if(h=="(")return j}throw Error("impossible to not to get capture group in kissy mvc route");}function l(){return n.nativeHistory&&z?q.pathname.substr(n.urlRoot.length)+q.search:q.href.replace(/^[^#]*#?!?(.*)$/,"$1")}function b(e){if(g.endsWith(e,"/"))e=e.substring(0,e.length-1);return e}function a(e){if(g.startsWith(e,"/"))e=e.substring(1);return e}function c(e,h){e=b(e);h=b(h);return e==
h}function d(e){if(e=e.match(G))return g.unparam(e[1]);return{}}function f(){var e=l(),h=e,j=0,p=-1,u="",v=-1,w=0,x=0;e=h.replace(G,"");A(H,function(y){var I=0;A(y[E],function(s){var F=s.regStr,K=s.paramNames,B=-1,t,L=s.callback;if(t=e.match(s.reg)){t.shift();var O=function(){var J={};A(t,function(M,N){J[K[N]]=M});return J};s=function(){u=F;v=B;w=L;x=O();j=y;p=t.length};if(t.length){B=k(F);if(B>v)s();else if(B==v&&p>=t.length)if(t.length<p)s();else F.length>u.length&&s();else j||s()}else{s();I=1;
return false}}});if(I)return false});if(x){h=d(h);w.apply(j,[x,h]);h={name:name,paths:x,query:h};j.fire("route:"+name,h);j.fire("route",h)}}function i(e,h){var j=e,p=[];e=g.escapeRegExp(e);e=e.replace(P,function(u,v,w,x,y){p.push(w||y);if(w)return"([^/]+)";else if(y)return"(.*)"});return{name:j,paramNames:p,reg:RegExp("^"+e+"$"),regStr:e,callback:h}}function r(e){this[E]={};this.addRoutes(e.newVal)}function n(){n.superclass.constructor.apply(this,arguments);this.on("afterRoutesChange",r,this);r.call(this,
{newVal:this.get("routes")});H.push(this)}var G=/\?(.*)/,A=g.each,P=/(:([\w\d]+))|(\\\*([\w\d]+))/g,H=[],C=window,q=C.location,D=C.history,z=!!(D&&D.pushState),E="__routerMap";n.ATTRS={routes:{}};g.extend(n,o,{addRoutes:function(e){var h=this;A(e,function(j,p){h[E][p]=i(p,g.isFunction(j)?j:h[j])})}},{navigate:function(e,h){if(l()!==e)if(n.nativeHistory&&z){D.pushState({},"",q.protocol+"//"+q.host+b(n.urlRoot)+("/"+a(e)));f()}else q.hash="!"+e;else h&&h.triggerRoute&&f()},start:function(e){e=e||{};
e.urlRoot=e.urlRoot||"";var h,j=e.nativeHistory,p=q.pathname,u=l(),v=q.hash.match(/#!.+/);h=n.urlRoot=e.urlRoot;if(n.nativeHistory=j)if(z){if(v)if(c(p,h)){D.replaceState({},"",q.protocol+"//"+q.host+b(n.urlRoot)+("/"+a(u)));e.triggerRoute=1}}else if(!c(p,h)){q.replace(b(h)+"/#!"+u);return}setTimeout(function(){if(j&&z)m.on(C,"popstate",f);else{m.on(C,"hashchange",f);e.triggerRoute=1}e.triggerRoute&&f();e.success&&e.success()},100)}});return n},{requires:["event","base"]});
KISSY.add("mvc/sync",function(g,m){var o={create:"POST",update:"POST","delete":"POST",read:"GET"};return function(k,l,b){b=g.merge({type:o[l],dataType:"json"},b);var a=b.data=b.data||{};a._method=l;if(!b.url)b.url=g.isString(k.get("url"))?k.get("url"):k.get("url").call(k);if(l=="create"||l=="update")a.model=k.toJSON();return m(b)}},{requires:["ajax"]});
KISSY.add("mvc/view",function(g,m,o){function k(a,c){if(g.isString(c))return a[c];return c}function l(){l.superclass.constructor.apply(this,arguments);var a;if(a=this.get("events"))this._afterEventsChange({newVal:a})}var b=m.all;l.ATTRS={el:{value:"<div />",getter:function(a){if(g.isString(a)){a=b(a);this.__set("el",a)}return a}},events:{}};g.extend(l,o,{_afterEventsChange:function(a){var c=a.prevVal;c&&this._removeEvents(c);this._addEvents(a.newVal)},_removeEvents:function(a){var c=this.get("el"),
d;for(d in a){var f=a[d],i;for(i in f){var r=k(this,f[i]);c.undelegate(i,d,r,this)}}},_addEvents:function(a){var c=this.get("el"),d;for(d in a){var f=a[d],i;for(i in f){var r=k(this,f[i]);c.delegate(i,d,r,this)}}},render:function(){return this},destroy:function(){this.get("el").remove()}});return l},{requires:["node","base"]});KISSY.add("mvc",function(g,m,o,k,l,b){return g.mix(m,{Model:o,View:l,Collection:k,Router:b})},{requires:["mvc/base","mvc/model","mvc/collection","mvc/view","mvc/router"]});
