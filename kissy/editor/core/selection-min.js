KISSY.Editor.add("selection",function(q){function D(b){this.document=this.document=b;this._={cache:{}};if(u){var a=this.getNative().createRange();if(!a||a.item&&a.item(0).ownerDocument!=b||a.parentElement&&a.parentElement().ownerDocument!=b)this.isInvalid=k}}function J(b){b=new D(b);return!b||b.isInvalid?F:b}function N(b){function a(g){var i=q.XHTML_DTD;return g._4e_isBlockBoundary()&&i.$empty[g._4e_name()]}var c=b.document,d=v._4e_getWin(c),e=new n(c.body),f=new n(c.documentElement);if(w.ie){q.Utils.ieEngine<
8&&f.on("click",function(g){(new n(g.target))._4e_name()==="html"&&b.getSelection().getNative().createRange().select()});(function(){function g(m,O){var H=x.createTextRange();try{H.moveToPoint(m,O)}catch(S){H=null}return H}function i(){var m=c.selection.createRange();o&&!m.item&&m.compareEndPoints("StartToEnd",m)===0&&o.select();z.remove(c,"mouseup",i);z.remove(c,"mousemove",l);o=A=0;r(k)}function l(m){if(m.button){if(m=g(m.pageX,m.pageY)){m.compareEndPoints("StartToStart",o)>0?m.setEndPoint("StartToStart",
o):m.setEndPoint("EndToEnd",o);m.select()}}else i()}var A,x=e[0],o;c.documentElement.unselectable=true;z.on(c,"mousedown contextmenu",function(m){if(m.target===f[0]){A&&i();if(!(f[0].scrollHeight>f[0].clientHeight)){y.log("fix ie cursor");A=1;if(o=g(m.pageX,m.pageY)){z.on(c,"mouseup",i);z.on(c,"mousemove",l);d.focus();o.select()}}}})})();var h,j,t=k;f.on("mousedown",function(){t=B});f.on("mouseup",function(){t=k});e.on("focusin",function(g){if((new n(g.target))._4e_name()=="body")if(h){try{t&&h.select()}catch(i){}h=
F}});e.on("focus",function(){j=k;r()});e.on("beforedeactivate",function(g){if(!g.relatedTarget){j=B;t=k}});b.on("blur",function(){try{var g=document.documentElement||document.body,i=g.scrollTop,l=g.scrollLeft;c&&c.selection.empty();g.scrollTop=i;g.scrollLeft=l}catch(A){}});e.on("mousedown",function(){j=B});e.on("mouseup",function(){j=k;setTimeout(function(){r(k)},0)});var r=function(g){if(j){var i=b.document,l=b.getSelection(),A=l&&l.getType(),x=l&&i.selection;if(g&&x&&A==s.SELECTION_NONE)if(!i.queryCommandEnabled("InsertImage")){setTimeout(function(){r(k)},
50);return}var o;if(!(x&&x.type&&x.type!="Control"&&(o=x.createRange())&&(o=o.parentElement())&&(o=o.nodeName)&&o.toLowerCase()in{input:1,textarea:1})){h=x&&l.getRanges()[0];b._monitor()}}};e.on("keydown",function(){j=B});e.on("keyup",function(){j=k;setTimeout(function(){r()},0)})}else{z.on(c,"mouseup",b._monitor,b);z.on(c,"keyup",b._monitor,b)}var E=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,G=q.Walker.whitespaces(k),
K=function(g){return G(g)&&g&&g[0].nodeType!=8};b.on("selectionChange",function(g){var i=g.path;g=(g=g.selection)&&g.getRanges()[0];if(!(!g||!g.collapsed||i.block)){if(i.blockLimit._4e_name()=="body"){if((i=g.fixBlock(k,"p"))&&i[0]!=e[0].lastChild)if(i._4e_outerHtml().match(E)){var l=i._4e_next(K);if(l&&l[0].nodeType==p.NODE_ELEMENT&&!a[l]){g.moveToElementEditablePosition(l);i._4e_remove()}else if((l=i._4e_previous(K))&&l[0].nodeType==p.NODE_ELEMENT&&!a[l]){g.moveToElementEditablePosition(l,l._4e_outerHtml().match(E)?
B:k);i._4e_remove()}}g.select();b.notifySelectionChange()}i=new q.Range(c);i.moveToElementEditablePosition(e,k);if((new q.ElementPath(i.startContainer)).blockLimit._4e_name()!=="body"){i=(new n(c.createElement("p"))).appendTo(e);w.ie||i._4e_appendBogus()}}})}q.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var k=true,B=false,F=null,y=KISSY,w=y.UA,v=y.DOM,z=y.Event,n=y.Node,s=q.SELECTION,I=q.RANGE,p=q.NODE,u=w.ie,P=q.Walker,C=q.Range,L={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,
object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};y.augment(D,{getNative:!u?function(){var b=this._.cache;return b.nativeSel||(b.nativeSel=v._4e_getWin(this.document).getSelection())}:function(){var b=this._.cache;return b.nativeSel||(b.nativeSel=this.document.selection)},getType:!u?function(){var b=this._.cache;if(b.type)return b.type;var a=s.SELECTION_TEXT,c=this.getNative();if(c){if(c.rangeCount==1){c=c.getRangeAt(0);var d=c.startContainer;if(d==c.endContainer&&
d.nodeType==p.NODE_ELEMENT&&Number(c.endOffset-c.startOffset)==1&&L[d.childNodes[c.startOffset].nodeName.toLowerCase()])a=s.SELECTION_ELEMENT}}else a=s.SELECTION_NONE;return b.type=a}:function(){var b=this._.cache;if(b.type)return b.type;var a=s.SELECTION_NONE;try{var c=this.getNative(),d=c.type;if(d=="Text")a=s.SELECTION_TEXT;if(d=="Control")a=s.SELECTION_ELEMENT;if(c.createRange().parentElement)a=s.SELECTION_TEXT}catch(e){}return b.type=a},getRanges:u?function(){var b=function(a,c){a=a.duplicate();
a.collapse(c);for(var d=a.parentElement(),e=d.childNodes,f,h=0;h<e.length;h++){var j=e[h];if(j.nodeType==p.NODE_ELEMENT){f=a.duplicate();f.moveToElementText(j);j=f.compareEndPoints("StartToStart",a);var t=f.compareEndPoints("EndToStart",a);f.collapse();if(j>0)break;else if(!j||t==1&&j==-1)return{container:d,offset:h};else if(!t)return{container:d,offset:h+1};f=F}}if(!f){f=a.duplicate();f.moveToElementText(d);f.collapse(B)}f.setEndPoint("StartToStart",a);f=String(f.text).replace(/\r\n|\r/g,"\n").length;
try{for(;f>0;)f-=e[--h].nodeValue.length}catch(r){f=0}return f===0?{container:d,offset:h}:{container:e[h],offset:-f}};return function(a){var c=this._.cache;if(c.ranges&&!a)return c.ranges;var d=this.getNative();a=d&&d.createRange();var e=this.getType();if(!d)return[];if(e==s.SELECTION_TEXT){d=new C(this.document);e=b(a,k);d.setStart(new n(e.container),e.offset);e=b(a);d.setEnd(new n(e.container),e.offset);return c.ranges=[d]}else if(e==s.SELECTION_ELEMENT){c=c.ranges=[];for(e=0;e<a.length;e++){var f=
a.item(e),h=f.parentNode,j=0;for(d=new C(this.document);j<h.childNodes.length&&h.childNodes[j]!=f;j++);d.setStart(new n(h),j);d.setEnd(new n(h),j+1);c.push(d)}return c}return c.ranges=[]}}():function(b){var a=this._.cache;if(a.ranges&&!b)return a.ranges;b=[];var c=this.getNative();if(!c)return[];for(var d=0;d<c.rangeCount;d++){var e=c.getRangeAt(d),f=new C(this.document);f.setStart(new n(e.startContainer),e.startOffset);f.setEnd(new n(e.endContainer),e.endOffset);b.push(f)}return a.ranges=b},getStartElement:function(){var b=
this._.cache;if(b.startElement!==undefined)return b.startElement;var a,c=this.getNative();switch(this.getType()){case s.SELECTION_ELEMENT:return this.getSelectedElement();case s.SELECTION_TEXT:var d=this.getRanges()[0];if(d)if(!d.collapsed){for(d.optimize();k;){a=d.startContainer;if(d.startOffset==(a[0].nodeType===p.NODE_ELEMENT?a[0].childNodes.length:a[0].nodeValue.length)&&!a._4e_isBlockBoundary())d.setStartAfter(a);else break}a=d.startContainer;if(a[0].nodeType!=p.NODE_ELEMENT)return a.parent();
a=new n(a[0].childNodes[d.startOffset]);if(!a[0]||a[0].nodeType!=p.NODE_ELEMENT)return d.startContainer;for(d=a[0].firstChild;d&&d.nodeType==p.NODE_ELEMENT;){a=new n(d);d=d.firstChild}return a}if(u){d=c.createRange();d.collapse(k);a=d.parentElement()}else if((a=c.anchorNode)&&a.nodeType!=p.NODE_ELEMENT)a=a.parentNode}return b.startElement=a?v._4e_wrap(a):F},getSelectedElement:function(){var b=this,a,c=b._.cache;if(c.selectedElement!==undefined)return c.selectedElement;if(u){a=b.getNative().createRange();
a=a.item&&a.item(0)}a||(a=function(){for(var d=b.getRanges()[0],e,f,h=2;h&&!((e=d.getEnclosedNode())&&e[0].nodeType==p.NODE_ELEMENT&&L[e._4e_name()]&&(f=e));h--)d.shrink(I.SHRINK_ELEMENT);return f&&f[0]}());return c.selectedElement=v._4e_wrap(a)},reset:function(){this._.cache={}},selectElement:function(b){var a,c=this.document;if(u)try{a=c.body.createControlRange();a.addElement(b[0]);a.select()}catch(d){a=c.body.createTextRange();a.moveToElementText(b[0]);a.select()}finally{}else{a=c.createRange();
a.selectNode(b[0]);b=this.getNative();b.removeAllRanges();b.addRange(a)}this.reset()},selectRanges:function(b){if(u){if(b.length>1){var a=b[b.length-1];b[0].setEnd(a.endContainer,a.endOffset);b.length=1}b[0]&&b[0].select()}else{a=this.getNative();if(!a)return;a.removeAllRanges();for(var c=0;c<b.length;c++){var d=b[c],e=this.document.createRange(),f=d.startContainer;if(d.collapsed&&(w.gecko&&w.gecko<1.09||w.opera||w.webkit)&&f[0].nodeType==p.NODE_ELEMENT&&!f[0].childNodes.length){f[0].appendChild(this.document.createTextNode(w.webkit?
"\u200b":""));d.startOffset++;d.endOffset++}e.setStart(f[0],d.startOffset);e.setEnd(d.endContainer[0],d.endOffset);a.addRange(e)}}this.reset()},createBookmarks2:function(b){for(var a=[],c=this.getRanges(),d=0;d<c.length;d++)a.push(c[d].createBookmark2(b));return a},createBookmarks:function(b,a){var c=[],d=this.document,e;a=a||this.getRanges();for(var f=a.length,h=0;h<f;h++){c.push(e=a[h].createBookmark(b,k));var j=(b=e.serializable)?y.one("#"+e.startNode,d):e.startNode;e=b?y.one("#"+e.endNode,d):e.endNode;
for(var t=h+1;t<f;t++){var r=a[t],E=r.startContainer,G=r.endContainer;v._4e_equals(E,j.parent())&&r.startOffset++;v._4e_equals(E,e.parent())&&r.startOffset++;v._4e_equals(G,j.parent())&&r.endOffset++;v._4e_equals(G,e.parent())&&r.endOffset++}}return c},selectBookmarks:function(b){for(var a=[],c=0;c<b.length;c++){var d=new C(this.document);d.moveToBookmark(b[c]);a.push(d)}this.selectRanges(a);return this},getCommonAncestor:function(){var b=this.getRanges();return b[0].startContainer._4e_commonAncestor(b[b.length-
1].endContainer)},scrollIntoView:function(){var b=this.getStartElement();b&&b._4e_scrollIntoView()},removeAllRanges:function(){var b=this.getNative();if(u)b&&b.clear();else b&&b.removeAllRanges()}});var M={table:1,tbody:1,tr:1},Q=P.whitespaces(k),R=/\ufeff|\u00a0/;C.prototype.select=C.prototype.select=!u?function(){var b=this.startContainer;this.collapsed&&b[0].nodeType==p.NODE_ELEMENT&&!b[0].childNodes.length&&b[0].appendChild(this.document.createTextNode(""));var a=this.document.createRange();a.setStart(b[0],
this.startOffset);try{a.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(k);a.setEnd(this.endContainer[0],this.endOffset)}else throw c;}b=J(this.document).getNative();b.removeAllRanges();b.addRange(a)}:function(b){var a=this.collapsed,c,d;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var e=this.startContainer[0].childNodes[this.startOffset];if(e.nodeType==p.NODE_ELEMENT){(new D(this.document)).selectElement(new n(e));
return}}if(this.startContainer[0].nodeType==p.NODE_ELEMENT&&this.startContainer._4e_name()in M||this.endContainer[0].nodeType==p.NODE_ELEMENT&&this.endContainer._4e_name()in M)this.shrink(I.SHRINK_ELEMENT,k);var f=this.createBookmark();e=f.startNode;var h;if(!a)h=f.endNode;f=this.document.body.createTextRange();f.moveToElementText(e[0]);f.moveStart("character",1);if(h){b=this.document.body.createTextRange();b.moveToElementText(h[0]);f.setEndPoint("EndToEnd",b);f.moveEnd("character",-1)}else{for(c=
e[0].nextSibling;c&&!Q(c);)c=c.nextSibling;c=!(c&&c.nodeValue&&c.nodeValue.match(R))&&(b||!e[0].previousSibling||e[0].previousSibling&&v._4e_name(e[0].previousSibling)=="br");d=new n(this.document.createElement("span"));d.html("&#65279;");d.insertBefore(e);if(c)v.insertBefore(this.document.createTextNode("\ufeff"),e[0]||e)}this.setStartBefore(e);e._4e_remove();if(a){if(c){f.moveStart("character",-1);f.select();this.document.selection.clear()}else f.select();if(d){this.moveToPosition(d,I.POSITION_BEFORE_START);
d._4e_remove()}}else{this.setEndBefore(h);h._4e_remove();f.select()}};D.getSelection=J;q.Selection=D;q.on("instanceCreated",function(b){N(b.editor)})});
