KISSY.Editor.add("image/dialog",function(w){function N(){function d(a){if(a.files)return a.files[0].size;return 0}e=new c.Dialog({autoRender:true,width:500,headerContent:"\u56fe\u7247",bodyContent:O,footerContent:P,mask:true});o.call(k,e);var b=e.get("el"),f=b.one(".ke-img-cancel"),h=b.one(".ke-img-insert"),A=c.Utils.verifyInputs,l=b.one(".ke-img-setting");D=b.one(".ke-img-upload-form");m=b.one(".ke-img-local-url");s=new c.Tabs({tabs:b.one("ul.ke-tabs"),contents:b.one("div.ke-image-tabs-content-wrap")});o.call(k,
s);m.val(x);t=b.one(".ke-img-url");n=b.one(".ke-img-height");j=b.one(".ke-img-width");u=b.one(".ke-img-ratio");E=c.Select.decorate(b.one(".ke-img-align"));F=b.one(".ke-img-margin");var v=c.Utils.placeholder;v(t,Q);v(n,G);v(j,G);n.on("keyup",function(){var a=parseInt(n.val());!a||!u[0].checked||u[0].disabled||!y||j.val(Math.floor(a*y))});o.call(k,n,t,j);j.on("keyup",function(){var a=parseInt(j.val());!a||!u[0].checked||u[0].disabled||!y||n.val(Math.floor(a/y))});o.call(k,j);f.on("click",function(a){e.hide();
a.halt()});o.call(k,f);var B=(new H("<a class='ke-button' style='position:absolute;z-index:"+c.baseZIndex(c.zIndexManager.LOADING_CANCEL)+";left:-9999px;top:-9999px;'>\u53d6\u6d88\u4e0a\u4f20</a>")).appendTo(document.body),z=null;B.on("click",function(a){a&&a.halt();e.unloading();if(z){R.remove(z,"load");S.remove(z)}B.css({left:-9999,top:-9999});z=null});o.call(k,B);h.on("click",function(a){a&&a.halt();if(s.activate()=="local"&&i){if(A(l.all("input")))if(m.val()==x)alert("\u8bf7\u5148\u9009\u62e9\u6587\u4ef6!");else if(T.test(m.val())){a=d(p[0]);
if(C&&C<a/1E3)alert("\u4e0a\u4f20\u56fe\u7247\u6700\u5927\uff1a"+C/1E3+"M");else{e.loading();z=c.Utils.doFormUpload({form:D,callback:function(g){z=null;B.css({left:-9999,top:-9999});g=q.trim(g.responseText).replace(/\r|\n/g,"");e.unloading();try{g=U.parse(g)}catch(Y){q.log(g);g=null}g||(g={error:"\u670d\u52a1\u5668\u51fa\u9519\uff0c\u8bf7\u91cd\u8bd5"});if(g.error)alert(g.error);else{t.val(g.imgUrl);(new Image).src=g.imgUrl;J()}}},i.serverParams,i.serverUrl);a=e.get("el");var K=a.offset();B.css({left:K.left+a[0].offsetWidth/2.5,top:K.top+a[0].offsetHeight/1.5})}}else{alert(V);
D[0].reset();m.val(x)}}else A(b.all("input"))&&J()});o.call(k,h);if(i){i.extraHtml&&b.one(".ke-img-up-extraHtml").html(i.extraHtml);var L=b.one(".ke-image-up"),C=i&&i.sizeLimit;p=(new H("<input type='file' style='position:absolute;cursor:pointer;left:"+(W.ie?"360":"369")+"px;z-index:2;top:0px;height:26px;' size='1' name='"+(i.fileInput||"Filedata")+"'/>")).insertAfter(m);if(C)x="\u5355\u5f20\u56fe\u7247\u5bb9\u91cf\u4e0d\u8d85\u8fc7 "+C/1E3+" M";m.val(x);p.css("opacity",0);p.on("mouseenter",function(){L.addClass("ke-button-hover")});p.on("mouseleave",
function(){L.removeClass("ke-button-hover")});p.on("change",function(){var a=p.val();m.val(a.replace(/.+[\/\\]/,""))});o.call(k,p);I.remote===false&&s.remove("remote")}else s.remove("local")}function J(){var d=t.val(),b=parseInt(n.val()),f=parseInt(j.val()),h=E.val(),A=parseInt(F.val()),l="";if(b)l+="height:"+b+"px;";if(f)l+="width:"+f+"px;";if(h)l+="float:"+h+";";isNaN(A)||(l+="margin:"+A+"px;");e.hide();if(r){w.fire("save");r.attr({src:d,_ke_saved_src:d,style:l});w.fire("save")}else{b=new H("<img "+
(l?"style='"+l+"'":"")+" src='"+d+"' _ke_saved_src='"+d+"' alt='' />",null,w.document);w.insertElement(b,function(v){v.on("abort error",function(){v.detach();v[0].src=d})})}}var q=KISSY,c=q.Editor,S=q.DOM,W=q.UA,U=q.JSON,H=q.Node,R=q.Event,Q="http://",G="\u81ea\u52a8",O="<div class='ke-image-wrap'><ul class='ke-tabs ks-clear'><li rel='remote'>\u7f51\u7edc\u56fe\u7247</li><li rel='local'>\u672c\u5730\u4e0a\u4f20</li></ul><div style='padding:12px 20px 5px 20px;'><div class='ke-image-tabs-content-wrap' ><div><label><span class='ke-image-title'>\u56fe\u7247\u5730\u5740\uff1a </span><input  data-verify='^(https?:/)?/[^\\s]+$'  data-warning='\u7f51\u5740\u683c\u5f0f\u4e3a\uff1ahttp:// \u6216 /' class='ke-img-url ke-input' style='width:390px;' /></label></div><div style='position:relative;'><form class='ke-img-upload-form' method='post'><p style='zoom:1;'><input class='ke-input ke-img-local-url' readonly='readonly' style='margin-right: 15px; vertical-align: middle; width: 368px;color:#969696;'/><a style='padding:3px 11px;position:absolute;left:390px;top:0px;z-index:1;' class='ke-image-up ke-button'>\u6d4f\u89c8...</a></p><div class='ke-img-up-extraHtml'></div></form></div></div><table style='width:100%;margin-top:8px;' class='ke-img-setting'><tr><td><label>\u5bbd\u5ea6\uff1a <input  data-verify='^("+
G+"|((?!0$)\\d+))?$'  data-warning='\u5bbd\u5ea6\u8bf7\u8f93\u5165\u6b63\u6574\u6570' class='ke-img-width ke-input' style='vertical-align:middle;width:60px' /> \u50cf\u7d20 </label></td><td><label>\u9ad8\u5ea6\uff1a <input  data-verify='^("+G+"|((?!0$)\\d+))?$'  data-warning='\u9ad8\u5ea6\u8bf7\u8f93\u5165\u6b63\u6574\u6570' class='ke-img-height ke-input' style='vertical-align:middle;width:60px' /> \u50cf\u7d20 </label><label><input type='checkbox' class='ke-img-ratio' style='vertical-align:middle;margin-left:5px;' checked='checked'/> \u9501\u5b9a\u9ad8\u5bbd\u6bd4</label></td></tr><tr><td><label>\u5bf9\u9f50\uff1a<select class='ke-img-align' title='\u5bf9\u9f50'><option value='none'>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select></label></td><td><label>\u95f4\u8ddd\uff1a <input  data-verify='^\\d+$'  data-warning='\u95f4\u8ddd\u8bf7\u8f93\u5165\u975e\u8d1f\u6574\u6570' class='ke-img-margin ke-input' style='width:60px' value='0'/> \u50cf\u7d20</label></td></tr></table></div></div>",
P="<div style='padding:5px 20px 20px;'><a class='ke-img-insert ke-button' style='margin-right:30px;'>\u786e\u5b9a</a> <a  class='ke-img-cancel ke-button'>\u53d6\u6d88</a></div>",e,s,t,n,j,E,u,F,y,m,p,D,x="\u8bf7\u70b9\u51fb\u6d4f\u89c8\u4e0a\u4f20\u56fe\u7247",r,I=w.cfg.pluginConfig.image||{},i=I.upload||null,M=i&&i.suffix||"png,jpg,jpeg,gif",T=RegExp(M.split(/,/).join("|")+"$","i"),V="\u53ea\u5141\u8bb8\u540e\u7f00\u540d\u4e3a"+M+"\u7684\u56fe\u7247",k={},o=c.Utils.addRes,X=c.Utils.destroyRes;c.use("overlay,tabs,select",function(){N();w.addDialog("image/dialog",{show:function(d){var b="remote",f=c.Utils.resetInput,
h=c.Utils.valInput;if((r=d)&&I.remote!==false){h(t,r.attr("src"));d=r.width();f=r.height();h(n,f);h(j,d);E.val(r.css("float")||"none");h=parseInt(r._4e_style("margin"))||0;F.val(h);u[0].disabled=false;y=d/f}else{if(s.getTab("local"))b="local";f(t);f(n);f(j);E.val("none");F.val(0);u[0].disabled=true;y=null}D[0].reset();m.val(x);s.activate(b);e.show()},hide:function(){e.hide()},destroy:function(){X.call(k)},dialog:e})})},{attach:false});
