KISSY.Editor.add("bubbleview",function(){var h=KISSY,k=h.Editor,s=h.Event,t=h.DOM;if(k.BubbleView)h.log("attach bubbleview more","warn");else{var n=h.require("uibase").create(k.Overlay,[],{renderUI:function(){this.get("el").addClass("ke-bubbleview-bubble")},show:function(){var b=this.get("el");b.css("visibility","hidden");b.stop(1);b.css("display","none");this.set("visible",true);b.fadeIn(0.3)},hide:function(){var b=this.get("el");b.css("visibility","hidden");b.stop(1);this.set("visible",false)},
destructor:function(){k.Utils.destroyRes.call(this)}},{ATTRS:{focus4e:{value:false},zIndex:{value:k.baseZIndex(k.zIndexManager.BUBBLE_VIEW)}}}),i={};n.destroy=function(b){if((b=i[b])&&b.bubble){b.bubble.destroy();b.bubble=null}};n.attach=function(b){function q(){if(c){c.hide();s.remove(u,"scroll",v)}}function w(){var d;var a=c._selectedEl;if(a){var f=r.iframe[0].contentWindow,e=r.iframe.offset();d=e.top;e=e.left;var l=e+t.width(f);f=d+t.height(f);var j=a._4e_getOffset(document),o=j.top;j=j.left;var y=
j+a.width();a=o+a.height();var m,g;if(a>f&&o<f)g=f-30;else if(a>d&&a<f)g=a;if(y>e&&j<e)m=e;else if(j>e&&j<l)m=j;d=m!==undefined&&g!==undefined?[m,g]:void 0}else d=void 0;if(d){c.set("xy",d);var p;m=c;g=null;for(p in i)if(i.hasOwnProperty(p)){a=i[p];if(a.bubble){if(e=m!=a.bubble){if(e=a.bubble.get("visible")){f=m;l=a.bubble;e=f.get("y");f=e+f.get("el")[0].offsetHeight;o=l.get("y");l=o+l.get("el")[0].offsetHeight;e=e<=l&&f>=l||e<=o&&f>=o}e=e}if(e)if(g){if(g.get("y")<a.bubble.get("y"))g=a.bubble}else g=
a.bubble}}if(p=g){d[1]=p.get("y")+p.get("el")[0].offsetHeight;c.set("xy",d)}c.get("visible")?h.log("already show by selectionChange"):c.show()}}function v(){if(c._selectedEl){if(c){c.get("el");c.hide()}z()}}function A(){s.on(u,"scroll",v);w()}var x=b.pluginName;h.mix(b,i[x].cfg,false);var B=b.pluginContext,C=b.func,r=b.editor,c=b.bubble;r.on("selectionChange",function(d){d=d.path;var a=d.elements;if(d&&a)if(d=d.lastElement)if(d=C(d)){a=i[x];if(!a.bubble){a.bubble=new n;a.bubble.render();a.cfg.init&&
a.cfg.init.call(a.bubble)}c=a.bubble;c._selectedEl=d;c._plugin=B;c.hide();h.later(A,10)}else if(c){c._selectedEl=c._plugin=null;q()}});r.on("sourcemode",q);var u=r.iframe[0].contentWindow,z=k.Utils.buffer(w,undefined,350)};n.register=function(b){var q=b.pluginName;i[q]=i[q]||{cfg:b};b.editor&&n.attach(b)};k.BubbleView=n}},{attach:false,requires:["overlay"]});
