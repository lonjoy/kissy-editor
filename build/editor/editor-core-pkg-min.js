/*
 Constructor for kissy editor,dependency moved to independent module
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com, lifesinger@gmail.com
 @version: 2
 @buildtime: 2011-12-31 16:52:11
*/
KISSY.add("editor/export",function(v){function D(w,u){var q=this;if(!(q instanceof D))return new D(w,u);if(v.isString(w))w=v.one(w);w=E._4e_wrap(w);u=u||{};u.pluginConfig=u.pluginConfig||{};q.cfg=u;u.pluginConfig=u.pluginConfig;q.cfg=u;v.app(q,v.EventTarget);var g=["htmldataprocessor","enterkey","clipboard"],d=x;q.use=function(b,f){b=b.split(",");if(!d)for(var o=0;o<g.length;o++){var A=g[o];v.inArray(A,b)||b.unshift(A)}q.ready(function(){v.Editor.use("button,select",function(){v.use.call(q,b.join(","),
function(){for(var a=0;a<b.length;a++)q.usePlugin(b[a]);f&&f.call(q);if(!d){q.setData(w.val());if(u.focus)q.focus();else(a=q.getSelection())&&a.removeAllRanges();d=H}},{global:D})})});return q};q.use=q.use;q.Config.base=D.Config.base;q.Config.debug=D.Config.debug;q.Config.componentJsName=s;q.init(w)}var E=v.DOM,H=true,x=false,s;s=parseFloat(v.version)<1.2?function(){return"plugin-min.js?t="+encodeURIComponent("2011-12-31 16:52:11")}:function(w,u){return w+"/plugin-min.js"+(u?u:"?t="+encodeURIComponent("2011-12-31 16:52:11"))};
v.app(D,v.EventTarget);D.Config.base=v.Config.base+"editor/plugins/";D.Config.debug=v.Config.debug;D.Config.componentJsName=s;v.Editor=D;v.Editor=D});KISSY.add("editor",function(v){return v.Editor},{requires:["dd","overlay"]});
KISSY.Editor.add("utils",function(v){var D=null,E=KISSY,H=E.Node,x=E.DOM,s=E.UA,w=E.Event,u;u=s.ie?document.documentMode||s.ie:void 0;var q={debugUrl:function(g){g=g.replace(/-min\.(js|css)/i,".$1");v.Config.debug||(g=g.replace(/\.(js|css)/i,"-min.$1"));if(g.indexOf("?t")==-1){g+=g.indexOf("?")!=-1?"&":"?";g+="t="+encodeURIComponent("2011-11-26 21:29:45")}return v.Config.base+g},lazyRun:function(g,d,b){var f=g[d],o=g[b];g[d]=function(){f.apply(this,arguments);g[d]=g[b];return o.apply(this,arguments)}},
getXY:function(g,d,b,f){b=b.defaultView||b.parentWindow;g-=x.scrollLeft(b);d-=x.scrollTop(b);if(f)if(b!=(f.defaultView||f.parentWindow)&&b.frameElement){f=x._4e_getOffset(b.frameElement,f);g+=f.left;d+=f.top}return{left:g,top:d}},tryThese:function(){for(var g,d=0,b=arguments.length;d<b;d++){var f=arguments[d];try{g=f();break}catch(o){}}return g},arrayCompare:function(g,d){if(!g&&!d)return true;if(!g||!d||g.length!=d.length)return false;for(var b=0;b<g.length;b++)if(g[b]!==d[b])return false;return true},
getByAddress:function(g,d,b){g=g.documentElement;for(var f=0;g&&f<d.length;f++){var o=d[f];if(b)for(var A=-1,a=0;a<g.childNodes.length;a++){var e=g.childNodes[a];if(!(b===true&&e.nodeType==3&&e.previousSibling&&e.previousSibling.nodeType==3)){A++;if(A==o){g=e;break}}}else g=g.childNodes[o]}return g?new H(g):D},clearAllMarkers:function(g){for(var d in g)g[d]._4e_clearMarkers(g,true)},htmlEncodeAttr:function(g){return g.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(g){return g.replace(/^\s+/,
"")},rtrim:function(g){return g.replace(/\s+$/,"")},trim:function(g){return this.ltrim(this.rtrim(g))},mix:function(){for(var g={},d=0;d<arguments.length;d++)g=E.mix(g,arguments[d]);return g},isCustomDomain:function(){if(!s.ie)return false;var g=document.domain,d=window.location.hostname;return g!=d&&g!="["+d+"]"},buffer:function(g,d,b){b=b||0;var f=D;return function(){f&&clearTimeout(f);var o=arguments;f=setTimeout(function(){return g.apply(d,o)},b)}},isNumber:function(g){return/^\d+(.\d+)?$/.test(E.trim(g))},
verifyInputs:function(g){for(var d=0;d<g.length;d++){var b=x._4e_wrap(g[d]),f=E.trim(q.valInput(b)),o=b.attr("data-verify");b=b.attr("data-warning");if(o&&!RegExp(o).test(f)){alert(b);return false}}return true},sourceDisable:function(g,d){g.on("sourcemode",d.disable,d);g.on("wysiwygmode",d.enable,d)},resetInput:function(g){var d=g.attr("placeholder");if(d&&s.ie){g.addClass("ke-input-tip");g.val(d)}else s.ie||g.val("")},valInput:function(g,d){if(d===undefined)return g.hasClass("ke-input-tip")?"":g.val();
else{g.removeClass("ke-input-tip");g.val(d)}},placeholder:function(g,d){g.attr("placeholder",d);if(s.ie){g.on("blur",function(){if(!E.trim(g.val())){g.addClass("ke-input-tip");g.val(d)}});g.on("focus",function(){g.removeClass("ke-input-tip");E.trim(g.val())==d&&g.val("")})}},htmlEncode:function(g){return!g?g:String(g).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(g){g=E.clone(g);for(var d in g)if(g.hasOwnProperty(d)){var b=g[d];if(E.isFunction(b))g[d]=
b()}return g},doFormUpload:function(g,d,b){function f(){var j={responseText:"",responseXML:D};j.argument=g?g.argument:D;try{var l;if((l=s.ie?A.contentWindow.document:A.contentDocument||window.frames[o].document)&&l.body)j.responseText=E.trim(x.text(l.body));j.responseXML=l&&l.XMLDocument?l.XMLDocument:l}catch(r){E.log("after data returns error ,maybe domain problem:");E.log(r,"error")}w.remove(A,"load",f);g.callback&&g.callback(j);setTimeout(function(){x._4e_remove(A)},100)}var o=E.guid("form-upload-"),
A=document.createElement("iframe");A.id=o;A.name=o;A.className="ke-hidden";var a="document.open();"+(q.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();";if(s.ie)A.src=s.ie?"javascript:void(function(){"+encodeURIComponent(a)+"}())":"";E.log("doFormUpload : "+A.src);document.body.appendChild(A);if(s.ie)document.frames[o].name=o;a=x._4e_unwrap(g.form);var e={target:x.attr(a,"target"),method:x.attr(a,"method"),encoding:x.attr(a,"encoding"),enctype:x.attr(a,"enctype"),action:x.attr(a,
"action")};x.attr(a,{target:o,method:"post",enctype:"multipart/form-data",encoding:"multipart/form-data"});b&&x.attr(a,"action",b);var k;if(d){k=[];d=v.Utils.normParams(d);for(var i in d)if(d.hasOwnProperty(i)){b=document.createElement("input");b.type="hidden";b.name=i;b.value=d[i];a.appendChild(b);k.push(b)}}w.on(A,"load",f);a.submit();x.attr(a,e);if(k){d=0;for(i=k.length;d<i;d++)x._4e_remove(k[d])}return A},map:function(g,d){for(var b=0;b<g.length;b++)g[b]=d(g[b]);return g},ieEngine:u,preventFocus:function(g){s.ie?
g._4e_unselectable():g.attr("onmousedown","return false;")},isFlashEmbed:function(g){g=g.attributes;return g.type=="application/x-shockwave-flash"||/\.swf(?:$|\?)/i.test(g.src||"")},addRes:function(){var g=this.__res=this.__res||[];g.push.apply(g,E.makeArray(arguments))},destroyRes:function(){for(var g=this.__res||[],d=0;d<g.length;d++){var b=g[d];if(E.isFunction(b))b();else{b.detach&&b.detach();b.destroy&&b.destroy();b.nodeType&&b.remove&&b.remove()}}this.__res=[]}};return v.Utils=q});
KISSY.Editor.add("dom",function(v){function D(a){return a.replace(/-(\w)/g,function(e,k){return k.toUpperCase()})}var E=KISSY,H=E.DOM,x=E.UA,s=E.Node,w=v.Utils,u={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};v.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};v.NODE=v.NODE;v.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,
POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};v.POSITION=v.POSITION;var q=v.NODE,g=v.POSITION,d={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},b={hr:1},f=function(a){return a[0]||a},o=function(a){if(a&&!a[0])return new s(a);return a},A={_4e_wrap:o,_4e_unwrap:f,_4e_equals:function(a,e){if(!a&&!e)return true;if(!a||!e)return false;a=f(a);e=f(e);
return a===e},_4e_isBlockBoundary:function(a,e){a=o(a);var k=E.mix(E.mix({},b),e||{});return d[a.css("display")]||k[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=f(a);for(var e=a.parentNode.childNodes,k=0;k<e.length;k++)if(e[k]===a)return k;return-1},_4e_first:function(a,e){a=f(a);var k=a.firstChild;if((k=k&&new s(k))&&e&&!e(k))k=k._4e_next(e);return k},_4e_move:function(a,e,k){a=f(a);H._4e_remove(a);
e=f(e);k?e.insertBefore(a,e.firstChild):e.appendChild(a)},_4e_name:function(a){a=f(a);var e=a.nodeName.toLowerCase();if(x.ie)if((a=a.scopeName)&&a!="HTML")e=a.toLowerCase()+":"+e;return e},_4e_isIdentical:function(a,e){if(a._4e_name()!=e._4e_name())return false;var k=a[0].attributes,i=e[0].attributes,j=k.length,l=i.length;if(j!=l)return false;for(var r=0;r<j;r++){var p=k[r],y=p.name;if(p.specified&&a.attr(y)!=e.attr(y))return false}if(w.ieEngine<8)for(r=0;r<l;r++){p=i[r];y=p.name;if(p.specified&&
a.attr(y)!=e.attr(y))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=f(a).childNodes;for(var e=0,k=a.length;e<k;e++){var i=a[e],j=i.nodeType;if(!(j==q.NODE_ELEMENT&&i.getAttribute("_ke_bookmark")))if(j==q.NODE_ELEMENT&&!A._4e_isEmptyInlineRemoveable(i)||j==q.NODE_TEXT&&E.trim(i.nodeValue))return false}return true},_4e_moveChildren:function(a,e,k){a=f(a);e=e[0]||e;if(a!=e)if(k)for(;k=a.lastChild;)e.insertBefore(a.removeChild(k),e.firstChild);else for(;k=a.firstChild;)e.appendChild(a.removeChild(k))},
_4e_mergeSiblings:function(){function a(e,k,i){if(k[0]&&k[0].nodeType==q.NODE_ELEMENT){for(var j=[];k.attr("_ke_bookmark")||k._4e_isEmptyInlineRemoveable();){j.push(k);k=i?new s(k[0].nextSibling):new s(k[0].previousSibling);if(!k[0]||k[0].nodeType!=q.NODE_ELEMENT)return}if(e._4e_isIdentical(k)){for(var l=i?e[0].lastChild:e[0].firstChild;j.length;)j.shift()._4e_move(e,!i);k._4e_moveChildren(e,!i);k._4e_remove();l[0]&&l[0].nodeType==q.NODE_ELEMENT&&l._4e_mergeSiblings()}}}return function(e){if(e[0])if(u[e._4e_name()]||
e._4e_name()=="a"){a(e,new s(e[0].nextSibling),true);a(e,new s(e[0].previousSibling))}}}(),_4e_unselectable:x.gecko?function(a){a=f(a);a.style.MozUserSelect="none"}:x.webkit?function(a){a=f(a);a.style.KhtmlUserSelect="none"}:function(a){a=f(a);if(x.ie||x.opera){var e=0;a.setAttribute("unselectable","on");for(var k=a.getElementsByTagName("*");a=k[e++];)switch(a.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:a.setAttribute("unselectable","on")}}},_4e_getOffset:function(a,
e){a=f(a);var k,i=0;k=0;var j=a.ownerDocument.defaultView||a.ownerDocument.parentWindow,l=a.ownerDocument,r=l.documentElement;e=e||l;if(a.getBoundingClientRect){if(a!==l.body&&r!==a){k=a.getBoundingClientRect();i=k.left+(e===l?H.scrollLeft(j):0);k=k.top+(e===l?H.scrollTop(j):0)}if(e)if(j!=(e.defaultView||e.parentWindow)&&j.frameElement){j=A._4e_getOffset(j.frameElement,e);i+=j.left;k+=j.top}}return{left:i,top:k}},_4e_splitText:function(a,e){a=f(a);var k=a.ownerDocument;if(!(!a||a.nodeType!=q.NODE_TEXT)){if(x.ie&&
e==a.nodeValue.length){var i=k.createTextNode("");H.insertAfter(i,a);return new s(i)}i=new s(a.splitText(e));if(k.documentMode){k=k.createTextNode("");H.insertAfter(k,i[0]);H._4e_remove(k)}return i}},_4e_parents:function(a,e){a=o(a);var k=[];do k[e?"push":"unshift"](a);while(a=a.parent());return k},_4e_clone:function(a,e,k){a=f(a);a=a.cloneNode(e);if(!k){var i=function(j){if(j.nodeType==q.NODE_ELEMENT){j.removeAttribute("id");j=j.childNodes;for(var l=0;l<j.length;l++)i(j[l])}};i(a)}return new s(a)},
_4e_nextSourceNode:function(a,e,k,i){a=f(a);if(i&&!i.call){var j=i[0]||i;i=function(r){r=r[0]||r;return r!==j}}e=!e&&a.firstChild;var l=new s(a);if(!e){if(a.nodeType==q.NODE_ELEMENT&&i&&i(a,true)===false)return null;e=a.nextSibling}for(;!e&&(l=l.parent());){if(i&&i(l,true)===false)return null;e=l[0].nextSibling}if(!e)return null;e=H._4e_wrap(e);if(i&&i(e)===false)return null;if(k&&k!=e[0].nodeType)return e._4e_nextSourceNode(false,k,i);return e},_4e_previousSourceNode:function(a,e,k,i){a=f(a);if(i&&
!i.call){var j=i[0]||i;i=function(r){r=r[0]||r;return r!==j}}e=!e&&a.lastChild;var l=new s(a);if(!e){if(a.nodeType==q.NODE_ELEMENT&&i&&i(a,true)===false)return null;e=a.previousSibling}for(;!e&&(l=l.parent());){if(i&&i(l,true)===false)return null;e=l[0].previousSibling}if(!e)return null;e=H._4e_wrap(e);if(i&&i(e)===false)return null;if(k&&e[0].nodeType!=k)return e._4e_previousSourceNode(false,k,i);return e},_4e_commonAncestor:function(a,e){if(a._4e_equals(e))return a;if(e[0].nodeType!=q.NODE_TEXT&&
e.contains(a))return e;var k=a[0].nodeType==q.NODE_TEXT?a.parent():a;do if(k[0].nodeType!=q.NODE_TEXT&&k.contains(e))return k;while(k=k.parent());return null},_4e_ascendant:function(a,e,k){a=f(a);if(!k)a=a.parentNode;if(e&&!E.isFunction(e)){var i=e;e=function(j){return j._4e_name()==i}}for(;a&&a.nodeType!=9;){if(!e||e(new s(a))===true)return new s(a);a=a.parentNode}return null},_4e_hasAttribute:w.ieEngine<9?function(a,e){a=f(a);var k=a.getAttributeNode(e);return!!(k&&k.specified)}:function(a,e){a=
f(a);return a.hasAttribute(e)},_4e_hasAttributes:w.ieEngine<9?function(a){a=f(a);for(var e=a.attributes,k=0;k<e.length;k++){var i=e[k];switch(i.name){case "class":if(a.getAttribute("class"))return true;break;default:if(i.specified)return true}}return false}:function(a){a=f(a);x.gecko&&a.removeAttribute("_moz_dirty");return a.hasAttributes()},_4e_position:function(a,e){var k=f(a),i=f(e);if(k.compareDocumentPosition)return k.compareDocumentPosition(i);if(k==i)return g.POSITION_IDENTICAL;if(k.nodeType==
q.NODE_ELEMENT&&i.nodeType==q.NODE_ELEMENT){if(k.contains){if(k.contains(i))return g.POSITION_CONTAINS+g.POSITION_PRECEDING;if(i.contains(k))return g.POSITION_IS_CONTAINED+g.POSITION_FOLLOWING}if("sourceIndex"in k)return k.sourceIndex<0||i.sourceIndex<0?g.POSITION_DISCONNECTED:k.sourceIndex<i.sourceIndex?g.POSITION_PRECEDING:g.POSITION_FOLLOWING}k=a._4e_address();i=e._4e_address();for(var j=Math.min(k.length,i.length),l=0;l<=j-1;l++)if(k[l]!=i[l]){if(l<j)return k[l]<i[l]?g.POSITION_PRECEDING:g.POSITION_FOLLOWING;
break}return k.length<i.length?g.POSITION_CONTAINS+g.POSITION_PRECEDING:g.POSITION_IS_CONTAINED+g.POSITION_FOLLOWING},_4e_address:function(a,e){a=f(a);for(var k=[],i=a.ownerDocument.documentElement,j=a;j&&j!=i;){var l=j.parentNode,r=-1;if(l){for(var p=0;p<l.childNodes.length;p++){var y=l.childNodes[p];if(!(e&&y.nodeType==3&&y.previousSibling&&y.previousSibling.nodeType==3)){r++;if(y==j)break}}k.unshift(r)}j=l}return k},_4e_breakParent:function(a,e){var k=new v.Range(a[0].ownerDocument);k.setStartAfter(a);
k.setEndAfter(e);var i=k.extractContents();k.insertNode(a._4e_remove());a[0].parentNode.insertBefore(i,a[0].nextSibling)},_4e_style:function(a,e,k){if(k!==undefined){a=o(a);a.css(e,k);a.attr("style")||a.removeAttr("style")}else{a=f(a);return a.style[D(e)]}},_4e_remove:function(a,e){var k=f(a),i=k.parentNode;if(i){if(e)for(var j;j=k.firstChild;)i.insertBefore(k.removeChild(j),k);i.removeChild(k)}return a},_4e_trim:function(a){H._4e_ltrim(a);H._4e_rtrim(a)},_4e_ltrim:function(a){a=f(a);for(var e;e=
a.firstChild;){if(e.nodeType==q.NODE_TEXT){var k=w.ltrim(e.nodeValue),i=e.nodeValue.length;if(k){if(k.length<i){(new s(e))._4e_splitText(i-k.length);a.removeChild(a.firstChild)}}else{a.removeChild(e);continue}}break}},_4e_rtrim:function(a){a=f(a);for(var e;e=a.lastChild;){if(e.type==q.NODE_TEXT){var k=w.rtrim(e.nodeValue),i=e.nodeValue.length;if(k){if(k.length<i){(new s(e))._4e_splitText(k.length);a.removeChild(a.lastChild)}}else{a.removeChild(e);continue}}break}if(!x.ie&&!x.opera)(e=a.lastChild)&&
e.nodeType==1&&e.nodeName.toLowerCase()=="br"&&e.parentNode.removeChild(e)},_4e_appendBogus:function(a){a=f(a);for(var e=a.lastChild;e&&e.nodeType==q.NODE_TEXT&&!E.trim(e.nodeValue);)e=e.previousSibling;if(!e||e.nodeType==q.NODE_TEXT||H._4e_name(e)!=="br"){e=x.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br");x.gecko&&e.setAttribute("type","_moz");a.appendChild(e)}},_4e_previous:function(a,e){var k=f(a),i;do i=(k=k.previousSibling)&&new s(k);while(i&&e&&!e(i));return i},
_4e_last:function(a,e){a=H._4e_wrap(a);var k=a[0].lastChild;if((k=k&&new s(k))&&e&&!e(k))k=k._4e_previous(e);return k},_4e_next:function(a,e){var k=f(a),i;do i=(k=k.nextSibling)&&new s(k);while(i&&e&&!e(i));return i},_4e_outerHtml:function(a){a=f(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var e=a.ownerDocument.createElement("div");e.appendChild(a.cloneNode(true));return e.innerHTML},_4e_setMarker:function(a,e,k,i){a=H._4e_wrap(a);var j=a.data("list_marker_id")||a.data("list_marker_id",
E.guid()).data("list_marker_id"),l=a.data("list_marker_names")||a.data("list_marker_names",{}).data("list_marker_names");e[j]=a;l[k]=1;return a.data(k,i)},_4e_clearMarkers:function(a,e,k){a=o(a);var i=a.data("list_marker_names"),j=a.data("list_marker_id"),l;for(l in i)a.removeData(l);a.removeData("list_marker_names");if(k){a.removeData("list_marker_id");delete e[j]}},_4e_copyAttributes:function(a,e,k){a=f(a);e=o(e);var i=a.attributes;k=k||{};for(var j=0;j<i.length;j++){var l=i[j],r=l.name.toLowerCase(),
p;if(!(r in k))if(r=="checked"&&(p=H.attr(a,r)))e.attr(r,p);else if(l.specified||x.ie&&l.value&&r=="value"){p=H.attr(a,r);if(p===null)p=l.nodeValue;e.attr(r,p)}}if(a.style.cssText!=="")e[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=H._4e_name(a);var e=v.XHTML_DTD;return(a=!e.$nonEditable[a]&&(e[a]||e.span))&&a["#"]},_4e_scrollIntoView:function(a){a=o(a);a.scrollIntoView(a[0].ownerDocument,false)},_4e_getElementsByTagName:function(a,e,k){a=f(a);if(!x.ie&&k)e=k+":"+e;k=[];a=a.getElementsByTagName(e);
for(e=0;e<a.length;e++)k.push(new s(a[e]));return k}};(function(a){E.mix(H,a);for(var e in a)a.hasOwnProperty(e)&&function(k){s.prototype[k]=function(){var i=[].slice.call(arguments,0);i.unshift(this);return a[k].apply(null,i)}}(e)})(A)});
KISSY.Editor.add("focusmanager",function(v){function D(){var f=this;f.iframeFocus=g;q=f;u&&clearTimeout(u);u=setTimeout(function(){f.fire("focus")},100)}function E(){var f=this;f.iframeFocus=d;q=b;u&&clearTimeout(u);u=setTimeout(function(){f.fire("blur")},100)}var H=KISSY,x=H.DOM,s=H.Event,w={},u,q;H={refreshAll:function(){for(var f in w){var o=w[f];o.document.designMode="off";o.document.designMode="on"}},currentInstance:function(){return q},getInstance:function(f){return w[f]},add:function(f){var o=
x._4e_getWin(f.document);s.on(o,"focus",D,f);s.on(o,"blur",E,f)},register:function(f){w[f._UUID]=f},remove:function(f){delete w[f._UUID];var o=x._4e_getWin(f.document);s.remove(o,"focus",D,f);s.remove(o,"blur",E,f)}};var g=true,d=false,b=null;H.refreshAll=H.refreshAll;v.focusManager=H;v.focusManager=H;v.getInstances=function(){return w};v.getInstances=v.getInstances});
KISSY.Editor.add("definition",function(v){var D=true,E=false,H=v.Utils,x=document,s=KISSY,w=s.UA,u=w.ie,q=s.DOM,g=s.Node,d=s.Event,b=v.focusManager,f=H.tryThese,o=1,A="document.open();"+(H.isCustomDomain()?'document.domain="'+x.domain+'";':"")+"document.close();",a="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"' ></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor" '+
(u?' src="javascript:void(function(){'+encodeURIComponent(A)+'}())"':"")+' allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>",e,k;e=v.SOURCE_MODE=0;k=v.WYSIWYG_MODE=1;v.SOURCE_MODE=e;v.WYSIWYG_MODE=k;s.augment(v,{init:function(i){var j=this,l;j.__commands={};j.__dialogs={};j.__plugins={};u&&q.addClass(x.body,"ke-ie"+u);if(w.trident)q.addClass(x.body,"ke-trident"+w.trident);else if(w.gecko)q.addClass(x.body,"ke-gecko");else w.webkit&&q.addClass(x.body,
"ke-webkit");l=new g(a);j.editorWrap=l;j._UUID=o++;b.register(j);j.wrap=l.one(".ke-textarea-wrap");j.iframe=j.wrap.one("iframe");j.toolBarDiv=l.one(".ke-editor-tools");j.textarea=i;j.statusDiv=l.one(".ke-editor-status");H.preventFocus(j.toolBarDiv);var r=i._4e_style("width"),p=i._4e_style("height");if(r){l.css("width",r);i.css("width","100%")}j.textarea.css("display","none");l.insertAfter(i);j.wrap[0].appendChild(i[0]);if(p){j.wrap.css("height",p);i.css("height","100%")}l=j.iframe;if(i._4e_hasAttribute("tabindex"))l[0].tabIndex=
w.webkit?-1:i[0].tabIndex;j.on("dataReady",function(){j._ready=D;v.fire("instanceCreated",{editor:j})});w.gecko?l.on("load",j._setUpIFrame,j):j._setUpIFrame();j.cfg.attachForm&&i[0].form&&j._attachForm()},destroy:function(){if(!this.__destroyed){var i=this.editorWrap,j=this.textarea,l=this.document,r=this.iframe[0].contentWindow;this.sync();v.focusManager.remove(this);d.remove(l);d.remove(l.documentElement);d.remove(l.body);d.remove(r);this.iframe.detach();l=this.__plugins;for(var p in l)if(l.hasOwnProperty(p)){r=
l[p];r.destroy&&r.destroy()}this.fire("destroy");j.insertBefore(i);i.remove();j.css({width:i[0].style.width,height:this.wrap.css("height")});j.show();this.__commands=this.__dialogs=this.__plugins=null;this.detach();this.__destroyed=true}},_attachForm:function(){var i=this,j=new g(i.textarea[0].form);j.on("submit",i.sync,i);i.on("destroy",function(){j.detach("submit",i.sync,i)})},useDialog:function(i,j){var l=this,r=v.Overlay;r&&r.loading();l.use(i,function(){var p=l.getDialog(i);if(p){j(p);r&&r.unloading()}else s.later(arguments.callee,
50,false,l)})},showDialog:function(i,j,l){var r=this;j=j||[];r.useDialog(i,function(p){p.show.apply(p,j);l&&l(p);r.fire("dialogShow",{dialog:p.dialog,pluginDialog:p,dialogName:i})})},addDialog:function(i,j){this.__dialogs[i]=j},getDialog:function(i){return this.__dialogs[i]},destroyDialog:function(i){var j=this.__dialogs[i];j&&j.destroy();this.__dialogs[i]=null},addCommand:function(i,j){this.__commands[i]=j},hasCommand:function(i){return this.__commands[i]},execCommand:function(i){var j=this.__commands[i],
l=s.makeArray(arguments);l.shift();l.unshift(this);return j.exec.apply(j,l)},getMode:function(){return this.textarea.css("display")=="none"?k:e},getData:function(i){var j;j=this.getMode()==k?this.document&&this.document.body?this.document.body.innerHTML:"":this.textarea.val();if(this.htmlDataProcessor)j=i?this.htmlDataProcessor.toHtml(j,"p"):this.htmlDataProcessor.toServer(j,"p");j=s.trim(j);if(/^<p>((&nbsp;)|\s)*<\/p>$/.test(j))j="";return j},setData:function(i){var j=i;if(this.htmlDataProcessor)j=
this.htmlDataProcessor.toDataFormat(i,"p");this.document.body.innerHTML=j;if(!j)this.document.body.innerHTML=j;this.getMode()!=k&&this.textarea.val(i)},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(i){this.document.body.innerHTML=i},_prepareIFrameHtml:function(i){var j=this.cfg,l=j.customStyle;j=j.customLink;var r="",p=v.Utils.debugUrl("../theme/editor-iframe.css");if(j)for(var y=0;y<j.length;y++)r+='<link href="'+
j[y]+'" rel="stylesheet"/>';return"<!doctype html><html><head><title>${title}</title><link href='"+p+"' rel='stylesheet'/><style>"+(l||"")+"</style>"+r+"</head><body class='ke-editor'>&nbsp;"+(i?'<script id="ke_actscript" type="text/javascript">'+(H.isCustomDomain()?'document.domain="'+x.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+i+'");<\/script>':"")+"</body></html>"},getSelection:function(){return v.Selection.getSelection(this.document)},focus:function(){var i=this.document,j=q._4e_getWin(i);
w.ie||j&&j.parent&&j.parent.focus();j&&j.focus();i&&i.body.focus();this.notifySelectionChange()},blur:function(){q._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},addCustomStyle:function(i){var j=this.cfg,l=this.document;j.customStyle=j.customStyle||"";j.customStyle+="\n"+i;j=l.createElement("style");l.getElementsByTagName("head")[0].appendChild(j);if(j.styleSheet)j.styleSheet.cssText=i;else j.appendChild(l.createTextNode(i))},addCustomLink:function(i){var j=this.cfg,l=
this.document;j.customLink=j.customLink||[];j.customLink.push(i);j=l.createElement("link");j.rel="stylesheet";l.getElementsByTagName("head")[0].appendChild(j);j.href=i},removeCustomLink:function(i){for(var j=this.cfg,l=s.makeArray(this.document.getElementsByTagName("link")),r=0;r<l.length;r++)l[r].href==i&&q._4e_remove(l[r]);j.customLink=j.customLink||[];j=j.customLink;i=s.indexOf(i,j);i!=-1&&j.splice(i,1)},_setUpIFrame:function(){function i(){y=p.document;j.document=y;l.detach();y.open("text/html",
"replace");y.write(r);y.close()}var j=this,l=j.iframe,r=j._prepareIFrameHtml(j._UUID),p=l[0].contentWindow,y;try{y=p.document}catch(G){l[0].src=l[0].src;if(u<7){setTimeout(i,10);return}}i()},ready:function(i){this._ready?i():this.on("dataReady",i)},addPlugin:function(i,j,l){this.__plugins=this.__plugins;l=l||{};l.func=j;this.__plugins[i]=l},usePlugin:function(i){var j=this.__plugins[i];if(j)if(!(j.status&&!j.duplicate)){i=this.Env.mods[i].requires||[];for(var l=0;l<i.length;l++)this.usePlugin(i[l]);
j.func.call(j);j.status=1}},_monitor:function(){var i=this;i._monitorId&&clearTimeout(i._monitorId);i._monitorId=setTimeout(function(){var j=i.getSelection();if(j&&!j.isInvalid){var l=j.getStartElement(),r=new v.ElementPath(l);if(!i.previousPath||!i.previousPath.compare(r)){i.previousPath=r;i.fire("selectionChange",{selection:j,path:r,element:l})}}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(i,j,l){var r=this;if(r.getMode()===k){r.focus();
var p,y=i._4e_name(),G=v.XHTML_DTD,c=v.RANGE,h=v.NODE,m=G.$block[y],z=r.getSelection(),n=z&&z.getRanges(),t,O,P,N;if(!n||n.length==0){var M=arguments,R=M.callee;setTimeout(function(){R.apply(r,M)},30)}else{r.fire("save");for(var Q=n.length-1;Q>=0;Q--){t=n[Q];t.deleteContents();p=!Q&&i||i._4e_clone(D);j&&j(p);if(m)for(;(P=t.getCommonAncestor(E,D))&&(N=G[P._4e_name()])&&!(N&&N[y]);)if(P._4e_name()in G.span)t.splitElement(P);else if(t.checkStartOfBlock()&&t.checkEndOfBlock()){t.setStartBefore(P);t.collapse(D);
P._4e_remove()}else t.splitBlock();t.insertNode(p);O||(O=p)}if(O){y=O._4e_nextSourceNode(D);G=r.document;N=v.XHTML_DTD;if(N.$inline[p._4e_name()]){y=new g(G.createTextNode(" "));y.insertAfter(O)}else if(y){if(y._4e_name()=="br"&&N[y.parent()._4e_name()].p){N=new g("<p>&nbsp;</p>",null,G);y[0].parentNode.replaceChild(N[0],y[0]);y=N}}else{N=new g("<p>&nbsp;</p>",null,G);N.insertAfter(O);y=N}t.moveToPosition(O,c.POSITION_AFTER_END);y&&y[0].nodeType==h.NODE_ELEMENT&&t.moveToElementEditablePosition(y);
z.selectRanges([t]);r.focus();p&&p._4e_scrollIntoView();r._saveLater();l&&l(p)}}}},insertHtml:function(i,j){var l=this;if(l.getMode()===k){if(l.htmlDataProcessor)i=l.htmlDataProcessor.toDataFormat(i,null,j);l.focus();l.fire("save");var r=l.document,p=0;if(u){var y=r.selection;y.type=="Control"&&y.clear();try{y.createRange().pasteHTML(i)}catch(G){s.log("insertHtml error in ie")}}else try{r.execCommand("inserthtml",E,i)}catch(c){setTimeout(function(){if(l.getSelection().getRanges().length==0){var h=
new v.Range(r),m=q._4e_first(r.body,function(z){return z[0].nodeType==1&&z._4e_name()!="br"});if(!m){m=new g(r.createElement("p"));r.body.appendChild(m[0])}h.setStartAt(m,v.RANGE.POSITION_AFTER_START);h.select()}r.execCommand("inserthtml",E,i)},p=100)}setTimeout(function(){l.getSelection().scrollIntoView()},p);l._saveLater(p)}},_saveLater:function(i){var j=this;if(j.__saveTimer){clearTimeout(j.__saveTimer);j.__saveTimer=null}j.__saveTimer=setTimeout(function(){j.fire("save")},i||0)}});v._initIFrame=
function(i){function j(n){f(function(){p.designMode="on";setTimeout(function(){p.designMode="off";c.focus();if(!arguments.callee.retry)arguments.callee.retry=D},50)},function(){p.designMode="off";q.attr(c,"contentEditable",E);q.attr(c,"contentEditable",D);!n&&j(1)})}var l=b.getInstance(i);i=l.textarea[0];var r=l.iframe[0].contentWindow,p=l.document,y=l.cfg,G=p.getElementById("ke_actscript");q._4e_remove(G);var c=p.body;if(u){c.hideFocus=D;c.disabled=D;c.contentEditable=D;c.removeAttribute("disabled")}else setTimeout(function(){if(w.gecko||
w.opera)c.contentEditable=D;else if(w.webkit)c.parentNode.contentEditable=D;else p.designMode="on"},0);if(w.webkit){d.on(p,"click",function(n){var t=new g(n.target);s.inArray(t._4e_name(),["input","select"])&&n.preventDefault()});d.on(p,"mouseup",function(n){var t=new g(n.target);s.inArray(t._4e_name(),["input","textarea"])&&n.preventDefault()})}if(w.gecko||u||w.opera){var h;h=(new g('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(i);h.on("focus",
function(){l.focus()});l.activateGecko=function(){w.gecko&&l.iframeFocus&&h[0].focus()};l.on("destroy",function(){h.detach();h.remove()})}if(p.documentMode||w.gecko||w.opera){var m=p.documentElement;d.on(m,"mousedown",function(n){if((new g(n.target))[0]==m){w.gecko&&j(E);h[0].focus()}})}d.on(r,"focus",function(){if(w.gecko)j(E);else w.opera&&c.focus();l.notifySelectionChange()});w.gecko&&d.on(l.document,"mousedown",function(){l.iframeFocus||j(E)});if(u){d.on(p,"keydown",function(n){if(n.keyCode in
{8:1,46:1}){var t=l.getSelection(),O=t.getSelectedElement();if(O){l.fire("save");var P=t.getRanges()[0].createBookmark();O._4e_remove();t.selectBookmarks([P]);l.fire("save");n.preventDefault()}}});if(p.compatMode=="CSS1Compat"){var z={33:1,34:1};d.on(p,"keydown",function(n){n.keyCode in z&&setTimeout(function(){l.getSelection().scrollIntoView()},0)})}}setTimeout(function(){u&&setTimeout(function(){if(p){c.runtimeStyle.marginBottom="0px";c.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){l.fire("dataReady");
var n=y.disableObjectResizing,t=y.disableInlineTableEditing;if(n||t)try{p.execCommand("enableObjectResizing",E,!n);p.execCommand("enableInlineTableEditing",E,!t)}catch(O){d.on(c,u?"resizestart":"resize",function(P){var N=new g(P.target);if(n||N._4e_name()==="table"&&t)P.preventDefault()})}},10);w.webkit&&d.on(p,"mousedown",function(n){n=new g(n.target);s.inArray(n._4e_name(),["img","hr","input","textarea","select"])&&l.getSelection().selectElement(n)});w.gecko&&d.on(p,"dragstart",function(n){var t=
new g(n.target);t._4e_name()==="img"&&/ke_/.test(t[0].className)&&n.preventDefault()});b.add(l)};x.documentMode>7&&function(){for(var i=s.all("link"),j=0;j<i.length;j++){var l=new g(i[j]),r=l.attr("href");r.indexOf("editor-pkg-min-mhtml.css")!=-1&&l.attr("href",r.replace(/editor-pkg-min-mhtml\.css/g,"editor-pkg-min-datauri.css"))}}()});
KISSY.Editor.add("zindex",function(){var v=KISSY.Editor;if(!v.zIndexManager){v.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,DD_PG:99999,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};v.baseZIndex=function(D){return(v.Config.baseZIndex||1E4)+D};v.baseZIndex=v.baseZIndex;v.zIndexManager=v.zIndexManager}});
KISSY.Editor.add("dtd",function(v){v.XHTML_DTD=function(){function D(){for(var r=arguments[0],p=arguments.length-1;p>0;)KISSY.mix(r,arguments[p--]);return r}var E={isindex:1,fieldset:1},H={input:1,button:1,select:1,textarea:1,label:1},x=D({a:1},H),s=D({iframe:1},x),w={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},u={ins:1,del:1,script:1,style:1},q=D({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,
cite:1,kbd:1,u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},u),g=D({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},q),d=D({p:1},g);H=D({iframe:1},g,H);g={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,
dir:1,map:1,dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var b=D({a:1},H),f={tr:1},o={"#":1},A=D({param:1},g),a=D({form:1},E,s,w,d),e={li:1},k={base:1,link:1,meta:1,title:1},i=D(k,{style:1,script:1}),j={head:1,body:1},l={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:D({html:1},j,
k),$block:l,$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:b,$body:D({script:1,style:1},l),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,
span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:j,head:i,style:o,body:a,base:{},link:{},meta:{},title:o,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:a,td:a,br:{},th:a,center:a,kbd:b,button:D(d,w),basefont:{},h5:b,h4:b,samp:b,h6:b,ol:e,h1:b,h3:b,option:o,h2:b,form:D(E,s,w,d),select:{optgroup:1,option:1},font:b,ins:b,menu:e,abbr:b,
label:b,table:{thead:1,col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:b,script:o,tfoot:f,cite:b,li:a,input:{},iframe:a,strong:b,textarea:o,noframes:a,big:b,small:b,span:b,hr:{},dt:b,sub:b,optgroup:{option:1},param:{},bdo:b,"var":b,div:a,object:A,sup:b,dd:a,strike:b,area:{},dir:e,map:D({area:1,form:1,p:1},E,u,w),applet:A,dl:{dt:1,dd:1},del:b,isindex:{},fieldset:D({legend:1},g),thead:f,ul:e,acronym:b,b:b,a:H,blockquote:a,caption:b,i:b,u:b,tbody:f,s:b,address:D(s,d),tt:b,legend:b,q:b,pre:D(q,
x),p:b,em:b,dfn:b}}();v.XHTML_DTD=v.XHTML_DTD});
KISSY.Editor.add("elementpath",function(v){function D(q){var g=s,d=s,b=[];for(q=q;q;){if(q[0].nodeType==x.NODE_ELEMENT){if(!this.lastElement)this.lastElement=q;var f=q._4e_name();if(!d){if(!g&&w[f])g=q;if(u[f]){var o;if(o=!g){if(o=f=="div"){a:{o=q;o=E._4e_unwrap(o);o=o.childNodes;for(var A=0,a=o.length;A<a;A++){var e=o[A];if(e.nodeType==x.NODE_ELEMENT&&H.$block[e.nodeName.toLowerCase()]){o=true;break a}}o=false}o=!o}o=o}if(o)g=q;else d=q}}b.push(q);if(f=="body")break}q=q.parent()}this.block=g;this.blockLimit=
d;this.elements=b}var E=KISSY.DOM,H=v.XHTML_DTD,x=v.NODE,s=null,w={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},u={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};D.prototype={compare:function(q){var g=this.elements;q=q&&q.elements;if(!q||g.length!=q.length)return false;for(var d=0;d<g.length;d++)if(!E._4e_equals(g[d],q[d]))return false;return true},contains:function(q){for(var g=this.elements,d=0;d<g.length;d++)if(g[d]._4e_name()in q)return g[d];
return s},toString:function(){var q=this.elements,g,d=[];for(g=0;g<q.length;g++)d.push(q[g]._4e_name());return d.toString()}};v.ElementPath=D});
KISSY.Editor.add("walker",function(v){function D(b,f){if(this._.end)return w;var o,A=this.range,a,e=this.guard,k=this.type,i=b?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;A.trim();if(A.collapsed){this.end();return w}}if(!b&&!this._.guardLTR){var j=A.endContainer,l=new d(j[0].childNodes[A.endOffset]);this._.guardLTR=function(G,c){return(G=g._4e_wrap(G))&&G[0]&&(!c||!g._4e_equals(j,G))&&(!l[0]||!G._4e_equals(l))&&(G[0].nodeType!=q.NODE_ELEMENT||!c||G._4e_name()!="body")}}if(b&&
!this._.guardRTL){var r=A.startContainer,p=A.startOffset>0&&new d(r[0].childNodes[A.startOffset-1]);this._.guardRTL=function(G,c){return(G=g._4e_wrap(G))&&G[0]&&(!c||!G._4e_equals(r))&&(!p[0]||!G._4e_equals(p))&&(G[0].nodeType!=q.NODE_ELEMENT||!c||G._4e_name()!="body")}}var y=b?this._.guardRTL:this._.guardLTR;a=e?function(G,c){if(y(G,c)===s)return s;return e(G,c)}:y;if(this.current)o=this.current[i](s,k,a);else if(b){o=A.endContainer;if(A.endOffset>0){o=new d(o[0].childNodes[A.endOffset-1]);if(a(o)===
s)o=w}else o=a(o,x)===s?w:o._4e_previousSourceNode(x,k,a)}else{o=A.startContainer;if((o=new d(o[0].childNodes[A.startOffset]))&&o[0]){if(a(o)===s)o=w}else o=a(A.startContainer,x)===s?w:A.startContainer._4e_nextSourceNode(x,k,a)}for(;o&&o[0]&&!this._.end;){this.current=o;if(!this.evaluator||this.evaluator(o)!==s){if(!f)return o}else if(f&&this.evaluator)return s;o=o[i](s,k,a)}this.end();return this.current=w}function E(b){for(var f,o=w;f=D.call(this,b);)o=f;return o}function H(b){this.range=b;this._=
{}}var x=true,s=false,w=null,u=KISSY,q=v.NODE,g=u.DOM,d=u.Node;u.augment(H,{end:function(){this._.end=1},next:function(){return D.call(this)},previous:function(){return D.call(this,x)},checkForward:function(){return D.call(this,s,x)!==s},checkBackward:function(){return D.call(this,x,x)!==s},lastForward:function(){return E.call(this)},lastBackward:function(){return E.call(this,x)},reset:function(){delete this.current;this._={}}});H.blockBoundary=function(b){return function(f){f=g._4e_wrap(f);return!(f&&
f[0].nodeType==q.NODE_ELEMENT&&f._4e_isBlockBoundary(b))}};H.bookmark=function(b,f){function o(A){return A&&A[0]&&A._4e_name()=="span"&&A.attr("_ke_bookmark")}return function(A){var a,e;a=A&&A[0]&&A[0].nodeType==q.NODE_TEXT&&(e=A.parent())&&o(e);a=b?a:a||o(A);return f^a}};H.whitespaces=function(b){return function(f){f=(f=f[0]||f)&&f.nodeType==q.NODE_TEXT&&!u.trim(f.nodeValue);return b^f}};H.invisible=function(b){var f=H.whitespaces();return function(o){o=f(o)||o[0].nodeType==q.NODE_ELEMENT&&!o[0].offsetHeight;
return b^o}};v.Walker=H});
KISSY.Editor.add("range",function(v){function D(c){this.endOffset=this.endContainer=this.startOffset=this.startContainer=g;this.collapsed=u;this.document=c}function E(c){var h=c[0].nodeType!=b.NODE_TEXT&&c._4e_name()in i.$removeEmpty,m=!d.trim(c[0].nodeValue);c=!!c.parent().attr("_ke_bookmark");return h||m||c}function H(c){return!y(c)&&!G(c)}function x(c){var h=q,m=A.bookmark(u);return function(z){if(m(z))return u;if(z[0].nodeType==b.NODE_TEXT){if(d.trim(z[0].nodeValue).length)return q}else if(z[0].nodeType==b.NODE_ELEMENT)if(!p[z._4e_name()])if(!c&&
!k.ie&&z._4e_name()=="br"&&!h)h=u;else return q;return u}}function s(c,h){function m(z){return z&&z.nodeName=="span"&&z.getAttribute("_ke_bookmark")}return function(z){var n,t;n=z&&!z.nodeName&&(t=z.parentNode)&&m(t);n=c?n:n||m(z);return h^n}}function w(c){return function(h){h=(h=h[0]||h)&&h.nodeType==b.NODE_TEXT&&!d.trim(h.nodeValue);return c^h}}v.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,
START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};v.RANGE=v.RANGE;var u=true,q=false,g=null,d=KISSY,b=v.NODE,f=v.RANGE,o=v.POSITION,A=v.Walker,a=d.DOM,e=v.Utils.getByAddress,k=d.UA,i=v.XHTML_DTD,j=v.ElementPath,l=d.Node,r={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};D.prototype.toString=function(){var c=[];c.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);c.push((this.endContainer[0].id||this.endContainer[0].nodeName)+":"+this.endOffset);
return c.join("<br/>")};d.augment(D,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&a._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var c=this.startContainer,h=this.startOffset;if(c[0].nodeType!=b.NODE_ELEMENT)if(h)h>=c[0].nodeValue.length&&this.setStartAfter(c);else this.setStartBefore(c);c=this.endContainer;h=this.endOffset;if(c[0].nodeType!=b.NODE_ELEMENT)if(h)h>=c[0].nodeValue.length&&this.setEndAfter(c);
else this.setEndBefore(c)},setStartAfter:function(c){this.setStart(c.parent(),c._4e_index()+1)},setStartBefore:function(c){this.setStart(c.parent(),c._4e_index())},setEndAfter:function(c){this.setEnd(c.parent(),c._4e_index()+1)},setEndBefore:function(c){this.setEnd(c.parent(),c._4e_index())},optimizeBookmark:function(){var c=this.startContainer,h=this.endContainer;c&&c._4e_name()=="span"&&c.attr("_ke_bookmark")&&this.setStartAt(c,f.POSITION_BEFORE_START);h&&h._4e_name()=="span"&&h.attr("_ke_bookmark")&&
this.setEndAt(h,f.POSITION_AFTER_END)},setStart:function(c,h){if(c[0].nodeType==b.NODE_ELEMENT&&r[c._4e_name()]){c=c.parent();h=c._4e_index()}this.startContainer=c;this.startOffset=h;if(!this.endContainer){this.endContainer=c;this.endOffset=h}this.updateCollapsed()},setEnd:function(c,h){if(c[0].nodeType==b.NODE_ELEMENT&&r[c._4e_name()]){c=c.parent();h=c._4e_index()+1}this.endContainer=c;this.endOffset=h;if(!this.startContainer){this.startContainer=c;this.startOffset=h}this.updateCollapsed()},setStartAt:function(c,
h){switch(h){case f.POSITION_AFTER_START:this.setStart(c,0);break;case f.POSITION_BEFORE_END:c[0].nodeType==b.NODE_TEXT?this.setStart(c,c[0].nodeValue.length):this.setStart(c,c[0].childNodes.length);break;case f.POSITION_BEFORE_START:this.setStartBefore(c);break;case f.POSITION_AFTER_END:this.setStartAfter(c)}this.updateCollapsed()},setEndAt:function(c,h){switch(h){case f.POSITION_AFTER_START:this.setEnd(c,0);break;case f.POSITION_BEFORE_END:c[0].nodeType==b.NODE_TEXT?this.setEnd(c,c[0].nodeValue.length):
this.setEnd(c,c[0].childNodes.length);break;case f.POSITION_BEFORE_START:this.setEndBefore(c);break;case f.POSITION_AFTER_END:this.setEndAfter(c)}this.updateCollapsed()},execContentsAction:function(c,h){var m=this.startContainer,z=this.endContainer,n=this.startOffset,t=this.endOffset,O,P=this.document,N;this.optimizeBookmark();if(z[0].nodeType==b.NODE_TEXT)z=z._4e_splitText(t);else if(z[0].childNodes.length>0)if(t>=z[0].childNodes.length){z=new l(z[0].appendChild(P.createTextNode("")));N=u}else z=
new l(z[0].childNodes[t]);if(m[0].nodeType==b.NODE_TEXT){m._4e_splitText(n);if(m._4e_equals(z))z=new l(m[0].nextSibling)}else if(n)if(n>=m[0].childNodes.length){O=new l(P.createTextNode(""));m.append(O);m=O;O=u}else m=new l(m[0].childNodes[n].previousSibling);else{O=new l(P.createTextNode(""));m.prepend(O);m=O;O=u}n=m._4e_parents();t=z._4e_parents();var M,R,Q;for(M=0;M<n.length;M++){R=n[M];Q=t[M];if(!R._4e_equals(Q))break}P=h;for(var U,W,B,J=M;J<n.length;J++){U=n[J];W=P&&!U._4e_equals(m)?P.appendChild(U._4e_clone()[0]):
null;for(U=U[0].nextSibling;U;){if(a._4e_equals(t[J],U)||a._4e_equals(z,U))break;B=U.nextSibling;if(c==2)P.appendChild(U.cloneNode(u));else{a._4e_remove(U);c==1&&P.appendChild(U)}U=B}if(W)P=W}P=h;for(M=M;M<t.length;M++){U=t[M];W=P&&c>0&&!U._4e_equals(z)?P.appendChild(U._4e_clone()[0]):null;if(!n[M]||!U.parent()._4e_equals(n[M].parent()))for(U=U[0].previousSibling;U;){if(a._4e_equals(n[M],U)||a._4e_equals(m,U))break;B=U.previousSibling;if(c==2)P.insertBefore(U.cloneNode(u),P.firstChild);else{a._4e_remove(U);
c==1&&P.insertBefore(U,P.firstChild)}U=B}if(W)P=W}if(c==2){Q=this.startContainer[0];if(Q.nodeType==b.NODE_TEXT&&Q.nextSibling&&Q.nextSibling.nodeType==b.NODE_TEXT){Q.data+=Q.nextSibling.data;Q.parentNode.removeChild(Q.nextSibling)}Q=this.endContainer[0];if(Q.nodeType==b.NODE_TEXT&&Q.nextSibling&&Q.nextSibling.nodeType==b.NODE_TEXT){Q.data+=Q.nextSibling.data;Q.parentNode.removeChild(Q.nextSibling)}}else{if(R&&Q&&(!m.parent()._4e_equals(R.parent())||!z.parent()._4e_equals(Q.parent()))){R=Q._4e_index();
O&&Q.parent()._4e_equals(m.parent())&&R--;this.setStart(Q.parent(),R)}this.collapse(u)}O&&m._4e_remove();N&&z[0].parentNode&&z._4e_remove()},collapse:function(c){if(c){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=u},clone:function(){var c=new D(this.document);c.startContainer=this.startContainer;c.startOffset=this.startOffset;c.endContainer=this.endContainer;c.endOffset=this.endOffset;
c.collapsed=this.collapsed;return c},getEnclosedNode:function(){var c=this.clone();c.optimize();if(c.startContainer[0].nodeType!=b.NODE_ELEMENT||c.endContainer[0].nodeType!=b.NODE_ELEMENT)return g;var h=new v.Walker(c),m=s(u,undefined),z=w(u);c.evaluator=function(n){return z(n)&&m(n)};c=h.next();h.reset();h=h.previous();return c&&c._4e_equals(h)?c:g},shrink:function(c,h){if(!this.collapsed){c=c||f.SHRINK_TEXT;var m=this.clone(),z=this.startContainer,n=this.endContainer,t=this.startOffset,O=this.endOffset,
P=1,N=1;if(z&&z[0].nodeType==b.NODE_TEXT)if(t)if(t>=z[0].nodeValue.length)m.setStartAfter(z);else{m.setStartBefore(z);P=0}else m.setStartBefore(z);if(n&&n[0].nodeType==b.NODE_TEXT)if(O)if(O>=n[0].nodeValue.length)m.setEndAfter(n);else{m.setEndAfter(n);N=0}else m.setEndBefore(n);m=new A(m);m.evaluator=function(R){R=R[0]||R;return R.nodeType==(c==f.SHRINK_ELEMENT?b.NODE_ELEMENT:b.NODE_TEXT)};var M;m.guard=function(R,Q){R=R[0]||R;if(c==f.SHRINK_ELEMENT&&R.nodeType==b.NODE_TEXT)return q;if(Q&&R==M)return q;
if(!Q&&R.nodeType==b.NODE_ELEMENT)M=R;return u};if(P)(z=m[c==f.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(z,h?f.POSITION_AFTER_START:f.POSITION_BEFORE_START);if(N){m.reset();(m=m[c==f.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(m,h?f.POSITION_BEFORE_END:f.POSITION_AFTER_END)}return!!(P||N)}},createBookmark2:function(c){var h=this.startContainer,m=this.endContainer,z=this.startOffset,n=this.endOffset,t,O;if(!h||!m)return{start:0,end:0};if(c){if(h[0].nodeType==b.NODE_ELEMENT)if((t=
new l(h[0].childNodes[z]))&&t[0]&&t[0].nodeType==b.NODE_TEXT&&z>0&&t[0].previousSibling.nodeType==b.NODE_TEXT){h=t;z=0}for(;h[0].nodeType==b.NODE_TEXT&&(O=h._4e_previous())&&O[0].nodeType==b.NODE_TEXT;){h=O;z+=O[0].nodeValue.length}if(!this.collapsed){if(m[0].nodeType==b.NODE_ELEMENT)if((t=new l(m[0].childNodes[n]))&&t[0]&&t[0].nodeType==b.NODE_TEXT&&n>0&&t[0].previousSibling.nodeType==b.NODE_TEXT){m=t;n=0}for(;m[0].nodeType==b.NODE_TEXT&&(O=m._4e_previous())&&O[0].nodeType==b.NODE_TEXT;){m=O;n+=
O[0].nodeValue.length}}}return{start:h._4e_address(c),end:this.collapsed?g:m._4e_address(c),startOffset:z,endOffset:n,normalized:c,is2:u}},createBookmark:function(c){var h,m,z,n,t=this.collapsed;h=new l("<span>",g,this.document);h.attr("_ke_bookmark",1);h.css("display","none");h.html("&nbsp;");if(c){z=d.guid("ke_bm_");h.attr("id",z+"S")}if(!t){m=h._4e_clone();m.html("&nbsp;");c&&m.attr("id",z+"E");n=this.clone();n.collapse();n.insertNode(m)}n=this.clone();n.collapse(u);n.insertNode(h);if(m){this.setStartAfter(h);
this.setEndBefore(m)}else this.moveToPosition(h,f.POSITION_AFTER_END);return{startNode:c?z+"S":h,endNode:c?z+"E":m,serializable:c,collapsed:t}},moveToPosition:function(c,h){this.setStartAt(c,h);this.collapse(u)},trim:function(c,h){var m=this.startContainer,z=this.startOffset,n=this.collapsed;if((!c||n)&&m[0]&&m[0].nodeType==b.NODE_TEXT){if(z)if(z>=m[0].nodeValue.length){z=m._4e_index()+1;m=m.parent()}else{var t=m._4e_splitText(z);z=m._4e_index()+1;m=m.parent();if(a._4e_equals(this.startContainer,
this.endContainer))this.setEnd(t,this.endOffset-this.startOffset);else if(a._4e_equals(m,this.endContainer))this.endOffset+=1}else{z=m._4e_index();m=m.parent()}this.setStart(m,z);if(n){this.collapse(u);return}}m=this.endContainer;z=this.endOffset;if(!(h||n)&&m[0]&&m[0].nodeType==b.NODE_TEXT){if(z){z>=m.nodeValue.length||m._4e_splitText(z);z=m._4e_index()+1}else z=m._4e_index();m=m.parent();this.setEnd(m,z)}},insertNode:function(c){this.optimizeBookmark();this.trim(q,u);var h=this.startContainer;h[0].insertBefore(c[0]||
c,h[0].childNodes[this.startOffset]||null);a._4e_equals(c.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(c)},moveToBookmark:function(c){if(c.is2){var h=e(this.document,c.start,c.normalized),m=c.startOffset,z=c.end&&e(this.document,c.end,c.normalized);c=c.endOffset;this.setStart(h,m);z?this.setEnd(z,c):this.collapse(u)}else{h=(m=c.serializable)?d.one("#"+c.startNode,this.document):c.startNode;c=m?d.one("#"+c.endNode,this.document):c.endNode;this.setStartBefore(h);h._4e_remove();
if(c&&c[0]){this.setEndBefore(c);c._4e_remove()}else this.collapse(u)}},getCommonAncestor:function(c,h){var m=this.startContainer,z=this.endContainer;m=a._4e_equals(m,z)?c&&m[0].nodeType==b.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new l(m[0].childNodes[this.startOffset]):m:m._4e_commonAncestor(z);return h&&m[0].nodeType==b.NODE_TEXT?m.parent():m},enlarge:function(c){switch(c){case f.ENLARGE_ELEMENT:if(this.collapsed)break;c=this.getCommonAncestor();var h=new l(this.document.body),m,z,n,t,
O,P=q,N,M;N=this.startContainer;M=this.startOffset;if(N[0].nodeType==b.NODE_TEXT){if(M){N=!d.trim(N[0].nodeValue.substring(0,M)).length&&N;P=!!N}if(N)if(!(t=N[0].previousSibling))n=N.parent()}else{if(M)t=N[0].childNodes[M-1]||N[0].lastChild;t||(n=N)}for(;n||t;){if(n&&!t){if(!O&&a._4e_equals(n,c))O=u;if(!h.contains(n))break;if(!P||n.css("display")!="inline"){P=q;if(O)m=n;else this.setStartBefore(n)}t=n[0].previousSibling}for(;t;){N=q;if(t.nodeType==b.NODE_TEXT){M=t.nodeValue;if(/[^\s\ufeff]/.test(M))t=
g;N=/[\s\ufeff]$/.test(M)}else if(t.offsetWidth>0&&!t.getAttribute("_ke_bookmark"))if(P&&i.$removeEmpty[t.nodeName.toLowerCase()]){M=a.text(t);if(/[^\s\ufeff]/.test(M))t=g;else for(var R=t.all||t.getElementsByTagName("*"),Q=0,U;U=R[Q++];)if(!i.$removeEmpty[U.nodeName.toLowerCase()]){t=g;break}if(t)N=!!M.length}else t=g;if(N)if(P)if(O)m=n;else n&&this.setStartBefore(n);else P=u;if(t){N=t.previousSibling;if(!n&&!N){n=new l(t);t=g;break}t=N}else n=g}if(n)n=n.parent()}N=this.endContainer;M=this.endOffset;
n=t=g;O=P=q;if(N[0].nodeType==b.NODE_TEXT){N=!d.trim(N[0].nodeValue.substring(M)).length&&N;P=!(N&&N[0].nodeValue.length);if(N)if(!(t=N[0].nextSibling))n=N.parent()}else(t=N[0].childNodes[M])||(n=N);for(;n||t;){if(n&&!t){if(!O&&a._4e_equals(n,c))O=u;if(!h.contains(n))break;if(!P||n.css("display")!="inline"){P=q;if(O)z=n;else n&&this.setEndAfter(n)}t=n[0].nextSibling}for(;t;){N=q;if(t.nodeType==b.NODE_TEXT){M=t.nodeValue;if(/[^\s\ufeff]/.test(M))t=g;N=/^[\s\ufeff]/.test(M)}else if(t.offsetWidth>0&&
!t.getAttribute("_ke_bookmark"))if(P&&i.$removeEmpty[t.nodeName.toLowerCase()]){M=a.text(t);if(/[^\s\ufeff]/.test(M))t=g;else{R=t.all||t.getElementsByTagName("*");for(Q=0;U=R[Q++];)if(!i.$removeEmpty[U.nodeName.toLowerCase()]){t=g;break}}if(t)N=!!M.length}else t=g;if(N)if(P)if(O)z=n;else this.setEndAfter(n);if(t){N=t.nextSibling;if(!n&&!N){n=new l(t);t=g;break}t=N}else n=g}if(n)n=n.parent()}if(m&&z){c=m.contains(z)?z:m;this.setStartBefore(c);this.setEndAfter(c)}break;case f.ENLARGE_BLOCK_CONTENTS:case f.ENLARGE_LIST_ITEM_CONTENTS:n=
new D(this.document);h=new l(this.document.body);n.setStartAt(h,f.POSITION_AFTER_START);n.setEnd(this.startContainer,this.startOffset);n=new A(n);var W,B,J=A.blockBoundary(c==f.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:g),C=function(I){var F=J(I);F||(W=I);return F};m=function(I){var F=C(I);if(!F&&I[0]&&I._4e_name()=="br")B=I;return F};n.guard=C;n=n.lastBackward();W=W||h;this.setStartAt(W,W._4e_name()!="br"&&(!n&&this.checkStartOfBlock()||n&&W.contains(n))?f.POSITION_AFTER_START:f.POSITION_AFTER_END);n=this.clone();
n.collapse();n.setEndAt(h,f.POSITION_BEFORE_END);n=new A(n);n.guard=c==f.ENLARGE_LIST_ITEM_CONTENTS?m:C;W=g;n=n.lastForward();W=W||h;this.setEndAt(W,!n&&this.checkEndOfBlock()||n&&W.contains(n)?f.POSITION_BEFORE_END:f.POSITION_BEFORE_START);B&&this.setEndAfter(B)}},checkStartOfBlock:function(){var c=this.startContainer,h=this.startOffset;if(h&&c[0].nodeType==b.NODE_TEXT)if(d.trim(c[0].nodeValue.substring(0,h)).length)return q;this.trim();c=new j(this.startContainer);h=this.clone();h.collapse(u);h.setStartAt(c.block||
c.blockLimit,f.POSITION_AFTER_START);c=new A(h);c.evaluator=x(u);return c.checkBackward()},checkEndOfBlock:function(){var c=this.endContainer,h=this.endOffset;if(c[0].nodeType==b.NODE_TEXT)if(d.trim(c[0].nodeValue.substring(h)).length)return q;this.trim();c=new j(this.endContainer);h=this.clone();h.collapse(q);h.setEndAt(c.block||c.blockLimit,f.POSITION_BEFORE_END);c=new A(h);c.evaluator=x(q);return c.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var c=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,c);return c},checkBoundaryOfElement:function(c,h){var m=this.clone();m[h==f.START?"setStartAt":"setEndAt"](c,h==f.START?f.POSITION_AFTER_START:f.POSITION_BEFORE_END);m=new A(m);m.evaluator=E;return m[h==f.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var c=this.startContainer,h=this.endContainer,m=this.startOffset,z=this.endOffset,n;if(c[0].nodeType==b.NODE_ELEMENT){n=c[0].childNodes.length;if(n>
m)c=new l(c[0].childNodes[m]);else if(n<1)c=c._4e_previousSourceNode();else{for(c=c[0];c.lastChild;)c=c.lastChild;c=new l(c);c=c._4e_nextSourceNode()||c}}if(h[0].nodeType==b.NODE_ELEMENT){n=h[0].childNodes.length;if(n>z)h=(new l(h[0].childNodes[z]))._4e_previousSourceNode(u);else if(n<1)h=h._4e_previousSourceNode();else{for(h=h[0];h.lastChild;)h=h.lastChild;h=new l(h)}}if(c._4e_position(h)&o.POSITION_FOLLOWING)c=h;return{startNode:c,endNode:h}},fixBlock:function(c,h){var m=this.createBookmark(),z=
new l(this.document.createElement(h));this.collapse(c);this.enlarge(f.ENLARGE_BLOCK_CONTENTS);z[0].appendChild(this.extractContents());z._4e_trim();k.ie||z._4e_appendBogus();this.insertNode(z);this.moveToBookmark(m);return z},splitBlock:function(c){var h=new j(this.startContainer),m=new j(this.endContainer),z=h.block,n=m.block,t=g;if(!h.blockLimit._4e_equals(m.blockLimit))return g;if(c!="br"){if(!z){z=this.fixBlock(u,c);n=(new j(this.endContainer)).block}n||(n=this.fixBlock(q,c))}c=z&&this.checkStartOfBlock();
h=n&&this.checkEndOfBlock();this.deleteContents();if(z&&a._4e_equals(z,n))if(h){t=new j(this.startContainer);this.moveToPosition(n,f.POSITION_AFTER_END);n=g}else if(c){t=new j(this.startContainer);this.moveToPosition(z,f.POSITION_BEFORE_START);z=g}else{n=this.splitElement(z);!k.ie&&!d.inArray(z._4e_name(),["ul","ol"])&&z._4e_appendBogus()}return{previousBlock:z,nextBlock:n,wasStartOfBlock:c,wasEndOfBlock:h,elementPath:t}},splitElement:function(c){if(!this.collapsed)return g;this.setEndAt(c,f.POSITION_BEFORE_END);
var h=this.extractContents(),m=c._4e_clone(q);m[0].appendChild(h);m.insertAfter(c);this.moveToPosition(c,f.POSITION_AFTER_END);return m},moveToElementEditablePosition:function(c,h){var m,z=v.XHTML_DTD;if(z.$empty[c._4e_name()])return q;for(;c&&c[0].nodeType==b.NODE_ELEMENT;){if(m=c._4e_isEditable())this.moveToPosition(c,h?f.POSITION_BEFORE_END:f.POSITION_AFTER_START);else if(z.$inline[c._4e_name()]){this.moveToPosition(c,h?f.POSITION_AFTER_END:f.POSITION_BEFORE_START);return u}if((c=z.$empty[c._4e_name()]?
c[h?"_4e_previous":"_4e_next"](H):h?c._4e_last(H):c._4e_first(H))&&c[0].nodeType==b.NODE_TEXT){this.moveToPosition(c,h?f.POSITION_AFTER_END:f.POSITION_BEFORE_START);return u}}return m},selectNodeContents:function(c){this.setStart(c,0);this.setEnd(c,c[0].nodeType==b.NODE_TEXT?c[0].nodeValue.length:c[0].childNodes.length)}});var p={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},
y=new A.whitespaces,G=new A.bookmark;v.Range=D});
KISSY.Editor.add("domiterator",function(v){function D(A){if(!(arguments.length<1)){this.range=A;this.forceBrBreak=H;this.enlargeBr=E;this.enforceRealBlocks=H;this._||(this._={})}}var E=true,H=false,x=KISSY,s=x.UA,w=v.Walker,u=v.Range,q=v.RANGE,g=v.NODE,d=v.ElementPath,b=x.Node,f=x.DOM,o=/^[\r\n\t ]*$/;x.augment(D,{getNextParagraph:function(A){var a,e,k,i,j;if(!this._.lastNode){e=this.range.clone();e.shrink(q.SHRINK_ELEMENT,E);e.enlarge(this.forceBrBreak||!this.enlargeBr?q.ENLARGE_LIST_ITEM_CONTENTS:
q.ENLARGE_BLOCK_CONTENTS);var l=new w(e),r=w.bookmark(E,E);l.evaluator=r;this._.nextNode=l.next();l=new w(e);l.evaluator=r;l=l.previous();this._.lastNode=l._4e_nextSourceNode(E);if(this._.lastNode&&this._.lastNode[0].nodeType==g.NODE_TEXT&&!x.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){r=new u(e.document);r.moveToPosition(this._.lastNode,q.POSITION_AFTER_END);if(r.checkEndOfBlock()){r=new d(r.endContainer);this._.lastNode=(r.block||r.blockLimit)._4e_nextSourceNode(E)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new b(e.document.createTextNode(""));f.insertAfter(this._.lastNode[0],l[0])}e=null}r=this._.nextNode;l=this._.lastNode;for(this._.nextNode=null;r;){var p=H,y=r[0].nodeType!=g.NODE_ELEMENT,G=H;if(y){if(r[0].nodeType==g.NODE_TEXT)if(o.test(r[0].nodeValue))y=H}else{var c=r._4e_name();if(r._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(c=="br")y=E;else if(!e&&!r[0].childNodes.length&&c!="hr"){a=r;k=r._4e_equals(l);break}if(e){e.setEndAt(r,q.POSITION_BEFORE_START);if(c!="br")this._.nextNode=
r}p=E}else{if(r[0].firstChild){if(!e){e=new u(this.range.document);e.setStartAt(r,q.POSITION_BEFORE_START)}r=new b(r[0].firstChild);continue}y=E}}if(y&&!e){e=new u(this.range.document);e.setStartAt(r,q.POSITION_BEFORE_START)}k=(!p||y)&&r._4e_equals(l);if(e&&!p)for(;!r[0].nextSibling&&!k;){c=r.parent();if(c._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){p=E;k||c._4e_equals(l);break}r=c;y=E;k=r._4e_equals(l);G=E}y&&e.setEndAt(r,q.POSITION_AFTER_END);r=r._4e_nextSourceNode(G,null,l);if((k=!r)||p&&e)break}if(!a){if(!e){this._.docEndMarker&&
this._.docEndMarker._4e_remove();return this._.nextNode=null}a=new d(e.startContainer);r=a.blockLimit;p={div:1,th:1,td:1};a=a.block;if((!a||!a[0])&&!this.enforceRealBlocks&&p[r._4e_name()]&&e.checkStartOfBlock()&&e.checkEndOfBlock())a=r;else if(!a||this.enforceRealBlocks&&a._4e_name()=="li"){a=new b(this.range.document.createElement(A||"p"));a[0].appendChild(e.extractContents());a._4e_trim();e.insertNode(a);i=j=E}else if(a._4e_name()!="li"){if(!e.checkStartOfBlock()||!e.checkEndOfBlock()){a=a._4e_clone(H);
a[0].appendChild(e.extractContents());a._4e_trim();j=e.splitBlock();i=!j.wasStartOfBlock;j=!j.wasEndOfBlock;e.insertNode(a)}}else if(!k)this._.nextNode=a._4e_equals(l)?null:e.getBoundaryNodes().endNode._4e_nextSourceNode(E,null,l)}if(i){e=new b(a[0].previousSibling);if(e[0]&&e[0].nodeType==g.NODE_ELEMENT)if(e._4e_name()=="br")e._4e_remove();else e[0].lastChild&&f._4e_name(e[0].lastChild)=="br"&&f._4e_remove(e[0].lastChild)}if(j){e=w.bookmark(H,E);i=new b(a[0].lastChild);if(i[0]&&i[0].nodeType==g.NODE_ELEMENT&&
i._4e_name()=="br")if(s.ie||i._4e_previous(e)||i._4e_next(e))i._4e_remove()}if(!this._.nextNode)this._.nextNode=k||a._4e_equals(l)?null:a._4e_nextSourceNode(E,null,l);return a}});u.prototype.createIterator=function(){return new D(this)}});
KISSY.Editor.add("selection",function(v){function D(p){this.document=this.document=p;this._={cache:{}};if(a){var y=this.getNative().createRange();if(!y||y.item&&y.item(0).ownerDocument!=p||y.parentElement&&y.parentElement().ownerDocument!=p)this.isInvalid=x}}function E(p){p=new D(p);return!p||p.isInvalid?w:p}function H(p){function y(M){var R=v.XHTML_DTD;return M._4e_isBlockBoundary()&&R.$empty[M._4e_name()]}var G=p.document,c=new b(G.body),h=new b(G.documentElement);if(q.ie){v.Utils.ieEngine<8&&h.on("click",
function(M){(new b(M.target))._4e_name()==="html"&&p.getSelection().getNative().createRange().select()});var m,z,n=x;h.on("mousedown",function(){n=s});h.on("mouseup",function(){n=x});c.on("focusin",function(M){if((new b(M.target))._4e_name()=="body")if(m){try{n&&m.select()}catch(R){}m=w}});c.on("focus",function(){z=x;t()});c.on("beforedeactivate",function(M){if(!M.relatedTarget){z=s;n=x}});p.on("blur",function(){try{var M=document.documentElement||document.body,R=M.scrollTop,Q=M.scrollLeft;G&&G.selection.empty();
M.scrollTop=R;M.scrollLeft=Q}catch(U){}});c.on("mousedown",function(){z=s});c.on("mouseup",function(){z=x;setTimeout(function(){t(x)},0)});var t=function(M){if(z){var R=p.document,Q=p.getSelection(),U=Q&&Q.getType(),W=Q&&R.selection;if(M&&W&&U==f.SELECTION_NONE)if(!R.queryCommandEnabled("InsertImage")){setTimeout(function(){t(x)},50);return}var B;if(!(W&&W.type&&W.type!="Control"&&(B=W.createRange())&&(B=B.parentElement())&&(B=B.nodeName)&&B.toLowerCase()in{input:1,textarea:1})){m=W&&Q.getRanges()[0];
p._monitor()}}};c.on("keydown",function(){z=s});c.on("keyup",function(){z=x;setTimeout(function(){t()},0)})}else{d.on(G,"mouseup",p._monitor,p);d.on(G,"keyup",p._monitor,p)}var O=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,P=v.Walker.whitespaces(x),N=function(M){return P(M)&&M&&M[0].nodeType!=8};p.on("selectionChange",function(M){var R=M.path;M=(M=M.selection)&&M.getRanges()[0];if(!(!M||!M.collapsed||R.block)){if(R.blockLimit._4e_name()==
"body"){if((R=M.fixBlock(x,"p"))&&R[0]!=c[0].lastChild)if(R._4e_outerHtml().match(O)){var Q=R._4e_next(N);if(Q&&Q[0].nodeType==A.NODE_ELEMENT&&!y[Q]){M.moveToElementEditablePosition(Q);R._4e_remove()}else if((Q=R._4e_previous(N))&&Q[0].nodeType==A.NODE_ELEMENT&&!y[Q]){M.moveToElementEditablePosition(Q,Q._4e_outerHtml().match(O)?s:x);R._4e_remove()}}M.select();p.notifySelectionChange()}R=new v.Range(G);R.moveToElementEditablePosition(c,x);if((new v.ElementPath(R.startContainer)).blockLimit._4e_name()!==
"body"){R=(new b(G.createElement("p"))).appendTo(c);q.ie||R._4e_appendBogus()}}})}v.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var x=true,s=false,w=null,u=KISSY,q=u.UA,g=u.DOM,d=u.Event,b=u.Node,f=v.SELECTION,o=v.RANGE,A=v.NODE,a=q.ie,e=v.Walker,k=v.Range,i={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};u.augment(D,{getNative:!a?function(){var p=this._.cache;return p.nativeSel||(p.nativeSel=
g._4e_getWin(this.document).getSelection())}:function(){var p=this._.cache;return p.nativeSel||(p.nativeSel=this.document.selection)},getType:!a?function(){var p=this._.cache;if(p.type)return p.type;var y=f.SELECTION_TEXT,G=this.getNative();if(G){if(G.rangeCount==1){G=G.getRangeAt(0);var c=G.startContainer;if(c==G.endContainer&&c.nodeType==A.NODE_ELEMENT&&Number(G.endOffset-G.startOffset)==1&&i[c.childNodes[G.startOffset].nodeName.toLowerCase()])y=f.SELECTION_ELEMENT}}else y=f.SELECTION_NONE;return p.type=
y}:function(){var p=this._.cache;if(p.type)return p.type;var y=f.SELECTION_NONE;try{var G=this.getNative(),c=G.type;if(c=="Text")y=f.SELECTION_TEXT;if(c=="Control")y=f.SELECTION_ELEMENT;if(G.createRange().parentElement)y=f.SELECTION_TEXT}catch(h){}return p.type=y},getRanges:a?function(){var p=function(y,G){y=y.duplicate();y.collapse(G);for(var c=y.parentElement(),h=c.childNodes,m,z=0;z<h.length;z++){var n=h[z];if(n.nodeType==A.NODE_ELEMENT){m=y.duplicate();m.moveToElementText(n);n=m.compareEndPoints("StartToStart",
y);var t=m.compareEndPoints("EndToStart",y);m.collapse();if(n>0)break;else if(!n||t==1&&n==-1)return{container:c,offset:z};else if(!t)return{container:c,offset:z+1};m=w}}if(!m){m=y.duplicate();m.moveToElementText(c);m.collapse(s)}m.setEndPoint("StartToStart",y);m=String(m.text).replace(/\r\n|\r/g,"\n").length;try{for(;m>0;)m-=h[--z].nodeValue.length}catch(O){m=0}return m===0?{container:c,offset:z}:{container:h[z],offset:-m}};return function(y){var G=this._.cache;if(G.ranges&&!y)return G.ranges;var c=
this.getNative();y=c&&c.createRange();var h=this.getType();if(!c)return[];if(h==f.SELECTION_TEXT){c=new k(this.document);h=p(y,x);c.setStart(new b(h.container),h.offset);h=p(y);c.setEnd(new b(h.container),h.offset);return G.ranges=[c]}else if(h==f.SELECTION_ELEMENT){G=G.ranges=[];for(h=0;h<y.length;h++){var m=y.item(h),z=m.parentNode,n=0;for(c=new k(this.document);n<z.childNodes.length&&z.childNodes[n]!=m;n++);c.setStart(new b(z),n);c.setEnd(new b(z),n+1);G.push(c)}return G}return G.ranges=[]}}():
function(p){var y=this._.cache;if(y.ranges&&!p)return y.ranges;p=[];var G=this.getNative();if(!G)return[];for(var c=0;c<G.rangeCount;c++){var h=G.getRangeAt(c),m=new k(this.document);m.setStart(new b(h.startContainer),h.startOffset);m.setEnd(new b(h.endContainer),h.endOffset);p.push(m)}return y.ranges=p},getStartElement:function(){var p=this._.cache;if(p.startElement!==undefined)return p.startElement;var y,G=this.getNative();switch(this.getType()){case f.SELECTION_ELEMENT:return this.getSelectedElement();
case f.SELECTION_TEXT:var c=this.getRanges()[0];if(c)if(!c.collapsed){for(c.optimize();x;){y=c.startContainer;if(c.startOffset==(y[0].nodeType===A.NODE_ELEMENT?y[0].childNodes.length:y[0].nodeValue.length)&&!y._4e_isBlockBoundary())c.setStartAfter(y);else break}y=c.startContainer;if(y[0].nodeType!=A.NODE_ELEMENT)return y.parent();y=new b(y[0].childNodes[c.startOffset]);if(!y[0]||y[0].nodeType!=A.NODE_ELEMENT)return c.startContainer;for(c=y[0].firstChild;c&&c.nodeType==A.NODE_ELEMENT;){y=new b(c);
c=c.firstChild}return y}if(a){c=G.createRange();c.collapse(x);y=c.parentElement()}else if((y=G.anchorNode)&&y.nodeType!=A.NODE_ELEMENT)y=y.parentNode}return p.startElement=y?g._4e_wrap(y):w},getSelectedElement:function(){var p=this,y,G=p._.cache;if(G.selectedElement!==undefined)return G.selectedElement;if(a){y=p.getNative().createRange();y=y.item&&y.item(0)}y||(y=function(){for(var c=p.getRanges()[0],h,m,z=2;z&&!((h=c.getEnclosedNode())&&h[0].nodeType==A.NODE_ELEMENT&&i[h._4e_name()]&&(m=h));z--)c.shrink(o.SHRINK_ELEMENT);
return m&&m[0]}());return G.selectedElement=g._4e_wrap(y)},reset:function(){this._.cache={}},selectElement:function(p){var y,G=this.document;if(a)try{y=G.body.createControlRange();y.addElement(p[0]);y.select()}catch(c){y=G.body.createTextRange();y.moveToElementText(p[0]);y.select()}finally{}else{y=G.createRange();y.selectNode(p[0]);p=this.getNative();p.removeAllRanges();p.addRange(y)}this.reset()},selectRanges:function(p){if(a){if(p.length>1){var y=p[p.length-1];p[0].setEnd(y.endContainer,y.endOffset);
p.length=1}p[0]&&p[0].select()}else{y=this.getNative();if(!y)return;y.removeAllRanges();for(var G=0;G<p.length;G++){var c=p[G],h=this.document.createRange(),m=c.startContainer;if(c.collapsed&&(q.gecko&&q.gecko<1.09||q.opera||q.webkit)&&m[0].nodeType==A.NODE_ELEMENT&&!m[0].childNodes.length){m[0].appendChild(this.document.createTextNode(q.webkit?"\u200b":""));c.startOffset++;c.endOffset++}h.setStart(m[0],c.startOffset);h.setEnd(c.endContainer[0],c.endOffset);y.addRange(h)}}this.reset()},createBookmarks2:function(p){for(var y=
[],G=this.getRanges(),c=0;c<G.length;c++)y.push(G[c].createBookmark2(p));return y},createBookmarks:function(p,y){var G=[],c=this.document,h;y=y||this.getRanges();for(var m=y.length,z=0;z<m;z++){G.push(h=y[z].createBookmark(p,x));var n=(p=h.serializable)?u.one("#"+h.startNode,c):h.startNode;h=p?u.one("#"+h.endNode,c):h.endNode;for(var t=z+1;t<m;t++){var O=y[t],P=O.startContainer,N=O.endContainer;g._4e_equals(P,n.parent())&&O.startOffset++;g._4e_equals(P,h.parent())&&O.startOffset++;g._4e_equals(N,
n.parent())&&O.endOffset++;g._4e_equals(N,h.parent())&&O.endOffset++}}return G},selectBookmarks:function(p){for(var y=[],G=0;G<p.length;G++){var c=new k(this.document);c.moveToBookmark(p[G]);y.push(c)}this.selectRanges(y);return this},getCommonAncestor:function(){var p=this.getRanges();return p[0].startContainer._4e_commonAncestor(p[p.length-1].endContainer)},scrollIntoView:function(){var p=this.getStartElement();p&&p._4e_scrollIntoView()},removeAllRanges:function(){var p=this.getNative();if(a)p&&
p.clear();else p&&p.removeAllRanges()}});var j={table:1,tbody:1,tr:1},l=e.whitespaces(x),r=/\ufeff|\u00a0/;k.prototype.select=k.prototype.select=!a?function(){var p=this.startContainer;this.collapsed&&p[0].nodeType==A.NODE_ELEMENT&&!p[0].childNodes.length&&p[0].appendChild(this.document.createTextNode(""));var y=this.document.createRange();y.setStart(p[0],this.startOffset);try{y.setEnd(this.endContainer[0],this.endOffset)}catch(G){if(G.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(x);
y.setEnd(this.endContainer[0],this.endOffset)}else throw G;}p=E(this.document).getNative();p.removeAllRanges();p.addRange(y)}:function(p){var y=this.collapsed,G,c;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var h=this.startContainer[0].childNodes[this.startOffset];if(h.nodeType==A.NODE_ELEMENT){(new D(this.document)).selectElement(new b(h));return}}if(this.startContainer[0].nodeType==A.NODE_ELEMENT&&this.startContainer._4e_name()in j||this.endContainer[0].nodeType==
A.NODE_ELEMENT&&this.endContainer._4e_name()in j)this.shrink(o.SHRINK_ELEMENT,x);var m=this.createBookmark();h=m.startNode;var z;if(!y)z=m.endNode;m=this.document.body.createTextRange();m.moveToElementText(h[0]);m.moveStart("character",1);if(z){p=this.document.body.createTextRange();p.moveToElementText(z[0]);m.setEndPoint("EndToEnd",p);m.moveEnd("character",-1)}else{for(G=h[0].nextSibling;G&&!l(G);)G=G.nextSibling;G=!(G&&G.nodeValue&&G.nodeValue.match(r))&&(p||!h[0].previousSibling||h[0].previousSibling&&
g._4e_name(h[0].previousSibling)=="br");c=new b(this.document.createElement("span"));c.html("&#65279;");c.insertBefore(h);if(G)g.insertBefore(this.document.createTextNode("\ufeff"),h[0]||h)}this.setStartBefore(h);h._4e_remove();if(y){if(G){m.moveStart("character",-1);m.select();this.document.selection.clear()}else m.select();if(c){this.moveToPosition(c,o.POSITION_BEFORE_START);c._4e_remove()}}else{this.setEndBefore(z);z._4e_remove();m.select()}};D.getSelection=E;v.Selection=D;v.on("instanceCreated",function(p){H(p.editor)})});
KISSY.Editor.add("styles",function(v){function D(B){return!B.attr("_ke_bookmark")}function E(B,J){for(var C in B)if(B.hasOwnProperty(C))if(y.isString(B[C]))B[C]=B[C].replace(W,function(I,F){return J[F]});else E(B[C],J)}function H(B,J){if(J){B=y.clone(B);E(B,J)}var C=this.element=this.element=(B.element||"*").toLowerCase();this.type=this.type=C=="#"||R[C]?h.STYLE_BLOCK:Q[C]?h.STYLE_OBJECT:h.STYLE_INLINE;this._={definition:B}}function x(B,J){var C=J?this.removeFromRange:this.applyToRange;B.body.focus();
for(var I=new z(B),F=I.getRanges(),L=0;L<F.length;L++)C.call(this,F[L]);I.selectRanges(F)}function s(B,J,C){var I=B.element;if(I=="*")I="span";J=new P(J.createElement(I));C&&C._4e_copyAttributes(J);C=B._.definition;B=C.attributes;C=H.getStyleText(C);if(B)for(var F in B)B.hasOwnProperty(F)&&J.attr(F,B[F]);if(C)J[0].style.cssText=C;return J}function w(B){var J=B.createBookmark(l),C=B.createIterator();C.enforceRealBlocks=l;C.enlargeBr=l;for(var I,F=B.document;I=C.getNextParagraph();){var L=s(this,F,
I);I=I;var K=L;L=K._4e_name=="pre";var S=I._4e_name=="pre",T=!L&&S;if(L&&!S){S=I;K=K;T=S.html();T=u(T,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");T=T.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");T=T.replace(/([ \t\n\r]+|&nbsp;)/g," ");T=T.replace(/<br\b[^>]*>/gi,"\n");if(N.ie){S=S[0].ownerDocument.createElement("div");S.appendChild(K[0]);K[0].outerHTML="<pre>"+T+"</pre>";K=new P(S.firstChild);K._4e_remove()}else K.html(T);K=K}else if(T)K=g(q(I),K);else I._4e_moveChildren(K);I[0].parentNode.replaceChild(K[0],
I[0]);if(L){I=K;L=void 0;if((L=I._4e_previousSourceNode(l,n.NODE_ELEMENT))&&L._4e_name()=="pre"){K=u(L.html(),/\n$/,"")+"\n\n"+u(I.html(),/^\n/,"");if(N.ie)I[0].outerHTML="<pre>"+K+"</pre>";else I.html(K);L._4e_remove()}}}B.moveToBookmark(J)}function u(B,J,C){var I="",F="";B=B.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(L,K,S){K&&(I=K);S&&(F=S);return""});return I+B.replace(J,C)+F}function q(B){var J=[];u(B._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(C,I,F){return I+"</pre>"+F+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(C,I){J.push(I)});return J}function g(B,J){for(var C=J[0].ownerDocument.createDocumentFragment(),I=0;I<B.length;I++){var F=B[I];F=F.replace(/(\r\n|\r)/g,"\n");F=u(F,/^[ \t]*\n/,"");F=u(F,/\n$/,"");F=u(F,/^[ \t]+|[ \t]+$/g,function(K,S){return K.length==1?"&nbsp;":S?" "+Array(K.length).join("&nbsp;"):Array(K.length).join("&nbsp;")+" "});F=F.replace(/\n/g,"<br>");F=F.replace(/[ \t]{2,}/g,function(K){return Array(K.length).join("&nbsp;")+
" "});var L=J._4e_clone();L.html(F);C.appendChild(L[0])}return C}function d(B){var J=B.document;if(B.collapsed){J=s(this,J,undefined);B.insertNode(J);B.moveToPosition(J,m.POSITION_BEFORE_END)}else{var C=this.element,I=this._.definition,F,L=v.XHTML_DTD[C];if(!L){F=l;L=v.XHTML_DTD.span}var K=B.createBookmark();B.enlarge(m.ENLARGE_ELEMENT);B.trim();var S=B.createBookmark(),T=S.startNode;S=S.endNode;for(var X=T,aa;X&&X[0];){var V=r;if(c._4e_equals(X,S)){X=p;V=l}else{var Z=X[0].nodeType,$=Z==n.NODE_ELEMENT?
X._4e_name():p;if($&&X.attr("_ke_bookmark")){X=X._4e_nextSourceNode(l);continue}if(!$||L[$]&&(X._4e_position(S)|t.POSITION_PRECEDING|t.POSITION_IDENTICAL|t.POSITION_IS_CONTAINED)==t.POSITION_PRECEDING+t.POSITION_IDENTICAL+t.POSITION_IS_CONTAINED&&(!I.childRule||I.childRule(X))){var Y=X.parent();if(Y&&C=="a"&&Y._4e_name()==C){Z=s(this,J,undefined);Y._4e_moveChildren(Z);Y[0].parentNode.replaceChild(Z[0],Y[0]);Z._4e_mergeSiblings()}else if(Y&&Y[0]&&((v.XHTML_DTD[Y._4e_name()]||v.XHTML_DTD.span)[C]||
F)&&(!I.parentRule||I.parentRule(Y))){if(!aa&&(!$||!v.XHTML_DTD.$removeEmpty[$]||(X._4e_position(S)|t.POSITION_PRECEDING|t.POSITION_IDENTICAL|t.POSITION_IS_CONTAINED)==t.POSITION_PRECEDING+t.POSITION_IDENTICAL+t.POSITION_IS_CONTAINED)){aa=new O(J);aa.setStartBefore(X)}if(Z==n.NODE_TEXT||Z==n.NODE_ELEMENT&&!X[0].childNodes.length){Y=X;for(Z=null;(V=!Y._4e_next(D))&&(Z=Y.parent())&&L[Z._4e_name()]&&(Z._4e_position(T)|t.POSITION_FOLLOWING|t.POSITION_IDENTICAL|t.POSITION_IS_CONTAINED)==t.POSITION_FOLLOWING+
t.POSITION_IDENTICAL+t.POSITION_IS_CONTAINED&&(!I.childRule||I.childRule(Z));)Y=Z;aa.setEndAfter(Y)}}else V=l}else V=l;X=X._4e_nextSourceNode()}if(V&&aa&&!aa.collapsed){V=s(this,J,undefined);Y=aa.getCommonAncestor();Z={styles:{},attrs:{},blockedStyles:{},blockedAttrs:{}};var ba;$=null;for(var ca;V&&Y&&V[0]&&Y[0];){if(Y._4e_name()==C){for(ba in I.attributes)if(I.attributes.hasOwnProperty(ba))if(!(Z.blockedAttrs[ba]||!(ca=Y.attr($))))if(V.attr(ba)==ca)V.removeAttr(ba);else Z.blockedAttrs[ba]=1;for($ in I.styles)if(I.styles.hasOwnProperty($))if(!(Z.blockedStyles[$]||
!(ca=Y._4e_style($))))if(V._4e_style($)==ca)V._4e_style($,"");else Z.blockedStyles[$]=1;if(!V._4e_hasAttributes()){V=p;break}}Y=Y.parent()}if(V){V[0].appendChild(aa.extractContents());k(this,V);aa.insertNode(V);V._4e_mergeSiblings();N.ie||V[0].normalize()}else{V=new P(J.createElement("span"));V[0].appendChild(aa.extractContents());aa.insertNode(V);k(this,V);V._4e_remove(true)}aa=p}}T._4e_remove();S._4e_remove();B.moveToBookmark(K);B.shrink(m.SHRINK_TEXT)}}function b(B){B.enlarge(m.ENLARGE_ELEMENT);
var J=B.createBookmark(),C=J.startNode;if(B.collapsed){for(var I=new M(C.parent()),F,L=0,K;L<I.elements.length&&(K=I.elements[L]);L++){if(K==I.block||K==I.blockLimit)break;if(this.checkElementRemovable(K)){var S=B.checkBoundaryOfElement(K,m.END),T=!S&&B.checkBoundaryOfElement(K,m.START);if(T||S){F=K;F.match=T?"start":"end"}else{K._4e_mergeSiblings();if(K._4e_name()!=this.element){S=A(this);i(K,S[K._4e_name()]||S["*"])}else a(this,K)}}}if(F&&F[0]){K=C;for(L=0;;L++){S=I.elements[L];if(c._4e_equals(S,
F))break;else if(S.match)continue;else S=S._4e_clone();S[0].appendChild(K[0]);K=S}c[F.match=="start"?"insertBefore":"insertAfter"](c._4e_unwrap(K),c._4e_unwrap(F))}}else{var X=J.endNode,aa=this;I=function(){for(var V=new M(C.parent()),Z=new M(X.parent()),$=p,Y=p,ba=0;ba<V.elements.length;ba++){var ca=V.elements[ba];if(ca==V.block||ca==V.blockLimit)break;if(aa.checkElementRemovable(ca))$=ca}for(ba=0;ba<Z.elements.length;ba++){ca=Z.elements[ba];if(ca==Z.block||ca==Z.blockLimit)break;if(aa.checkElementRemovable(ca))Y=
ca}Y&&X._4e_breakParent(Y);$&&C._4e_breakParent($)};I();for(F=new P(C[0].nextSibling);F[0]!==X[0];){L=F._4e_nextSourceNode();if(F[0]&&F[0].nodeType==n.NODE_ELEMENT&&this.checkElementRemovable(F)){if(F._4e_name()==this.element)a(this,F);else{K=A(this);i(F,K[F._4e_name()]||K["*"])}if(L[0].nodeType==n.NODE_ELEMENT&&L.contains(C)){I();L=new P(C[0].nextSibling)}}F=L}}B.moveToBookmark(J)}function f(B){B=String(B);var J={};B.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(C,
I,F){J[I]=F});return J}function o(B,J){var C="";if(J!==r){C=document.createElement("span");C.style.cssText=B;C=C.style.cssText||""}else C=B;return C.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function A(B){if(B._.overrides)return B._.overrides;var J=B._.overrides={},C=B._.definition.overrides;if(C){y.isArray(C)||(C=[C]);for(var I=0;I<C.length;I++){var F=C[I],L,K,S;if(typeof F=="string")L=F.toLowerCase();else{L=F.element?F.element.toLowerCase():B.element;
K=F.attributes;S=F.styles}F=J[L]||(J[L]={});if(K){L=F.attributes=F.attributes||[];for(var T in K)K.hasOwnProperty(T)&&L.push([T.toLowerCase(),K[T]])}if(S){F=F.styles=F.styles||[];for(var X in S)S.hasOwnProperty(X)&&F.push([X.toLowerCase(),S[X]])}}}return J}function a(B,J){var C=B._.definition,I=A(B),F=G.mix(C.attributes,(I[J._4e_name()]||I["*"]||{}).attributes);C=G.mix(C.styles,(I[J._4e_name()]||I["*"]||{}).styles);I=y.isEmptyObject(F)&&y.isEmptyObject(C);for(var L in F)if(F.hasOwnProperty(L))if(!((L==
"class"||B._.definition.fullMatch)&&J.attr(L)!=e(L,F[L]))){I=I||!!J._4e_hasAttribute(L);J.removeAttr(L)}for(var K in C)if(C.hasOwnProperty(K))if(!(B._.definition.fullMatch&&J._4e_style(K)!=e(K,C[K],l))){I=I||!!J._4e_style(K);J._4e_style(K,"")}j(J)}function e(B,J,C){var I=new P("<span>");I[C?"_4e_style":"attr"](B,J);return I[C?"_4e_style":"attr"](B)}function k(B,J){for(var C=A(B),I=J.all(B.element),F=I.length;--F>=0;)a(B,new P(I[F]));for(var L in C)if(C.hasOwnProperty(L))if(L!=B.element){I=J.all(L);
for(F=I.length-1;F>=0;F--){var K=new P(I[F]);i(K,C[L])}}}function i(B,J){var C,I=J&&J.attributes;if(I)for(C=0;C<I.length;C++){var F=I[C][0],L;if(L=B.attr(F)){var K=I[C][1];if(K===p||K.test&&K.test(L)||typeof K=="string"&&L==K)B[0].removeAttribute(F)}}if(I=J&&J.styles)for(C=0;C<I.length;C++){F=I[C][0];if(K=B.css(F)){var S=I[C][1];if(S===p||S.test&&S.test(L)||typeof S=="string"&&K==S)B.css(F,"")}}j(B)}function j(B){if(!B._4e_hasAttributes()){var J=B[0].firstChild,C=B[0].lastChild;B._4e_remove(l);if(J){J.nodeType==
n.NODE_ELEMENT&&c._4e_mergeSiblings(J);C&&J!=C&&C.nodeType==n.NODE_ELEMENT&&c._4e_mergeSiblings(C)}}}var l=true,r=false,p=null,y=KISSY,G=v.Utils,c=y.DOM,h={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},m=v.RANGE,z=v.Selection,n=v.NODE,t=v.POSITION,O=v.Range,P=y.Node,N=y.UA,M=v.ElementPath,R={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},Q={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},U=/\s*(?:;\s*|$)/g,W=/#\((.+?)\)/g;v.STYLE=h;H.prototype={apply:function(B){x.call(this,
B,r)},remove:function(B){x.call(this,B,l)},applyToRange:function(B){return(this.applyToRange=this.type==h.STYLE_INLINE?d:this.type==h.STYLE_BLOCK?w:this.type==h.STYLE_OBJECT?p:p).call(this,B)},removeFromRange:function(B){return(this.removeFromRange=this.type==h.STYLE_INLINE?b:p).call(this,B)},checkElementRemovable:function(B,J){if(!B)return r;var C=this._.definition,I;if(B._4e_name()==this.element){if(!J&&!B._4e_hasAttributes())return l;var F=C._AC;if(F)C=F;else{F={};var L=0,K=C.attributes;if(K)for(var S in K)if(K.hasOwnProperty(S)){L++;
F[S]=K[S]}if(K=H.getStyleText(C)){F.style||L++;F.style=K}F._length=L;C=C._AC=F}if(C._length){for(var T in C)if(T!="_length")if(C.hasOwnProperty(T)){L=B.attr(T)||"";if(T=="style")a:{F=C[T];L=o(L,r);typeof F=="string"&&(F=f(F));typeof L=="string"&&(L=f(L));K=void 0;for(K in F)if(F.hasOwnProperty(K))if(!(K in L&&(L[K]==F[K]||F[K]=="inherit"||L[K]=="inherit"))){F=r;break a}F=l}else F=C[T]==L;if(F){if(!J)return l}else if(J)return r}if(J)return l}else return l}T=A(this);if(T=T[B._4e_name()]||T["*"]){if(!(C=
T.attributes)&&!(I=T.styles))return l;if(C)for(F=0;F<C.length;F++){T=C[F][0];if(T=B.attr(T)){L=C[F][1];if(L===p||typeof L=="string"&&T==L||L.test&&L.test(T))return l}}if(I)for(F=0;F<I.length;F++)if(T=B.css(I[F][0])){C=I[F][1];if(C===p||typeof C=="string"&&T==C||C.test&&C.test(T))return l}}return r},checkActive:function(B){switch(this.type){case h.STYLE_BLOCK:return this.checkElementRemovable(B.block||B.blockLimit,l);case h.STYLE_OBJECT:case h.STYLE_INLINE:for(var J=B.elements,C=0,I;C<J.length;C++){I=
J[C];if(!(this.type==h.STYLE_INLINE&&(c._4e_equals(I,B.block)||c._4e_equals(I,B.blockLimit))))if(!(this.type==h.STYLE_OBJECT&&!(I._4e_name()in Q)))if(this.checkElementRemovable(I,l))return l}}return r}};H.getStyleText=function(B){var J=B._ST;if(J)return J;J=B.styles;var C=B.attributes&&B.attributes.style||"",I="";if(C.length)C=C.replace(U,";");for(var F in J)if(J.hasOwnProperty(F)){var L=J[F],K=(F+":"+L).replace(U,";");if(L=="inherit")I+=K;else C+=K}if(C.length)C=o(C);C+=I;return B._ST=C};v.Style=
H});
KISSY.Editor.add("htmlparser",function(){function v(){this._={htmlPartsRegex:RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var D=KISSY,E=function(){},H=D.Editor,x=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,s={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},w=H.XHTML_DTD;D.augment(v,{onTagOpen:E,onTagClose:E,
onText:E,onCDATA:E,onComment:E,parse:function(u){for(var q,g,d=0,b;q=this._.htmlPartsRegex.exec(u);){g=q.index;if(g>d){d=u.substring(d,g);b?b.push(d):this.onText(d)}d=this._.htmlPartsRegex.lastIndex;if(g=q[1]){g=g.toLowerCase();if(b&&w.$cdata[g]){this.onCDATA(b.join(""));b=null}if(!b){this.onTagClose(g);continue}}if(b)b.push(q[0]);else if(g=q[3]){g=g.toLowerCase();if(!/="/.test(g)){var f={},o;q=q[4];var A=!!(q&&q.charAt(q.length-1)=="/");if(q)for(;o=x.exec(q);){var a=o[1].toLowerCase();o=o[2]||o[3]||
o[4]||"";f[a]=!o&&s[a]?a:o}this.onTagOpen(g,f,A);if(!b&&w.$cdata[g])b=[]}}else if(g=q[2])this.onComment(g)}u.length>d&&this.onText(u.substring(d,u.length))}});H.HtmlParser=v;H.HtmlParser=v});
KISSY.Editor.add("htmlparser-basicwriter",function(){function v(){this._={output:[]}}var D=KISSY,E=D.Editor,H=E.Utils;D.augment(v,{openTag:function(x){this._.output.push("<",x)},openTagClose:function(x,s){s?this._.output.push(" />"):this._.output.push(">")},attribute:function(x,s){if(typeof s=="string")s=H.htmlEncodeAttr(s);this._.output.push(" ",x,'="',s,'"')},closeTag:function(x){this._.output.push("</",x,">")},text:function(x){this._.output.push(x)},comment:function(x){this._.output.push("<!--",
x,"--\>")},write:function(x){this._.output.push(x)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(x){var s=this._.output.join("");x&&this.reset();return s}});E.HtmlParser.BasicWriter=v});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function v(){v.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=s;this.sortAttributes=x;this._.indent=s;this._.indentation="";this._.rules={};var w=E.XHTML_DTD,u;for(u in H.mix({},w.$nonBodyContent,w.$block,w.$listItem,w.$tableContent))this.setRules(u,{indent:x,breakBeforeOpen:x,breakAfterOpen:x,breakBeforeClose:!w[u]["#"],breakAfterClose:x});this.setRules("br",
{breakAfterOpen:x});this.setRules("title",{indent:s,breakAfterOpen:s});this.setRules("style",{indent:s,breakBeforeClose:x});this.setRules("pre",{indent:s})}var D=KISSY,E=D.Editor,H=E.Utils,x=true,s=false;D.extend(v,E.HtmlParser.BasicWriter,{openTag:function(w){var u=this._.rules[w];if(this._.indent)this.indentation();else if(u&&u.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",w)},openTagClose:function(w,u){var q=this._.rules[w];if(u)this._.output.push(this.selfClosingEnd);
else{this._.output.push(">");if(q&&q.indent)this._.indentation+=this.indentationChars}q&&q.breakAfterOpen&&this.lineBreak()},attribute:function(w,u){if(typeof u=="string"){this.forceSimpleAmpersand&&(u=u.replace(/&amp;/g,"&"));u=H.htmlEncodeAttr(u)}this._.output.push(" ",w,'="',u,'"')},closeTag:function(w){var u=this._.rules[w];if(u&&u.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();else if(u&&u.breakBeforeClose){this.lineBreak();
this.indentation()}this._.output.push("</",w,">");u&&u.breakAfterClose&&this.lineBreak()},text:function(w){if(this._.indent){this.indentation();w=H.ltrim(w)}this._.output.push(w)},comment:function(w){this._.indent&&this.indentation();this._.output.push("<!--",w,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=x},indentation:function(){this._.output.push(this._.indentation);this._.indent=s},setRules:function(w,u){var q=this._.rules[w];if(q)H.mix(q,
u);else this._.rules[w]=u}});E.HtmlParser.HtmlWriter=v});
KISSY.Editor.add("htmlparser-fragment",function(){function v(){this.children=[];this.parent=H;this._={isBlockLike:D,hasInlineStarted:E}}var D=true,E=false,H=null,x=KISSY.Editor,s={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},w=KISSY,u=x.Utils,q=x.NODE,g=x.XHTML_DTD;u.mix({table:1,ul:1,ol:1,dl:1},g.table,g.ul,g.ol,g.dl);var d=g.$list,b=g.$listItem;v.FromHtml=function(f,o){function A(h){var m;if(j.length>0)for(var z=0;z<j.length;z++){var n=j[z],t=n.name,O=g[t],P=r.name&&g[r.name];
if((!P||P[t])&&(!h||!O||O[h]||!g[h])){if(!m){a();m=1}n=n.clone();n.parent=r;r=n;j.splice(z,1);z--}}}function a(){for(;l.length;)r.add(l.shift())}function e(h,m,z){m=m||r||i;if(o&&!m.type){var n,t;if((n=h.attributes&&(t=h.attributes._ke_real_element_type)?t:h.name)&&!(n in g.$body)&&!(n in g.$nonBodyContent)){t=r;r=m;k.onTagOpen({li:"ul",dt:"dl",dd:"dl"}[n]||o,{});m=r;if(z)r=t}}if(h._.isBlockLike&&h.name!="pre"){z=h.children.length;if((n=h.children[z-1])&&n.type==q.NODE_TEXT)if(t=u.rtrim(n.value))n.value=
t;else h.children.length=z-1}m.add(h);if(h.returnPoint){r=h.returnPoint;delete h.returnPoint}}var k=new x.HtmlParser,i=new v,j=[],l=[],r=i,p=E,y;k.onTagOpen=function(h,m,z){var n=new x.HtmlParser.Element(h,m);if(n.isUnknown&&z)n.isEmpty=D;if(g.$removeEmpty[h]&&w.isEmptyObject(m))j.push(n);else{if(String(h)==="pre")p=D;else if(String(h)==="br"&&p){r.add(new x.HtmlParser.Text("\n"));return}if(String(h)==="br")l.push(n);else{var t=r.name,O=t&&(g[t]||(r._.isBlockLike?g.div:g.span));if(O&&!n.isUnknown&&
!r.isUnknown&&!O[h]){O=E;var P;if(h in d&&t in d){t=r.children;(t=t[t.length-1])&&t.name in b||e(t=new x.HtmlParser.Element("li"),r);y=r;P=t}else if(h==t)e(r,r.parent);else{e(r,r.parent,D);!s[t]&&t in g.$inline&&j.unshift(r);O=D}r=P?P:r.returnPoint||r.parent;if(O){k.onTagOpen.apply(this,arguments);return}}A(h);a();n.parent=r;n.returnPoint=y;y=0;if(n.isEmpty)e(n);else r=n}}};k.onTagClose=function(h){for(var m=j.length-1;m>=0;m--)if(h==j[m].name){j.splice(m,1);return}for(var z=[],n=[],t=r;t.type&&t.name!=
h;){t._.isBlockLike||n.unshift(t);z.push(t);t=t.parent}if(t.type){for(m=0;m<z.length;m++){var O=z[m];e(O,O.parent)}r=t;if(r.name=="pre")p=E;t._.isBlockLike&&a();e(t,t.parent);if(t==r)r=r.parent;j=j.concat(n)}if(h=="body")o=E};k.onText=function(h){if(!r._.hasInlineStarted&&!p){h=u.ltrim(h);if(h.length===0)return}a();A();if(o&&(!r.type||r.name=="body")&&u.trim(h))this.onTagOpen(o,{});p||(h=h.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));r.add(new x.HtmlParser.Text(h))};k.onCDATA=function(h){r.add(new x.HtmlParser.cdata(h))};
k.onComment=function(h){r.add(new x.HtmlParser.Comment(h))};k.parse(f);for(a();r.type;){var G=r.parent,c=r;if(o&&(!G.type||G.name=="body")&&!g.$body[c.name]){r=G;k.onTagOpen(o,{});G=r}G.add(c);r=G}return i};w.augment(v,{add:function(f){var o=this.children.length;if(o=o>0&&this.children[o-1]||H){if(f._.isBlockLike&&o.type==q.NODE_TEXT){o.value=u.rtrim(o.value);if(o.value.length===0){this.children.pop();this.add(f);return}}o.next=f}f.previous=o;f.parent=this;this.children.push(f);this._.hasInlineStarted=
f.type==q.NODE_TEXT||f.type==q.NODE_ELEMENT&&!f._.isBlockLike},writeHtml:function(f,o){var A;this.filterChildren=this.filterChildren=function(){var a=new x.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,a,o,D);a=a.getHtml();this.children=(new v.FromHtml(a)).children;A=1};!this.name&&o&&o.onFragment(this);this.writeChildrenHtml(f,A?H:o)},writeChildrenHtml:function(f,o){for(var A=0;A<this.children.length;A++)this.children[A].writeHtml(f,o)}});x.HtmlParser.Fragment=v});
KISSY.Editor.add("htmlparser-element",function(){function v(x,s){this.name=x;this.attributes=s||(s={});this.children=[];var w=s._ke_real_element_type||x,u=D.XHTML_DTD;w=!!(u.$nonBodyContent[w]||u.$block[w]||u.$listItem[w]||u.$tableContent[w]||u.$nonEditable[w]||w=="br");var q=!!u.$empty[x];this.isEmpty=q;this.isUnknown=!u[x];this._={isBlockLike:w,hasInlineStarted:q||!w}}var D=KISSY.Editor,E=D.NODE,H=function(x,s){x=x[0];s=s[0];return x<s?-1:x>s?1:0};KISSY.augment(v,{type:E.NODE_ELEMENT,add:D.HtmlParser.Fragment.prototype.add,
clone:function(){return new v(this.name,this.attributes)},writeHtml:function(x,s){var w=this.attributes,u=this,q=u.name,g,d,b,f;u.filterChildren=function(){if(!f){var a=new D.HtmlParser.BasicWriter;D.HtmlParser.Fragment.prototype.writeChildrenHtml.call(u,a,s);u.children=(new D.HtmlParser.Fragment.FromHtml(a.getHtml())).children;f=1}};u.filterChildren=u.filterChildren;if(s){for(;;){if(!(q=s.onElementName(q)))return;u.name=q;if(!(u=s.onElement(u)))return;u.parent=this.parent;if(u.name==q)break;if(u.type!=
E.NODE_ELEMENT){u.writeHtml(x,s);return}q=u.name;if(!q){this.writeChildrenHtml.call(u,x,f?null:s);return}}w=u.attributes}x.openTag(q,w);for(var o=[],A=0;A<2;A++)for(g in w){d=g;b=w[g];if(A==1)o.push([g,b]);else if(s){for(;;)if(d=s.onAttributeName(g))if(d!=g){delete w[g];g=d}else break;else{delete w[g];break}if(d)if((b=s.onAttribute(u,d,b))===false)delete w[d];else w[d]=b}}x.sortAttributes&&o.sort(H);w=o.length;for(A=0;A<w;A++){g=o[A];x.attribute(g[0],g[1])}x.openTagClose(q,u.isEmpty);if(!u.isEmpty){this.writeChildrenHtml.call(u,
x,f?null:s);x.closeTag(q)}},writeChildrenHtml:function(){D.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});D.HtmlParser.Element=v});
KISSY.Editor.add("htmlparser-filter",function(){function v(d){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};d&&this.addRules(d,10)}function D(d,b){for(var f=0;d&&f<b.length;f++){var o=b[f];d=d.replace(o[0],o[1])}return d}function E(d,b,f){if(typeof b=="function")b=[b];var o,A;A=d.length;var a=b&&b.length;if(a){for(o=0;o<A&&d[o].pri<f;o++);for(A=a-1;A>=0;A--)if(a=b[A]){a.pri=f;d.splice(o,0,a)}}}function H(d,b,f){if(b)for(var o in b){var A=d[o];d[o]=x(A,b[o],
f);A||d.$length++}}function x(d,b,f){if(b){b.pri=f;if(d){if(d.splice)E(d,b,f);else{d=d.pri>f?[b,d]:[d,b];d.filter=s}return d}else return b.filter=b}}function s(d){for(var b=d.type||d instanceof u.HtmlParser.Fragment,f=0;f<this.length;f++){if(b)var o=d.type,A=d.name;var a=this[f].apply(window,arguments);if(a===g)return a;if(b){if(a&&(a.name!=A||a.type!=o))return a}else if(typeof a!="string")return a;a!=undefined&&(d=a)}return d}var w=KISSY,u=w.Editor,q=u.NODE,g=false;w.augment(v,{addRules:function(d,
b){if(typeof b!="number")b=10;E(this._.elementNames,d.elementNames,b);E(this._.attributeNames,d.attributeNames,b);H(this._.elements,d.elements,b);H(this._.attributes,d.attributes,b);this._.text=x(this._.text,d.text,b)||this._.text;this._.comment=x(this._.comment,d.comment,b)||this._.comment;this._.root=x(this._.root,d.root,b)||this._.root},onElementName:function(d){return D(d,this._.elementNames)},onAttributeName:function(d){return D(d,this._.attributeNames)},onText:function(d){var b=this._.text;
return b?b.filter(d):d},onComment:function(d,b){var f=this._.comment;return f?f.filter(d,b):d},onFragment:function(d){var b=this._.root;return b?b.filter(d):d},onElement:function(d){for(var b=[this._.elements["^"],this._.elements[d.name],this._.elements.$],f,o=0;o<3;o++)if(f=b[o]){f=f.filter(d,this);if(f===g)return null;if(f&&f!=d)return this.onNode(f);if(d.parent&&!d.name)break}return d},onNode:function(d){var b=d.type;return b==q.NODE_ELEMENT?this.onElement(d):b==q.NODE_TEXT?new u.HtmlParser.Text(this.onText(d.value)):
null},onAttribute:function(d,b,f){if(b=this._.attributes[b]){d=b.filter(f,d,this);if(d===g)return g;if(typeof d!="undefined")return d}return f}});u.HtmlParser.Filter=v});KISSY.Editor.add("htmlparser-text",function(){function v(x){this.value=x;this._={isBlockLike:H}}var D=KISSY,E=D.Editor,H=false;D.augment(v,{type:E.NODE.NODE_TEXT,writeHtml:function(x,s){var w=this.value;s&&!(w=s.onText(w,this))||x.text(w)}});E.HtmlParser.Text=v;E.HtmlParser.Text=v});
KISSY.Editor.add("htmlparser-cdata",function(v){v.HtmlParser.cdata=function(D){this.value=D};v.HtmlParser.cdata.prototype={type:v.NODE.NODE_TEXT,writeHtml:function(D){D.write(this.value)}}});
KISSY.Editor.add("htmlparser-comment",function(){function v(H){this.value=H;this._={isBlockLike:false}}var D=KISSY.Editor,E=D.NODE;D.HtmlParser.Comment=v;D.HtmlParser.Comment=v;v.prototype={constructor:v,type:E.NODE_COMMENT,writeHtml:function(H,x){var s=this.value;if(x){if(!(s=x.onComment(s,this)))return;if(typeof s!="string"){s.parent=this.parent;s.writeHtml(H,x);return}}H.comment(s)}}});
KISSY.Editor.add("button",function(){function v(s){if(s&&s.indexOf("<")==-1)return s;return 0}var D=KISSY,E=D.Editor,H=D.require("uibase");if(E.TripleButton)D.log("TripleButton attach twice","warn");else{var x=H.create([H.Box.Render||H.Box],{_updateHref:function(){this.get("el").attr("href","javascript:void('"+(v(this.get("text"))||v(this.get("title")))+"')")},bindUI:function(){var s=this,w=s.get("el");w.on("click",s._action,s);w.on("mousedown",function(){s.get("state")=="off"&&w.addClass("ke-triplebutton-active")});
w.on("mouseup mouseleave",function(){s.get("state")=="off"&&w.hasClass("ke-triplebutton-active")&&setTimeout(function(){w.removeClass("ke-triplebutton-active")},300)})},_uiSetTitle:function(){this.get("el").attr("title",this.get("title"));this._updateHref()},_uiSetContentCls:function(s){var w=this.get("el");if(s!==undefined){w.html("<span class='ke-toolbar-item "+s+"' />");w._4e_unselectable()}},_uiSetText:function(s){this.get("el").html(s);this._updateHref()},_uiSetState:function(s){this["_"+s]()},
disable:function(){this._savedState=this.get("state");this.set("state","disabled")},enable:function(){this.get("state")=="disabled"&&this.set("state",this._savedState)},_action:function(s){this.fire(this.get("state")+"Click",{TripleEvent:s});this.fire("click",{TripleClickType:this.get("state")+"Click"});s&&s.preventDefault()},bon:function(){this.set("state","on")},boff:function(){this.set("state","off")},_on:function(){var s=this.get("el");s.removeClass("ke-triplebutton-off ke-triplebutton-disabled");
s.addClass("ke-triplebutton-on")},_off:function(){var s=this.get("el");s.removeClass("ke-triplebutton-on ke-triplebutton-disabled");s.addClass("ke-triplebutton-off")},_disabled:function(){var s=this.get("el");s.removeClass("ke-triplebutton-off ke-triplebutton-on");s.addClass("ke-triplebutton-disabled")}},{ATTRS:{state:{value:"off"},elCls:{value:"ke-triplebutton ke-triplebutton-off"},elTagName:{value:"a"},title:{},contentCls:{},text:{}}});x.ON="on";x.OFF="off";x.DISABLED="disabled";x.ON_CLASS="ke-triplebutton-on";
x.OFF_CLASS="ke-triplebutton-off";x.DISABLED_CLASS="ke-triplebutton-disabled";E.TripleButton=x;E.prototype.addButton=function(s,w){var u=this,q=new x({render:u.toolBarDiv,autoRender:true,title:w.title,text:w.text,contentCls:w.contentCls}),g={name:s,btn:q,editor:u,cfg:w,call:function(){var d=D.makeArray(arguments),b=d.shift();return w[b].apply(g,d)},reload:function(d){D.mix(w,d);q.enable();u.on("selectionChange",function(){u.getMode()!=E.SOURCE_MODE&&w.selectionChange&&w.selectionChange.apply(g,arguments)});
q.on("click",function(b){var f=b.TripleClickType;w[f]&&w[f].apply(g,arguments);b&&b.halt()});if(w.mode==E.WYSIWYG_MODE){u.on("wysiwygmode",q.enable,q);u.on("sourcemode",q.disable,q)}w.init&&w.init.call(g)},destroy:function(){w.destroy&&w.destroy.call(g);q.destroy()}};w.loading?q.disable():g.reload(undefined);return g}}},{attach:false});
KISSY.Editor.add("select",function(){function v(d){v.superclass.constructor.call(this,d);this._init()}function D(d){if(d&&d.indexOf("<")==-1)return d;return 0}var E=KISSY,H=E.Node,x=E.Event,s=E.DOM,w=E.Editor;if(w.Select)E.log("ke select attach more");else{v.DISABLED=0;v.ENABLED=1;var u=w.XHTML_DTD;v.ATTRS={showValue:{},el:{},cls:{},container:{},doc:{},value:{},width:{},title:{},items:{},emptyText:{},align:{value:["l","b"]},menuContainer:{valueFn:function(){for(var d=this.el.parent();d;){var b=d._4e_name();
if(u[b]&&u[b].div)return d;d=d.parent()}return new H(document.body)}},state:{value:1}};v.decorate=function(d){for(var b=d.width(),f=[],o=d.all("option"),A=0;A<o.length;A++){var a=o[A];f.push({name:s.html(a),value:s.attr(a,"value")})}return new v({width:b+"px",title:d.attr("title"),el:d,items:f,cls:"ke-combox",value:d.val()})};var q=w.Utils.addRes,g=w.Utils.destroyRes;E.extend(v,E.Base,{_init:function(){var d=this.get("container"),b=this.get("el"),f=new H("<span class='ke-select-wrap'><a class='ke-select'><span class='ke-select-text'><span class='ke-select-text-inner'></span></span><span class='ke-select-drop-wrap'><span class='ke-select-drop'></span></span></a></span>"),
o=f.one("a"),A=this.get("title")||"",a=this.get("cls"),e=f.one(".ke-select-text"),k=f.one(".ke-select-text-inner");f.one(".ke-select-drop");this.get("value")!==undefined?k.html(this._findNameByV(this.get("value"))):k.html(A);e.css("width",this.get("width"));f._4e_unselectable();A&&f.attr("title",A);o.attr("href","javascript:void('"+D(A)+"')");a&&f.addClass(a);if(b)b[0].parentNode.replaceChild(f[0],b[0]);else d&&f.appendTo(d);f.on("click",this._click,this);this.el=f;this.title=k;this._focusA=f.one("a.ke-select");
w.Utils.lazyRun(this,"_prepare","_real");this.on("afterValueChange",this._valueChange,this);this.on("afterStateChange",this._stateChange,this)},_findNameByV:function(d){var b=this.get("title")||"",f=this.get("items");if(this.get("showValue"))return d||b;for(var o=0;o<f.length;o++){var A=f[o];if(A.value==d){b=A.name;break}}return b},_valueChange:function(d){this.title.html(this._findNameByV(d.newVal))},_itemsChange:function(d){var b;b=d.newVal;d=this._selectList;d.html("");if(b&&b.length)for(var f=
0;f<b.length;f++){var o=b[f];(new H("<a class='ke-select-menu-item' href='javascript:void(\""+D(o.name)+"\")' data-value='"+o.value+"'>"+o.name+"</a>",o.attrs)).appendTo(d)._4e_unselectable()}else if(b=this.get("emptyText"))(new H("<a class='ke-select-menu-item' href='javascript:void(\""+D(b)+"\")'>"+b+"</a>")).appendTo(d)._4e_unselectable();this.as=d.all("a")},val:function(d){if(d!==undefined){this.set("value",d);return this}else return this.get("value")},_resize:function(){this.menu.get("visible")&&
this._real()},_prepare:function(){function d(k){k=new H(k.target);f.contains(k)||f._4e_equals(k)||a.hide()}var b=this,f=b.el,o=b.get("popUpWidth"),A=b._focusA,a=new w.Overlay({autoRender:true,render:b.get("menuContainer"),content:"<div>",focus4e:false,elCls:"ke-menu",width:o?o:f.width(),zIndex:w.baseZIndex(w.zIndexManager.SELECT),focusMgr:false}),e=b.get("items");q.call(b,a);o=a.get("contentEl").one("div");b.menu=a;x.on(window,"resize",b._resize,b);q.call(b,function(){x.remove(window,"resize",b._resize,
b)});b.get("title")&&(new H("<div class='ke-menu-title ke-select-menu-item' style='margin-top:-6px;' >"+b.get("title")+"</div>")).appendTo(o);b._selectList=(new H("<div>")).appendTo(o);b._itemsChange({newVal:e});a.on("show",function(){A.addClass("ke-select-active")});a.on("hide",function(){A.removeClass("ke-select-active")});x.on(document,"click",d);q.call(b,function(){x.remove(document,"click",d)});b.get("doc")&&x.on(b.get("doc"),"click",d);o.on("click",b._select,b);b.as=b._selectList.all("a");x.on(o[0],
"mouseenter",function(){b.as.removeClass("ke-menu-selected")});q.call(b,o);b.on("afterItemsChange",b._itemsChange,b);b.menuNode=o},_stateChange:function(d){var b=this.el;d.newVal==1?b.removeClass("ke-select-disabled"):b.addClass("ke-select-disabled")},enable:function(){this.set("state",1)},disable:function(){this.set("state",0)},_select:function(d){d&&d.halt();var b=this.menu,f=this.menuNode;if((d=(new H(d.target))._4e_ascendant(function(a){return f.contains(a)&&a._4e_name()=="a"},true))&&d._4e_hasAttribute("data-value")){var o=
this.get("value"),A=d.attr("data-value");this.set("value",A);this.fire("click",{newVal:A,prevVal:o,name:d.html()});b.hide()}},_real:function(){var d=this.el,b=d.offset(),f=E.clone(b),o=this.menu.get("el").height(),A=this.menu.get("el").width(),a=s.scrollTop(),e=s.scrollLeft(),k=s.viewportHeight(),i=s.viewportWidth();i=e+i-60;k=a+k;var j=b.top+(d.height()-2);d=b.left+d.width()-2;var l=this.get("align"),r=l[0];if(l[1]=="b"){b.top=j;if(b.top+o>k&&f.top-a>k-j)b.top=f.top-o}else{b.top=f.top-o;if(b.top<
a&&f.top-a<k-j)b.top=j}if(r=="l"){if(b.left+A>i&&d-e>i-f.left)b.left=d-A}else{b.left=d-A;if(b.left<e&&d-e<i-f.left)b.left=f.left}this.menu.set("xy",[b.left,b.top]);this.menu.show()},_click:function(d){if(!this.loading){d&&d.preventDefault();var b=this;d=b.el;var f=b.get("value");if(!d.hasClass("ke-select-disabled"))if(b._focusA.hasClass("ke-select-active"))b.menu&&b.menu.hide();else{b.loading=true;w.use("overlay",function(){b.loading=false;b.fire("select");b._prepare();f&&b.menu&&b.as.each(function(o){o.attr("data-value")==
f?o.addClass("ke-menu-selected"):o.removeClass("ke-menu-selected")})})}}},destroy:function(){g.call(this);this.el.detach();this.el.remove()}});w.Select=v;w.prototype.addSelect=function(d,b){var f=this;b=E.mix({container:f.toolBarDiv,doc:f.document,menuContainer:new H(document.body)},b);var o=new v(b),A={name:d,btn:o,editor:f,cfg:b,call:function(){var a=E.makeArray(arguments),e=a.shift();return b[e].apply(A,a)},reload:function(a){E.mix(b,a);o.enable();f.on("selectionChange",function(){f.getMode()!=
w.SOURCE_MODE&&b.selectionChange&&b.selectionChange.apply(A,arguments)});o.on("click",function(e){var k=e.type;b[k]&&b[k].apply(A,arguments);e&&e.halt()});if(b.mode==w.WYSIWYG_MODE){f.on("wysiwygmode",o.enable,o);f.on("sourcemode",o.disable,o)}b.init&&b.init.call(A)},destroy:function(){b.destroy&&b.destroy.call(A);o.destroy()}};b.loading?o.disable():A.reload(undefined);return A}}},{attach:false});
