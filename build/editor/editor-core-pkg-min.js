/*
 Constructor for kissy editor,dependency moved to independent module
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com, lifesinger@gmail.com
 @version: 2.1.5
 @buildtime: 2011-10-20 15:52:23
*/
KISSY.add("editor/export",function(o){function B(y,z){var m=this;if(!(m instanceof B))return new B(y,z);if(o.isString(y))y=o.one(y);y=D._4e_wrap(y);z=z||{};z.pluginConfig=z.pluginConfig||{};m.cfg=z;z.pluginConfig=z.pluginConfig;m.cfg=z;o.app(m,o.EventTarget);var f=["htmldataprocessor","enterkey","clipboard"],e=w;m.use=function(b,g){b=b.split(",");if(!e)for(var u=0;u<f.length;u++){var j=f[u];o.inArray(j,b)||b.unshift(j)}m.ready(function(){o.Editor.use("button,select",function(){o.use.call(m,b.join(","),
function(){for(var a=0;a<b.length;a++)m.usePlugin(b[a]);g&&g.call(m);if(!e){m.setData(y.val());if(z.focus)m.focus();else(a=m.getSelection())&&a.removeAllRanges();e=G}},{global:B})})});return m};m.use=m.use;m.Config.base=B.Config.base;m.Config.debug=B.Config.debug;m.Config.componentJsName=x;m.init(y)}var D=o.DOM,G=true,w=false,x;x=parseFloat(o.version)<1.2?function(){return"plugin-min.js?t=2011-10-20 15:52:23"}:function(y,z){return y+"/plugin-min.js"+(z?z:"?t=2011-10-20 15:52:23")};o.app(B,o.EventTarget);B.Config.base=
o.Config.base+"editor/plugins/";B.Config.debug=o.Config.debug;B.Config.componentJsName=x;o.Editor=B;o.Editor=B});KISSY.add("editor",function(o){return o.Editor},{requires:["dd","overlay"]});
KISSY.Editor.add("utils",function(o){var B=null,D=KISSY,G=D.Node,w=D.DOM,x=D.UA,y=D.Event,z;z=x.ie?document.documentMode||x.ie:void 0;var m={debugUrl:function(f){f=f.replace(/-min\.(js|css)/i,".$1");o.Config.debug||(f=f.replace(/\.(js|css)/i,"-min.$1"));if(f.indexOf("?t")==-1){f+=f.indexOf("?")!=-1?"&":"?";f+="t="+encodeURIComponent("2011-09-19 15:00:39")}return o.Config.base+f},lazyRun:function(f,e,b){var g=f[e],u=f[b];f[e]=function(){g.apply(this,arguments);f[e]=f[b];return u.apply(this,arguments)}},
getXY:function(f,e,b,g){b=b.defaultView||b.parentWindow;f-=w.scrollLeft(b);e-=w.scrollTop(b);if(g)if(b!=(g.defaultView||g.parentWindow)&&b.frameElement){g=w._4e_getOffset(b.frameElement,g);f+=g.left;e+=g.top}return{left:f,top:e}},tryThese:function(){for(var f,e=0,b=arguments.length;e<b;e++){var g=arguments[e];try{f=g();break}catch(u){}}return f},arrayCompare:function(f,e){if(!f&&!e)return true;if(!f||!e||f.length!=e.length)return false;for(var b=0;b<f.length;b++)if(f[b]!==e[b])return false;return true},
getByAddress:function(f,e,b){f=f.documentElement;for(var g=0;f&&g<e.length;g++){var u=e[g];if(b)for(var j=-1,a=0;a<f.childNodes.length;a++){var d=f.childNodes[a];if(!(b===true&&d.nodeType==3&&d.previousSibling&&d.previousSibling.nodeType==3)){j++;if(j==u){f=d;break}}}else f=f.childNodes[u]}return f?new G(f):B},clearAllMarkers:function(f){for(var e in f)f[e]._4e_clearMarkers(f,true)},htmlEncodeAttr:function(f){return f.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(f){return f.replace(/^\s+/,
"")},rtrim:function(f){return f.replace(/\s+$/,"")},trim:function(f){return this.ltrim(this.rtrim(f))},mix:function(){for(var f={},e=0;e<arguments.length;e++)f=D.mix(f,arguments[e]);return f},isCustomDomain:function(){if(!x.ie)return false;var f=document.domain,e=window.location.hostname;return f!=e&&f!="["+e+"]"},duplicateStr:function(f,e){return Array(e+1).join(f)},throttle:function(f,e,b){b=b||150;if(b===-1)return function(){f.apply(e,arguments)};var g=(new Date).getTime();return function(){var u=
(new Date).getTime();if(u-g>b){g=u;f.apply(e,arguments)}}},buffer:function(f,e,b){b=b||0;var g=B;return function(){g&&clearTimeout(g);var u=arguments;g=setTimeout(function(){return f.apply(e,u)},b)}},isNumber:function(f){return/^\d+(.\d+)?$/.test(D.trim(f))},verifyInputs:function(f){for(var e=0;e<f.length;e++){var b=w._4e_wrap(f[e]),g=D.trim(b.val()),u=b.attr("data-verify");b=b.attr("data-warning");if(u&&!RegExp(u).test(g)){alert(b);return false}}return true},sourceDisable:function(f,e){f.on("sourcemode",
e.disable,e);f.on("wysiwygmode",e.enable,e)},resetInput:function(f){var e=f.attr("placeholder");if(e&&!x.webkit){f.addClass("ke-input-tip");f.val(e)}else x.webkit&&f.val("")},valInput:function(f,e){f.removeClass("ke-input-tip");f.val(e)},placeholder:function(f,e){f.attr("placeholder",e);if(!x.webkit){f.on("blur",function(){if(!D.trim(f.val())){f.addClass("ke-input-tip");f.val(e)}});f.on("focus",function(){f.removeClass("ke-input-tip");D.trim(f.val())==e&&f.val("")})}},clean:function(f){f=f[0]||f;
for(var e=D.makeArray(f.childNodes),b=0;b<e.length;b++){var g=e[b];g.nodeType==o.NODE.NODE_TEXT&&!D.trim(g.nodeValue)&&f.removeChild(g)}},htmlEncode:function(f){return!f?f:String(f).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},htmlDecode:function(f){return!f?f:String(f).replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&quot;/g,'"').replace(/&amp;/g,"&")},equalsIgnoreCase:function(f,e){return f.toLowerCase()==e.toLowerCase()},normParams:function(f){f=D.clone(f);
for(var e in f)if(f.hasOwnProperty(e)){var b=f[e];if(D.isFunction(b))f[e]=b()}return f},doFormUpload:function(f,e,b){function g(){var i={responseText:"",responseXML:B};i.argument=f?f.argument:B;try{var p;if((p=x.ie?j.contentWindow.document:j.contentDocument||window.frames[u].document)&&p.body)i.responseText=D.trim(w.text(p.body));i.responseXML=p&&p.XMLDocument?p.XMLDocument:p}catch(r){D.log(r)}y.remove(j,"load",g);f.callback&&f.callback(i);setTimeout(function(){w._4e_remove(j)},100)}var u=D.guid("form-upload-"),
j=document.createElement("iframe");j.id=u;j.name=u;j.className="ke-hidden";var a="document.open();"+(m.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();";if(x.ie)j.src=x.ie?"javascript:void(function(){"+encodeURIComponent(a)+"}())":"";D.log("doFormUpload : "+j.src);document.body.appendChild(j);if(x.ie)document.frames[u].name=u;a=w._4e_unwrap(f.form);var d={target:a.target,method:a.method,encoding:a.encoding,enctype:a.enctype,action:a.action};a.target=u;a.method="POST";
a.enctype=a.encoding="multipart/form-data";if(b)a.action=b;var k;if(e){k=[];e=o.Utils.normParams(e);for(var h in e)if(e.hasOwnProperty(h)){b=document.createElement("input");b.type="hidden";b.name=h;b.value=e[h];a.appendChild(b);k.push(b)}}y.on(j,"load",g);a.submit();a.target=d.target;a.method=d.method;a.enctype=d.enctype;a.encoding=d.encoding;a.action=d.action;if(k){e=0;for(h=k.length;e<h;e++)w._4e_remove(k[e])}return j},extern:function(f,e){for(var b in e)f[b]=e[b]},map:function(f,e){for(var b=0;b<
f.length;b++)f[b]=e(f[b]);return f},ieEngine:z,preventFocus:function(f){x.ie?f._4e_unselectable():f.attr("onmousedown","return false;")},isFlashEmbed:function(f){f=f.attributes;return f.type=="application/x-shockwave-flash"||/\.swf(?:$|\?)/i.test(f.src||"")},addRes:function(){var f=this.__res=this.__res||[];f.push.apply(f,D.makeArray(arguments))},destroyRes:function(){for(var f=this.__res||[],e=0;e<f.length;e++){var b=f[e];if(D.isFunction(b))b();else{b.detach&&b.detach();b.destroy&&b.destroy();b.nodeType&&
b.remove&&b.remove()}}this.__res=[]}};o.Utils=m;o.Utils=m;x.ieEngine=m.ieEngine;m.extern(m,{debugUrl:m.debugUrl,lazyRun:m.lazyRun,getXY:m.getXY,tryThese:m.tryThese,arrayCompare:m.arrayCompare,getByAddress:m.getByAddress,clearAllMarkers:m.clearAllMarkers,htmlEncodeAttr:m.htmlEncodeAttr,ltrim:m.ltrim,rtrim:m.rtrim,trim:m.trim,mix:m.mix,isCustomDomain:m.isCustomDomain,duplicateStr:m.duplicateStr,buffer:m.buffer,isNumber:m.isNumber,verifyInputs:m.verifyInputs,sourceDisable:m.sourceDisable,resetInput:m.resetInput,
placeholder:m.placeholder,clean:m.clean,htmlEncode:m.htmlEncode,htmlDecode:m.htmlDecode,equalsIgnoreCase:m.equalsIgnoreCase,normParams:m.normParams,throttle:m.throttle,doFormUpload:m.doFormUpload,map:m.map})});
KISSY.Editor.add("dom",function(o){function B(a){return a.replace(/-(\w)/g,function(d,k){return k.toUpperCase()})}var D=KISSY,G=D.DOM,w=D.UA,x=D.Node,y=o.Utils,z={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};o.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};o.NODE=o.NODE;o.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,
POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};o.POSITION=o.POSITION;var m=o.NODE,f=o.POSITION,e={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},b={hr:1},g=function(a){return a[0]||a},u=function(a){if(a&&!a[0])return new x(a);return a},j={_4e_wrap:u,_4e_unwrap:g,_4e_equals:function(a,d){if(!a&&!d)return true;if(!a||!d)return false;a=g(a);d=g(d);
return a===d},_4e_isBlockBoundary:function(a,d){a=u(a);var k=D.mix(D.mix({},b),d||{});return e[a.css("display")]||k[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=g(a);for(var d=a.parentNode.childNodes,k=0;k<d.length;k++)if(d[k]===a)return k;return-1},_4e_first:function(a,d){a=g(a);var k=a.firstChild;if((k=k&&new x(k))&&d&&!d(k))k=k._4e_next(d);return k},_4e_move:function(a,d,k){a=g(a);G._4e_remove(a);
d=g(d);k?d.insertBefore(a,d.firstChild):d.appendChild(a)},_4e_name:function(a){a=g(a);var d=a.nodeName.toLowerCase();if(w.ie)if((a=a.scopeName)&&a!="HTML")d=a.toLowerCase()+":"+d;return d},_4e_isIdentical:function(a,d){if(a._4e_name()!=d._4e_name())return false;var k=a[0].attributes,h=d[0].attributes,i=k.length,p=h.length;if(i!=p)return false;for(var r=0;r<i;r++){var q=k[r],v=q.name;if(q.specified&&a.attr(v)!=d.attr(v))return false}if(y.ieEngine<8)for(r=0;r<p;r++){q=h[r];v=q.name;if(q.specified&&
a.attr(v)!=d.attr(v))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=g(a).childNodes;for(var d=0,k=a.length;d<k;d++){var h=a[d],i=h.nodeType;if(!(i==m.NODE_ELEMENT&&h.getAttribute("_ke_bookmark")))if(i==m.NODE_ELEMENT&&!j._4e_isEmptyInlineRemoveable(h)||i==m.NODE_TEXT&&D.trim(h.nodeValue))return false}return true},_4e_moveChildren:function(a,d,k){a=g(a);d=d[0]||d;if(a!=d)if(k)for(;k=a.lastChild;)d.insertBefore(a.removeChild(k),d.firstChild);else for(;k=a.firstChild;)d.appendChild(a.removeChild(k))},
_4e_mergeSiblings:function(){function a(d,k,h){if(k[0]&&k[0].nodeType==m.NODE_ELEMENT){for(var i=[];k.attr("_ke_bookmark")||k._4e_isEmptyInlineRemoveable();){i.push(k);k=h?new x(k[0].nextSibling):new x(k[0].previousSibling);if(!k[0]||k[0].nodeType!=m.NODE_ELEMENT)return}if(d._4e_isIdentical(k)){for(var p=h?d[0].lastChild:d[0].firstChild;i.length;)i.shift()._4e_move(d,!h);k._4e_moveChildren(d,!h);k._4e_remove();p[0]&&p[0].nodeType==m.NODE_ELEMENT&&p._4e_mergeSiblings()}}}return function(d){if(d[0])if(z[d._4e_name()]||
d._4e_name()=="a"){a(d,new x(d[0].nextSibling),true);a(d,new x(d[0].previousSibling))}}}(),_4e_unselectable:w.gecko?function(a){a=g(a);a.style.MozUserSelect="none"}:w.webkit?function(a){a=g(a);a.style.KhtmlUserSelect="none"}:function(a){a=g(a);if(w.ie||w.opera){var d=0;a.setAttribute("unselectable","on");for(var k=a.getElementsByTagName("*");a=k[d++];)switch(a.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:a.setAttribute("unselectable","on")}}},_4e_getOffset:function(a,
d){a=g(a);var k,h=0;k=0;var i=a.ownerDocument.defaultView||a.ownerDocument.parentWindow,p=a.ownerDocument,r=p.documentElement;d=d||p;if(a.getBoundingClientRect){if(a!==p.body&&r!==a){k=a.getBoundingClientRect();h=k.left+(d===p?G.scrollLeft(i):0);k=k.top+(d===p?G.scrollTop(i):0)}if(d)if(i!=(d.defaultView||d.parentWindow)&&i.frameElement){i=j._4e_getOffset(i.frameElement,d);h+=i.left;k+=i.top}}return{left:h,top:k}},_4e_getFrameDocument:function(a){return(a=g(a))&&a.contentWindow.document},_4e_splitText:function(a,
d){a=g(a);var k=a.ownerDocument;if(!(!a||a.nodeType!=m.NODE_TEXT)){if(w.ie&&d==a.nodeValue.length){var h=k.createTextNode("");G.insertAfter(h,a);return new x(h)}h=new x(a.splitText(d));if(k.documentMode){k=k.createTextNode("");G.insertAfter(k,h[0]);G._4e_remove(k)}return h}},_4e_parents:function(a,d){a=u(a);var k=[];do k[d?"push":"unshift"](a);while(a=a.parent());return k},_4e_clone:function(a,d,k){a=g(a);a=a.cloneNode(d);if(!k){var h=function(i){if(i.nodeType==m.NODE_ELEMENT){i.removeAttribute("id");
i=i.childNodes;for(var p=0;p<i.length;p++)h(i[p])}};h(a)}return new x(a)},_4e_nextSourceNode:function(a,d,k,h){a=g(a);if(h&&!h.call){var i=h[0]||h;h=function(r){r=r[0]||r;return r!==i}}d=!d&&a.firstChild;var p=new x(a);if(!d){if(a.nodeType==m.NODE_ELEMENT&&h&&h(a,true)===false)return null;d=a.nextSibling}for(;!d&&(p=p.parent());){if(h&&h(p,true)===false)return null;d=p[0].nextSibling}if(!d)return null;d=G._4e_wrap(d);if(h&&h(d)===false)return null;if(k&&k!=d[0].nodeType)return d._4e_nextSourceNode(false,
k,h);return d},_4e_previousSourceNode:function(a,d,k,h){a=g(a);if(h&&!h.call){var i=h[0]||h;h=function(r){r=r[0]||r;return r!==i}}d=!d&&a.lastChild;var p=new x(a);if(!d){if(a.nodeType==m.NODE_ELEMENT&&h&&h(a,true)===false)return null;d=a.previousSibling}for(;!d&&(p=p.parent());){if(h&&h(p,true)===false)return null;d=p[0].previousSibling}if(!d)return null;d=G._4e_wrap(d);if(h&&h(d)===false)return null;if(k&&d[0].nodeType!=k)return d._4e_previousSourceNode(false,k,h);return d},_4e_commonAncestor:function(a,
d){if(a._4e_equals(d))return a;if(d[0].nodeType!=m.NODE_TEXT&&d.contains(a))return d;var k=a[0].nodeType==m.NODE_TEXT?a.parent():a;do if(k[0].nodeType!=m.NODE_TEXT&&k.contains(d))return k;while(k=k.parent());return null},_4e_ascendant:function(a,d,k){a=g(a);if(!k)a=a.parentNode;if(d&&!D.isFunction(d)){var h=d;d=function(i){return i._4e_name()==h}}for(;a&&a.nodeType!=9;){if(!d||d(new x(a))===true)return new x(a);a=a.parentNode}return null},_4e_hasAttribute:y.ieEngine<9?function(a,d){a=g(a);var k=a.getAttributeNode(d);
return!!(k&&k.specified)}:function(a,d){a=g(a);return a.hasAttribute(d)},_4e_hasAttributes:y.ieEngine<9?function(a){a=g(a);for(var d=a.attributes,k=0;k<d.length;k++){var h=d[k];switch(h.name){case "class":if(a.getAttribute("class"))return true;break;default:if(h.specified)return true}}return false}:function(a){a=g(a);w.gecko&&a.removeAttribute("_moz_dirty");return a.hasAttributes()},_4e_position:function(a,d){var k=g(a),h=g(d);if(k.compareDocumentPosition)return k.compareDocumentPosition(h);if(k==
h)return f.POSITION_IDENTICAL;if(k.nodeType==m.NODE_ELEMENT&&h.nodeType==m.NODE_ELEMENT){if(k.contains){if(k.contains(h))return f.POSITION_CONTAINS+f.POSITION_PRECEDING;if(h.contains(k))return f.POSITION_IS_CONTAINED+f.POSITION_FOLLOWING}if("sourceIndex"in k)return k.sourceIndex<0||h.sourceIndex<0?f.POSITION_DISCONNECTED:k.sourceIndex<h.sourceIndex?f.POSITION_PRECEDING:f.POSITION_FOLLOWING}k=a._4e_address();h=d._4e_address();for(var i=Math.min(k.length,h.length),p=0;p<=i-1;p++)if(k[p]!=h[p]){if(p<
i)return k[p]<h[p]?f.POSITION_PRECEDING:f.POSITION_FOLLOWING;break}return k.length<h.length?f.POSITION_CONTAINS+f.POSITION_PRECEDING:f.POSITION_IS_CONTAINED+f.POSITION_FOLLOWING},_4e_address:function(a,d){a=g(a);for(var k=[],h=a.ownerDocument.documentElement,i=a;i&&i!=h;){var p=i.parentNode,r=-1;if(p){for(var q=0;q<p.childNodes.length;q++){var v=p.childNodes[q];if(!(d&&v.nodeType==3&&v.previousSibling&&v.previousSibling.nodeType==3)){r++;if(v==i)break}}k.unshift(r)}i=p}return k},_4e_breakParent:function(a,
d){var k=new o.Range(a[0].ownerDocument);k.setStartAfter(a);k.setEndAfter(d);var h=k.extractContents();k.insertNode(a._4e_remove());a[0].parentNode.insertBefore(h,a[0].nextSibling)},_4e_style:function(a,d,k){if(k!==undefined){a=u(a);a.css(d,k);a.attr("style")||a.removeAttr("style")}else{a=g(a);return a.style[B(d)]}},_4e_remove:function(a,d){var k=g(a),h=k.parentNode;if(h){if(d)for(var i;i=k.firstChild;)h.insertBefore(k.removeChild(i),k);h.removeChild(k)}return a},_4e_trim:function(a){G._4e_ltrim(a);
G._4e_rtrim(a)},_4e_ltrim:function(a){a=g(a);for(var d;d=a.firstChild;){if(d.nodeType==m.NODE_TEXT){var k=y.ltrim(d.nodeValue),h=d.nodeValue.length;if(k){if(k.length<h){(new x(d))._4e_splitText(h-k.length);a.removeChild(a.firstChild)}}else{a.removeChild(d);continue}}break}},_4e_rtrim:function(a){a=g(a);for(var d;d=a.lastChild;){if(d.type==m.NODE_TEXT){var k=y.rtrim(d.nodeValue),h=d.nodeValue.length;if(k){if(k.length<h){(new x(d))._4e_splitText(k.length);a.removeChild(a.lastChild)}}else{a.removeChild(d);
continue}}break}if(!w.ie&&!w.opera)(d=a.lastChild)&&d.nodeType==1&&d.nodeName.toLowerCase()=="br"&&d.parentNode.removeChild(d)},_4e_appendBogus:function(a){a=g(a);for(var d=a.lastChild;d&&d.nodeType==m.NODE_TEXT&&!D.trim(d.nodeValue);)d=d.previousSibling;if(!d||d.nodeType==m.NODE_TEXT||G._4e_name(d)!=="br"){d=w.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br");w.gecko&&d.setAttribute("type","_moz");a.appendChild(d)}},_4e_previous:function(a,d){var k=g(a),h;do h=(k=k.previousSibling)&&
new x(k);while(h&&d&&!d(h));return h},_4e_last:function(a,d){a=G._4e_wrap(a);var k=a[0].lastChild;if((k=k&&new x(k))&&d&&!d(k))k=k._4e_previous(d);return k},_4e_next:function(a,d){var k=g(a),h;do h=(k=k.nextSibling)&&new x(k);while(h&&d&&!d(h));return h},_4e_outerHtml:function(a){a=g(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var d=a.ownerDocument.createElement("div");d.appendChild(a.cloneNode(true));return d.innerHTML},_4e_setMarker:function(a,d,k,h){a=G._4e_wrap(a);var i=a.data("list_marker_id")||
a.data("list_marker_id",D.guid()).data("list_marker_id"),p=a.data("list_marker_names")||a.data("list_marker_names",{}).data("list_marker_names");d[i]=a;p[k]=1;return a.data(k,h)},_4e_clearMarkers:function(a,d,k){a=u(a);var h=a.data("list_marker_names"),i=a.data("list_marker_id"),p;for(p in h)a.removeData(p);a.removeData("list_marker_names");if(k){a.removeData("list_marker_id");delete d[i]}},_4e_copyAttributes:function(a,d,k){a=g(a);d=u(d);var h=a.attributes;k=k||{};for(var i=0;i<h.length;i++){var p=
h[i],r=p.name.toLowerCase(),q;if(!(r in k))if(r=="checked"&&(q=G.attr(a,r)))d.attr(r,q);else if(p.specified||w.ie&&p.value&&r=="value"){q=G.attr(a,r);if(q===null)q=p.nodeValue;d.attr(r,q)}}if(a.style.cssText!=="")d[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=G._4e_name(a);var d=o.XHTML_DTD;return(a=!d.$nonEditable[a]&&(d[a]||d.span))&&a["#"]},_4e_scrollIntoView:function(a){a=u(a);a.scrollIntoView(a[0].ownerDocument,false)},_4e_getElementsByTagName:function(a,d,k){a=g(a);if(!w.ie&&
k)d=k+":"+d;k=[];a=a.getElementsByTagName(d);for(d=0;d<a.length;d++)k.push(new x(a[d]));return k}};y.extern(j,{_4e_wrap:j._4e_wrap,_4e_unwrap:j._4e_unwrap,_4e_equals:j._4e_equals,_4e_isBlockBoundary:j._4e_isBlockBoundary,_4e_getWin:j._4e_getWin,_4e_index:j._4e_index,_4e_first:j._4e_first,_4e_move:j._4e_move,_4e_name:j._4e_name,_4e_isIdentical:j._4e_isIdentical,_4e_isEmptyInlineRemoveable:j._4e_isEmptyInlineRemoveable,_4e_moveChildren:j._4e_moveChildren,_4e_mergeSiblings:j._4e_mergeSiblings,_4e_unselectable:j._4e_unselectable,
_4e_getOffset:j._4e_getOffset,_4e_getFrameDocument:j._4e_getFrameDocument,_4e_splitText:j._4e_splitText,_4e_parents:j._4e_parents,_4e_clone:j._4e_clone,_4e_nextSourceNode:j._4e_nextSourceNode,_4e_previousSourceNode:j._4e_previousSourceNode,_4e_commonAncestor:j._4e_commonAncestor,_4e_ascendant:j._4e_ascendant,_4e_hasAttribute:j._4e_hasAttribute,_4e_hasAttributes:j._4e_hasAttributes,_4e_position:j._4e_position,_4e_address:j._4e_address,_4e_breakParent:j._4e_breakParent,_4e_style:j._4e_style,_4e_remove:j._4e_remove,
_4e_trim:j._4e_trim,_4e_ltrim:j._4e_ltrim,_4e_rtrim:j._4e_rtrim,_4e_appendBogus:j._4e_appendBogus,_4e_last:j._4e_last,_4e_previous:j._4e_previous,_4e_next:j._4e_next,_4e_outerHtml:j._4e_outerHtml,_4e_setMarker:j._4e_setMarker,_4e_clearMarkers:j._4e_clearMarkers,_4e_getUniqueId:j._4e_getUniqueId,_4e_copyAttributes:j._4e_copyAttributes,_4e_isEditable:j._4e_isEditable,_4e_scrollIntoView:j._4e_scrollIntoView,_4e_getElementsByTagName:j._4e_getElementsByTagName});(function(a){D.mix(G,a);for(var d in a)a.hasOwnProperty(d)&&
function(k){x.prototype[k]=function(){var h=[].slice.call(arguments,0);h.unshift(this);return a[k].apply(null,h)}}(d)})(j)});
KISSY.Editor.add("focusmanager",function(o){function B(){var g=this;g.iframeFocus=f;m=g;z&&clearTimeout(z);z=setTimeout(function(){g.fire("focus")},100)}function D(){var g=this;g.iframeFocus=e;m=b;z&&clearTimeout(z);z=setTimeout(function(){g.fire("blur")},100)}var G=KISSY,w=G.DOM,x=G.Event,y={},z,m;G={refreshAll:function(){for(var g in y){var u=y[g];u.document.designMode="off";u.document.designMode="on"}},currentInstance:function(){return m},getInstance:function(g){return y[g]},add:function(g){var u=
w._4e_getWin(g.document);x.on(u,"focus",B,g);x.on(u,"blur",D,g)},register:function(g){y[g._UUID]=g},remove:function(g){delete y[g._UUID];var u=w._4e_getWin(g.document);x.remove(u,"focus",B,g);x.remove(u,"blur",D,g)}};var f=true,e=false,b=null;G.refreshAll=G.refreshAll;o.focusManager=G;o.focusManager=G;o.getInstances=function(){return y};o.getInstances=o.getInstances});
KISSY.Editor.add("definition",function(o){var B=true,D=false,G=o.Utils,w=document,x=KISSY,y=x.UA,z=y.ie,m=x.DOM,f=x.Node,e=x.Event,b=o.focusManager,g=G.tryThese,u=1,j="document.open();"+(G.isCustomDomain()?'document.domain="'+w.domain+'";':"")+"document.close();",a="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"' ></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+
(z?"javascript:void(function(){"+encodeURIComponent(j)+"}())":"")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>",d,k;d=o.SOURCE_MODE=0;k=o.WYSIWYG_MODE=1;o.SOURCE_MODE=d;o.WYSIWYG_MODE=k;x.augment(o,{init:function(h){var i=this;i.__commands={};i.__dialogs={};i.__plugins={};z&&m.addClass(w.body,"ke-ie"+z);if(y.trident)m.addClass(w.body,"ke-trident"+y.trident);else if(y.gecko)m.addClass(w.body,"ke-gecko");else y.webkit&&m.addClass(w.body,
"ke-webkit");var p=new f(a);i.editorWrap=p;i._UUID=u++;b.register(i);i.wrap=p.one(".ke-textarea-wrap");i.wrap=i.wrap;i.iframe=i.wrap.one("iframe");i.iframe=i.iframe;i.toolBarDiv=p.one(".ke-editor-tools");i.toolBarDiv=i.toolBarDiv;i.textarea=h;i.textarea=i.textarea;i.statusDiv=p.one(".ke-editor-status");i.statusDiv=i.statusDiv;G.preventFocus(i.toolBarDiv);var r=h._4e_style("width"),q=h._4e_style("height");if(r){p.css("width",r);h.css("width","100%")}i.textarea.css("display","none");p.insertAfter(h);
i.wrap[0].appendChild(h[0]);if(q){i.wrap.css("height",q);h.css("height","100%")}p=i.iframe;if(h._4e_hasAttribute("tabindex"))p[0].tabIndex=y.webkit?-1:h[0].tabIndex;i.on("dataReady",function(){i._ready=B;o.fire("instanceCreated",{editor:i})});y.gecko?p.on("load",i._setUpIFrame,i):i._setUpIFrame();i.cfg.attachForm&&h[0].form&&i._attachForm()},destroy:function(){if(!this.__destroyed){var h=this.editorWrap,i=this.textarea,p=this.document,r=this.iframe[0].contentWindow;this.sync();o.focusManager.remove(this);
e.remove(p);e.remove(p.documentElement);e.remove(p.body);e.remove(r);this.iframe.detach();p=this.__plugins;for(var q in p)if(p.hasOwnProperty(q)){r=p[q];r.destroy&&r.destroy()}this.fire("destroy");i.insertBefore(h);h.remove();i.css({width:h.css("width"),height:this.wrap.css("height")});i.show();this.__commands=this.__dialogs=this.__plugins=null;this.detach();this.__destroyed=true}},_attachForm:function(){var h=this,i=new f(h.textarea[0].form);i.on("submit",h.sync,h);h.on("destroy",function(){i.detach("submit",
h.sync,h)})},useDialog:function(h,i){var p=this,r=o.Overlay;r&&r.loading();p.use(h,function(){var q=p.getDialog(h);if(q){i(q);r&&r.unloading()}else x.later(arguments.callee,50,false,p)})},addDialog:function(h,i){this.__dialogs[h]=i},getDialog:function(h){return this.__dialogs[h]},destroyDialog:function(h){var i=this.__dialogs[h];i&&i.destroy();this.__dialogs[h]=null},addCommand:function(h,i){this.__commands[h]=i},hasCommand:function(h){return this.__commands[h]},execCommand:function(h){var i=this.__commands[h],
p=x.makeArray(arguments);p.shift();p.unshift(this);return i.exec.apply(i,p)},getMode:function(){return this.textarea.css("display")=="none"?k:d},getData:function(h){var i;i=this.getMode()==k?this.document&&this.document.body?this.document.body.innerHTML:"":this.textarea.val();if(this.htmlDataProcessor)i=h?this.htmlDataProcessor.toHtml(i,"p"):this.htmlDataProcessor.toServer(i,"p");i=x.trim(i);if(/^<p>((&nbsp;)|\s)*<\/p>$/.test(i))i="";return i},setData:function(h){var i=h;if(this.htmlDataProcessor)i=
this.htmlDataProcessor.toDataFormat(h,"p");this.document.body.innerHTML=i;if(!i)this.document.body.innerHTML=i;this.getMode()!=k&&this.textarea.val(h)},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(h){this.document.body.innerHTML=h},_prepareIFrameHtml:function(h){var i=this.cfg,p=i.customStyle;i=i.customLink;var r="",q=o.Utils.debugUrl("../theme/editor-iframe.css");if(i)for(var v=0;v<i.length;v++)r+='<link href="'+
i[v]+'" rel="stylesheet"/>';return"<!doctype html><html><head><title>${title}</title><link href='"+q+"' rel='stylesheet'/><style>"+(p||"")+"</style>"+r+"</head><body class='ke-editor'>&nbsp;"+(h?'<script id="ke_actscript" type="text/javascript">'+(G.isCustomDomain()?'document.domain="'+w.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+h+'");<\/script>':"")+"</body></html>"},getSelection:function(){return o.Selection.getSelection(this.document)},focus:function(){var h=this.document,i=m._4e_getWin(h);
y.webkit&&i&&i.parent&&i.parent.focus();y.webkit&&i&&i.focus();h&&h.body.focus();this.notifySelectionChange()},blur:function(){m._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},addCustomStyle:function(h){var i=this.cfg,p=this.document;i.customStyle=i.customStyle||"";i.customStyle+="\n"+h;i=p.createElement("style");p.getElementsByTagName("head")[0].appendChild(i);if(i.styleSheet)i.styleSheet.cssText=h;else i.appendChild(p.createTextNode(h))},addCustomLink:function(h){var i=
this.cfg,p=this.document;i.customLink=i.customLink||[];i.customLink.push(h);i=p.createElement("link");i.rel="stylesheet";p.getElementsByTagName("head")[0].appendChild(i);i.href=h},removeCustomLink:function(h){for(var i=this.cfg,p=x.makeArray(this.document.getElementsByTagName("link")),r=0;r<p.length;r++)p[r].href==h&&m._4e_remove(p[r]);i.customLink=i.customLink||[];i=i.customLink;h=x.indexOf(h,i);h!=-1&&i.splice(h,1)},_setUpIFrame:function(){function h(){v=q.document;i.document=v;p.detach();v.open("text/html",
"replace");v.write(r);v.close()}var i=this,p=i.iframe,r=i._prepareIFrameHtml(i._UUID),q=p[0].contentWindow,v;try{v=q.document}catch(I){p[0].src=p[0].src;if(z<7){setTimeout(h,10);return}}h()},ready:function(h){this._ready?h():this.on("dataReady",h)},addPlugin:function(h,i,p){this.__plugins=this.__plugins;p=p||{};p.func=i;this.__plugins[h]=p},usePlugin:function(h){var i=this.__plugins[h];if(i)if(!(i.status&&!i.duplicate)){h=this.Env.mods[h].requires||[];for(var p=0;p<h.length;p++)this.usePlugin(h[p]);
i.func.call(i);i.status=1}},_monitor:function(){var h=this;h._monitorId&&clearTimeout(h._monitorId);h._monitorId=setTimeout(function(){var i=h.getSelection();if(i&&!i.isInvalid){var p=i.getStartElement(),r=new o.ElementPath(p);if(!h.previousPath||!h.previousPath.compare(r)){h.previousPath=r;h.fire("selectionChange",{selection:i,path:r,element:p})}}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(h,i,p){var r=this;if(r.getMode()===k){r.focus();
var q,v=h._4e_name(),I=o.XHTML_DTD,A=o.RANGE,c=o.NODE,l=I.$block[v],t=r.getSelection(),s=t&&t.getRanges(),n,C,P,O;if(!s||s.length==0){var Q=arguments,N=Q.callee;setTimeout(function(){N.apply(r,Q)},30)}else{r.fire("save");for(var T=s.length-1;T>=0;T--){n=s[T];n.deleteContents();q=!T&&h||h._4e_clone(B);i&&i(q);if(l)for(;(P=n.getCommonAncestor(D,B))&&(O=I[P._4e_name()])&&!(O&&O[v]);)if(P._4e_name()in I.span)n.splitElement(P);else if(n.checkStartOfBlock()&&n.checkEndOfBlock()){n.setStartBefore(P);n.collapse(B);
P._4e_remove()}else n.splitBlock();n.insertNode(q);C||(C=q)}if(C){v=C._4e_nextSourceNode(B);I=r.document;O=o.XHTML_DTD;if(O.$inline[q._4e_name()]){v=new f(I.createTextNode(" "));v.insertAfter(C)}else if(v){if(v._4e_name()=="br"&&O[v.parent()._4e_name()].p){O=new f("<p>&nbsp;</p>",null,I);v[0].parentNode.replaceChild(O[0],v[0]);v=O}}else{O=new f("<p>&nbsp;</p>",null,I);O.insertAfter(C);v=O}n.moveToPosition(C,A.POSITION_AFTER_END);v&&v[0].nodeType==c.NODE_ELEMENT&&n.moveToElementEditablePosition(v);
t.selectRanges([n]);r.focus();q&&q._4e_scrollIntoView();r._saveLater();p&&p(q)}}}},insertHtml:function(h,i){if(this.getMode()===k){if(this.htmlDataProcessor)h=this.htmlDataProcessor.toDataFormat(h,null,i);this.focus();this.fire("save");var p=this.document,r=0;if(z){var q=p.selection;q.type=="Control"&&q.clear();try{q.createRange().pasteHTML(h)}catch(v){x.log("insertHtml error in ie")}}else try{p.execCommand("inserthtml",D,h)}catch(I){setTimeout(function(){p.execCommand("inserthtml",D,h)},100);r=100}this.getSelection().scrollIntoView();
this._saveLater(r)}},_saveLater:function(h){var i=this;if(i.__saveTimer){clearTimeout(i.__saveTimer);i.__saveTimer=null}i.__saveTimer=setTimeout(function(){i.fire("save")},h||0)}});o._initIFrame=function(h){function i(s){g(function(){q.designMode="on";setTimeout(function(){q.designMode="off";A.focus();if(!arguments.callee.retry)arguments.callee.retry=B},50)},function(){q.designMode="off";m.attr(A,"contentEditable",D);m.attr(A,"contentEditable",B);!s&&i(1)})}var p=b.getInstance(h);h=p.textarea[0];
var r=p.iframe[0].contentWindow,q=p.document,v=p.cfg,I=q.getElementById("ke_actscript");m._4e_remove(I);var A=q.body;if(z){A.hideFocus=B;A.disabled=B;A.contentEditable=B;A.removeAttribute("disabled")}else setTimeout(function(){if(y.gecko||y.opera)A.contentEditable=B;else if(y.webkit)A.parentNode.contentEditable=B;else q.designMode="on"},0);if(y.webkit){e.on(q,"click",function(s){var n=new f(s.target);x.inArray(n._4e_name(),["input","select"])&&s.preventDefault()});e.on(q,"mouseup",function(s){var n=
new f(s.target);x.inArray(n._4e_name(),["input","textarea"])&&s.preventDefault()})}if(y.gecko||z||y.opera){var c;c=(new f('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(h);c.on("focus",function(){p.focus()});p.activateGecko=function(){y.gecko&&p.iframeFocus&&c[0].focus()};p.on("destroy",function(){c.detach();c.remove()})}if(q.documentMode||y.gecko||y.opera){var l=q.documentElement;e.on(l,"mousedown",function(s){if((new f(s.target))[0]==l){y.gecko&&
i(D);c[0].focus()}})}e.on(r,"focus",function(){if(y.gecko)i(D);else y.opera&&A.focus();p.notifySelectionChange()});y.gecko&&e.on(p.document,"mousedown",function(){p.iframeFocus||i(D)});if(z){e.on(q,"keydown",function(s){if(s.keyCode in{8:1,46:1}){var n=p.getSelection(),C=n.getSelectedElement();if(C){p.fire("save");var P=n.getRanges()[0].createBookmark();C._4e_remove();n.selectBookmarks([P]);p.fire("save");s.preventDefault()}}});if(q.compatMode=="CSS1Compat"){var t={33:1,34:1};e.on(q,"keydown",function(s){s.keyCode in
t&&setTimeout(function(){p.getSelection().scrollIntoView()},0)})}}setTimeout(function(){z&&setTimeout(function(){if(q){A.runtimeStyle.marginBottom="0px";A.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){p.fire("dataReady");var s=v.disableObjectResizing,n=v.disableInlineTableEditing;if(s||n)try{q.execCommand("enableObjectResizing",D,!s);q.execCommand("enableInlineTableEditing",D,!n)}catch(C){e.on(A,z?"resizestart":"resize",function(P){var O=new f(P.target);if(s||O._4e_name()==="table"&&
n)P.preventDefault()})}},10);y.webkit&&e.on(q,"mousedown",function(s){s=new f(s.target);x.inArray(s._4e_name(),["img","hr","input","textarea","select"])&&p.getSelection().selectElement(s)});y.gecko&&e.on(q,"dragstart",function(s){var n=new f(s.target);n._4e_name()==="img"&&/ke_/.test(n[0].className)&&s.preventDefault()});b.add(p)};document.documentMode>7&&function(){for(var h=x.all("link"),i=0;i<h.length;i++){var p=new f(h[i]),r=p.attr("href");r.indexOf("editor-pkg-min-mhtml.css")!=-1&&p.attr("href",
r.replace(/editor-pkg-min-mhtml\.css/g,"editor-pkg-min-datauri.css"))}}();j=o.prototype;G.extern(j,{removeCustomLink:j.removeCustomLink,addCustomLink:j.addCustomLink,setData:j.setData,getData:j.getData,insertElement:j.insertElement,insertHtml:j.insertHtml,ready:j.ready,addCustomStyle:j.addCustomStyle,addCommand:j.addCommand,hasCommand:j.hasCommand,execCommand:j.execCommand,useDialog:j.useDialog,addDialog:j.addDialog,getDialog:j.getDialog,getMode:j.getMode,sync:j.sync,getSelection:j.getSelection,focus:j.focus,
blur:j.blur,notifySelectionChange:j.notifySelectionChange})});KISSY.Editor.add("zindex",function(){var o=KISSY.Editor;if(!o.zIndexManager){o.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,DD_PG:99999,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};o.baseZIndex=function(B){return(o.Config.baseZIndex||1E4)+B};o.baseZIndex=o.baseZIndex;o.zIndexManager=o.zIndexManager}});
KISSY.Editor.add("dtd",function(o){o.XHTML_DTD=function(){function B(){for(var r=arguments[0],q=arguments.length-1;q>0;)KISSY.mix(r,arguments[q--]);return r}var D={isindex:1,fieldset:1},G={input:1,button:1,select:1,textarea:1,label:1},w=B({a:1},G),x=B({iframe:1},w),y={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},z={ins:1,del:1,script:1,style:1},m=B({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,
cite:1,kbd:1,u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},z),f=B({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},m),e=B({p:1},f);G=B({iframe:1},f,G);f={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,
dir:1,map:1,dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var b=B({a:1},G),g={tr:1},u={"#":1},j=B({param:1},f),a=B({form:1},D,x,y,e),d={li:1},k={base:1,link:1,meta:1,title:1},h=B(k,{style:1,script:1}),i={head:1,body:1},p={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:B({html:1},i,
k),$block:p,$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:b,$body:B({script:1,style:1},p),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,
span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:i,head:h,style:u,body:a,base:{},link:{},meta:{},title:u,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:a,td:a,br:{},th:a,center:a,kbd:b,button:B(e,y),basefont:{},h5:b,h4:b,samp:b,h6:b,ol:d,h1:b,h3:b,option:u,h2:b,form:B(D,x,y,e),select:{optgroup:1,option:1},font:b,ins:b,menu:d,abbr:b,
label:b,table:{thead:1,col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:b,script:u,tfoot:g,cite:b,li:a,input:{},iframe:a,strong:b,textarea:u,noframes:a,big:b,small:b,span:b,hr:{},dt:b,sub:b,optgroup:{option:1},param:{},bdo:b,"var":b,div:a,object:j,sup:b,dd:a,strike:b,area:{},dir:d,map:B({area:1,form:1,p:1},D,z,y),applet:j,dl:{dt:1,dd:1},del:b,isindex:{},fieldset:B({legend:1},f),thead:g,ul:d,acronym:b,b:b,a:G,blockquote:a,caption:b,i:b,u:b,tbody:g,s:b,address:B(x,e),tt:b,legend:b,q:b,pre:B(m,
w),p:b,em:b,dfn:b}}();o.XHTML_DTD=o.XHTML_DTD});
KISSY.Editor.add("elementpath",function(o){function B(f){var e=x,b=x,g=[];for(f=f;f&&f[0];){if(f[0].nodeType==w.NODE_ELEMENT){if(!this.lastElement)this.lastElement=f;var u=f._4e_name();if(!b){if(!e&&y[u])e=f;if(z[u]){var j;if(j=!e){if(j=u=="div"){a:{j=f;j=j[0]||j;j=j.childNodes;for(var a=0,d=j.length;a<d;a++){var k=j[a];if(k.nodeType==w.NODE_ELEMENT&&G.$block[k.nodeName.toLowerCase()]){j=true;break a}}j=false}j=!j}j=j}if(j)e=f;else b=f}}g.push(f);if(u=="body")break}f=f.parent()}this.block=this.block=
e;this.blockLimit=this.blockLimit=b;this.elements=this.elements=g}var D=KISSY.DOM,G=o.XHTML_DTD,w=o.NODE,x=null,y={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},z={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};B.prototype={compare:function(f){var e=this.elements;f=f&&f.elements;if(!f||e.length!=f.length)return false;for(var b=0;b<e.length;b++)if(!D._4e_equals(e[b],f[b]))return false;return true},contains:function(f){for(var e=this.elements,b=0;b<
e.length;b++)if(e[b]._4e_name()in f)return e[b];return x}};o.ElementPath=o.ElementPath=B;var m=B.prototype;o.Utils.extern(m,{compare:m.compare,contains:m.contains})});
KISSY.Editor.add("walker",function(o){function B(g,u){if(this._.end)return y;var j,a=this.range,d,k=this.guard,h=this.type,i=g?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;a.trim();if(a.collapsed){this.end();return y}}if(!g&&!this._.guardLTR){var p=a.endContainer,r=new e(p[0].childNodes[a.endOffset]);this._.guardLTR=function(A,c){return(A=f._4e_wrap(A))&&A[0]&&(!c||!f._4e_equals(p,A))&&(!r[0]||!A._4e_equals(r))&&(A[0].nodeType!=m.NODE_ELEMENT||!c||A._4e_name()!="body")}}if(g&&
!this._.guardRTL){var q=a.startContainer,v=a.startOffset>0&&new e(q[0].childNodes[a.startOffset-1]);this._.guardRTL=function(A,c){return(A=f._4e_wrap(A))&&A[0]&&(!c||!A._4e_equals(q))&&(!v[0]||!A._4e_equals(v))&&(A[0].nodeType!=m.NODE_ELEMENT||!c||A._4e_name()!="body")}}var I=g?this._.guardRTL:this._.guardLTR;d=k?function(A,c){if(I(A,c)===x)return x;return k(A,c)}:I;if(this.current)j=this.current[i](x,h,d);else if(g){j=a.endContainer;if(a.endOffset>0){j=new e(j[0].childNodes[a.endOffset-1]);if(d(j)===
x)j=y}else j=d(j,w)===x?y:j._4e_previousSourceNode(w,h,d)}else{j=a.startContainer;if((j=new e(j[0].childNodes[a.startOffset]))&&j[0]){if(d(j)===x)j=y}else j=d(a.startContainer,w)===x?y:a.startContainer._4e_nextSourceNode(w,h,d)}for(;j&&j[0]&&!this._.end;){this.current=j;if(!this.evaluator||this.evaluator(j)!==x){if(!u)return j}else if(u&&this.evaluator)return x;j=j[i](x,h,d)}this.end();return this.current=y}function D(g){for(var u,j=y;u=B.call(this,g);)j=u;return j}function G(g){this.range=g;this._=
{}}var w=true,x=false,y=null,z=KISSY,m=o.NODE,f=z.DOM,e=z.Node;z.augment(G,{end:function(){this._.end=1},next:function(){return B.call(this)},previous:function(){return B.call(this,w)},checkForward:function(){return B.call(this,x,w)!==x},checkBackward:function(){return B.call(this,w,w)!==x},lastForward:function(){return D.call(this)},lastBackward:function(){return D.call(this,w)},reset:function(){delete this.current;this._={}}});G.blockBoundary=function(g){return function(u){u=f._4e_wrap(u);return!(u&&
u[0].nodeType==m.NODE_ELEMENT&&u._4e_isBlockBoundary(g))}};G.listItemBoundary=function(){return this.blockBoundary({br:1})};G.bookmark=function(g,u){function j(a){return a&&a[0]&&a._4e_name()=="span"&&a.attr("_ke_bookmark")}return function(a){var d,k;d=a&&a[0]&&a[0].nodeType==m.NODE_TEXT&&(k=a.parent())&&j(k);d=g?d:d||j(a);return u^d}};G.whitespaces=function(g){return function(u){u=(u=u[0]||u)&&u.nodeType==m.NODE_TEXT&&!z.trim(u.nodeValue);return g^u}};G.invisible=function(g){var u=G.whitespaces();
return function(j){j=u(j)||j[0].nodeType==m.NODE_ELEMENT&&!j[0].offsetHeight;return g^j}};o.Walker=G;o.Walker=G;var b=G.prototype;o.Utils.extern(b,{end:b.end,next:b.next,previous:b.previous,checkForward:b.checkForward,checkBackward:b.checkBackward,lastForward:b.lastForward,lastBackward:b.lastBackward,reset:b.reset});o.Utils.extern(G,{blockBoundary:G.blockBoundary,listItemBoundary:G.listItemBoundary,bookmark:G.bookmark,whitespaces:G.whitespaces,invisible:G.invisible})});
KISSY.Editor.add("range",function(o){function B(c){this.endOffset=this.endContainer=this.startOffset=this.startContainer=f;this.collapsed=z;this.document=c}function D(c){var l=c[0].nodeType!=b.NODE_TEXT&&c._4e_name()in h.$removeEmpty,t=!e.trim(c[0].nodeValue);c=!!c.parent().attr("_ke_bookmark");return l||t||c}function G(c){return!v(c)&&!I(c)}function w(c){var l=m,t=j.bookmark(z);return function(s){if(t(s))return z;if(s[0].nodeType==b.NODE_TEXT){if(e.trim(s[0].nodeValue).length)return m}else if(s[0].nodeType==
b.NODE_ELEMENT)if(!q[s._4e_name()])if(!c&&!k.ie&&s._4e_name()=="br"&&!l)l=z;else return m;return z}}function x(c,l){function t(s){return s&&s.nodeName=="span"&&s.getAttribute("_ke_bookmark")}return function(s){var n,C;n=s&&!s.nodeName&&(C=s.parentNode)&&t(C);n=c?n:n||t(s);return l^n}}function y(c){return function(l){l=(l=l[0]||l)&&l.nodeType==b.NODE_TEXT&&!e.trim(l.nodeValue);return c^l}}o.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};o.RANGE=o.RANGE;var z=true,m=false,f=null,e=KISSY,b=o.NODE,g=o.RANGE,u=o.POSITION,j=o.Walker,a=e.DOM,d=o.Utils.getByAddress,k=e.UA,h=o.XHTML_DTD,i=o.ElementPath,p=e.Node,r={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};B.prototype.toString=function(){var c=[];c.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);c.push((this.endContainer[0].id||
this.endContainer[0].nodeName)+":"+this.endOffset);return c.join("<br/>")};e.augment(B,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&a._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var c=this.startContainer,l=this.startOffset;if(c[0].nodeType!=b.NODE_ELEMENT)if(l)l>=c[0].nodeValue.length&&this.setStartAfter(c);else this.setStartBefore(c);c=this.endContainer;l=this.endOffset;if(c[0].nodeType!=b.NODE_ELEMENT)if(l)l>=
c[0].nodeValue.length&&this.setEndAfter(c);else this.setEndBefore(c)},setStartAfter:function(c){this.setStart(c.parent(),c._4e_index()+1)},setStartBefore:function(c){this.setStart(c.parent(),c._4e_index())},setEndAfter:function(c){this.setEnd(c.parent(),c._4e_index()+1)},setEndBefore:function(c){this.setEnd(c.parent(),c._4e_index())},optimizeBookmark:function(){var c=this.startContainer,l=this.endContainer;c&&c._4e_name()=="span"&&c.attr("_ke_bookmark")&&this.setStartAt(c,g.POSITION_BEFORE_START);
l&&l._4e_name()=="span"&&l.attr("_ke_bookmark")&&this.setEndAt(l,g.POSITION_AFTER_END)},setStart:function(c,l){if(c[0].nodeType==b.NODE_ELEMENT&&r[c._4e_name()]){c=c.parent();l=c._4e_index()}this.startContainer=c;this.startOffset=l;if(!this.endContainer){this.endContainer=c;this.endOffset=l}this.updateCollapsed()},setEnd:function(c,l){if(c[0].nodeType==b.NODE_ELEMENT&&r[c._4e_name()]){c=c.parent();l=c._4e_index()+1}this.endContainer=c;this.endOffset=l;if(!this.startContainer){this.startContainer=
c;this.startOffset=l}this.updateCollapsed()},setStartAt:function(c,l){switch(l){case g.POSITION_AFTER_START:this.setStart(c,0);break;case g.POSITION_BEFORE_END:c[0].nodeType==b.NODE_TEXT?this.setStart(c,c[0].nodeValue.length):this.setStart(c,c[0].childNodes.length);break;case g.POSITION_BEFORE_START:this.setStartBefore(c);break;case g.POSITION_AFTER_END:this.setStartAfter(c)}this.updateCollapsed()},setEndAt:function(c,l){switch(l){case g.POSITION_AFTER_START:this.setEnd(c,0);break;case g.POSITION_BEFORE_END:c[0].nodeType==
b.NODE_TEXT?this.setEnd(c,c[0].nodeValue.length):this.setEnd(c,c[0].childNodes.length);break;case g.POSITION_BEFORE_START:this.setEndBefore(c);break;case g.POSITION_AFTER_END:this.setEndAfter(c)}this.updateCollapsed()},execContentsAction:function(c,l){var t=this.startContainer,s=this.endContainer,n=this.startOffset,C=this.endOffset,P,O=this.document,Q;this.optimizeBookmark();if(s[0].nodeType==b.NODE_TEXT)s=s._4e_splitText(C);else if(s[0].childNodes.length>0)if(C>=s[0].childNodes.length){s=new p(s[0].appendChild(O.createTextNode("")));
Q=z}else s=new p(s[0].childNodes[C]);if(t[0].nodeType==b.NODE_TEXT){t._4e_splitText(n);if(t._4e_equals(s))s=new p(t[0].nextSibling)}else if(n)if(n>=t[0].childNodes.length){P=new p(O.createTextNode(""));t.append(P);t=P;P=z}else t=new p(t[0].childNodes[n].previousSibling);else{P=new p(O.createTextNode(""));t.prepend(P);t=P;P=z}n=t._4e_parents();C=s._4e_parents();var N,T,R;for(N=0;N<n.length;N++){T=n[N];R=C[N];if(!T._4e_equals(R))break}O=l;for(var V,X,Z,F=N;F<n.length;F++){V=n[F];X=O&&!V._4e_equals(t)?
O.appendChild(V._4e_clone()[0]):null;for(V=V[0].nextSibling;V;){if(a._4e_equals(C[F],V)||a._4e_equals(s,V))break;Z=V.nextSibling;if(c==2)O.appendChild(V.cloneNode(z));else{a._4e_remove(V);c==1&&O.appendChild(V)}V=Z}if(X)O=X}O=l;for(N=N;N<C.length;N++){V=C[N];X=O&&c>0&&!V._4e_equals(s)?O.appendChild(V._4e_clone()[0]):null;if(!n[N]||!V.parent()._4e_equals(n[N].parent()))for(V=V[0].previousSibling;V;){if(a._4e_equals(n[N],V)||a._4e_equals(t,V))break;Z=V.previousSibling;if(c==2)O.insertBefore(V.cloneNode(z),
O.firstChild);else{a._4e_remove(V);c==1&&O.insertBefore(V,O.firstChild)}V=Z}if(X)O=X}if(c==2){R=this.startContainer[0];if(R.nodeType==b.NODE_TEXT&&R.nextSibling&&R.nextSibling.nodeType==b.NODE_TEXT){R.data+=R.nextSibling.data;R.parentNode.removeChild(R.nextSibling)}R=this.endContainer[0];if(R.nodeType==b.NODE_TEXT&&R.nextSibling&&R.nextSibling.nodeType==b.NODE_TEXT){R.data+=R.nextSibling.data;R.parentNode.removeChild(R.nextSibling)}}else{if(T&&R&&(!t.parent()._4e_equals(T.parent())||!s.parent()._4e_equals(R.parent()))){T=
R._4e_index();P&&R.parent()._4e_equals(t.parent())&&T--;this.setStart(R.parent(),T)}this.collapse(z)}P&&t._4e_remove();Q&&s[0].parentNode&&s._4e_remove()},collapse:function(c){if(c){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=z},clone:function(){var c=new B(this.document);c.startContainer=this.startContainer;c.startOffset=this.startOffset;c.endContainer=this.endContainer;c.endOffset=
this.endOffset;c.collapsed=this.collapsed;return c},getEnclosedNode:function(){var c=this.clone();c.optimize();if(c.startContainer[0].nodeType!=b.NODE_ELEMENT||c.endContainer[0].nodeType!=b.NODE_ELEMENT)return f;var l=new o.Walker(c),t=x(z,undefined),s=y(z);c.evaluator=function(n){return s(n)&&t(n)};c=l.next();l.reset();l=l.previous();return c&&c._4e_equals(l)?c:f},shrink:function(c,l){if(!this.collapsed){c=c||g.SHRINK_TEXT;var t=this.clone(),s=this.startContainer,n=this.endContainer,C=this.startOffset,
P=this.endOffset,O=1,Q=1;if(s&&s[0].nodeType==b.NODE_TEXT)if(C)if(C>=s[0].nodeValue.length)t.setStartAfter(s);else{t.setStartBefore(s);O=0}else t.setStartBefore(s);if(n&&n[0].nodeType==b.NODE_TEXT)if(P)if(P>=n[0].nodeValue.length)t.setEndAfter(n);else{t.setEndAfter(n);Q=0}else t.setEndBefore(n);t=new j(t);t.evaluator=function(T){T=T[0]||T;return T.nodeType==(c==g.SHRINK_ELEMENT?b.NODE_ELEMENT:b.NODE_TEXT)};var N;t.guard=function(T,R){T=T[0]||T;if(c==g.SHRINK_ELEMENT&&T.nodeType==b.NODE_TEXT)return m;
if(R&&T==N)return m;if(!R&&T.nodeType==b.NODE_ELEMENT)N=T;return z};if(O)(s=t[c==g.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(s,l?g.POSITION_AFTER_START:g.POSITION_BEFORE_START);if(Q){t.reset();(t=t[c==g.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(t,l?g.POSITION_BEFORE_END:g.POSITION_AFTER_END)}return!!(O||Q)}},getTouchedStartNode:function(){var c=this.startContainer;if(this.collapsed||c[0].nodeType!=b.NODE_ELEMENT)return c;return c.childNodes[this.startOffset]||c},createBookmark2:function(c){var l=
this.startContainer,t=this.endContainer,s=this.startOffset,n=this.endOffset,C,P;if(!l||!t)return{start:0,end:0};if(c){if(l[0].nodeType==b.NODE_ELEMENT)if((C=new p(l[0].childNodes[s]))&&C[0]&&C[0].nodeType==b.NODE_TEXT&&s>0&&C[0].previousSibling.nodeType==b.NODE_TEXT){l=C;s=0}for(;l[0].nodeType==b.NODE_TEXT&&(P=l._4e_previous())&&P[0].nodeType==b.NODE_TEXT;){l=P;s+=P[0].nodeValue.length}if(!this.collapsed){if(t[0].nodeType==b.NODE_ELEMENT)if((C=new p(t[0].childNodes[n]))&&C[0]&&C[0].nodeType==b.NODE_TEXT&&
n>0&&C[0].previousSibling.nodeType==b.NODE_TEXT){t=C;n=0}for(;t[0].nodeType==b.NODE_TEXT&&(P=t._4e_previous())&&P[0].nodeType==b.NODE_TEXT;){t=P;n+=P[0].nodeValue.length}}}return{start:l._4e_address(c),end:this.collapsed?f:t._4e_address(c),startOffset:s,endOffset:n,normalized:c,is2:z}},createBookmark:function(c){var l,t,s,n,C=this.collapsed;l=new p("<span>",f,this.document);l.attr("_ke_bookmark",1);l.css("display","none");l.html("&nbsp;");if(c){s=e.guid("ke_bm_");l.attr("id",s+"S")}if(!C){t=l._4e_clone();
t.html("&nbsp;");c&&t.attr("id",s+"E");n=this.clone();n.collapse();n.insertNode(t)}n=this.clone();n.collapse(z);n.insertNode(l);if(t){this.setStartAfter(l);this.setEndBefore(t)}else this.moveToPosition(l,g.POSITION_AFTER_END);return{startNode:c?s+"S":l,endNode:c?s+"E":t,serializable:c,collapsed:C}},moveToPosition:function(c,l){this.setStartAt(c,l);this.collapse(z)},trim:function(c,l){var t=this.startContainer,s=this.startOffset,n=this.collapsed;if((!c||n)&&t[0]&&t[0].nodeType==b.NODE_TEXT){if(s)if(s>=
t[0].nodeValue.length){s=t._4e_index()+1;t=t.parent()}else{var C=t._4e_splitText(s);s=t._4e_index()+1;t=t.parent();if(a._4e_equals(this.startContainer,this.endContainer))this.setEnd(C,this.endOffset-this.startOffset);else if(a._4e_equals(t,this.endContainer))this.endOffset+=1}else{s=t._4e_index();t=t.parent()}this.setStart(t,s);if(n){this.collapse(z);return}}t=this.endContainer;s=this.endOffset;if(!(l||n)&&t[0]&&t[0].nodeType==b.NODE_TEXT){if(s){s>=t.nodeValue.length||t._4e_splitText(s);s=t._4e_index()+
1}else s=t._4e_index();t=t.parent();this.setEnd(t,s)}},insertNode:function(c){this.optimizeBookmark();this.trim(m,z);var l=this.startContainer;l[0].insertBefore(c[0]||c,l[0].childNodes[this.startOffset]||null);a._4e_equals(c.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(c)},moveToBookmark:function(c){if(c.is2){var l=d(this.document,c.start,c.normalized),t=c.startOffset,s=c.end&&d(this.document,c.end,c.normalized);c=c.endOffset;this.setStart(l,t);s?this.setEnd(s,c):this.collapse(z)}else{l=
(t=c.serializable)?e.one("#"+c.startNode,this.document):c.startNode;c=t?e.one("#"+c.endNode,this.document):c.endNode;this.setStartBefore(l);l._4e_remove();if(c&&c[0]){this.setEndBefore(c);c._4e_remove()}else this.collapse(z)}},getCommonAncestor:function(c,l){var t=this.startContainer,s=this.endContainer;t=a._4e_equals(t,s)?c&&t[0].nodeType==b.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new p(t[0].childNodes[this.startOffset]):t:t._4e_commonAncestor(s);return l&&t[0].nodeType==b.NODE_TEXT?t.parent():
t},enlarge:function(c){switch(c){case g.ENLARGE_ELEMENT:if(this.collapsed)break;c=this.getCommonAncestor();var l=new p(this.document.body),t,s,n,C,P,O=m,Q,N;Q=this.startContainer;N=this.startOffset;if(Q[0].nodeType==b.NODE_TEXT){if(N){Q=!e.trim(Q[0].nodeValue.substring(0,N)).length&&Q;O=!!Q}if(Q)if(!(C=Q[0].previousSibling))n=Q.parent()}else{if(N)C=Q[0].childNodes[N-1]||Q[0].lastChild;C||(n=Q)}for(;n||C;){if(n&&!C){if(!P&&a._4e_equals(n,c))P=z;if(!l.contains(n))break;if(!O||n.css("display")!="inline"){O=
m;if(P)t=n;else this.setStartBefore(n)}C=n[0].previousSibling}for(;C;){Q=m;if(C.nodeType==b.NODE_TEXT){N=C.nodeValue;if(/[^\s\ufeff]/.test(N))C=f;Q=/[\s\ufeff]$/.test(N)}else if(C.offsetWidth>0&&!C.getAttribute("_ke_bookmark"))if(O&&h.$removeEmpty[C.nodeName.toLowerCase()]){N=a.text(C);if(/[^\s\ufeff]/.test(N))C=f;else for(var T=C.all||C.getElementsByTagName("*"),R=0,V;V=T[R++];)if(!h.$removeEmpty[V.nodeName.toLowerCase()]){C=f;break}if(C)Q=!!N.length}else C=f;if(Q)if(O)if(P)t=n;else n&&this.setStartBefore(n);
else O=z;if(C){Q=C.previousSibling;if(!n&&!Q){n=new p(C);C=f;break}C=Q}else n=f}if(n)n=n.parent()}Q=this.endContainer;N=this.endOffset;n=C=f;P=O=m;if(Q[0].nodeType==b.NODE_TEXT){Q=!e.trim(Q[0].nodeValue.substring(N)).length&&Q;O=!(Q&&Q[0].nodeValue.length);if(Q)if(!(C=Q[0].nextSibling))n=Q.parent()}else(C=Q[0].childNodes[N])||(n=Q);for(;n||C;){if(n&&!C){if(!P&&a._4e_equals(n,c))P=z;if(!l.contains(n))break;if(!O||n.css("display")!="inline"){O=m;if(P)s=n;else n&&this.setEndAfter(n)}C=n[0].nextSibling}for(;C;){Q=
m;if(C.nodeType==b.NODE_TEXT){N=C.nodeValue;if(/[^\s\ufeff]/.test(N))C=f;Q=/^[\s\ufeff]/.test(N)}else if(C.offsetWidth>0&&!C.getAttribute("_ke_bookmark"))if(O&&h.$removeEmpty[C.nodeName.toLowerCase()]){N=a.text(C);if(/[^\s\ufeff]/.test(N))C=f;else{T=C.all||C.getElementsByTagName("*");for(R=0;V=T[R++];)if(!h.$removeEmpty[V.nodeName.toLowerCase()]){C=f;break}}if(C)Q=!!N.length}else C=f;if(Q)if(O)if(P)s=n;else this.setEndAfter(n);if(C){Q=C.nextSibling;if(!n&&!Q){n=new p(C);C=f;break}C=Q}else n=f}if(n)n=
n.parent()}if(t&&s){c=t.contains(s)?s:t;this.setStartBefore(c);this.setEndAfter(c)}break;case g.ENLARGE_BLOCK_CONTENTS:case g.ENLARGE_LIST_ITEM_CONTENTS:n=new B(this.document);l=new p(this.document.body);n.setStartAt(l,g.POSITION_AFTER_START);n.setEnd(this.startContainer,this.startOffset);n=new j(n);var X,Z,F=j.blockBoundary(c==g.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:f),K=function(E){var J=F(E);J||(X=E);return J};t=function(E){var J=K(E);if(!J&&E[0]&&E._4e_name()=="br")Z=E;return J};n.guard=K;n=n.lastBackward();
X=X||l;this.setStartAt(X,X._4e_name()!="br"&&(!n&&this.checkStartOfBlock()||n&&X.contains(n))?g.POSITION_AFTER_START:g.POSITION_AFTER_END);n=this.clone();n.collapse();n.setEndAt(l,g.POSITION_BEFORE_END);n=new j(n);n.guard=c==g.ENLARGE_LIST_ITEM_CONTENTS?t:K;X=f;n=n.lastForward();X=X||l;this.setEndAt(X,!n&&this.checkEndOfBlock()||n&&X.contains(n)?g.POSITION_BEFORE_END:g.POSITION_BEFORE_START);Z&&this.setEndAfter(Z)}},checkStartOfBlock:function(){var c=this.startContainer,l=this.startOffset;if(l&&c[0].nodeType==
b.NODE_TEXT)if(e.trim(c[0].nodeValue.substring(0,l)).length)return m;this.trim();c=new i(this.startContainer);l=this.clone();l.collapse(z);l.setStartAt(c.block||c.blockLimit,g.POSITION_AFTER_START);c=new j(l);c.evaluator=w(z);return c.checkBackward()},checkEndOfBlock:function(){var c=this.endContainer,l=this.endOffset;if(c[0].nodeType==b.NODE_TEXT)if(e.trim(c[0].nodeValue.substring(l)).length)return m;this.trim();c=new i(this.endContainer);l=this.clone();l.collapse(m);l.setEndAt(c.block||c.blockLimit,
g.POSITION_BEFORE_END);c=new j(l);c.evaluator=w(m);return c.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var c=this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,c);return c},checkBoundaryOfElement:function(c,l){var t=this.clone();t[l==g.START?"setStartAt":"setEndAt"](c,l==g.START?g.POSITION_AFTER_START:g.POSITION_BEFORE_END);t=new j(t);t.evaluator=D;return t[l==g.START?"checkBackward":"checkForward"]()},
getBoundaryNodes:function(){var c=this.startContainer,l=this.endContainer,t=this.startOffset,s=this.endOffset,n;if(c[0].nodeType==b.NODE_ELEMENT){n=c[0].childNodes.length;if(n>t)c=new p(c[0].childNodes[t]);else if(n<1)c=c._4e_previousSourceNode();else{for(c=c[0];c.lastChild;)c=c.lastChild;c=new p(c);c=c._4e_nextSourceNode()||c}}if(l[0].nodeType==b.NODE_ELEMENT){n=l[0].childNodes.length;if(n>s)l=(new p(l[0].childNodes[s]))._4e_previousSourceNode(z);else if(n<1)l=l._4e_previousSourceNode();else{for(l=
l[0];l.lastChild;)l=l.lastChild;l=new p(l)}}if(c._4e_position(l)&u.POSITION_FOLLOWING)c=l;return{startNode:c,endNode:l}},fixBlock:function(c,l){var t=this.createBookmark(),s=new p(this.document.createElement(l));this.collapse(c);this.enlarge(g.ENLARGE_BLOCK_CONTENTS);s[0].appendChild(this.extractContents());s._4e_trim();k.ie||s._4e_appendBogus();for(var n=s[0].childNodes,C=0;C<n.length;C++){var P=n[C];P.nodeType==8&&this.insertNode(new p(P))}this.insertNode(s);this.moveToBookmark(t);return s},splitBlock:function(c){var l=
new i(this.startContainer),t=new i(this.endContainer),s=l.block,n=t.block,C=f;if(!l.blockLimit._4e_equals(t.blockLimit))return f;if(c!="br"){if(!s){s=this.fixBlock(z,c);n=(new i(this.endContainer)).block}n||(n=this.fixBlock(m,c))}c=s&&this.checkStartOfBlock();l=n&&this.checkEndOfBlock();this.deleteContents();if(s&&a._4e_equals(s,n))if(l){C=new i(this.startContainer);this.moveToPosition(n,g.POSITION_AFTER_END);n=f}else if(c){C=new i(this.startContainer);this.moveToPosition(s,g.POSITION_BEFORE_START);
s=f}else{n=this.splitElement(s);!k.ie&&!e.inArray(s._4e_name(),["ul","ol"])&&s._4e_appendBogus()}return{previousBlock:s,nextBlock:n,wasStartOfBlock:c,wasEndOfBlock:l,elementPath:C}},splitElement:function(c){if(!this.collapsed)return f;this.setEndAt(c,g.POSITION_BEFORE_END);var l=this.extractContents(),t=c._4e_clone(m);t[0].appendChild(l);t.insertAfter(c);this.moveToPosition(c,g.POSITION_AFTER_END);return t},moveToElementEditablePosition:function(c,l){var t,s=o.XHTML_DTD;if(s.$empty[c._4e_name()])return m;
for(;c&&c[0].nodeType==b.NODE_ELEMENT;){if(t=c._4e_isEditable())this.moveToPosition(c,l?g.POSITION_BEFORE_END:g.POSITION_AFTER_START);else if(s.$inline[c._4e_name()]){this.moveToPosition(c,l?g.POSITION_AFTER_END:g.POSITION_BEFORE_START);return z}if((c=s.$empty[c._4e_name()]?c[l?"_4e_previous":"_4e_next"](G):c[l?"_4e_last":"_4e_first"](G))&&c[0].nodeType==b.NODE_TEXT){this.moveToPosition(c,l?g.POSITION_AFTER_END:g.POSITION_BEFORE_START);return z}}return t},selectNodeContents:function(c){this.setStart(c,
0);this.setEnd(c,c[0].nodeType==b.NODE_TEXT?c[0].nodeValue.length:c[0].childNodes.length)}});var q={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},v=new j.whitespaces,I=new j.bookmark;o.Range=B;o.Range=B;var A=B.prototype;o.Utils.extern(A,{updateCollapsed:A.updateCollapsed,optimize:A.optimize,setStartAfter:A.setStartAfter,setEndAfter:A.setEndAfter,setStartBefore:A.setStartBefore,
setEndBefore:A.setEndBefore,optimizeBookmark:A.optimizeBookmark,setStart:A.setStart,setEnd:A.setEnd,setStartAt:A.setStartAt,setEndAt:A.setEndAt,execContentsAction:A.execContentsAction,collapse:A.collapse,clone:A.clone,getEnclosedNode:A.getEnclosedNode,shrink:A.shrink,getTouchedStartNode:A.getTouchedStartNode,createBookmark2:A.createBookmark2,createBookmark:A.createBookmark,moveToPosition:A.moveToPosition,trim:A.trim,insertNode:A.insertNode,moveToBookmark:A.moveToBookmark,getCommonAncestor:A.getCommonAncestor,
enlarge:A.enlarge,checkStartOfBlock:A.checkStartOfBlock,checkEndOfBlock:A.checkEndOfBlock,deleteContents:A.deleteContents,extractContents:A.extractContents,checkBoundaryOfElement:A.checkBoundaryOfElement,getBoundaryNodes:A.getBoundaryNodes,fixBlock:A.fixBlock,splitBlock:A.splitBlock,splitElement:A.splitElement,moveToElementEditablePosition:A.moveToElementEditablePosition,selectNodeContents:A.selectNodeContents})});
KISSY.Editor.add("domiterator",function(o){function B(j){if(!(arguments.length<1)){this.range=j;this.forceBrBreak=G;this.enlargeBr=D;this.enforceRealBlocks=G;this._||(this._={})}}var D=true,G=false,w=KISSY,x=w.UA,y=o.Walker,z=o.Range,m=o.RANGE,f=o.NODE,e=o.ElementPath,b=w.Node,g=w.DOM,u=/^[\r\n\t ]*$/;w.augment(B,{getNextParagraph:function(j){var a,d,k,h,i;if(!this._.lastNode){d=this.range.clone();d.shrink(m.SHRINK_ELEMENT,D);d.enlarge(this.forceBrBreak||!this.enlargeBr?m.ENLARGE_LIST_ITEM_CONTENTS:
m.ENLARGE_BLOCK_CONTENTS);var p=new y(d),r=y.bookmark(D,D);p.evaluator=r;this._.nextNode=p.next();p=new y(d);p.evaluator=r;p=p.previous();this._.lastNode=p._4e_nextSourceNode(D);if(this._.lastNode&&this._.lastNode[0].nodeType==f.NODE_TEXT&&!w.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){r=new z(d.document);r.moveToPosition(this._.lastNode,m.POSITION_AFTER_END);if(r.checkEndOfBlock()){r=new e(r.endContainer);this._.lastNode=(r.block||r.blockLimit)._4e_nextSourceNode(D)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new b(d.document.createTextNode(""));g.insertAfter(this._.lastNode[0],p[0])}d=null}r=this._.nextNode;p=this._.lastNode;for(this._.nextNode=null;r;){var q=G,v=r[0].nodeType!=f.NODE_ELEMENT,I=G;if(v){if(r[0].nodeType==f.NODE_TEXT)if(u.test(r[0].nodeValue))v=G}else{var A=r._4e_name();if(r._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(A=="br")v=D;else if(!d&&!r[0].childNodes.length&&A!="hr"){a=r;k=r._4e_equals(p);break}if(d){d.setEndAt(r,m.POSITION_BEFORE_START);if(A!="br")this._.nextNode=
r}q=D}else{if(r[0].firstChild){if(!d){d=new z(this.range.document);d.setStartAt(r,m.POSITION_BEFORE_START)}r=new b(r[0].firstChild);continue}v=D}}if(v&&!d){d=new z(this.range.document);d.setStartAt(r,m.POSITION_BEFORE_START)}k=(!q||v)&&r._4e_equals(p);if(d&&!q)for(;!r[0].nextSibling&&!k;){A=r.parent();if(A._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){q=D;k||A._4e_equals(p);break}r=A;v=D;k=r._4e_equals(p);I=D}v&&d.setEndAt(r,m.POSITION_AFTER_END);r=r._4e_nextSourceNode(I,null,p);if((k=!r)||q&&d)break}if(!a){if(!d){this._.docEndMarker&&
this._.docEndMarker._4e_remove();return this._.nextNode=null}a=new e(d.startContainer);r=a.blockLimit;q={div:1,th:1,td:1};a=a.block;if((!a||!a[0])&&!this.enforceRealBlocks&&q[r._4e_name()]&&d.checkStartOfBlock()&&d.checkEndOfBlock())a=r;else if(!a||this.enforceRealBlocks&&a._4e_name()=="li"){a=new b(this.range.document.createElement(j||"p"));a[0].appendChild(d.extractContents());a._4e_trim();d.insertNode(a);h=i=D}else if(a._4e_name()!="li"){if(!d.checkStartOfBlock()||!d.checkEndOfBlock()){a=a._4e_clone(G);
a[0].appendChild(d.extractContents());a._4e_trim();i=d.splitBlock();h=!i.wasStartOfBlock;i=!i.wasEndOfBlock;d.insertNode(a)}}else if(!k)this._.nextNode=a._4e_equals(p)?null:d.getBoundaryNodes().endNode._4e_nextSourceNode(D,null,p)}if(h){d=new b(a[0].previousSibling);if(d[0]&&d[0].nodeType==f.NODE_ELEMENT)if(d._4e_name()=="br")d._4e_remove();else d[0].lastChild&&g._4e_name(d[0].lastChild)=="br"&&g._4e_remove(d[0].lastChild)}if(i){d=y.bookmark(G,D);h=new b(a[0].lastChild);if(h[0]&&h[0].nodeType==f.NODE_ELEMENT&&
h._4e_name()=="br")if(x.ie||h._4e_previous(d)||h._4e_next(d))h._4e_remove()}if(!this._.nextNode)this._.nextNode=k||a._4e_equals(p)?null:a._4e_nextSourceNode(D,null,p);return a}});z.prototype.createIterator=function(){return new B(this)}});
KISSY.Editor.add("selection",function(o){function B(q){this.document=this.document=q;this._={cache:{}};if(a){var v=this.getNative().createRange();if(!v||v.item&&v.item(0).ownerDocument!=q||v.parentElement&&v.parentElement().ownerDocument!=q)this.isInvalid=w}}function D(q){q=new B(q);return!q||q.isInvalid?y:q}function G(q){function v(N){var T=o.XHTML_DTD;return N._4e_isBlockBoundary()&&T.$empty[N._4e_name()]}var I=q.document,A=new b(I.body),c=new b(I.documentElement);if(m.ie){m.ieEngine<8&&c.on("click",
function(N){(new b(N.target))._4e_name()==="html"&&q.getSelection().getNative().createRange().select()});var l,t,s=1;c.on("mousedown",function(){s=0});c.on("mouseup",function(){s=1});A.on("focusin",function(N){if((new b(N.target))._4e_name()=="body")if(l){try{s&&l.select()}catch(T){}l=y}});A.on("focus",function(){t=w;C()});A.on("beforedeactivate",function(N){if(!N.relatedTarget){n();s=1}});q.on("blur",function(){try{var N=document.documentElement||document.body,T=N.scrollTop,R=N.scrollLeft;I&&I.selection.empty();
N.scrollTop=T;N.scrollLeft=R}catch(V){}});A.on("mousedown",function(){n()});A.on("mouseup",function(){t=w;setTimeout(function(){C(w)},0)});var n=function(){t=x},C=function(N){if(t){var T=q.document,R=q.getSelection(),V=R&&R.getType(),X=R&&T.selection;if(N&&X&&V==g.SELECTION_NONE)if(!T.queryCommandEnabled("InsertImage")){setTimeout(function(){C(w)},50);return}var Z;if(!(X&&X.type&&X.type!="Control"&&(Z=X.createRange())&&(Z=Z.parentElement())&&(Z=Z.nodeName)&&Z.toLowerCase()in{input:1,textarea:1})){l=
X&&R.getRanges()[0];q._monitor()}}};A.on("keydown",n);A.on("keyup",function(){t=w;C()});e.on(I,"selectionchange",C)}else{e.on(I,"mouseup",q._monitor,q);e.on(I,"keyup",q._monitor,q)}var P=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,O=o.Walker.whitespaces(w),Q=function(N){return O(N)&&N&&N[0].nodeType!=8};q.on("selectionChange",function(N){var T=N.path;N=(N=N.selection)&&N.getRanges()[0];if(!(!N||!N.collapsed||T.block))if(T.blockLimit._4e_name()==
"body")if(T=N.fixBlock(w,"p")){if(T._4e_outerHtml().match(P)){var R=T._4e_next(Q);if(R&&R[0].nodeType==j.NODE_ELEMENT&&!v[R]){N.moveToElementEditablePosition(R);T._4e_remove()}else if((R=T._4e_previous(Q))&&R[0].nodeType==j.NODE_ELEMENT&&!v[R]){N.moveToElementEditablePosition(R,R._4e_outerHtml().match(P)?x:w);T._4e_remove()}}N.select();a||q.notifySelectionChange()}})}o.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var w=true,x=false,y=null,z=KISSY,m=z.UA,f=z.DOM,e=z.Event,b=z.Node,
g=o.SELECTION,u=o.RANGE,j=o.NODE,a=m.ie,d=o.Walker,k=o.Range,h={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};z.augment(B,{getNative:!a?function(){var q=this._.cache;return q.nativeSel||(q.nativeSel=f._4e_getWin(this.document).getSelection())}:function(){var q=this._.cache;return q.nativeSel||(q.nativeSel=this.document.selection)},getType:!a?function(){var q=this._.cache;if(q.type)return q.type;var v=g.SELECTION_TEXT,
I=this.getNative();if(I){if(I.rangeCount==1){I=I.getRangeAt(0);var A=I.startContainer;if(A==I.endContainer&&A.nodeType==j.NODE_ELEMENT&&Number(I.endOffset-I.startOffset)==1&&h[A.childNodes[I.startOffset].nodeName.toLowerCase()])v=g.SELECTION_ELEMENT}}else v=g.SELECTION_NONE;return q.type=v}:function(){var q=this._.cache;if(q.type)return q.type;var v=g.SELECTION_NONE;try{var I=this.getNative(),A=I.type;if(A=="Text")v=g.SELECTION_TEXT;if(A=="Control")v=g.SELECTION_ELEMENT;if(I.createRange().parentElement)v=
g.SELECTION_TEXT}catch(c){}return q.type=v},getRanges:a?function(){var q=function(v,I){v=v.duplicate();v.collapse(I);for(var A=v.parentElement(),c=A.childNodes,l,t=0;t<c.length;t++){var s=c[t];if(s.nodeType==j.NODE_ELEMENT){l=v.duplicate();l.moveToElementText(s);s=l.compareEndPoints("StartToStart",v);var n=l.compareEndPoints("EndToStart",v);l.collapse();if(s>0)break;else if(!s||n==1&&s==-1)return{container:A,offset:t};else if(!n)return{container:A,offset:t+1};l=y}}if(!l){l=v.duplicate();l.moveToElementText(A);
l.collapse(x)}l.setEndPoint("StartToStart",v);l=String(l.text).replace(/\r\n|\r/g,"\n").length;try{for(;l>0;)l-=c[--t].nodeValue.length}catch(C){l=0}return l===0?{container:A,offset:t}:{container:c[t],offset:-l}};return function(v){var I=this._.cache;if(I.ranges&&!v)return I.ranges;var A=this.getNative();v=A&&A.createRange();var c=this.getType();if(!A)return[];if(c==g.SELECTION_TEXT){A=new k(this.document);c=q(v,w);A.setStart(new b(c.container),c.offset);c=q(v);A.setEnd(new b(c.container),c.offset);
return I.ranges=[A]}else if(c==g.SELECTION_ELEMENT){I=I.ranges=[];for(c=0;c<v.length;c++){var l=v.item(c),t=l.parentNode,s=0;for(A=new k(this.document);s<t.childNodes.length&&t.childNodes[s]!=l;s++);A.setStart(new b(t),s);A.setEnd(new b(t),s+1);I.push(A)}return I}return I.ranges=[]}}():function(q){var v=this._.cache;if(v.ranges&&!q)return v.ranges;q=[];var I=this.getNative();if(!I)return[];for(var A=0;A<I.rangeCount;A++){var c=I.getRangeAt(A),l=new k(this.document);l.setStart(new b(c.startContainer),
c.startOffset);l.setEnd(new b(c.endContainer),c.endOffset);q.push(l)}return v.ranges=q},getStartElement:function(){var q=this._.cache;if(q.startElement!==undefined)return q.startElement;var v,I=this.getNative();switch(this.getType()){case g.SELECTION_ELEMENT:return this.getSelectedElement();case g.SELECTION_TEXT:var A=this.getRanges()[0];if(A)if(!A.collapsed){for(A.optimize();w;){v=A.startContainer;if(A.startOffset==(v[0].nodeType===j.NODE_ELEMENT?v[0].childNodes.length:v[0].nodeValue.length)&&!v._4e_isBlockBoundary())A.setStartAfter(v);
else break}v=A.startContainer;if(v[0].nodeType!=j.NODE_ELEMENT)return v.parent();v=new b(v[0].childNodes[A.startOffset]);if(!v[0]||v[0].nodeType!=j.NODE_ELEMENT)return A.startContainer;for(A=v[0].firstChild;A&&A.nodeType==j.NODE_ELEMENT;){v=new b(A);A=A.firstChild}return v}if(a){A=I.createRange();A.collapse(w);v=A.parentElement()}else if((v=I.anchorNode)&&v.nodeType!=j.NODE_ELEMENT)v=v.parentNode}return q.startElement=v?f._4e_wrap(v):y},getSelectedElement:function(){var q=this,v,I=q._.cache;if(I.selectedElement!==
undefined)return I.selectedElement;if(a){v=q.getNative().createRange();v=v.item&&v.item(0)}v||(v=function(){for(var A=q.getRanges()[0],c,l,t=2;t&&!((c=A.getEnclosedNode())&&c[0].nodeType==j.NODE_ELEMENT&&h[c._4e_name()]&&(l=c));t--)A.shrink(u.SHRINK_ELEMENT);return l&&l[0]}());return I.selectedElement=f._4e_wrap(v)},reset:function(){this._.cache={}},selectElement:function(q){var v,I=this.document;if(a)try{v=I.body.createControlRange();v.addElement(q[0]);v.select()}catch(A){v=I.body.createTextRange();
v.moveToElementText(q[0]);v.select()}finally{}else{v=I.createRange();v.selectNode(q[0]);q=this.getNative();q.removeAllRanges();q.addRange(v)}this.reset()},selectRanges:function(q){if(a){if(q.length>1){var v=q[q.length-1];q[0].setEnd(v.endContainer,v.endOffset);q.length=1}q[0]&&q[0].select()}else{v=this.getNative();if(!v)return;v.removeAllRanges();for(var I=0;I<q.length;I++){var A=q[I],c=this.document.createRange(),l=A.startContainer;A.collapsed&&m.gecko&&m.gecko<1.09&&l[0].nodeType==j.NODE_ELEMENT&&
!l[0].childNodes.length&&l[0].appendChild(this.document.createTextNode(""));c.setStart(l[0],A.startOffset);c.setEnd(A.endContainer[0],A.endOffset);v.addRange(c)}}this.reset()},createBookmarks2:function(q){for(var v=[],I=this.getRanges(),A=0;A<I.length;A++)v.push(I[A].createBookmark2(q));return v},createBookmarks:function(q,v){var I=[],A=this.document,c;v=v||this.getRanges();for(var l=v.length,t=0;t<l;t++){I.push(c=v[t].createBookmark(q,w));var s=(q=c.serializable)?z.one("#"+c.startNode,A):c.startNode;
c=q?z.one("#"+c.endNode,A):c.endNode;for(var n=t+1;n<l;n++){var C=v[n],P=C.startContainer,O=C.endContainer;f._4e_equals(P,s.parent())&&C.startOffset++;f._4e_equals(P,c.parent())&&C.startOffset++;f._4e_equals(O,s.parent())&&C.endOffset++;f._4e_equals(O,c.parent())&&C.endOffset++}}return I},selectBookmarks:function(q){for(var v=[],I=0;I<q.length;I++){var A=new k(this.document);A.moveToBookmark(q[I]);v.push(A)}this.selectRanges(v);return this},getCommonAncestor:function(){var q=this.getRanges();return q[0].startContainer._4e_commonAncestor(q[q.length-
1].endContainer)},scrollIntoView:function(){var q=this.getStartElement();q&&q._4e_scrollIntoView()},removeAllRanges:function(){var q=this.getNative();if(a)q&&q.clear();else q&&q.removeAllRanges()}});var i={table:1,tbody:1,tr:1},p=d.whitespaces(w),r=/\ufeff|\u00a0/;k.prototype.select=k.prototype.select=!a?function(){var q=this.startContainer;this.collapsed&&q[0].nodeType==j.NODE_ELEMENT&&!q[0].childNodes.length&&q[0].appendChild(this.document.createTextNode(""));var v=this.document.createRange();v.setStart(q[0],
this.startOffset);try{v.setEnd(this.endContainer[0],this.endOffset)}catch(I){if(I.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(w);v.setEnd(this.endContainer[0],this.endOffset)}else throw I;}q=D(this.document).getNative();q.removeAllRanges();q.addRange(v)}:function(q){var v=this.collapsed,I,A;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var c=this.startContainer[0].childNodes[this.startOffset];if(c.nodeType==j.NODE_ELEMENT){(new B(this.document)).selectElement(new b(c));
return}}if(this.startContainer[0].nodeType==j.NODE_ELEMENT&&this.startContainer._4e_name()in i||this.endContainer[0].nodeType==j.NODE_ELEMENT&&this.endContainer._4e_name()in i)this.shrink(u.SHRINK_ELEMENT,w);var l=this.createBookmark();c=l.startNode;var t;if(!v)t=l.endNode;l=this.document.body.createTextRange();l.moveToElementText(c[0]);l.moveStart("character",1);if(t){q=this.document.body.createTextRange();q.moveToElementText(t[0]);l.setEndPoint("EndToEnd",q);l.moveEnd("character",-1)}else{for(I=
c[0].nextSibling;I&&!p(I);)I=I.nextSibling;I=!(I&&I.nodeValue&&I.nodeValue.match(r))&&(q||!c[0].previousSibling||c[0].previousSibling&&f._4e_name(c[0].previousSibling)=="br");A=new b(this.document.createElement("span"));A.html("&#65279;");A.insertBefore(c);if(I)f.insertBefore(this.document.createTextNode("\ufeff"),c[0]||c)}this.setStartBefore(c);c._4e_remove();if(v){if(I){l.moveStart("character",-1);l.select();this.document.selection.clear()}else l.select();if(A){this.moveToPosition(A,u.POSITION_BEFORE_START);
A._4e_remove()}}else{this.setEndBefore(t);t._4e_remove();l.select()}};B.getSelection=D;o.Selection=B;o.Selection=B;d=B.prototype;o.Utils.extern(d,{getNative:d.getNative,getType:d.getType,getRanges:d.getRanges,getStartElement:d.getStartElement,getSelectedElement:d.getSelectedElement,reset:d.reset,selectElement:d.selectElement,selectRanges:d.selectRanges,createBookmarks2:d.createBookmarks2,createBookmarks:d.createBookmarks,getCommonAncestor:d.getCommonAncestor,scrollIntoView:d.scrollIntoView,selectBookmarks:d.selectBookmarks,
removeAllRanges:d.removeAllRanges});o.on("instanceCreated",function(q){G(q.editor)})});
KISSY.Editor.add("styles",function(o){function B(F){return!F.attr("_ke_bookmark")}function D(F,K){for(var E in F)if(F.hasOwnProperty(E))if(I.isString(F[E]))F[E]=F[E].replace(X,function(J,H){return K[H]});else D(F[E],K)}function G(F,K){if(K){F=I.clone(F);D(F,K)}var E=this.element=this.element=(F.element||"*").toLowerCase();this.type=this.type=E=="#"||T[E]?l.STYLE_BLOCK:R[E]?l.STYLE_OBJECT:l.STYLE_INLINE;this._={definition:F}}function w(F,K){var E=K?this.removeFromRange:this.applyToRange;F.body.focus();
for(var J=new s(F),H=J.getRanges(),M=0;M<H.length;M++)E.call(this,H[M]);J.selectRanges(H)}function x(F,K,E){var J=F.element;if(J=="*")J="span";K=new O(K.createElement(J));E&&E._4e_copyAttributes(K);return y(K,F)}function y(F,K){var E=K._.definition,J=E.attributes;E=G.getStyleText(E);if(J)for(var H in J)F.attr(H,J[H]);if(E)F[0].style.cssText=E;return F}function z(F){var K=F.createBookmark(r),E=F.createIterator();E.enforceRealBlocks=r;E.enlargeBr=r;for(var J,H=F.document;J=E.getNextParagraph();){var M=
x(this,H,J);J=J;var L=M;M=L._4e_name=="pre";var S=J._4e_name=="pre",U=!M&&S;if(M&&!S){S=J;L=L;U=S.html();U=m(U,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");U=U.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");U=U.replace(/([ \t\n\r]+|&nbsp;)/g," ");U=U.replace(/<br\b[^>]*>/gi,"\n");if(Q.ie){S=S[0].ownerDocument.createElement("div");S.appendChild(L[0]);L[0].outerHTML="<pre>"+U+"</pre>";L=new O(S.firstChild);L._4e_remove()}else L.html(U);L=L}else if(U)L=e(f(J),L);else J._4e_moveChildren(L);J[0].parentNode.replaceChild(L[0],
J[0]);if(M){J=L;M=void 0;if((M=J._4e_previousSourceNode(r,n.NODE_ELEMENT))&&M._4e_name()=="pre"){L=m(M.html(),/\n$/,"")+"\n\n"+m(J.html(),/^\n/,"");if(Q.ie)J[0].outerHTML="<pre>"+L+"</pre>";else J.html(L);M._4e_remove()}}}F.moveToBookmark(K)}function m(F,K,E){var J="",H="";F=F.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(M,L,S){L&&(J=L);S&&(H=S);return""});return J+F.replace(K,E)+H}function f(F){var K=[];m(F._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(E,J,H){return J+"</pre>"+H+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(E,J){K.push(J)});return K}function e(F,K){for(var E=K[0].ownerDocument.createDocumentFragment(),J=0;J<F.length;J++){var H=F[J];H=H.replace(/(\r\n|\r)/g,"\n");H=m(H,/^[ \t]*\n/,"");H=m(H,/\n$/,"");H=m(H,/^[ \t]+|[ \t]+$/g,function(L,S){return L.length==1?"&nbsp;":S?" "+Array(L.length).join("&nbsp;"):Array(L.length).join("&nbsp;")+" "});H=H.replace(/\n/g,"<br>");H=H.replace(/[ \t]{2,}/g,function(L){return Array(L.length).join("&nbsp;")+
" "});var M=K._4e_clone();M.html(H);E.appendChild(M[0])}return E}function b(F){var K=F.document;if(F.collapsed){K=x(this,K,undefined);F.insertNode(K);F.moveToPosition(K,t.POSITION_BEFORE_END)}else{var E=this.element,J=this._.definition,H,M=o.XHTML_DTD[E]||(H=r,o.XHTML_DTD.span),L=F.createBookmark();F.enlarge(t.ENLARGE_ELEMENT);F.trim();var S=F.createBookmark(),U=S.startNode;S=S.endNode;for(var Y=U,aa;Y&&Y[0];){var W=q;if(c._4e_equals(Y,S)){Y=v;W=r}else{var $=Y[0].nodeType,ca=$==n.NODE_ELEMENT?Y._4e_name():
v;if(ca&&Y.attr("_ke_bookmark")){Y=Y._4e_nextSourceNode(r);continue}if(!ca||M[ca]&&(Y._4e_position(S)|C.POSITION_PRECEDING|C.POSITION_IDENTICAL|C.POSITION_IS_CONTAINED)==C.POSITION_PRECEDING+C.POSITION_IDENTICAL+C.POSITION_IS_CONTAINED&&(!J.childRule||J.childRule(Y))){var ea=Y.parent();if(ea&&ea[0]&&((o.XHTML_DTD[ea._4e_name()]||o.XHTML_DTD.span)[E]||H)&&(!J.parentRule||J.parentRule(ea))){if(!aa&&(!ca||!o.XHTML_DTD.$removeEmpty[ca]||(Y._4e_position(S)|C.POSITION_PRECEDING|C.POSITION_IDENTICAL|C.POSITION_IS_CONTAINED)==
C.POSITION_PRECEDING+C.POSITION_IDENTICAL+C.POSITION_IS_CONTAINED)){aa=new P(K);aa.setStartBefore(Y)}if($==n.NODE_TEXT||$==n.NODE_ELEMENT&&!Y[0].childNodes.length){$=Y;for(var da;(W=!$._4e_next(B))&&(da=$.parent(),M[da._4e_name()])&&(da._4e_position(U)|C.POSITION_FOLLOWING|C.POSITION_IDENTICAL|C.POSITION_IS_CONTAINED)==C.POSITION_FOLLOWING+C.POSITION_IDENTICAL+C.POSITION_IS_CONTAINED&&(!J.childRule||J.childRule(da));)$=da;aa.setEndAfter($)}}else W=r}else W=r;Y=Y._4e_nextSourceNode()}if(W&&aa&&!aa.collapsed){W=
x(this,K,undefined);$=aa.getCommonAncestor();ca={styles:{},attrs:{},blockedStyles:{},blockedAttrs:{}};for(var ba,fa,ga;W&&$&&W[0]&&$[0];){if($._4e_name()==E){for(ba in J.attributes)if(!(ca.blockedAttrs[ba]||!(ga=$.attr(fa))))if(W.attr(ba)==ga)W.removeAttr(ba);else ca.blockedAttrs[ba]=1;for(fa in J.styles)if(!(ca.blockedStyles[fa]||!(ga=$._4e_style(fa))))if(W._4e_style(fa)==ga)W._4e_style(fa,"");else ca.blockedStyles[fa]=1;if(!W._4e_hasAttributes()){W=v;break}}$=$.parent()}if(W){W[0].appendChild(aa.extractContents());
h(this,W);aa.insertNode(W);W._4e_mergeSiblings();Q.ie||W[0].normalize()}else{W=new O(K.createElement("span"));W[0].appendChild(aa.extractContents());aa.insertNode(W);h(this,W);W._4e_remove(true)}aa=v}}U._4e_remove();S._4e_remove();F.moveToBookmark(L);F.shrink(t.SHRINK_TEXT)}}function g(F){F.enlarge(t.ENLARGE_ELEMENT);var K=F.createBookmark(),E=K.startNode;if(F.collapsed){for(var J=new N(E.parent()),H,M=0,L;M<J.elements.length&&(L=J.elements[M]);M++){if(L==J.block||L==J.blockLimit)break;if(this.checkElementRemovable(L)){var S=
F.checkBoundaryOfElement(L,t.END),U=!S&&F.checkBoundaryOfElement(L,t.START);if(U||S){H=L;H.match=U?"start":"end"}else{L._4e_mergeSiblings();if(L._4e_name()!=this.element){S=a(this);i(L,S[L._4e_name()]||S["*"])}else d(this,L)}}}if(H&&H[0]){L=E;for(M=0;;M++){S=J.elements[M];if(c._4e_equals(S,H))break;else if(S.match)continue;else S=S._4e_clone();S[0].appendChild(L[0]);L=S}c[H.match=="start"?"insertBefore":"insertAfter"](c._4e_unwrap(L),c._4e_unwrap(H))}}else{var Y=K.endNode,aa=this;J=function(){for(var W=
new N(E.parent()),$=new N(Y.parent()),ca=v,ea=v,da=0;da<W.elements.length;da++){var ba=W.elements[da];if(ba==W.block||ba==W.blockLimit)break;if(aa.checkElementRemovable(ba))ca=ba}for(da=0;da<$.elements.length;da++){ba=$.elements[da];if(ba==$.block||ba==$.blockLimit)break;if(aa.checkElementRemovable(ba))ea=ba}ea&&Y._4e_breakParent(ea);ca&&E._4e_breakParent(ca)};J();for(H=new O(E[0].nextSibling);H[0]!==Y[0];){M=H._4e_nextSourceNode();if(H[0]&&H[0].nodeType==n.NODE_ELEMENT&&this.checkElementRemovable(H)){if(H._4e_name()==
this.element)d(this,H);else{L=a(this);i(H,L[H._4e_name()]||L["*"])}if(M[0].nodeType==n.NODE_ELEMENT&&M.contains(E)){J();M=new O(E[0].nextSibling)}}H=M}}F.moveToBookmark(K)}function u(F){F=String(F);var K={};F.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(E,J,H){K[J]=H});return K}function j(F,K){var E="";if(K!==q){E=document.createElement("span");E.style.cssText=F;E=E.style.cssText||""}else E=F;return E.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,
",").toLowerCase()}function a(F){if(F._.overrides)return F._.overrides;var K=F._.overrides={},E=F._.definition.overrides;if(E){I.isArray(E)||(E=[E]);for(var J=0;J<E.length;J++){var H=E[J],M,L,S;if(typeof H=="string")M=H.toLowerCase();else{M=H.element?H.element.toLowerCase():F.element;L=H.attributes;S=H.styles}H=K[M]||(K[M]={});if(L){M=H.attributes=H.attributes||[];for(var U in L)L.hasOwnProperty(U)&&M.push([U.toLowerCase(),L[U]])}if(S){H=H.styles=H.styles||[];for(var Y in S)S.hasOwnProperty(Y)&&H.push([Y.toLowerCase(),
S[Y]])}}}return K}function d(F,K){var E=F._.definition,J=a(F),H=A.mix(E.attributes,(J[K._4e_name()]||J["*"]||{}).attributes);E=A.mix(E.styles,(J[K._4e_name()]||J["*"]||{}).styles);J=I.isEmptyObject(H)&&I.isEmptyObject(E);for(var M in H)if(H.hasOwnProperty(M))if(!((M=="class"||F._.definition.fullMatch)&&K.attr(M)!=k(M,H[M]))){J=J||!!K._4e_hasAttribute(M);K.removeAttr(M)}for(var L in E)if(E.hasOwnProperty(L))if(!(F._.definition.fullMatch&&K._4e_style(L)!=k(L,E[L],r))){J=J||!!K._4e_style(L);K._4e_style(L,
"")}p(K)}function k(F,K,E){var J=new O("<span>");J[E?"_4e_style":"attr"](F,K);return J[E?"_4e_style":"attr"](F)}function h(F,K){for(var E=a(F),J=K.all(F.element),H=J.length;--H>=0;)d(F,new O(J[H]));for(var M in E)if(M!=F.element){J=K.all(M);for(H=J.length-1;H>=0;H--){var L=new O(J[H]);i(L,E[M])}}}function i(F,K){var E,J=K&&K.attributes;if(J)for(E=0;E<J.length;E++){var H=J[E][0],M;if(M=F.attr(H)){var L=J[E][1];if(L===v||L.test&&L.test(M)||typeof L=="string"&&M==L)F[0].removeAttribute(H)}}if(J=K&&K.styles)for(E=
0;E<J.length;E++){H=J[E][0];if(L=F.css(H)){var S=J[E][1];if(S===v||S.test&&S.test(M)||typeof S=="string"&&L==S)F.css(H,"")}}p(F)}function p(F){if(!F._4e_hasAttributes()){var K=F[0].firstChild,E=F[0].lastChild;F._4e_remove(r);if(K){K.nodeType==n.NODE_ELEMENT&&c._4e_mergeSiblings(K);E&&K!=E&&E.nodeType==n.NODE_ELEMENT&&c._4e_mergeSiblings(E)}}}var r=true,q=false,v=null,I=KISSY,A=o.Utils,c=I.DOM,l={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},t=o.RANGE,s=o.Selection,n=o.NODE,C=o.POSITION,P=o.Range,O=
I.Node,Q=I.UA,N=o.ElementPath,T={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},R={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},V=/\s*(?:;\s*|$)/g,X=/#\((.+?)\)/g;o.STYLE=l;G.prototype={apply:function(F){w.call(this,F,q)},remove:function(F){w.call(this,F,r)},applyToRange:function(F){return(this.applyToRange=this.type==l.STYLE_INLINE?b:this.type==l.STYLE_BLOCK?z:this.type==l.STYLE_OBJECT?v:v).call(this,F)},removeFromRange:function(F){return(this.removeFromRange=
this.type==l.STYLE_INLINE?g:v).call(this,F)},applyToObject:function(F){y(F,this)},checkElementRemovable:function(F,K){if(!F)return q;var E=this._.definition,J;if(F._4e_name()==this.element){if(!K&&!F._4e_hasAttributes())return r;var H=E._AC;if(H)E=H;else{H={};var M=0,L=E.attributes;if(L)for(var S in L){M++;H[S]=L[S]}if(L=G.getStyleText(E)){H.style||M++;H.style=L}H._length=M;E=E._AC=H}if(E._length){for(var U in E)if(U!="_length"){M=F.attr(U)||"";if(U=="style")a:{H=E[U];M=j(M,q);typeof H=="string"&&
(H=u(H));typeof M=="string"&&(M=u(M));L=void 0;for(L in H)if(!(L in M&&(M[L]==H[L]||H[L]=="inherit"||M[L]=="inherit"))){H=q;break a}H=r}else H=E[U]==M;if(H){if(!K)return r}else if(K)return q}if(K)return r}else return r}U=a(this);if(U=U[F._4e_name()]||U["*"]){if(!(E=U.attributes)&&!(J=U.styles))return r;if(E)for(H=0;H<E.length;H++){U=E[H][0];if(U=F.attr(U)){M=E[H][1];if(M===v||typeof M=="string"&&U==M||M.test&&M.test(U))return r}}if(J)for(H=0;H<J.length;H++)if(U=F.css(J[H][0])){E=J[H][1];if(E===v||
typeof E=="string"&&U==E||E.test&&E.test(U))return r}}return q},checkActive:function(F){switch(this.type){case l.STYLE_BLOCK:return this.checkElementRemovable(F.block||F.blockLimit,r);case l.STYLE_OBJECT:case l.STYLE_INLINE:for(var K=F.elements,E=0,J;E<K.length;E++){J=K[E];if(!(this.type==l.STYLE_INLINE&&(c._4e_equals(J,F.block)||c._4e_equals(J,F.blockLimit))))if(!(this.type==l.STYLE_OBJECT&&!(J._4e_name()in R)))if(this.checkElementRemovable(J,r))return r}}return q}};G.getStyleText=function(F){var K=
F._ST;if(K)return K;K=F.styles;var E=F.attributes&&F.attributes.style||"",J="";if(E.length)E=E.replace(V,";");for(var H in K){var M=K[H],L=(H+":"+M).replace(V,";");if(M=="inherit")J+=L;else E+=L}if(E.length)E=j(E);E+=J;return F._ST=E};o.Style=G;o.Style=G;var Z=G.prototype;o.Utils.extern(Z,{apply:Z.apply,remove:Z.remove,applyToRange:Z.applyToRange,removeFromRange:Z.removeFromRange,applyToObject:Z.applyToObject,checkElementRemovable:Z.checkElementRemovable,checkActive:Z.checkActive})});
KISSY.Editor.add("htmlparser",function(){function o(){this._={htmlPartsRegex:RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var B=KISSY,D=function(){},G=B.Editor,w=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,x={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},y=G.XHTML_DTD;B.augment(o,{onTagOpen:D,onTagClose:D,
onText:D,onCDATA:D,onComment:D,parse:function(z){for(var m,f,e=0,b;m=this._.htmlPartsRegex.exec(z);){f=m.index;if(f>e){e=z.substring(e,f);b?b.push(e):this.onText(e)}e=this._.htmlPartsRegex.lastIndex;if(f=m[1]){f=f.toLowerCase();if(b&&y.$cdata[f]){this.onCDATA(b.join(""));b=null}if(!b){this.onTagClose(f);continue}}if(b)b.push(m[0]);else if(f=m[3]){f=f.toLowerCase();if(!/="/.test(f)){var g={},u;m=m[4];var j=!!(m&&m.charAt(m.length-1)=="/");if(m)for(;u=w.exec(m);){var a=u[1].toLowerCase();u=u[2]||u[3]||
u[4]||"";g[a]=!u&&x[a]?a:u}this.onTagOpen(f,g,j);if(!b&&y.$cdata[f])b=[]}}else if(f=m[2])this.onComment(f)}z.length>e&&this.onText(z.substring(e,z.length))}});G.HtmlParser=o;G.HtmlParser=o});
KISSY.Editor.add("htmlparser-basicwriter",function(){function o(){this._={output:[]}}var B=KISSY,D=B.Editor,G=D.Utils;B.augment(o,{openTag:function(w){this._.output.push("<",w)},openTagClose:function(w,x){x?this._.output.push(" />"):this._.output.push(">")},attribute:function(w,x){if(typeof x=="string")x=G.htmlEncodeAttr(x);this._.output.push(" ",w,'="',x,'"')},closeTag:function(w){this._.output.push("</",w,">")},text:function(w){this._.output.push(w)},comment:function(w){this._.output.push("<!--",
w,"--\>")},write:function(w){this._.output.push(w)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(w){var x=this._.output.join("");w&&this.reset();return x}});D.HtmlParser.BasicWriter=o;D.HtmlParser.BasicWriter=o;B=o.prototype;D.Utils.extern(B,{openTag:B.openTag,openTagClose:B.openTagClose,attribute:B.attribute,closeTag:B.closeTag,text:B.text,comment:B.comment,write:B.write,reset:B.reset,getHtml:B.getHtml})});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function o(){o.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=x;this.sortAttributes=w;this._.indent=x;this._.indentation="";this._.rules={};var y=D.XHTML_DTD,z;for(z in G.mix({},y.$nonBodyContent,y.$block,y.$listItem,y.$tableContent))this.setRules(z,{indent:w,breakBeforeOpen:w,breakAfterOpen:w,breakBeforeClose:!y[z]["#"],breakAfterClose:w});this.setRules("br",
{breakAfterOpen:w});this.setRules("title",{indent:x,breakAfterOpen:x});this.setRules("style",{indent:x,breakBeforeClose:w});this.setRules("pre",{indent:x})}var B=KISSY,D=B.Editor,G=D.Utils,w=true,x=false;B.extend(o,D.HtmlParser.BasicWriter,{openTag:function(y){var z=this._.rules[y];if(this._.indent)this.indentation();else if(z&&z.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",y)},openTagClose:function(y,z){var m=this._.rules[y];if(z)this._.output.push(this.selfClosingEnd);
else{this._.output.push(">");if(m&&m.indent)this._.indentation+=this.indentationChars}m&&m.breakAfterOpen&&this.lineBreak()},attribute:function(y,z){if(typeof z=="string"){this.forceSimpleAmpersand&&(z=z.replace(/&amp;/g,"&"));z=G.htmlEncodeAttr(z)}this._.output.push(" ",y,'="',z,'"')},closeTag:function(y){var z=this._.rules[y];if(z&&z.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();else if(z&&z.breakBeforeClose){this.lineBreak();
this.indentation()}this._.output.push("</",y,">");z&&z.breakAfterClose&&this.lineBreak()},text:function(y){if(this._.indent){this.indentation();y=G.ltrim(y)}this._.output.push(y)},comment:function(y){this._.indent&&this.indentation();this._.output.push("<!--",y,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=w},indentation:function(){this._.output.push(this._.indentation);this._.indent=x},setRules:function(y,z){var m=this._.rules[y];if(m)G.mix(m,
z);else this._.rules[y]=z}});D.HtmlParser.HtmlWriter=o;D.HtmlParser.HtmlWriter=o;B=o.prototype;D.Utils.extern(B,{openTag:B.openTag,openTagClose:B.openTagClose,attribute:B.attribute,closeTag:B.closeTag,text:B.text,comment:B.comment,lineBreak:B.lineBreak,indentation:B.indentation,setRules:B.setRules})});
KISSY.Editor.add("htmlparser-fragment",function(){function o(){this.children=[];this.parent=G;this._={isBlockLike:B,hasInlineStarted:D}}var B=true,D=false,G=null,w=KISSY.Editor,x={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},y=KISSY,z=w.Utils,m=w.NODE,f=w.XHTML_DTD;z.mix({table:1,ul:1,ol:1,dl:1},f.table,f.ul,f.ol,f.dl);var e=f.$list,b=f.$listItem;o.FromHtml=function(g,u){function j(c){var l;if(i.length>0)for(var t=0;t<i.length;t++){var s=i[t],n=s.name,C=f[n],P=r.name&&f[r.name];
if((!P||P[n])&&(!c||!C||C[c]||!f[c])){if(!l){a();l=1}s=s.clone();s.parent=r;r=s;i.splice(t,1);t--}}}function a(){for(;p.length;)r.add(p.shift())}function d(c,l,t){l=l||r||h;if(u&&!l.type){var s,n;if((s=c.attributes&&(n=c.attributes._ke_real_element_type)?n:c.name)&&!(s in f.$body)&&!(s in f.$nonBodyContent)){n=r;r=l;k.onTagOpen({li:"ul",dt:"dl",dd:"dl"}[s]||u,{});l=r;if(t)r=n}}if(c._.isBlockLike&&c.name!="pre"){t=c.children.length;if((s=c.children[t-1])&&s.type==m.NODE_TEXT)if(n=z.rtrim(s.value))s.value=
n;else c.children.length=t-1}l.add(c);if(c.returnPoint){r=c.returnPoint;delete c.returnPoint}}var k=new w.HtmlParser,h=new o,i=[],p=[],r=h,q=D,v;k.onTagOpen=function(c,l,t){var s=new w.HtmlParser.Element(c,l);if(s.isUnknown&&t)s.isEmpty=B;if(f.$removeEmpty[c])i.push(s);else{if(String(c)==="pre")q=B;else if(String(c)==="br"&&q){r.add(new w.HtmlParser.Text("\n"));return}if(String(c)==="br")p.push(s);else{var n=r.name,C=n&&(f[n]||(r._.isBlockLike?f.div:f.span));if(C&&!s.isUnknown&&!r.isUnknown&&!C[c]){C=
D;var P;if(c in e&&n in e){n=r.children;(n=n[n.length-1])&&n.name in b||d(n=new w.HtmlParser.Element("li"),r);v=r;P=n}else if(c==n)d(r,r.parent);else{d(r,r.parent,B);!x[n]&&n in f.$inline&&i.unshift(r);C=B}r=P?P:r.returnPoint||r.parent;if(C){k.onTagOpen.apply(this,arguments);return}}j(c);a();s.parent=r;s.returnPoint=v;v=0;if(s.isEmpty)d(s);else r=s}}};k.onTagClose=function(c){for(var l=i.length-1;l>=0;l--)if(c==i[l].name){i.splice(l,1);return}for(var t=[],s=[],n=r;n.type&&n.name!=c;){n._.isBlockLike||
s.unshift(n);t.push(n);n=n.parent}if(n.type){for(l=0;l<t.length;l++){var C=t[l];d(C,C.parent)}r=n;if(r.name=="pre")q=D;n._.isBlockLike&&a();d(n,n.parent);if(n==r)r=r.parent;i=i.concat(s)}if(c=="body")u=D};k.onText=function(c){if(!r._.hasInlineStarted&&!q){c=z.ltrim(c);if(c.length===0)return}a();j();if(u&&(!r.type||r.name=="body")&&z.trim(c))this.onTagOpen(u,{});q||(c=c.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));r.add(new w.HtmlParser.Text(c))};k.onCDATA=function(c){r.add(new w.HtmlParser.cdata(c))};
k.onComment=function(c){r.add(new w.HtmlParser.Comment(c))};k.parse(g);for(a();r.type;){var I=r.parent,A=r;if(u&&(!I.type||I.name=="body")&&!f.$body[A.name]){r=I;k.onTagOpen(u,{});I=r}I.add(A);r=I}return h};y.augment(o,{add:function(g){var u=this.children.length;if(u=u>0&&this.children[u-1]||G){if(g._.isBlockLike&&u.type==m.NODE_TEXT){u.value=z.rtrim(u.value);if(u.value.length===0){this.children.pop();this.add(g);return}}u.next=g}g.previous=u;g.parent=this;this.children.push(g);this._.hasInlineStarted=
g.type==m.NODE_TEXT||g.type==m.NODE_ELEMENT&&!g._.isBlockLike},writeHtml:function(g,u){var j;this.filterChildren=this.filterChildren=function(){var a=new w.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,a,u,B);a=a.getHtml();this.children=(new o.FromHtml(a)).children;j=1};!this.name&&u&&u.onFragment(this);this.writeChildrenHtml(g,j?G:u)},writeChildrenHtml:function(g,u){for(var j=0;j<this.children.length;j++)this.children[j].writeHtml(g,u)}});w.HtmlParser.Fragment=o;w.HtmlParser.Fragment=o;
o.FromHtml=o.FromHtml;y=o.prototype;w.Utils.extern(y,{add:y.add,writeHtml:y.writeHtml,writeChildrenHtml:y.writeChildrenHtml})});
KISSY.Editor.add("htmlparser-element",function(){function o(x,y){this.name=x;this.attributes=y||(y={});this.children=[];var z=y._ke_real_element_type||x,m=B.XHTML_DTD;z=!!(m.$nonBodyContent[z]||m.$block[z]||m.$listItem[z]||m.$tableContent[z]||m.$nonEditable[z]||z=="br");var f=!!m.$empty[x];this.isEmpty=f;this.isUnknown=!m[x];this._={isBlockLike:z,hasInlineStarted:f||!z}}var B=KISSY.Editor,D=B.NODE,G=function(x,y){x=x[0];y=y[0];return x<y?-1:x>y?1:0};KISSY.augment(o,{type:D.NODE_ELEMENT,add:B.HtmlParser.Fragment.prototype.add,
clone:function(){return new o(this.name,this.attributes)},writeHtml:function(x,y){var z=this.attributes,m=this,f=m.name,e,b,g,u;m.filterChildren=function(){if(!u){var d=new B.HtmlParser.BasicWriter;B.HtmlParser.Fragment.prototype.writeChildrenHtml.call(m,d,y);m.children=(new B.HtmlParser.Fragment.FromHtml(d.getHtml())).children;u=1}};m.filterChildren=m.filterChildren;if(y){for(;;){if(!(f=y.onElementName(f)))return;m.name=f;if(!(m=y.onElement(m)))return;m.parent=this.parent;if(m.name==f)break;if(m.type!=
D.NODE_ELEMENT){m.writeHtml(x,y);return}f=m.name;if(!f){this.writeChildrenHtml.call(m,x,u?null:y);return}}z=m.attributes}x.openTag(f,z);for(var j=[],a=0;a<2;a++)for(e in z){b=e;g=z[e];if(a==1)j.push([e,g]);else if(y){for(;;)if(b=y.onAttributeName(e))if(b!=e){delete z[e];e=b}else break;else{delete z[e];break}if(b)if((g=y.onAttribute(m,b,g))===false)delete z[b];else z[b]=g}}x.sortAttributes&&j.sort(G);z=j.length;for(a=0;a<z;a++){e=j[a];x.attribute(e[0],e[1])}x.openTagClose(f,m.isEmpty);if(!m.isEmpty){this.writeChildrenHtml.call(m,
x,u?null:y);x.closeTag(f)}},writeChildrenHtml:function(){B.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});B.HtmlParser.Element=o;B.HtmlParser.Element=o;var w=o.prototype;B.Utils.extern(w,{type:w.type,add:w.add,clone:w.clone,writeHtml:w.writeHtml,writeChildrenHtml:w.writeChildrenHtml})});
KISSY.Editor.add("htmlparser-filter",function(){function o(e){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};e&&this.addRules(e,10)}function B(e,b){for(var g=0;e&&g<b.length;g++){var u=b[g];e=e.replace(u[0],u[1])}return e}function D(e,b,g){if(typeof b=="function")b=[b];var u,j;j=e.length;var a=b&&b.length;if(a){for(u=0;u<j&&e[u].pri<g;u++);for(j=a-1;j>=0;j--)if(a=b[j]){a.pri=g;e.splice(u,0,a)}}}function G(e,b,g){if(b)for(var u in b){var j=e[u];e[u]=w(j,b[u],
g);j||e.$length++}}function w(e,b,g){if(b){b.pri=g;if(e){if(e.splice)D(e,b,g);else{e=e.pri>g?[b,e]:[e,b];e.filter=x}return e}else return b.filter=b}}function x(e){for(var b=e.type||e instanceof z.HtmlParser.Fragment,g=0;g<this.length;g++){if(b)var u=e.type,j=e.name;var a=this[g].apply(window,arguments);if(a===f)return a;if(b){if(a&&(a.name!=j||a.type!=u))return a}else if(typeof a!="string")return a;a!=undefined&&(e=a)}return e}var y=KISSY,z=y.Editor,m=z.NODE,f=false;y.augment(o,{addRules:function(e,
b){if(typeof b!="number")b=10;D(this._.elementNames,e.elementNames,b);D(this._.attributeNames,e.attributeNames,b);G(this._.elements,e.elements,b);G(this._.attributes,e.attributes,b);this._.text=w(this._.text,e.text,b)||this._.text;this._.comment=w(this._.comment,e.comment,b)||this._.comment;this._.root=w(this._.root,e.root,b)||this._.root},onElementName:function(e){return B(e,this._.elementNames)},onAttributeName:function(e){return B(e,this._.attributeNames)},onText:function(e){var b=this._.text;
return b?b.filter(e):e},onComment:function(e,b){var g=this._.comment;return g?g.filter(e,b):e},onFragment:function(e){var b=this._.root;return b?b.filter(e):e},onElement:function(e){for(var b=[this._.elements["^"],this._.elements[e.name],this._.elements.$],g,u=0;u<3;u++)if(g=b[u]){g=g.filter(e,this);if(g===f)return null;if(g&&g!=e)return this.onNode(g);if(e.parent&&!e.name)break}return e},onNode:function(e){var b=e.type;return b==m.NODE_ELEMENT?this.onElement(e):b==m.NODE_TEXT?new z.HtmlParser.Text(this.onText(e.value)):
null},onAttribute:function(e,b,g){if(b=this._.attributes[b]){e=b.filter(g,e,this);if(e===f)return f;if(typeof e!="undefined")return e}return g}});z.HtmlParser.Filter=o;y=o.prototype;z.Utils.extern(y,{addRules:y.addRules,onElementName:y.onElementName,onAttributeName:y.onAttributeName,onText:y.onText,onComment:y.onComment,onFragment:y.onFragment,onElement:y.onElement,onNode:y.onNode,onAttribute:y.onAttribute});z.HtmlParser.Filter=o});
KISSY.Editor.add("htmlparser-text",function(){function o(w){this.value=w;this._={isBlockLike:G}}var B=KISSY,D=B.Editor,G=false;B.augment(o,{type:D.NODE.NODE_TEXT,writeHtml:function(w,x){var y=this.value;x&&!(y=x.onText(y,this))||w.text(y)}});D.HtmlParser.Text=o;D.HtmlParser.Text=o});KISSY.Editor.add("htmlparser-cdata",function(o){o.HtmlParser.cdata=function(B){this.value=B};o.HtmlParser.cdata.prototype={type:o.NODE.NODE_TEXT,writeHtml:function(B){B.write(this.value)}}});
KISSY.Editor.add("htmlparser-comment",function(){function o(G){this.value=G;this._={isBlockLike:false}}var B=KISSY.Editor,D=B.NODE;B.HtmlParser.Comment=o;B.HtmlParser.Comment=o;o.prototype={constructor:o,type:D.NODE_COMMENT,writeHtml:function(G,w){var x=this.value;if(w){if(!(x=w.onComment(x,this)))return;if(typeof x!="string"){x.parent=this.parent;x.writeHtml(G,w);return}}G.comment(x)}}});
KISSY.Editor.add("button",function(){function o(w){if(w&&w.indexOf("<")==-1)return w;return 0}var B=KISSY,D=B.Editor;if(D.TripleButton)B.log("TripleButton attach twice","warn");else{var G=B.UIBase.create([B.UIBase.Box.Render||B.UIBase.Box],{_updateHref:function(){this.get("el").attr("href","javascript:void('"+(o(this.get("text"))||o(this.get("title")))+"')")},bindUI:function(){var w=this,x=w.get("el");x.on("click",w._action,w);x.on("mousedown",function(){w.get("state")=="off"&&x.addClass("ke-triplebutton-active")});
x.on("mouseup mouseleave",function(){w.get("state")=="off"&&x.hasClass("ke-triplebutton-active")&&setTimeout(function(){x.removeClass("ke-triplebutton-active")},300)})},_uiSetTitle:function(){this.get("el").attr("title",this.get("title"));this._updateHref()},_uiSetContentCls:function(w){var x=this.get("el");if(w!==undefined){x.html("<span class='ke-toolbar-item "+w+"' />");x._4e_unselectable()}},_uiSetText:function(w){this.get("el").html(w);this._updateHref()},_uiSetState:function(w){this["_"+w]()},
disable:function(){this._savedState=this.get("state");this.set("state","disabled")},enable:function(){this.get("state")=="disabled"&&this.set("state",this._savedState)},_action:function(w){this.fire(this.get("state")+"Click",{TripleEvent:w});this.fire("click",{TripleClickType:this.get("state")+"Click"});w&&w.preventDefault()},bon:function(){this.set("state","on")},boff:function(){this.set("state","off")},_on:function(){var w=this.get("el");w.removeClass("ke-triplebutton-off ke-triplebutton-disabled");
w.addClass("ke-triplebutton-on")},_off:function(){var w=this.get("el");w.removeClass("ke-triplebutton-on ke-triplebutton-disabled");w.addClass("ke-triplebutton-off")},_disabled:function(){var w=this.get("el");w.removeClass("ke-triplebutton-off ke-triplebutton-on");w.addClass("ke-triplebutton-disabled")}},{ATTRS:{state:{value:"off"},elCls:{value:"ke-triplebutton ke-triplebutton-off"},elTagName:{value:"a"},title:{},contentCls:{},text:{}}});G.ON="on";G.OFF="off";G.DISABLED="disabled";G.ON_CLASS="ke-triplebutton-on";
G.OFF_CLASS="ke-triplebutton-off";G.DISABLED_CLASS="ke-triplebutton-disabled";D.TripleButton=G;D.prototype.addButton=function(w,x){var y=this,z=new G({render:y.toolBarDiv,autoRender:true,title:x.title,text:x.text,contentCls:x.contentCls}),m={btn:z,editor:y,cfg:x,call:function(){var f=B.makeArray(arguments),e=f.shift();return x[e].apply(m,f)},reload:function(f){B.mix(x,f);z.enable();y.on("selectionChange",function(){y.getMode()!=D.SOURCE_MODE&&x.selectionChange&&x.selectionChange.apply(m,arguments)});
z.on("click",function(e){var b=e.TripleClickType;x[b]&&x[b].apply(m,arguments);e&&e.halt()});if(x.mode==D.WYSIWYG_MODE){y.on("wysiwygmode",z.enable,z);y.on("sourcemode",z.disable,z)}x.init&&x.init.call(m)},destroy:function(){x.destroy&&x.destroy.call(m);z.destroy()}};x.loading?z.disable():m.reload(undefined);return m}}},{attach:false});
KISSY.Editor.add("select",function(){function o(e){o.superclass.constructor.call(this,e);this._init()}function B(e){if(e&&e.indexOf("<")==-1)return e;return 0}var D=KISSY,G=D.Node,w=D.Event,x=D.DOM,y=D.Editor;if(y.Select)D.log("ke select attach more");else{o.DISABLED=0;o.ENABLED=1;var z=y.XHTML_DTD;o.ATTRS={showValue:{},el:{},cls:{},container:{},doc:{},value:{},width:{},title:{},items:{},emptyText:{},align:{value:["l","b"]},menuContainer:{valueFn:function(){for(var e=this.el.parent();e;){var b=e._4e_name();
if(z[b]&&z[b].div)return e;e=e.parent()}return new G(document.body)}},state:{value:1}};o.decorate=function(e){for(var b=e.width(),g=[],u=e.all("option"),j=0;j<u.length;j++){var a=u[j];g.push({name:x.html(a),value:x.attr(a,"value")})}return new o({width:b+"px",title:e.attr("title"),el:e,items:g,cls:"ke-combox",value:e.val()})};var m=y.Utils.addRes,f=y.Utils.destroyRes;D.extend(o,D.Base,{_init:function(){var e=this.get("container"),b=this.get("el"),g=new G("<span class='ke-select-wrap'><a class='ke-select'><span class='ke-select-text'><span class='ke-select-text-inner'></span></span><span class='ke-select-drop-wrap'><span class='ke-select-drop'></span></span></a></span>"),
u=g.one("a"),j=this.get("title")||"",a=this.get("cls"),d=g.one(".ke-select-text"),k=g.one(".ke-select-text-inner");g.one(".ke-select-drop");this.get("value")!==undefined?k.html(this._findNameByV(this.get("value"))):k.html(j);d.css("width",this.get("width"));g._4e_unselectable();j&&g.attr("title",j);u.attr("href","javascript:void('"+B(j)+"')");a&&g.addClass(a);if(b)b[0].parentNode.replaceChild(g[0],b[0]);else e&&g.appendTo(e);g.on("click",this._click,this);this.el=g;this.title=k;this._focusA=g.one("a.ke-select");
y.Utils.lazyRun(this,"_prepare","_real");this.on("afterValueChange",this._valueChange,this);this.on("afterStateChange",this._stateChange,this)},_findNameByV:function(e){var b=this.get("title")||"",g=this.get("items");if(this.get("showValue"))return e||b;for(var u=0;u<g.length;u++){var j=g[u];if(j.value==e){b=j.name;break}}return b},_valueChange:function(e){this.title.html(this._findNameByV(e.newVal))},_itemsChange:function(e){var b;b=e.newVal;e=this._selectList;e.html("");if(b&&b.length)for(var g=
0;g<b.length;g++){var u=b[g];(new G("<a class='ke-select-menu-item' href='javascript:void(\""+B(u.name)+"\")' data-value='"+u.value+"'>"+u.name+"</a>",u.attrs)).appendTo(e)._4e_unselectable()}else if(b=this.get("emptyText"))(new G("<a class='ke-select-menu-item' href='javascript:void(\""+B(b)+"\")'>"+b+"</a>")).appendTo(e)._4e_unselectable();this.as=e.all("a")},val:function(e){if(e!==undefined){this.set("value",e);return this}else return this.get("value")},_resize:function(){this.menu.get("visible")&&
this._real()},_prepare:function(){function e(k){k=new G(k.target);g.contains(k)||g._4e_equals(k)||a.hide()}var b=this,g=b.el,u=b.get("popUpWidth"),j=b._focusA,a=new y.Overlay({autoRender:true,render:b.get("menuContainer"),content:"<div>",focus4e:false,elCls:"ke-menu",width:u?u:g.width(),zIndex:y.baseZIndex(y.zIndexManager.SELECT),focusMgr:false}),d=b.get("items");m.call(b,a);u=a.get("contentEl").one("div");b.menu=a;w.on(window,"resize",b._resize,b);m.call(b,function(){w.remove(window,"resize",b._resize,
b)});b.get("title")&&(new G("<div class='ke-menu-title ke-select-menu-item' style='margin-top:-6px;' >"+b.get("title")+"</div>")).appendTo(u);b._selectList=(new G("<div>")).appendTo(u);b._itemsChange({newVal:d});a.on("show",function(){j.addClass("ke-select-active")});a.on("hide",function(){j.removeClass("ke-select-active")});w.on(document,"click",e);m.call(b,function(){w.remove(document,"click",e)});b.get("doc")&&w.on(b.get("doc"),"click",e);u.on("click",b._select,b);b.as=b._selectList.all("a");w.on(u[0],
"mouseenter",function(){b.as.removeClass("ke-menu-selected")});m.call(b,u);b.on("afterItemsChange",b._itemsChange,b);b.menuNode=u},_stateChange:function(e){var b=this.el;e.newVal==1?b.removeClass("ke-select-disabled"):b.addClass("ke-select-disabled")},enable:function(){this.set("state",1)},disable:function(){this.set("state",0)},_select:function(e){e&&e.halt();var b=this.menu,g=this.menuNode;if((e=(new G(e.target))._4e_ascendant(function(a){return g.contains(a)&&a._4e_name()=="a"},true))&&e._4e_hasAttribute("data-value")){var u=
this.get("value"),j=e.attr("data-value");this.set("value",j);this.fire("click",{newVal:j,prevVal:u,name:e.html()});b.hide()}},_real:function(){var e=this.el,b=e.offset(),g=D.clone(b),u=this.menu.get("el").height(),j=this.menu.get("el").width(),a=x.scrollTop(),d=x.scrollLeft(),k=x.viewportHeight(),h=x.viewportWidth();h=d+h-60;k=a+k;var i=b.top+(e.height()-2);e=b.left+e.width()-2;var p=this.get("align"),r=p[0];if(p[1]=="b"){b.top=i;if(b.top+u>k&&g.top-a>k-i)b.top=g.top-u}else{b.top=g.top-u;if(b.top<
a&&g.top-a<k-i)b.top=i}if(r=="l"){if(b.left+j>h&&e-d>h-g.left)b.left=e-j}else{b.left=e-j;if(b.left<d&&e-d<h-g.left)b.left=g.left}this.menu.set("xy",[b.left,b.top]);this.menu.show()},_click:function(e){if(!this.loading){e&&e.preventDefault();var b=this;e=b.el;var g=b.get("value");if(!e.hasClass("ke-select-disabled"))if(b._focusA.hasClass("ke-select-active"))b.menu&&b.menu.hide();else{b.loading=true;y.use("overlay",function(){b.loading=false;b.fire("select");b._prepare();g&&b.menu&&b.as.each(function(u){u.attr("data-value")==
g?u.addClass("ke-menu-selected"):u.removeClass("ke-menu-selected")})})}}},destroy:function(){f.call(this);this.el.detach();this.el.remove()}});y.Select=o;y.prototype.addSelect=function(e,b){var g=this;b=D.mix({container:g.toolBarDiv,doc:g.document,menuContainer:new G(document.body)},b);var u=new o(b),j={btn:u,editor:g,cfg:b,call:function(){var a=D.makeArray(arguments),d=a.shift();return b[d].apply(j,a)},reload:function(a){D.mix(b,a);u.enable();g.on("selectionChange",function(){g.getMode()!=y.SOURCE_MODE&&
b.selectionChange&&b.selectionChange.apply(j,arguments)});u.on("click",function(d){var k=d.type;b[k]&&b[k].apply(j,arguments);d&&d.halt()});if(b.mode==y.WYSIWYG_MODE){g.on("wysiwygmode",u.enable,u);g.on("sourcemode",u.disable,u)}b.init&&b.init.call(j)},destroy:function(){b.destroy&&b.destroy.call(j);u.destroy()}};b.loading?u.disable():j.reload(undefined);return j}}},{attach:false});
