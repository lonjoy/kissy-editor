KISSY.Editor.add("walker",function(s){function m(b,d){if(this._.end)return j;var a,c=this.range,f,n=this.guard,p=this.type,t=b?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;c.trim();if(c.collapsed){this.end();return j}}if(!b&&!this._.guardLTR){var u=c.endContainer,v=new q(u[0].childNodes[c.endOffset]);this._.guardLTR=function(e,k){return(e=r._4e_wrap(e))&&e[0]&&(!k||!r._4e_equals(u,e))&&(!v[0]||!e._4e_equals(v))&&(e[0].nodeType!=l.NODE_ELEMENT||!k||e._4e_name()!="body")}}if(b&&
!this._.guardRTL){var w=c.startContainer,x=c.startOffset>0&&new q(w[0].childNodes[c.startOffset-1]);this._.guardRTL=function(e,k){return(e=r._4e_wrap(e))&&e[0]&&(!k||!e._4e_equals(w))&&(!x[0]||!e._4e_equals(x))&&(e[0].nodeType!=l.NODE_ELEMENT||!k||e._4e_name()!="body")}}var y=b?this._.guardRTL:this._.guardLTR;f=n?function(e,k){if(y(e,k)===g)return g;return n(e,k)}:y;if(this.current)a=this.current[t](g,p,f);else if(b){a=c.endContainer;if(c.endOffset>0){a=new q(a[0].childNodes[c.endOffset-1]);if(f(a)===
g)a=j}else a=f(a,i)===g?j:a._4e_previousSourceNode(i,p,f)}else{a=c.startContainer;if((a=new q(a[0].childNodes[c.startOffset]))&&a[0]){if(f(a)===g)a=j}else a=f(c.startContainer,i)===g?j:c.startContainer._4e_nextSourceNode(i,p,f)}for(;a&&a[0]&&!this._.end;){this.current=a;if(!this.evaluator||this.evaluator(a)!==g){if(!d)return a}else if(d&&this.evaluator)return g;a=a[t](g,p,f)}this.end();return this.current=j}function z(b){for(var d,a=j;d=m.call(this,b);)a=d;return a}function h(b){this.range=b;this._=
{}}var i=true,g=false,j=null,o=KISSY,B=o.UA,l=s.NODE,r=o.DOM,A=s.XHTML_DTD,q=o.Node;o.augment(h,{end:function(){this._.end=1},next:function(){return m.call(this)},previous:function(){return m.call(this,i)},checkForward:function(){return m.call(this,g,i)!==g},checkBackward:function(){return m.call(this,i,i)!==g},lastForward:function(){return z.call(this)},lastBackward:function(){return z.call(this,i)},reset:function(){delete this.current;this._={}}});h.blockBoundary=function(b){return function(d){d=
r._4e_wrap(d);return!(d&&d[0].nodeType==l.NODE_ELEMENT&&d._4e_isBlockBoundary(b))}};h.bookmark=function(b,d){function a(c){return c&&c[0]&&c._4e_name()=="span"&&c.attr("_ke_bookmark")}return function(c){var f,n;f=c&&c[0]&&c[0].nodeType==l.NODE_TEXT&&(n=c.parent())&&a(n);f=b?f:f||a(c);return d^f}};h.whitespaces=function(b){return function(d){d=(d=d[0]||d)&&d.nodeType==l.NODE_TEXT&&!o.trim(d.nodeValue);return b^d}};h.invisible=function(b){var d=h.whitespaces();return function(a){a=d(a)||a[0].nodeType==
l.NODE_ELEMENT&&!a[0].offsetHeight;return b^a}};var C=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,D=h.whitespaces(),E=h.bookmark();h.getBogus=function(b){do b=b._4e_previousSourceNode();while(E(b)||D(b)||b.type==1&&b._4e_name()in A.$inline&&!(b._4e_name()in A.$empty));if(b&&(!B.ie?b._4e_name()=="br":b[0].nodeType==3&&C.test(b.text())))return b;return false};s.Walker=h});
