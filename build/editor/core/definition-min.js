KISSY.Editor.add("definition",function(k){var q=true,w=false,A=k.Utils,z=document,l=KISSY,i=l.UA,u=i.ie,v=l.DOM,p=l.Node,n=l.Event,E=k.focusManager,H=A.tryThese,I=1,j="document.open();"+(A.isCustomDomain()?'document.domain="'+z.domain+'";':"")+"document.close();",J="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"' ></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+
(u?"javascript:void(function(){"+encodeURIComponent(j)+"}())":"")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>",F,y;F=k.SOURCE_MODE=0;y=k.WYSIWYG_MODE=1;k.SOURCE_MODE=F;k.WYSIWYG_MODE=y;l.augment(k,{init:function(b){var a=this;a.__commands={};a.__dialogs={};a.__plugins={};u&&v.addClass(z.body,"ke-ie"+u);if(i.trident)v.addClass(z.body,"ke-trident"+i.trident);else if(i.gecko)v.addClass(z.body,"ke-gecko");else i.webkit&&v.addClass(z.body,
"ke-webkit");var c=new p(J);a.editorWrap=c;a._UUID=I++;E.register(a);a.wrap=c.one(".ke-textarea-wrap");a.wrap=a.wrap;a.iframe=a.wrap.one("iframe");a.iframe=a.iframe;a.toolBarDiv=c.one(".ke-editor-tools");a.toolBarDiv=a.toolBarDiv;a.textarea=b;a.textarea=a.textarea;a.statusDiv=c.one(".ke-editor-status");a.statusDiv=a.statusDiv;A.preventFocus(a.toolBarDiv);var e=b._4e_style("width"),d=b._4e_style("height");if(e){c.css("width",e);b.css("width","100%")}a.textarea.css("display","none");c.insertAfter(b);
a.wrap[0].appendChild(b[0]);if(d){a.wrap.css("height",d);b.css("height","100%")}c=a.iframe;if(b._4e_hasAttribute("tabindex"))c[0].tabIndex=i.webkit?-1:b[0].tabIndex;a.on("dataReady",function(){a._ready=q;k.fire("instanceCreated",{editor:a})});i.gecko?c.on("load",a._setUpIFrame,a):a._setUpIFrame();a.cfg.attachForm&&b[0].form&&a._attachForm()},destroy:function(){if(!this.__destroyed){var b=this.editorWrap,a=this.textarea,c=this.document,e=this.iframe[0].contentWindow;this.sync();k.focusManager.remove(this);
n.remove(c);n.remove(c.documentElement);n.remove(c.body);n.remove(e);this.iframe.detach();c=this.__plugins;for(var d in c)if(c.hasOwnProperty(d)){e=c[d];e.destroy&&e.destroy()}this.fire("destroy");a.insertBefore(b);b.remove();a.css({width:b.css("width"),height:this.wrap.css("height")});a.show();this.__commands=this.__dialogs=this.__plugins=null;this.detach();this.__destroyed=true}},_attachForm:function(){var b=this,a=new p(b.textarea[0].form);a.on("submit",b.sync,b);b.on("destroy",function(){a.detach("submit",
b.sync,b)})},useDialog:function(b,a){var c=this,e=k.Overlay;e&&e.loading();c.use(b,function(){var d=c.getDialog(b);if(d){a(d);e&&e.unloading()}else l.later(arguments.callee,50,false,c)})},addDialog:function(b,a){this.__dialogs[b]=a},getDialog:function(b){return this.__dialogs[b]},destroyDialog:function(b){var a=this.__dialogs[b];a&&a.destroy();this.__dialogs[b]=null},addCommand:function(b,a){this.__commands[b]=a},hasCommand:function(b){return this.__commands[b]},execCommand:function(b){var a=this.__commands[b],
c=l.makeArray(arguments);c.shift();c.unshift(this);return a.exec.apply(a,c)},getMode:function(){return this.textarea.css("display")=="none"?y:F},getData:function(b){var a;a=this.getMode()==y?this.document&&this.document.body?this.document.body.innerHTML:"":this.textarea.val();if(this.htmlDataProcessor)a=b?this.htmlDataProcessor.toHtml(a,"p"):this.htmlDataProcessor.toServer(a,"p");a=l.trim(a);if(/^<p>((&nbsp;)|\s)*<\/p>$/.test(a))a="";return a},setData:function(b){var a=b;if(this.htmlDataProcessor)a=
this.htmlDataProcessor.toDataFormat(b,"p");this.document.body.innerHTML=a;if(!a)this.document.body.innerHTML=a;this.getMode()!=y&&this.textarea.val(b)},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(b){this.document.body.innerHTML=b},_prepareIFrameHtml:function(b){var a=this.cfg,c=a.customStyle;a=a.customLink;var e="",d=k.Utils.debugUrl("../theme/editor-iframe.css");if(a)for(var g=0;g<a.length;g++)e+='<link href="'+
a[g]+'" rel="stylesheet"/>';return"<!doctype html><html><head><title>${title}</title><link href='"+d+"' rel='stylesheet'/><style>"+(c||"")+"</style>"+e+"</head><body class='ke-editor'>&nbsp;"+(b?'<script id="ke_actscript" type="text/javascript">'+(A.isCustomDomain()?'document.domain="'+z.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+b+'");<\/script>':"")+"</body></html>"},getSelection:function(){return k.Selection.getSelection(this.document)},focus:function(){var b=this.document,a=v._4e_getWin(b);
i.webkit&&a&&a.parent&&a.parent.focus();i.webkit&&a&&a.focus();b&&b.body.focus();this.notifySelectionChange()},blur:function(){v._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},addCustomStyle:function(b){var a=this.cfg,c=this.document;a.customStyle=a.customStyle||"";a.customStyle+="\n"+b;a=c.createElement("style");c.getElementsByTagName("head")[0].appendChild(a);if(a.styleSheet)a.styleSheet.cssText=b;else a.appendChild(c.createTextNode(b))},addCustomLink:function(b){var a=
this.cfg,c=this.document;a.customLink=a.customLink||[];a.customLink.push(b);a=c.createElement("link");a.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(a);a.href=b},removeCustomLink:function(b){for(var a=this.cfg,c=l.makeArray(this.document.getElementsByTagName("link")),e=0;e<c.length;e++)c[e].href==b&&v._4e_remove(c[e]);a.customLink=a.customLink||[];a=a.customLink;b=l.indexOf(b,a);b!=-1&&a.splice(b,1)},_setUpIFrame:function(){function b(){g=d.document;a.document=g;c.detach();g.open("text/html",
"replace");g.write(e);g.close()}var a=this,c=a.iframe,e=a._prepareIFrameHtml(a._UUID),d=c[0].contentWindow,g;try{g=d.document}catch(r){c[0].src=c[0].src;if(u<7){setTimeout(b,10);return}}b()},ready:function(b){this._ready?b():this.on("dataReady",b)},addPlugin:function(b,a,c){this.__plugins=this.__plugins;c=c||{};c.func=a;this.__plugins[b]=c},usePlugin:function(b){var a=this.__plugins[b];if(a)if(!(a.status&&!a.duplicate)){b=this.Env.mods[b].requires||[];for(var c=0;c<b.length;c++)this.usePlugin(b[c]);
a.func.call(a);a.status=1}},_monitor:function(){var b=this;b._monitorId&&clearTimeout(b._monitorId);b._monitorId=setTimeout(function(){var a=b.getSelection();if(a&&!a.isInvalid){var c=a.getStartElement(),e=new k.ElementPath(c);if(!b.previousPath||!b.previousPath.compare(e)){b.previousPath=e;b.fire("selectionChange",{selection:a,path:e,element:c})}}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(b,a,c){var e=this;if(e.getMode()===y){e.focus();
var d,g=b._4e_name(),r=k.XHTML_DTD,m=k.RANGE,x=k.NODE,C=r.$block[g],B=e.getSelection(),f=B&&B.getRanges(),h,s,t,o;if(!f||f.length==0){var G=arguments,K=G.callee;setTimeout(function(){K.apply(e,G)},30)}else{e.fire("save");for(var D=f.length-1;D>=0;D--){h=f[D];h.deleteContents();d=!D&&b||b._4e_clone(q);a&&a(d);if(C)for(;(t=h.getCommonAncestor(w,q))&&(o=r[t._4e_name()])&&!(o&&o[g]);)if(t._4e_name()in r.span)h.splitElement(t);else if(h.checkStartOfBlock()&&h.checkEndOfBlock()){h.setStartBefore(t);h.collapse(q);
t._4e_remove()}else h.splitBlock();h.insertNode(d);s||(s=d)}if(s){g=s._4e_nextSourceNode(q);r=e.document;o=k.XHTML_DTD;if(o.$inline[d._4e_name()]){g=new p(r.createTextNode(" "));g.insertAfter(s)}else if(g){if(g._4e_name()=="br"&&o[g.parent()._4e_name()].p){o=new p("<p>&nbsp;</p>",null,r);g[0].parentNode.replaceChild(o[0],g[0]);g=o}}else{o=new p("<p>&nbsp;</p>",null,r);o.insertAfter(s);g=o}h.moveToPosition(s,m.POSITION_AFTER_END);g&&g[0].nodeType==x.NODE_ELEMENT&&h.moveToElementEditablePosition(g);
B.selectRanges([h]);e.focus();d&&d._4e_scrollIntoView();e._saveLater();c&&c(d)}}}},insertHtml:function(b,a){if(this.getMode()===y){if(this.htmlDataProcessor)b=this.htmlDataProcessor.toDataFormat(b,null,a);this.focus();this.fire("save");var c=this.document,e=0;if(u){var d=c.selection;d.type=="Control"&&d.clear();try{d.createRange().pasteHTML(b)}catch(g){l.log("insertHtml error in ie")}}else try{c.execCommand("inserthtml",w,b)}catch(r){setTimeout(function(){c.execCommand("inserthtml",w,b)},100);e=100}this.getSelection().scrollIntoView();
this._saveLater(e)}},_saveLater:function(b){var a=this;if(a.__saveTimer){clearTimeout(a.__saveTimer);a.__saveTimer=null}a.__saveTimer=setTimeout(function(){a.fire("save")},b||0)}});k._initIFrame=function(b){function a(f){H(function(){d.designMode="on";setTimeout(function(){d.designMode="off";m.focus();if(!arguments.callee.retry)arguments.callee.retry=q},50)},function(){d.designMode="off";v.attr(m,"contentEditable",w);v.attr(m,"contentEditable",q);!f&&a(1)})}var c=E.getInstance(b);b=c.textarea[0];
var e=c.iframe[0].contentWindow,d=c.document,g=c.cfg,r=d.getElementById("ke_actscript");v._4e_remove(r);var m=d.body;if(u){m.hideFocus=q;m.disabled=q;m.contentEditable=q;m.removeAttribute("disabled")}else setTimeout(function(){if(i.gecko||i.opera)m.contentEditable=q;else if(i.webkit)m.parentNode.contentEditable=q;else d.designMode="on"},0);if(i.webkit){n.on(d,"click",function(f){var h=new p(f.target);l.inArray(h._4e_name(),["input","select"])&&f.preventDefault()});n.on(d,"mouseup",function(f){var h=
new p(f.target);l.inArray(h._4e_name(),["input","textarea"])&&f.preventDefault()})}if(i.gecko||u||i.opera){var x;x=(new p('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(b);x.on("focus",function(){c.focus()});c.activateGecko=function(){i.gecko&&c.iframeFocus&&x[0].focus()};c.on("destroy",function(){x.detach();x.remove()})}if(d.documentMode||i.gecko||i.opera){var C=d.documentElement;n.on(C,"mousedown",function(f){if((new p(f.target))[0]==C){i.gecko&&
a(w);x[0].focus()}})}n.on(e,"focus",function(){if(i.gecko)a(w);else i.opera&&m.focus();c.notifySelectionChange()});i.gecko&&n.on(c.document,"mousedown",function(){c.iframeFocus||a(w)});if(u){n.on(d,"keydown",function(f){if(f.keyCode in{8:1,46:1}){var h=c.getSelection(),s=h.getSelectedElement();if(s){c.fire("save");var t=h.getRanges()[0].createBookmark();s._4e_remove();h.selectBookmarks([t]);c.fire("save");f.preventDefault()}}});if(d.compatMode=="CSS1Compat"){var B={33:1,34:1};n.on(d,"keydown",function(f){f.keyCode in
B&&setTimeout(function(){c.getSelection().scrollIntoView()},0)})}}setTimeout(function(){u&&setTimeout(function(){if(d){m.runtimeStyle.marginBottom="0px";m.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){c.fire("dataReady");var f=g.disableObjectResizing,h=g.disableInlineTableEditing;if(f||h)try{d.execCommand("enableObjectResizing",w,!f);d.execCommand("enableInlineTableEditing",w,!h)}catch(s){n.on(m,u?"resizestart":"resize",function(t){var o=new p(t.target);if(f||o._4e_name()==="table"&&
h)t.preventDefault()})}},10);i.webkit&&n.on(d,"mousedown",function(f){f=new p(f.target);l.inArray(f._4e_name(),["img","hr","input","textarea","select"])&&c.getSelection().selectElement(f)});i.gecko&&n.on(d,"dragstart",function(f){var h=new p(f.target);h._4e_name()==="img"&&/ke_/.test(h[0].className)&&f.preventDefault()});E.add(c)};document.documentMode>7&&function(){for(var b=l.all("link"),a=0;a<b.length;a++){var c=new p(b[a]),e=c.attr("href");e.indexOf("editor-pkg-min-mhtml.css")!=-1&&c.attr("href",
e.replace(/editor-pkg-min-mhtml\.css/g,"editor-pkg-min-datauri.css"))}}();j=k.prototype;A.extern(j,{removeCustomLink:j.removeCustomLink,addCustomLink:j.addCustomLink,setData:j.setData,getData:j.getData,insertElement:j.insertElement,insertHtml:j.insertHtml,ready:j.ready,addCustomStyle:j.addCustomStyle,addCommand:j.addCommand,hasCommand:j.hasCommand,execCommand:j.execCommand,useDialog:j.useDialog,addDialog:j.addDialog,getDialog:j.getDialog,getMode:j.getMode,sync:j.sync,getSelection:j.getSelection,focus:j.focus,
blur:j.blur,notifySelectionChange:j.notifySelectionChange})});
