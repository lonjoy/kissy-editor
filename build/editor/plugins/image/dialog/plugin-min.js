KISSY.Editor.add("image/dialog",function(w){function N(b){for(b=b.parent();b;){var a=b._4e_name();if(a=="a")return b;if(O.$block[a]||O.$blockLimit[a])break;b=b.parent()}return null}function T(){function b(c){if(c.files)return c.files[0].size;return 0}h=new e.Dialog({autoRender:true,width:500,headerContent:"\u56fe\u7247",bodyContent:U,footerContent:V,mask:true});t.call(p,h);var a=h.get("el"),k=a.one(".ke-img-cancel"),u=a.one(".ke-img-insert"),x=e.Utils.verifyInputs,G=a.one(".ke-img-setting");H=a.one(".ke-img-upload-form");
q=a.one(".ke-img-local-url");y=new e.Tabs({tabs:a.one("ul.ke-tabs"),contents:a.one("div.ke-image-tabs-content-wrap")});t.call(p,y);q.val(B);z=a.one(".ke-img-url");r=a.one(".ke-img-height");n=a.one(".ke-img-width");A=a.one(".ke-img-ratio");I=e.Select.decorate(a.one(".ke-img-align"));J=a.one(".ke-img-margin");C=a.one(".ke-img-link");D=a.one(".ke-img-link-blank");var i=e.Utils.placeholder;i(z,W);i(r,K);i(n,K);i(C,"http://");r.on("keyup",function(){var c=parseInt(f(r));!c||!A[0].checked||A[0].disabled||
!E||f(n,Math.floor(c*E))});t.call(p,r,z,n);n.on("keyup",function(){var c=parseInt(f(n));!c||!A[0].checked||A[0].disabled||!E||f(r,Math.floor(c/E))});t.call(p,n);k.on("click",function(c){h.hide();c.halt()});t.call(p,k);var g=(new L("<a class='ke-button' style='position:absolute;z-index:"+e.baseZIndex(e.zIndexManager.LOADING_CANCEL)+";left:-9999px;top:-9999px;'>\u53d6\u6d88\u4e0a\u4f20</a>")).appendTo(document.body),d=null;g.on("click",function(c){c&&c.halt();h.unloading();if(d){X.remove(d,"load");Y.remove(d)}g.css({left:-9999,
top:-9999});d=null});t.call(p,g);u.on("click",function(c){c.halt();if(y.activate()=="local"&&l){if(x(G.all("input")))if(q.val()==B)alert("\u8bf7\u5148\u9009\u62e9\u6587\u4ef6!");else if(Z.test(q.val())){c=b(v[0]);if(o&&o<c/1E3)alert("\u4e0a\u4f20\u56fe\u7247\u6700\u5927\uff1a"+o/1E3+"M");else{h.loading();d=e.Utils.doFormUpload({form:H,callback:function(j){d=null;g.css({left:-9999,top:-9999});j=s.trim(j.responseText).replace(/\r|\n/g,"");h.unloading();try{j=$.parse(j)}catch(ca){s.log(j);j=null}j||(j={error:"\u670d\u52a1\u5668\u51fa\u9519\uff0c\u8bf7\u91cd\u8bd5"});if(j.error)alert(j.error);else{f(z,j.imgUrl);
(new Image).src=j.imgUrl;P()}}},l.serverParams,l.serverUrl);c=h.get("el");var Q=c.offset();g.css({left:Q.left+c[0].offsetWidth/2.5,top:Q.top+c[0].offsetHeight/1.5})}}else{alert(aa);H[0].reset();q.val(B)}}else x(a.all("input"))&&P()});t.call(p,u);if(l){l.extraHtml&&a.one(".ke-img-up-extraHtml").html(l.extraHtml);var F=a.one(".ke-image-up"),o=l&&l.sizeLimit;v=(new L("<input type='file' style='position:absolute;cursor:pointer;left:"+(R.ie?"360":R.chrome?"319":"369")+"px;z-index:2;top:0px;height:26px;' size='1' name='"+
(l.fileInput||"Filedata")+"'/>")).insertAfter(q);if(o)B="\u5355\u5f20\u56fe\u7247\u5bb9\u91cf\u4e0d\u8d85\u8fc7 "+o/1E3+" M";q.val(B);v.css("opacity",0);v.on("mouseenter",function(){F.addClass("ke-button-hover")});v.on("mouseleave",function(){F.removeClass("ke-button-hover")});v.on("change",function(){var c=v.val();q.val(c.replace(/.+[\/\\]/,""))});t.call(p,v);M.remote===false&&y.remove("remote")}else y.remove("local")}function P(){var b=f(z),a,k=parseInt(f(r)),u=parseInt(f(n)),x=I.val(),G=parseInt(J.val()),i="";if(k)i+="height:"+k+"px;";if(u)i+=
"width:"+u+"px;";if(x)i+="float:"+x+";";isNaN(G)||(i+="margin:"+G+"px;");h.hide();if(m){a=m;w.fire("save");m.attr({src:b,_ke_saved_src:b,style:i})}else{a=new L("<img "+(i?"style='"+i+"'":"")+" src='"+b+"' _ke_saved_src='"+b+"' alt='' />",null,w.document);w.insertElement(a)}setTimeout(function(){var g=N(a),d=s.trim(f(C)),F=w.getSelection(),o;if(g)if(d)g.attr("_ke_saved_href",d).attr("href",d).attr("target",D.attr("checked")?"_blank":"_self");else{o=F.createBookmarks();g._4e_remove(true)}else if(d){o=
F.createBookmarks();g=new L("<a></a>");g.attr("_ke_saved_href",d).attr("href",d).attr("target",D.attr("checked")?"_blank":"_self");d=a[0];d.parentNode.replaceChild(g[0],d);g.append(d)}o&&F.selectBookmarks(o);m&&w.fire("save")},100)}var s=KISSY,e=s.Editor,O=e.XHTML_DTD,Y=s.DOM,R=s.UA,$=s.JSON,L=s.Node,X=s.Event,W="http://",K="\u81ea\u52a8",U="<div class='ke-image-wrap'><ul class='ke-tabs ks-clear'><li rel='remote'>\u7f51\u7edc\u56fe\u7247</li><li rel='local'>\u672c\u5730\u4e0a\u4f20</li></ul><div style='padding:12px 20px 5px 20px;'><div class='ke-image-tabs-content-wrap' ><div><label><span class='ke-image-title'>\u56fe\u7247\u5730\u5740\uff1a </span><input  data-verify='^(https?:/)?/[^\\s]+$'  data-warning='\u7f51\u5740\u683c\u5f0f\u4e3a\uff1ahttp:// \u6216 /' class='ke-img-url ke-input' style='width:390px;vertical-align:middle;' /></label></div><div style='position:relative;'><form class='ke-img-upload-form' method='post'><p style='zoom:1;'><input class='ke-input ke-img-local-url' readonly='readonly' style='margin-right: 15px; vertical-align: middle; width: 368px;color:#969696;'/><a style='padding:3px 11px;position:absolute;left:390px;top:0px;z-index:1;' class='ke-image-up ke-button'>\u6d4f\u89c8...</a></p><div class='ke-img-up-extraHtml'></div></form></div></div><table style='width:100%;margin-top:8px;' class='ke-img-setting'><tr><td><label>\u5bbd\u5ea6\uff1a <input  data-verify='^("+
K+"|((?!0$)\\d+))?$'  data-warning='\u5bbd\u5ea6\u8bf7\u8f93\u5165\u6b63\u6574\u6570' class='ke-img-width ke-input' style='vertical-align:middle;width:60px' /> \u50cf\u7d20 </label></td><td><label>\u9ad8\u5ea6\uff1a <input  data-verify='^("+K+"|((?!0$)\\d+))?$'  data-warning='\u9ad8\u5ea6\u8bf7\u8f93\u5165\u6b63\u6574\u6570' class='ke-img-height ke-input' style='vertical-align:middle;width:60px' /> \u50cf\u7d20 </label><label><input type='checkbox' class='ke-img-ratio' style='vertical-align:middle;margin-left:5px;' checked='checked'/> \u9501\u5b9a\u9ad8\u5bbd\u6bd4</label></td></tr><tr><td><label>\u5bf9\u9f50\uff1a<select class='ke-img-align' title='\u5bf9\u9f50'><option value='none'>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select></label></td><td><label>\u95f4\u8ddd\uff1a <input  data-verify='^\\d+$'  data-warning='\u95f4\u8ddd\u8bf7\u8f93\u5165\u975e\u8d1f\u6574\u6570' class='ke-img-margin ke-input' style='width:60px' value='10'/> \u50cf\u7d20</label></td></tr><tr><td colspan='2' style='padding-top: 6px'><label>\u94fe\u63a5\u7f51\u5740\uff1a <input class='ke-img-link ke-input' style='width:235px;vertical-align:middle;'  data-verify='^(?:(?:\\s*)|(?:https?://[^\\s]+)|(?:#.+))$'  data-warning='\u8bf7\u8f93\u5165\u5408\u9002\u7684\u7f51\u5740\u683c\u5f0f' /></label><label><input class='ke-img-link-blank' style='vertical-align:middle;margin-left:5px;' type='checkbox'/> &nbsp; \u5728\u65b0\u7a97\u53e3\u6253\u5f00\u94fe\u63a5</label></td></tr></table></div></div>",
V="<div style='padding:5px 20px 20px;'><a class='ke-img-insert ke-button' style='margin-right:30px;'>\u786e\u5b9a</a> <a  class='ke-img-cancel ke-button'>\u53d6\u6d88</a></div>",h,y,z,r,n,I,A,J,E,q,C,D,v,H,B="\u8bf7\u70b9\u51fb\u6d4f\u89c8\u4e0a\u4f20\u56fe\u7247",m,M=w.cfg.pluginConfig.image||{},l=M.upload||null,S=l&&l.suffix||"png,jpg,jpeg,gif",Z=RegExp(S.split(/,/).join("|")+"$","i"),aa="\u53ea\u5141\u8bb8\u540e\u7f00\u540d\u4e3a"+S+"\u7684\u56fe\u7247",p={},t=e.Utils.addRes,ba=e.Utils.destroyRes,f=e.Utils.valInput;e.use("overlay,tabs,select",function(){T();w.addDialog("image/dialog",{show:function(b){var a=
"remote",k=e.Utils.resetInput;if((m=b)&&M.remote!==false){f(z,m.attr("src"));b=m.width();var u=m.height();f(r,u);f(n,b);I.val(m.css("float")||"none");var x=parseInt(m._4e_style("margin"))||0;J.val(x);A[0].disabled=false;E=b/u;if(b=N(m)){f(C,b.attr("_ke_saved_href")||b.attr("href"));D.attr("checked",b.attr("target")=="_blank")}else{k(C);D.attr("checked",true)}}else{if(y.getTab("local"))a="local";D.attr("checked",true);k(z);k(C);k(r);k(n);I.val("none");J.val(10);A[0].disabled=true;E=null}H[0].reset();
q.val(B);y.activate(a);h.show()},hide:function(){h.hide()},destroy:function(){ba.call(p)},dialog:h})})},{attach:false});
