KISSY.Editor.add("bubbleview",function(){function p(a,e){if(a){var d=a._selectedEl;if(d){var f=e.iframe[0].contentWindow,c=e.iframe.offset(),h=c.top;c=c.left;var g=c+q.width(f);f=h+q.height(f);var b=d._4e_getOffset(document),m=b.top;b=b.left;var r=b+d.width();d=m+d.height();var n,o;if(d>f&&m<f)o=f-30;else if(d>h&&d<f)o=d;if(r>c&&b<c)n=c;else if(b>c&&b<g)n=b;if(n!==undefined&&o!==undefined)return[n,o]}}}function s(a){a=i[a];if(!a.bubble){a.bubble=new j;a.bubble.render();a.cfg.init&&a.cfg.init.call(a.bubble)}return a.bubble}
var l=KISSY,k=l.Editor,t=l.Event,q=l.DOM;if(k.BubbleView)l.log("attach bubbleview more","warn");else{var j=l.UIBase.create(k.Overlay,[],{renderUI:function(){this.get("el").addClass("ke-bubbleview-bubble")},show:function(a){if(a=p(this,a)){this.set("xy",[a.left,a.top]);var e,d=null;for(e in i)if(i.hasOwnProperty(e)){var f=i[e];if(f.bubble){var c;if(c=this!=f.bubble){if(c=f.bubble.get("visible")){var h=f.bubble;c=this.get("y");var g=c+this.get("el")[0].offsetHeight,b=h.get("y");h=b+h.get("el")[0].offsetHeight;
c=!(g<b||h<c)}c=c}if(c)if(d){if(d.get("y")<f.bubble.get("y"))d=f.bubble}else d=f.bubble}}if(e=d)a[1]=e.get("y")+e.get("el")[0].offsetHeight;j.superclass.show.call(this);this.set("xy",a)}},destructor:function(){k.Utils.destroyRes.call(this)}},{ATTRS:{focus4e:{value:false},zIndex:{value:k.baseZIndex(k.zIndexManager.BUBBLE_VIEW)}}}),i={};j.destroy=function(a){if((a=i[a])&&a.bubble){a.bubble.destroy();a.bubble=null}};j.attach=function(a){function e(){g&&g.hide()}var d=a.pluginName;l.mix(a,i[d].cfg,false);
var f=a.pluginContext,c=a.func,h=a.editor,g=a.bubble;h.on("selectionChange",function(b){b=b.path;var m=b.elements;if(b&&m)if(b=b.lastElement)if(b=c(b)){g=s(d);g._selectedEl=b;g._plugin=f;e();setTimeout(function(){g.show(h)},10)}else if(g){g._selectedEl=g._plugin=null;e()}});h.on("sourcemode",e);t.on(h.iframe[0].contentWindow,"scroll",k.Utils.buffer(function(){var b=p(g,h);if(b){g.set("xy",b);g.set("visible",true)}else e()},undefined,30))};j.register=function(a){var e=a.pluginName;i[e]=i[e]||{cfg:a};
a.editor&&j.attach(a)};k.BubbleView=j}},{attach:false,requires:["overlay"]});
