KISSY.Editor.add("bubbleview",function(){function r(a,h){var e=a._selectedEl,f=h.iframe[0].contentWindow,b=h.iframe.offset(),i=b.top;b=b.left;var p=b+s.width(f);f=i+s.height(f);var g=e._4e_getOffset(document),d=g.top;g=g.left;var q=g+e.width();e=d+e.height();var o,c;if(e>f&&d<f)c=f-30;else if(e>i&&e<f)c=e;if(q>b&&g<b)o=b;else if(g>b&&g<p)o=g;if(o!==undefined&&c!==undefined)return[o,c]}var l=KISSY,m=l.Editor,t=l.Event,s=l.DOM;if(m.BubbleView)l.log("attach bubbleview more","warn");else{var n=l.require("uibase").create(m.Overlay,
[],{renderUI:function(){this.get("el").addClass("ke-bubbleview-bubble")},show:function(a){if(a=r(this,a)){this.set("xy",[a.left,a.top]);var h,e=null;for(h in k)if(k.hasOwnProperty(h)){var f=k[h];if(f.bubble){var b;if(b=this!=f.bubble){if(b=f.bubble.get("visible")){var i=f.bubble;b=this.get("y");var p=b+this.get("el")[0].offsetHeight,g=i.get("y");i=g+i.get("el")[0].offsetHeight;b=!(p<g||i<b)}b=b}if(b)if(e){if(e.get("y")<f.bubble.get("y"))e=f.bubble}else e=f.bubble}}if(h=e)a[1]=h.get("y")+h.get("el")[0].offsetHeight;
n.superclass.show.call(this);this.set("xy",a)}},destructor:function(){m.Utils.destroyRes.call(this)}},{ATTRS:{focus4e:{value:false},zIndex:{value:m.baseZIndex(m.zIndexManager.BUBBLE_VIEW)}}}),k={};n.destroy=function(a){if((a=k[a])&&a.bubble){a.bubble.destroy();a.bubble=null}};n.attach=function(a){function h(){if(d){d.hide();t.remove(q,"scroll",e)}}function e(){if(d){d.get("el").stop(1);d.hide()}o()}function f(){t.on(q,"scroll",e);d.show(g)}var b=a.pluginName;l.mix(a,k[b].cfg,false);var i=a.pluginContext,
p=a.func,g=a.editor,d=a.bubble;g.on("selectionChange",function(c){c=c.path;var j=c.elements;if(c&&j)if(c=c.lastElement)if(c=p(c)){j=k[b];if(!j.bubble){j.bubble=new n;j.bubble.render();j.cfg.init&&j.cfg.init.call(j.bubble)}d=j.bubble;d._selectedEl=c;d._plugin=i;h();l.later(f,10)}else if(d){d._selectedEl=d._plugin=null;h()}});g.on("sourcemode",h);var q=g.iframe[0].contentWindow,o=m.Utils.buffer(function(){var c=r(d,g);if(c){d.set("xy",c);c=d.get("el");c.css("display","none");d.set("visible",true);c.fadeIn(0.3)}},
undefined,350)};n.register=function(a){var h=a.pluginName;k[h]=k[h]||{cfg:a};a.editor&&n.attach(a)};m.BubbleView=n}},{attach:false,requires:["overlay"]});
