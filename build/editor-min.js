/*
 Constructor for kissy editor,dependency moved to independent module
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com, lifesinger@gmail.com
 @version: 2
 @buildtime: 2012-01-12 16:25:38
*/
KISSY.add("editor/export",function(n){function w(m,p){var l=this;if(!(l instanceof w))return new w(m,p);if(n.isString(m))m=n.one(m);m=v._4e_wrap(m);p=p||{};p.pluginConfig=p.pluginConfig||{};l.cfg=p;p.pluginConfig=p.pluginConfig;l.cfg=p;n.app(l,n.EventTarget);var d=["htmldataprocessor","enterkey","clipboard"],b=r;l.use=function(c,e){c=c.split(",");if(!b)for(var t=0;t<d.length;t++){var q=d[t];n.inArray(q,c)||c.unshift(q)}l.ready(function(){n.Editor.use("button,select",function(){n.use.call(l,c.join(","),
function(){for(var a=0;a<c.length;a++)l.usePlugin(c[a]);e&&e.call(l);if(!b){l.setData(m.val());if(p.focus)l.focus();else(a=l.getSelection())&&a.removeAllRanges();b=z}},{global:w})})});return l};l.use=l.use;l.Config.base=w.Config.base;l.Config.debug=w.Config.debug;l.Config.componentJsName=s;l.init(m)}var v=n.DOM,z=true,r=false,s;s=parseFloat(n.version)<1.2?function(){return"plugin-min.js?t="+encodeURIComponent("2012-01-12 16:25:38")}:function(m,p){return m+"/plugin-min.js"+(p?p:"?t="+encodeURIComponent("2012-01-12 16:25:38"))};
n.app(w,n.EventTarget);w.Config.base=n.Config.base+"editor/plugins/";w.Config.debug=n.Config.debug;w.Config.componentJsName=s;n.Editor=w;n.Editor=w});KISSY.add("editor",function(n){return n.Editor},{requires:["dd","overlay"]});
KISSY.Editor.add("utils",function(n){var w=null,v=KISSY,z=v.Node,r=v.DOM,s=v.UA,m=v.Event,p;p=s.ie?document.documentMode||s.ie:void 0;var l={debugUrl:function(d){d=d.replace(/-min\.(js|css)/i,".$1");n.Config.debug||(d=d.replace(/\.(js|css)/i,"-min.$1"));if(d.indexOf("?t")==-1){d+=d.indexOf("?")!=-1?"&":"?";d+="t="+encodeURIComponent("2012-01-11 13:45:11")}return n.Config.base+d},lazyRun:function(d,b,c){var e=d[b],t=d[c];d[b]=function(){e.apply(this,arguments);d[b]=d[c];return t.apply(this,arguments)}},
getXY:function(d,b,c,e){c=c.defaultView||c.parentWindow;d-=r.scrollLeft(c);b-=r.scrollTop(c);if(e)if(c!=(e.defaultView||e.parentWindow)&&c.frameElement){e=r._4e_getOffset(c.frameElement,e);d+=e.left;b+=e.top}return{left:d,top:b}},tryThese:function(){for(var d,b=0,c=arguments.length;b<c;b++){var e=arguments[b];try{d=e();break}catch(t){}}return d},arrayCompare:function(d,b){if(!d&&!b)return true;if(!d||!b||d.length!=b.length)return false;for(var c=0;c<d.length;c++)if(d[c]!==b[c])return false;return true},
getByAddress:function(d,b,c){d=d.documentElement;for(var e=0;d&&e<b.length;e++){var t=b[e];if(c)for(var q=-1,a=0;a<d.childNodes.length;a++){var f=d.childNodes[a];if(!(c===true&&f.nodeType==3&&f.previousSibling&&f.previousSibling.nodeType==3)){q++;if(q==t){d=f;break}}}else d=d.childNodes[t]}return d?new z(d):w},clearAllMarkers:function(d){for(var b in d)d[b]._4e_clearMarkers(d,true)},htmlEncodeAttr:function(d){return d.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(d){return d.replace(/^\s+/,
"")},rtrim:function(d){return d.replace(/\s+$/,"")},trim:function(d){return this.ltrim(this.rtrim(d))},mix:function(){for(var d={},b=0;b<arguments.length;b++)d=v.mix(d,arguments[b]);return d},isCustomDomain:function(){if(!s.ie)return false;var d=document.domain,b=window.location.hostname;return d!=b&&d!="["+b+"]"},buffer:function(d,b,c){c=c||0;var e=w;return function(){e&&clearTimeout(e);var t=arguments;e=setTimeout(function(){return d.apply(b,t)},c)}},isNumber:function(d){return/^\d+(.\d+)?$/.test(v.trim(d))},
verifyInputs:function(d){for(var b=0;b<d.length;b++){var c=r._4e_wrap(d[b]),e=v.trim(l.valInput(c)),t=c.attr("data-verify");c=c.attr("data-warning");if(t&&!RegExp(t).test(e)){alert(c);return false}}return true},sourceDisable:function(d,b){d.on("sourcemode",b.disable,b);d.on("wysiwygmode",b.enable,b)},resetInput:function(d){var b=d.attr("placeholder");if(b&&s.ie){d.addClass("ke-input-tip");d.val(b)}else s.ie||d.val("")},valInput:function(d,b){if(b===undefined)return d.hasClass("ke-input-tip")?"":d.val();
else{d.removeClass("ke-input-tip");d.val(b)}},placeholder:function(d,b){d.attr("placeholder",b);if(s.ie){d.on("blur",function(){if(!v.trim(d.val())){d.addClass("ke-input-tip");d.val(b)}});d.on("focus",function(){d.removeClass("ke-input-tip");v.trim(d.val())==b&&d.val("")})}},htmlEncode:function(d){return!d?d:String(d).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(d){d=v.clone(d);for(var b in d)if(d.hasOwnProperty(b)){var c=d[b];if(v.isFunction(c))d[b]=
c()}return d},doFormUpload:function(d,b,c){function e(){var h={responseText:"",responseXML:w};h.argument=d?d.argument:w;try{var o;if((o=s.ie?q.contentWindow.document:q.contentDocument||window.frames[t].document)&&o.body)h.responseText=v.trim(r.text(o.body));h.responseXML=o&&o.XMLDocument?o.XMLDocument:o}catch(k){v.log("after data returns error ,maybe domain problem:");v.log(k,"error")}m.remove(q,"load",e);d.callback&&d.callback(h);setTimeout(function(){r._4e_remove(q)},100)}var t=v.guid("form-upload-"),
q=document.createElement("iframe");q.id=t;q.name=t;q.className="ke-hidden";var a="document.open();"+(l.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();";if(s.ie)q.src=s.ie?"javascript:void(function(){"+encodeURIComponent(a)+"}())":"";v.log("doFormUpload : "+q.src);document.body.appendChild(q);if(s.ie)document.frames[t].name=t;a=r._4e_unwrap(d.form);var f={target:r.attr(a,"target"),method:r.attr(a,"method"),encoding:r.attr(a,"encoding"),enctype:r.attr(a,"enctype"),action:r.attr(a,
"action")};r.attr(a,{target:t,method:"post",enctype:"multipart/form-data",encoding:"multipart/form-data"});c&&r.attr(a,"action",c);var i;if(b){i=[];b=n.Utils.normParams(b);for(var g in b)if(b.hasOwnProperty(g)){c=document.createElement("input");c.type="hidden";c.name=g;c.value=b[g];a.appendChild(c);i.push(c)}}m.on(q,"load",e);a.submit();r.attr(a,f);if(i){b=0;for(g=i.length;b<g;b++)r._4e_remove(i[b])}return q},map:function(d,b){for(var c=0;c<d.length;c++)d[c]=b(d[c]);return d},ieEngine:p,preventFocus:function(d){s.ie?
d._4e_unselectable():d.attr("onmousedown","return false;")},isFlashEmbed:function(d){d=d.attributes;return d.type=="application/x-shockwave-flash"||/\.swf(?:$|\?)/i.test(d.src||"")},addRes:function(){var d=this.__res=this.__res||[];d.push.apply(d,v.makeArray(arguments))},destroyRes:function(){for(var d=this.__res||[],b=0;b<d.length;b++){var c=d[b];if(v.isFunction(c))c();else{c.detach&&c.detach();c.destroy&&c.destroy();c.nodeType&&c.remove&&c.remove()}}this.__res=[]}};return n.Utils=l});
KISSY.Editor.add("dom",function(n){function w(a){return a.replace(/-(\w)/g,function(f,i){return i.toUpperCase()})}var v=KISSY,z=v.DOM,r=v.UA,s=v.Node,m=n.Utils,p={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};n.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};n.NODE=n.NODE;n.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,
POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};n.POSITION=n.POSITION;var l=n.NODE,d=n.POSITION,b={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},c={hr:1},e=function(a){return a[0]||a},t=function(a){if(a&&!a[0])return new s(a);return a},q={_4e_wrap:t,_4e_unwrap:e,_4e_equals:function(a,f){if(!a&&!f)return true;if(!a||!f)return false;a=e(a);f=e(f);
return a===f},_4e_isBlockBoundary:function(a,f){a=t(a);var i=v.mix(v.mix({},c),f||{});return b[a.css("display")]||i[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=e(a);for(var f=a.parentNode.childNodes,i=0;i<f.length;i++)if(f[i]===a)return i;return-1},_4e_first:function(a,f){a=e(a);var i=a.firstChild;if((i=i&&new s(i))&&f&&!f(i))i=i._4e_next(f);return i},_4e_move:function(a,f,i){a=e(a);z._4e_remove(a);
f=e(f);i?f.insertBefore(a,f.firstChild):f.appendChild(a)},_4e_name:function(a){a=e(a);var f=a.nodeName.toLowerCase();if(r.ie)if((a=a.scopeName)&&a!="HTML")f=a.toLowerCase()+":"+f;return f},_4e_isIdentical:function(a,f){if(a._4e_name()!=f._4e_name())return false;var i=a[0].attributes,g=f[0].attributes,h=i.length,o=g.length;if(h!=o)return false;for(var k=0;k<h;k++){var u=i[k],x=u.name;if(u.specified&&a.attr(x)!=f.attr(x))return false}if(m.ieEngine<8)for(k=0;k<o;k++){u=g[k];x=u.name;if(u.specified&&
a.attr(x)!=f.attr(x))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=e(a).childNodes;for(var f=0,i=a.length;f<i;f++){var g=a[f],h=g.nodeType;if(!(h==l.NODE_ELEMENT&&g.getAttribute("_ke_bookmark")))if(h==l.NODE_ELEMENT&&!q._4e_isEmptyInlineRemoveable(g)||h==l.NODE_TEXT&&v.trim(g.nodeValue))return false}return true},_4e_moveChildren:function(a,f,i){a=e(a);f=f[0]||f;if(a!=f)if(i)for(;i=a.lastChild;)f.insertBefore(a.removeChild(i),f.firstChild);else for(;i=a.firstChild;)f.appendChild(a.removeChild(i))},
_4e_mergeSiblings:function(){function a(f,i,g){if(i[0]&&i[0].nodeType==l.NODE_ELEMENT){for(var h=[];i.attr("_ke_bookmark")||i._4e_isEmptyInlineRemoveable();){h.push(i);i=g?new s(i[0].nextSibling):new s(i[0].previousSibling);if(!i[0]||i[0].nodeType!=l.NODE_ELEMENT)return}if(f._4e_isIdentical(i)){for(var o=g?f[0].lastChild:f[0].firstChild;h.length;)h.shift()._4e_move(f,!g);i._4e_moveChildren(f,!g);i._4e_remove();o[0]&&o[0].nodeType==l.NODE_ELEMENT&&o._4e_mergeSiblings()}}}return function(f){if(f[0])if(p[f._4e_name()]||
f._4e_name()=="a"){a(f,new s(f[0].nextSibling),true);a(f,new s(f[0].previousSibling))}}}(),_4e_unselectable:r.gecko?function(a){a=e(a);a.style.MozUserSelect="none"}:r.webkit?function(a){a=e(a);a.style.KhtmlUserSelect="none"}:function(a){a=e(a);if(r.ie||r.opera){var f=0;a.setAttribute("unselectable","on");for(var i=a.getElementsByTagName("*");a=i[f++];)switch(a.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:a.setAttribute("unselectable","on")}}},_4e_getOffset:function(a,
f){a=e(a);var i,g=0;i=0;var h=a.ownerDocument.defaultView||a.ownerDocument.parentWindow,o=a.ownerDocument,k=o.documentElement;f=f||o;if(a.getBoundingClientRect){if(a!==o.body&&k!==a){i=a.getBoundingClientRect();g=i.left+(f===o?z.scrollLeft(h):0);i=i.top+(f===o?z.scrollTop(h):0)}if(f)if(h!=(f.defaultView||f.parentWindow)&&h.frameElement){h=q._4e_getOffset(h.frameElement,f);g+=h.left;i+=h.top}}return{left:g,top:i}},_4e_splitText:function(a,f){a=e(a);var i=a.ownerDocument;if(!(!a||a.nodeType!=l.NODE_TEXT)){if(r.ie&&
f==a.nodeValue.length){var g=i.createTextNode("");z.insertAfter(g,a);return new s(g)}g=new s(a.splitText(f));if(i.documentMode){i=i.createTextNode("");z.insertAfter(i,g[0]);z._4e_remove(i)}return g}},_4e_parents:function(a,f){a=t(a);var i=[];do i[f?"push":"unshift"](a);while(a=a.parent());return i},_4e_clone:function(a,f,i){a=e(a);a=a.cloneNode(f);if(!i){var g=function(h){if(h.nodeType==l.NODE_ELEMENT){h.removeAttribute("id");h=h.childNodes;for(var o=0;o<h.length;o++)g(h[o])}};g(a)}return new s(a)},
_4e_nextSourceNode:function(a,f,i,g){a=e(a);if(g&&!g.call){var h=g[0]||g;g=function(k){k=k[0]||k;return k!==h}}f=!f&&a.firstChild;var o=new s(a);if(!f){if(a.nodeType==l.NODE_ELEMENT&&g&&g(a,true)===false)return null;f=a.nextSibling}for(;!f&&(o=o.parent());){if(g&&g(o,true)===false)return null;f=o[0].nextSibling}if(!f)return null;f=z._4e_wrap(f);if(g&&g(f)===false)return null;if(i&&i!=f[0].nodeType)return f._4e_nextSourceNode(false,i,g);return f},_4e_previousSourceNode:function(a,f,i,g){a=e(a);if(g&&
!g.call){var h=g[0]||g;g=function(k){k=k[0]||k;return k!==h}}f=!f&&a.lastChild;var o=new s(a);if(!f){if(a.nodeType==l.NODE_ELEMENT&&g&&g(a,true)===false)return null;f=a.previousSibling}for(;!f&&(o=o.parent());){if(g&&g(o,true)===false)return null;f=o[0].previousSibling}if(!f)return null;f=z._4e_wrap(f);if(g&&g(f)===false)return null;if(i&&f[0].nodeType!=i)return f._4e_previousSourceNode(false,i,g);return f},_4e_commonAncestor:function(a,f){if(a._4e_equals(f))return a;if(f[0].nodeType!=l.NODE_TEXT&&
f.contains(a))return f;var i=a[0].nodeType==l.NODE_TEXT?a.parent():a;do if(i[0].nodeType!=l.NODE_TEXT&&i.contains(f))return i;while(i=i.parent());return null},_4e_ascendant:function(a,f,i){a=e(a);if(!i)a=a.parentNode;if(f&&!v.isFunction(f)){var g=f;f=function(h){return h._4e_name()==g}}for(;a&&a.nodeType!=9;){if(!f||f(new s(a))===true)return new s(a);a=a.parentNode}return null},_4e_hasAttribute:m.ieEngine<9?function(a,f){a=e(a);var i=a.getAttributeNode(f);return!!(i&&i.specified)}:function(a,f){a=
e(a);return a.hasAttribute(f)},_4e_hasAttributes:m.ieEngine<9?function(a){a=e(a);for(var f=a.attributes,i=0;i<f.length;i++){var g=f[i];switch(g.name){case "class":if(a.getAttribute("class"))return true;break;default:if(g.specified)return true}}return false}:function(a){a=e(a);r.gecko&&a.removeAttribute("_moz_dirty");return a.hasAttributes()},_4e_position:function(a,f){var i=e(a),g=e(f);if(i.compareDocumentPosition)return i.compareDocumentPosition(g);if(i==g)return d.POSITION_IDENTICAL;if(i.nodeType==
l.NODE_ELEMENT&&g.nodeType==l.NODE_ELEMENT){if(i.contains){if(i.contains(g))return d.POSITION_CONTAINS+d.POSITION_PRECEDING;if(g.contains(i))return d.POSITION_IS_CONTAINED+d.POSITION_FOLLOWING}if("sourceIndex"in i)return i.sourceIndex<0||g.sourceIndex<0?d.POSITION_DISCONNECTED:i.sourceIndex<g.sourceIndex?d.POSITION_PRECEDING:d.POSITION_FOLLOWING}i=a._4e_address();g=f._4e_address();for(var h=Math.min(i.length,g.length),o=0;o<=h-1;o++)if(i[o]!=g[o]){if(o<h)return i[o]<g[o]?d.POSITION_PRECEDING:d.POSITION_FOLLOWING;
break}return i.length<g.length?d.POSITION_CONTAINS+d.POSITION_PRECEDING:d.POSITION_IS_CONTAINED+d.POSITION_FOLLOWING},_4e_address:function(a,f){a=e(a);for(var i=[],g=a.ownerDocument.documentElement,h=a;h&&h!=g;){var o=h.parentNode,k=-1;if(o){for(var u=0;u<o.childNodes.length;u++){var x=o.childNodes[u];if(!(f&&x.nodeType==3&&x.previousSibling&&x.previousSibling.nodeType==3)){k++;if(x==h)break}}i.unshift(k)}h=o}return i},_4e_breakParent:function(a,f){var i=new n.Range(a[0].ownerDocument);i.setStartAfter(a);
i.setEndAfter(f);var g=i.extractContents();i.insertNode(a._4e_remove());a[0].parentNode.insertBefore(g,a[0].nextSibling)},_4e_style:function(a,f,i){if(i!==undefined){a=t(a);a.css(f,i);var g=a[0].style;i==""&&g.removeAttribute&&g.removeAttribute(f);g.cssText||a[0].removeAttribute("style")}else{a=e(a);return a.style[w(f)]}},_4e_remove:function(a,f){var i=e(a),g=i.parentNode;if(g){if(f)for(var h;h=i.firstChild;)g.insertBefore(i.removeChild(h),i);g.removeChild(i)}return a},_4e_trim:function(a){z._4e_ltrim(a);
z._4e_rtrim(a)},_4e_ltrim:function(a){a=e(a);for(var f;f=a.firstChild;){if(f.nodeType==l.NODE_TEXT){var i=m.ltrim(f.nodeValue),g=f.nodeValue.length;if(i){if(i.length<g){(new s(f))._4e_splitText(g-i.length);a.removeChild(a.firstChild)}}else{a.removeChild(f);continue}}break}},_4e_rtrim:function(a){a=e(a);for(var f;f=a.lastChild;){if(f.type==l.NODE_TEXT){var i=m.rtrim(f.nodeValue),g=f.nodeValue.length;if(i){if(i.length<g){(new s(f))._4e_splitText(i.length);a.removeChild(a.lastChild)}}else{a.removeChild(f);
continue}}break}if(!r.ie&&!r.opera)(f=a.lastChild)&&f.nodeType==1&&f.nodeName.toLowerCase()=="br"&&f.parentNode.removeChild(f)},_4e_appendBogus:function(a){a=e(a);for(var f=a.lastChild;f&&f.nodeType==l.NODE_TEXT&&!v.trim(f.nodeValue);)f=f.previousSibling;if(!f||f.nodeType==l.NODE_TEXT||z._4e_name(f)!=="br"){f=r.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br");r.gecko&&f.setAttribute("type","_moz");a.appendChild(f)}},_4e_getBogus:function(a){return n.Walker.getBogus(t(a))},
_4e_previous:function(a,f){var i=e(a),g;do g=(i=i.previousSibling)&&new s(i);while(g&&f&&!f(g));return g},_4e_last:function(a,f){a=z._4e_wrap(a);var i=a[0].lastChild;if((i=i&&new s(i))&&f&&!f(i))i=i._4e_previous(f);return i},_4e_next:function(a,f){var i=e(a),g;do g=(i=i.nextSibling)&&new s(i);while(g&&f&&!f(g));return g},_4e_outerHtml:function(a){a=e(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var f=a.ownerDocument.createElement("div");f.appendChild(a.cloneNode(true));return f.innerHTML},
_4e_setMarker:function(a,f,i,g){a=z._4e_wrap(a);var h=a.data("list_marker_id")||a.data("list_marker_id",v.guid()).data("list_marker_id"),o=a.data("list_marker_names")||a.data("list_marker_names",{}).data("list_marker_names");f[h]=a;o[i]=1;return a.data(i,g)},_4e_clearMarkers:function(a,f,i){a=t(a);var g=a.data("list_marker_names"),h=a.data("list_marker_id"),o;for(o in g)a.removeData(o);a.removeData("list_marker_names");if(i){a.removeData("list_marker_id");delete f[h]}},_4e_copyAttributes:function(a,
f,i){a=e(a);f=t(f);var g=a.attributes;i=i||{};for(var h=0;h<g.length;h++){var o=g[h],k=o.name.toLowerCase(),u;if(!(k in i))if(k=="checked"&&(u=z.attr(a,k)))f.attr(k,u);else if(o.specified||r.ie&&o.value&&k=="value"){u=z.attr(a,k);if(u===null)u=o.nodeValue;f.attr(k,u)}}if(a.style.cssText!=="")f[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=z._4e_name(a);var f=n.XHTML_DTD;return(a=!f.$nonEditable[a]&&(f[a]||f.span))&&a["#"]},_4e_scrollIntoView:function(a){a=t(a);a.scrollIntoView(a[0].ownerDocument,
false)},_4e_getElementsByTagName:function(a,f,i){a=e(a);if(!r.ie&&i)f=i+":"+f;i=[];a=a.getElementsByTagName(f);for(f=0;f<a.length;f++)i.push(new s(a[f]));return i}};(function(a){v.mix(z,a);for(var f in a)a.hasOwnProperty(f)&&function(i){s.prototype[i]=function(){var g=[].slice.call(arguments,0);g.unshift(this);return a[i].apply(null,g)}}(f)})(q)});
KISSY.Editor.add("focusmanager",function(n){function w(){var e=this;e.iframeFocus=d;l=e;p&&clearTimeout(p);p=setTimeout(function(){e.fire("focus")},100)}function v(){var e=this;e.iframeFocus=b;l=c;p&&clearTimeout(p);p=setTimeout(function(){e.fire("blur")},100)}var z=KISSY,r=z.DOM,s=z.Event,m={},p,l;z={refreshAll:function(){for(var e in m){var t=m[e];t.document.designMode="off";t.document.designMode="on"}},currentInstance:function(){return l},getInstance:function(e){return m[e]},add:function(e){var t=
r._4e_getWin(e.document);s.on(t,"focus",w,e);s.on(t,"blur",v,e)},register:function(e){m[e._UUID]=e},remove:function(e){delete m[e._UUID];var t=r._4e_getWin(e.document);s.remove(t,"focus",w,e);s.remove(t,"blur",v,e)}};var d=true,b=false,c=null;z.refreshAll=z.refreshAll;n.focusManager=z;n.focusManager=z;n.getInstances=function(){return m};n.getInstances=n.getInstances});
KISSY.Editor.add("definition",function(n){var w=true,v=false,z=n.Utils,r=document,s=KISSY,m=s.UA,p=m.ie,l=s.DOM,d=s.Node,b=s.Event,c=n.focusManager,e=z.tryThese,t=1,q="document.open();"+(z.isCustomDomain()?'document.domain="'+r.domain+'";':"")+"document.close();",a="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"' ></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor" '+
(p?' src="javascript:void(function(){'+encodeURIComponent(q)+'}())"':"")+' allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>",f,i;f=n.SOURCE_MODE=0;i=n.WYSIWYG_MODE=1;n.SOURCE_MODE=f;n.WYSIWYG_MODE=i;s.augment(n,{init:function(g){var h=this,o;h.__commands={};h.__dialogs={};h.__plugins={};p&&l.addClass(r.body,"ke-ie"+p);if(m.trident)l.addClass(r.body,"ke-trident"+m.trident);else if(m.gecko)l.addClass(r.body,"ke-gecko");else m.webkit&&l.addClass(r.body,
"ke-webkit");o=new d(a);h.editorWrap=o;h._UUID=t++;c.register(h);h.wrap=o.one(".ke-textarea-wrap");h.iframe=h.wrap.one("iframe");h.toolBarDiv=o.one(".ke-editor-tools");h.textarea=g;h.statusDiv=o.one(".ke-editor-status");z.preventFocus(h.toolBarDiv);var k=g._4e_style("width"),u=g._4e_style("height");if(k){o.css("width",k);g.css("width","100%")}h.textarea.css("display","none");o.insertAfter(g);h.wrap[0].appendChild(g[0]);if(u){h.wrap.css("height",u);g.css("height","100%")}o=h.iframe;if(g._4e_hasAttribute("tabindex"))o[0].tabIndex=
m.webkit?-1:g[0].tabIndex;h.on("dataReady",function(){h._ready=w;n.fire("instanceCreated",{editor:h})});m.gecko?o.on("load",h._setUpIFrame,h):h._setUpIFrame();h.cfg.attachForm&&g[0].form&&h._attachForm()},destroy:function(){if(!this.__destroyed){var g=this.editorWrap,h=this.textarea,o=this.document,k=this.iframe[0].contentWindow;this.sync();n.focusManager.remove(this);b.remove(o);b.remove(o.documentElement);b.remove(o.body);b.remove(k);this.iframe.detach();o=this.__plugins;for(var u in o)if(o.hasOwnProperty(u)){k=
o[u];k.destroy&&k.destroy()}this.fire("destroy");h.insertBefore(g);g.remove();h.css({width:g[0].style.width,height:this.wrap.css("height")});h.show();this.__commands=this.__dialogs=this.__plugins=null;this.detach();this.__destroyed=true}},_attachForm:function(){var g=this,h=new d(g.textarea[0].form);h.on("submit",g.sync,g);g.on("destroy",function(){h.detach("submit",g.sync,g)})},useDialog:function(g,h){var o=this,k=n.Overlay;k&&k.loading();o.use(g,function(){var u=o.getDialog(g);if(u){h(u);k&&k.unloading()}else s.later(arguments.callee,
50,false,o)})},showDialog:function(g,h,o){var k=this;h=h||[];k.useDialog(g,function(u){u.show.apply(u,h);o&&o(u);k.fire("dialogShow",{dialog:u.dialog,pluginDialog:u,dialogName:g})})},addDialog:function(g,h){this.__dialogs[g]=h},getDialog:function(g){return this.__dialogs[g]},destroyDialog:function(g){var h=this.__dialogs[g];h&&h.destroy();this.__dialogs[g]=null},addCommand:function(g,h){this.__commands[g]=h},hasCommand:function(g){return this.__commands[g]},execCommand:function(g){var h=this.__commands[g],
o=s.makeArray(arguments);o.shift();o.unshift(this);return h.exec.apply(h,o)},getMode:function(){return this.textarea.css("display")=="none"?i:f},getData:function(g){var h;h=this.getMode()==i?this.document&&this.document.body?this.document.body.innerHTML:"":this.textarea.val();if(this.htmlDataProcessor)h=g?this.htmlDataProcessor.toHtml(h,"p"):this.htmlDataProcessor.toServer(h,"p");h=s.trim(h);if(/^<p>((&nbsp;)|\s)*<\/p>$/.test(h))h="";return h},setData:function(g){var h=g;if(this.htmlDataProcessor)h=
this.htmlDataProcessor.toDataFormat(g,"p");this.document.body.innerHTML=h;if(!h)this.document.body.innerHTML=h;this.getMode()!=i&&this.textarea.val(g)},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(g){this.document.body.innerHTML=g},_prepareIFrameHtml:function(g){var h=this.cfg,o=h.customStyle;h=h.customLink;var k="",u=n.Utils.debugUrl("../theme/editor-iframe.css");if(h)for(var x=0;x<h.length;x++)k+='<link href="'+
h[x]+'" rel="stylesheet"/>';return"<!doctype html><html><head>"+(r.documentMode===8?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"")+"<title>${title}</title><link href='"+u+"' rel='stylesheet'/><style>"+(o||"")+"</style>"+k+"</head><body class='ke-editor'>&nbsp;"+(g?'<script id="ke_actscript" type="text/javascript">'+(z.isCustomDomain()?'document.domain="'+r.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+g+'");<\/script>':"")+"</body></html>"},getSelection:function(){return n.Selection.getSelection(this.document)},
focus:function(){var g=this.document,h=l._4e_getWin(g);m.ie||h&&h.parent&&h.parent.focus();h&&h.focus();g&&g.body.focus();this.notifySelectionChange()},blur:function(){l._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},addCustomStyle:function(g){var h=this.cfg,o=this.document;h.customStyle=h.customStyle||"";h.customStyle+="\n"+g;h=o.createElement("style");o.getElementsByTagName("head")[0].appendChild(h);if(h.styleSheet)h.styleSheet.cssText=g;else h.appendChild(o.createTextNode(g))},
addCustomLink:function(g){var h=this.cfg,o=this.document;h.customLink=h.customLink||[];h.customLink.push(g);h=o.createElement("link");h.rel="stylesheet";o.getElementsByTagName("head")[0].appendChild(h);h.href=g},removeCustomLink:function(g){for(var h=this.cfg,o=s.makeArray(this.document.getElementsByTagName("link")),k=0;k<o.length;k++)o[k].href==g&&l._4e_remove(o[k]);h.customLink=h.customLink||[];h=h.customLink;g=s.indexOf(g,h);g!=-1&&h.splice(g,1)},_setUpIFrame:function(){function g(){x=u.document;
h.document=x;o.detach();x.open("text/html","replace");x.write(k);x.close()}var h=this,o=h.iframe,k=h._prepareIFrameHtml(h._UUID),u=o[0].contentWindow,x;try{x=u.document}catch(E){o[0].src=o[0].src;if(p<7){setTimeout(g,10);return}}g()},ready:function(g){this._ready?g():this.on("dataReady",g)},addPlugin:function(g,h,o){this.__plugins=this.__plugins;o=o||{};o.func=h;this.__plugins[g]=o},usePlugin:function(g){var h=this.__plugins[g];if(h)if(!(h.status&&!h.duplicate)){g=this.Env.mods[g].requires||[];for(var o=
0;o<g.length;o++)this.usePlugin(g[o]);h.func.call(h);h.status=1}},_monitor:function(){var g=this;g._monitorId&&clearTimeout(g._monitorId);g._monitorId=setTimeout(function(){var h=g.getSelection();if(h&&!h.isInvalid){var o=h.getStartElement(),k=new n.ElementPath(o);if(!g.previousPath||!g.previousPath.compare(k)){g.previousPath=k;g.fire("selectionChange",{selection:h,path:k,element:o})}}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(g,h,o){var k=
this;if(k.getMode()===i){k.focus();var u,x=g._4e_name(),E=n.XHTML_DTD,j=n.RANGE,y=n.NODE,C=E.$block[x],A=k.getSelection(),B=A&&A.getRanges(),D,K,M,O;if(!B||B.length==0){var R=arguments,U=R.callee;setTimeout(function(){U.apply(k,R)},30)}else{k.fire("save");for(var S=B.length-1;S>=0;S--){D=B[S];D.deleteContents();u=!S&&g||g._4e_clone(w);h&&h(u);if(C)for(;(M=D.getCommonAncestor(v,w))&&(O=E[M._4e_name()])&&!(O&&O[x]);)if(M._4e_name()in E.span)D.splitElement(M);else if(D.checkStartOfBlock()&&D.checkEndOfBlock()){D.setStartBefore(M);
D.collapse(w);M._4e_remove()}else D.splitBlock();D.insertNode(u);K||(K=u)}if(K){x=K._4e_nextSourceNode(w);E=k.document;O=n.XHTML_DTD;if(O.$inline[u._4e_name()]){x=new d(E.createTextNode(" "));x.insertAfter(K)}else if(x){if(x._4e_name()=="br"&&O[x.parent()._4e_name()].p){O=new d("<p>&nbsp;</p>",null,E);x[0].parentNode.replaceChild(O[0],x[0]);x=O}}else{O=new d("<p>&nbsp;</p>",null,E);O.insertAfter(K);x=O}D.moveToPosition(K,j.POSITION_AFTER_END);x&&x[0].nodeType==y.NODE_ELEMENT&&D.moveToElementEditablePosition(x);
A.selectRanges([D]);k.focus();u&&u._4e_scrollIntoView();k._saveLater();o&&o(u)}}}},insertHtml:function(g,h){var o=this;if(o.getMode()===i){if(o.htmlDataProcessor)g=o.htmlDataProcessor.toDataFormat(g,null,h);o.focus();o.fire("save");var k=o.document,u=0;if(p){var x=k.selection;x.type=="Control"&&x.clear();try{x.createRange().pasteHTML(g)}catch(E){s.log("insertHtml error in ie")}}else try{k.execCommand("inserthtml",v,g)}catch(j){setTimeout(function(){if(o.getSelection().getRanges().length==0){var y=
new n.Range(k),C=l._4e_first(k.body,function(A){return A[0].nodeType==1&&A._4e_name()!="br"});if(!C){C=new d(k.createElement("p"));k.body.appendChild(C[0])}y.setStartAt(C,n.RANGE.POSITION_AFTER_START);y.select()}k.execCommand("inserthtml",v,g)},u=100)}setTimeout(function(){o.getSelection().scrollIntoView()},u);o._saveLater(u)}},_saveLater:function(g){var h=this;if(h.__saveTimer){clearTimeout(h.__saveTimer);h.__saveTimer=null}h.__saveTimer=setTimeout(function(){h.fire("save")},g||0)}});n._initIFrame=
function(g){function h(B){e(function(){u.designMode="on";setTimeout(function(){u.designMode="off";j.focus();if(!arguments.callee.retry)arguments.callee.retry=w},50)},function(){u.designMode="off";l.attr(j,"contentEditable",v);l.attr(j,"contentEditable",w);!B&&h(1)})}var o=c.getInstance(g);g=o.textarea[0];var k=o.iframe[0].contentWindow,u=o.document,x=o.cfg,E=u.getElementById("ke_actscript");l._4e_remove(E);var j=u.body;if(p){j.hideFocus=w;j.disabled=w;j.contentEditable=w;j.removeAttribute("disabled")}else setTimeout(function(){if(m.gecko||
m.opera)j.contentEditable=w;else if(m.webkit)j.parentNode.contentEditable=w;else u.designMode="on"},0);if(m.webkit){b.on(u,"click",function(B){var D=new d(B.target);s.inArray(D._4e_name(),["input","select"])&&B.preventDefault()});b.on(u,"mouseup",function(B){var D=new d(B.target);s.inArray(D._4e_name(),["input","textarea"])&&B.preventDefault()})}if(m.gecko||p||m.opera){var y;y=(new d('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(g);y.on("focus",
function(){o.focus()});o.activateGecko=function(){m.gecko&&o.iframeFocus&&y[0].focus()};o.on("destroy",function(){y.detach();y.remove()})}if(m.gecko||m.opera){var C=u.documentElement;b.on(C,"mousedown",function(B){if(B.target==C){m.gecko&&h(v);y[0].focus()}})}b.on(k,"focus",function(){if(m.gecko)h(v);else m.opera&&j.focus();o.notifySelectionChange()});m.gecko&&b.on(o.document,"mousedown",function(){o.iframeFocus||h(v)});if(p){b.on(u,"keydown",function(B){if(B.keyCode in{8:1,46:1}){var D=o.getSelection(),
K=D.getSelectedElement();if(K){o.fire("save");var M=D.getRanges()[0].createBookmark();K._4e_remove();D.selectBookmarks([M]);o.fire("save");B.preventDefault()}}});if(u.compatMode=="CSS1Compat"){var A={33:1,34:1};b.on(u,"keydown",function(B){B.keyCode in A&&setTimeout(function(){o.getSelection().scrollIntoView()},0)})}}setTimeout(function(){p&&setTimeout(function(){if(u){j.runtimeStyle.marginBottom="0px";j.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){o.fire("dataReady");var B=x.disableObjectResizing,
D=x.disableInlineTableEditing;if(B||D)try{u.execCommand("enableObjectResizing",v,!B);u.execCommand("enableInlineTableEditing",v,!D)}catch(K){b.on(j,p?"resizestart":"resize",function(M){var O=new d(M.target);if(B||O._4e_name()==="table"&&D)M.preventDefault()})}},10);m.webkit&&b.on(u,"mousedown",function(B){B=new d(B.target);s.inArray(B._4e_name(),["img","hr","input","textarea","select"])&&o.getSelection().selectElement(B)});m.gecko&&b.on(u,"dragstart",function(B){var D=new d(B.target);D._4e_name()===
"img"&&/ke_/.test(D[0].className)&&B.preventDefault()});c.add(o)};r.documentMode>7&&function(){for(var g=s.all("link"),h=0;h<g.length;h++){var o=new d(g[h]),k=o.attr("href");k.indexOf("editor-pkg-min-mhtml.css")!=-1&&o.attr("href",k.replace(/editor-pkg-min-mhtml\.css/g,"editor-pkg-min-datauri.css"))}}()});
KISSY.Editor.add("zindex",function(){var n=KISSY.Editor;if(!n.zIndexManager){n.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,DD_PG:99999,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};n.baseZIndex=function(w){return(n.Config.baseZIndex||1E4)+w};n.baseZIndex=n.baseZIndex;n.zIndexManager=n.zIndexManager}});
KISSY.Editor.add("dtd",function(n){n.XHTML_DTD=function(){function w(){for(var k=arguments[0],u=arguments.length-1;u>0;)KISSY.mix(k,arguments[u--]);return k}var v={isindex:1,fieldset:1},z={input:1,button:1,select:1,textarea:1,label:1},r=w({a:1},z),s=w({iframe:1},r),m={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},p={ins:1,del:1,script:1,style:1},l=w({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,
cite:1,kbd:1,u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},p),d=w({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},l),b=w({p:1},d);z=w({iframe:1},d,z);d={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,
dir:1,map:1,dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var c=w({a:1},z),e={tr:1},t={"#":1},q=w({param:1},d),a=w({form:1},v,s,m,b),f={li:1},i={base:1,link:1,meta:1,title:1},g=w(i,{style:1,script:1}),h={head:1,body:1},o={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:w({html:1},h,
i),$block:o,$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:c,$body:w({script:1,style:1},o),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,
span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:h,head:g,style:t,body:a,base:{},link:{},meta:{},title:t,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:a,td:a,br:{},th:a,center:a,kbd:c,button:w(b,m),basefont:{},h5:c,h4:c,samp:c,h6:c,ol:f,h1:c,h3:c,option:t,h2:c,form:w(v,s,m,b),select:{optgroup:1,option:1},font:c,ins:c,menu:f,abbr:c,
label:c,table:{thead:1,col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:c,script:t,tfoot:e,cite:c,li:a,input:{},iframe:a,strong:c,textarea:t,noframes:a,big:c,small:c,span:c,hr:{},dt:c,sub:c,optgroup:{option:1},param:{},bdo:c,"var":c,div:a,object:q,sup:c,dd:a,strike:c,area:{},dir:f,map:w({area:1,form:1,p:1},v,p,m),applet:q,dl:{dt:1,dd:1},del:c,isindex:{},fieldset:w({legend:1},d),thead:e,ul:f,acronym:c,b:c,a:z,blockquote:a,caption:c,i:c,u:c,tbody:e,s:c,address:w(s,b),tt:c,legend:c,q:c,pre:w(l,
r),p:c,em:c,dfn:c}}();n.XHTML_DTD=n.XHTML_DTD});
KISSY.Editor.add("elementpath",function(n){function w(l){var d=s,b=s,c=[];for(l=l;l;){if(l[0].nodeType==r.NODE_ELEMENT){if(!this.lastElement)this.lastElement=l;var e=l._4e_name();if(!b){if(!d&&m[e])d=l;if(p[e]){var t;if(t=!d){if(t=e=="div"){a:{t=l;t=v._4e_unwrap(t);t=t.childNodes;for(var q=0,a=t.length;q<a;q++){var f=t[q];if(f.nodeType==r.NODE_ELEMENT&&z.$block[f.nodeName.toLowerCase()]){t=true;break a}}t=false}t=!t}t=t}if(t)d=l;else b=l}}c.push(l);if(e=="body")break}l=l.parent()}this.block=d;this.blockLimit=
b;this.elements=c}var v=KISSY.DOM,z=n.XHTML_DTD,r=n.NODE,s=null,m={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},p={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};w.prototype={compare:function(l){var d=this.elements;l=l&&l.elements;if(!l||d.length!=l.length)return false;for(var b=0;b<d.length;b++)if(!v._4e_equals(d[b],l[b]))return false;return true},contains:function(l){for(var d=this.elements,b=0;b<d.length;b++)if(d[b]._4e_name()in l)return d[b];
return s},toString:function(){var l=this.elements,d,b=[];for(d=0;d<l.length;d++)b.push(l[d]._4e_name());return b.toString()}};n.ElementPath=w});
KISSY.Editor.add("walker",function(n){function w(f,i){if(this._.end)return m;var g,h=this.range,o,k=this.guard,u=this.type,x=f?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;h.trim();if(h.collapsed){this.end();return m}}if(!f&&!this._.guardLTR){var E=h.endContainer,j=new e(E[0].childNodes[h.endOffset]);this._.guardLTR=function(B,D){return(B=b._4e_wrap(B))&&B[0]&&(!D||!b._4e_equals(E,B))&&(!j[0]||!B._4e_equals(j))&&(B[0].nodeType!=d.NODE_ELEMENT||!D||B._4e_name()!="body")}}if(f&&
!this._.guardRTL){var y=h.startContainer,C=h.startOffset>0&&new e(y[0].childNodes[h.startOffset-1]);this._.guardRTL=function(B,D){return(B=b._4e_wrap(B))&&B[0]&&(!D||!B._4e_equals(y))&&(!C[0]||!B._4e_equals(C))&&(B[0].nodeType!=d.NODE_ELEMENT||!D||B._4e_name()!="body")}}var A=f?this._.guardRTL:this._.guardLTR;o=k?function(B,D){if(A(B,D)===s)return s;return k(B,D)}:A;if(this.current)g=this.current[x](s,u,o);else if(f){g=h.endContainer;if(h.endOffset>0){g=new e(g[0].childNodes[h.endOffset-1]);if(o(g)===
s)g=m}else g=o(g,r)===s?m:g._4e_previousSourceNode(r,u,o)}else{g=h.startContainer;if((g=new e(g[0].childNodes[h.startOffset]))&&g[0]){if(o(g)===s)g=m}else g=o(h.startContainer,r)===s?m:h.startContainer._4e_nextSourceNode(r,u,o)}for(;g&&g[0]&&!this._.end;){this.current=g;if(!this.evaluator||this.evaluator(g)!==s){if(!i)return g}else if(i&&this.evaluator)return s;g=g[x](s,u,o)}this.end();return this.current=m}function v(f){for(var i,g=m;i=w.call(this,f);)g=i;return g}function z(f){this.range=f;this._=
{}}var r=true,s=false,m=null,p=KISSY,l=p.UA,d=n.NODE,b=p.DOM,c=n.XHTML_DTD,e=p.Node;p.augment(z,{end:function(){this._.end=1},next:function(){return w.call(this)},previous:function(){return w.call(this,r)},checkForward:function(){return w.call(this,s,r)!==s},checkBackward:function(){return w.call(this,r,r)!==s},lastForward:function(){return v.call(this)},lastBackward:function(){return v.call(this,r)},reset:function(){delete this.current;this._={}}});z.blockBoundary=function(f){return function(i){i=
b._4e_wrap(i);return!(i&&i[0].nodeType==d.NODE_ELEMENT&&i._4e_isBlockBoundary(f))}};z.bookmark=function(f,i){function g(h){return h&&h[0]&&h._4e_name()=="span"&&h.attr("_ke_bookmark")}return function(h){var o,k;o=h&&h[0]&&h[0].nodeType==d.NODE_TEXT&&(k=h.parent())&&g(k);o=f?o:o||g(h);return i^o}};z.whitespaces=function(f){return function(i){i=(i=i[0]||i)&&i.nodeType==d.NODE_TEXT&&!p.trim(i.nodeValue);return f^i}};z.invisible=function(f){var i=z.whitespaces();return function(g){g=i(g)||g[0].nodeType==
d.NODE_ELEMENT&&!g[0].offsetHeight;return f^g}};var t=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,q=z.whitespaces(),a=z.bookmark();z.getBogus=function(f){do f=f._4e_previousSourceNode();while(a(f)||q(f)||f.type==1&&f._4e_name()in c.$inline&&!(f._4e_name()in c.$empty));if(f&&(!l.ie?f._4e_name()=="br":f[0].nodeType==3&&t.test(f.text())))return f;return false};n.Walker=z});
KISSY.Editor.add("range",function(n){function w(j){this.endOffset=this.endContainer=this.startOffset=this.startContainer=d;this.collapsed=p;this.document=j}function v(j){var y=j[0].nodeType!=c.NODE_TEXT&&j._4e_name()in g.$removeEmpty,C=!b.trim(j[0].nodeValue);j=!!j.parent().attr("_ke_bookmark");return y||C||j}function z(j){return!x(j)&&!E(j)}function r(j){var y=l,C=q.bookmark(p);return function(A){if(C(A))return p;if(A[0].nodeType==c.NODE_TEXT){if(b.trim(A[0].nodeValue).length)return l}else if(A[0].nodeType==
c.NODE_ELEMENT)if(!u[A._4e_name()])if(!j&&!i.ie&&A._4e_name()=="br"&&!y)y=p;else return l;return p}}function s(j,y){function C(A){return A&&A.nodeName=="span"&&A.getAttribute("_ke_bookmark")}return function(A){var B,D;B=A&&!A.nodeName&&(D=A.parentNode)&&C(D);B=j?B:B||C(A);return y^B}}function m(j){return function(y){y=(y=y[0]||y)&&y.nodeType==c.NODE_TEXT&&!b.trim(y.nodeValue);return j^y}}n.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};n.RANGE=n.RANGE;var p=true,l=false,d=null,b=KISSY,c=n.NODE,e=n.RANGE,t=n.POSITION,q=n.Walker,a=b.DOM,f=n.Utils.getByAddress,i=b.UA,g=n.XHTML_DTD,h=n.ElementPath,o=b.Node,k={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};w.prototype.toString=function(){var j=[];j.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);j.push((this.endContainer[0].id||
this.endContainer[0].nodeName)+":"+this.endOffset);return j.join("<br/>")};b.augment(w,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&a._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var j=this.startContainer,y=this.startOffset;if(j[0].nodeType!=c.NODE_ELEMENT)if(y)y>=j[0].nodeValue.length&&this.setStartAfter(j);else this.setStartBefore(j);j=this.endContainer;y=this.endOffset;if(j[0].nodeType!=c.NODE_ELEMENT)if(y)y>=
j[0].nodeValue.length&&this.setEndAfter(j);else this.setEndBefore(j)},setStartAfter:function(j){this.setStart(j.parent(),j._4e_index()+1)},setStartBefore:function(j){this.setStart(j.parent(),j._4e_index())},setEndAfter:function(j){this.setEnd(j.parent(),j._4e_index()+1)},setEndBefore:function(j){this.setEnd(j.parent(),j._4e_index())},optimizeBookmark:function(){var j=this.startContainer,y=this.endContainer;j&&j._4e_name()=="span"&&j.attr("_ke_bookmark")&&this.setStartAt(j,e.POSITION_BEFORE_START);
y&&y._4e_name()=="span"&&y.attr("_ke_bookmark")&&this.setEndAt(y,e.POSITION_AFTER_END)},setStart:function(j,y){if(j[0].nodeType==c.NODE_ELEMENT&&k[j._4e_name()]){j=j.parent();y=j._4e_index()}this.startContainer=j;this.startOffset=y;if(!this.endContainer){this.endContainer=j;this.endOffset=y}this.updateCollapsed()},setEnd:function(j,y){if(j[0].nodeType==c.NODE_ELEMENT&&k[j._4e_name()]){j=j.parent();y=j._4e_index()+1}this.endContainer=j;this.endOffset=y;if(!this.startContainer){this.startContainer=
j;this.startOffset=y}this.updateCollapsed()},setStartAt:function(j,y){switch(y){case e.POSITION_AFTER_START:this.setStart(j,0);break;case e.POSITION_BEFORE_END:j[0].nodeType==c.NODE_TEXT?this.setStart(j,j[0].nodeValue.length):this.setStart(j,j[0].childNodes.length);break;case e.POSITION_BEFORE_START:this.setStartBefore(j);break;case e.POSITION_AFTER_END:this.setStartAfter(j)}this.updateCollapsed()},setEndAt:function(j,y){switch(y){case e.POSITION_AFTER_START:this.setEnd(j,0);break;case e.POSITION_BEFORE_END:j[0].nodeType==
c.NODE_TEXT?this.setEnd(j,j[0].nodeValue.length):this.setEnd(j,j[0].childNodes.length);break;case e.POSITION_BEFORE_START:this.setEndBefore(j);break;case e.POSITION_AFTER_END:this.setEndAfter(j)}this.updateCollapsed()},execContentsAction:function(j,y){var C=this.startContainer,A=this.endContainer,B=this.startOffset,D=this.endOffset,K,M=this.document,O;this.optimizeBookmark();if(A[0].nodeType==c.NODE_TEXT)A=A._4e_splitText(D);else if(A[0].childNodes.length>0)if(D>=A[0].childNodes.length){A=new o(A[0].appendChild(M.createTextNode("")));
O=p}else A=new o(A[0].childNodes[D]);if(C[0].nodeType==c.NODE_TEXT){C._4e_splitText(B);if(C._4e_equals(A))A=new o(C[0].nextSibling)}else if(B)if(B>=C[0].childNodes.length){K=new o(M.createTextNode(""));C.append(K);C=K;K=p}else C=new o(C[0].childNodes[B].previousSibling);else{K=new o(M.createTextNode(""));C.prepend(K);C=K;K=p}B=C._4e_parents();D=A._4e_parents();var R,U,S;for(R=0;R<B.length;R++){U=B[R];S=D[R];if(!U._4e_equals(S))break}M=y;for(var P,Q,F,J=R;J<B.length;J++){P=B[J];Q=M&&!P._4e_equals(C)?
M.appendChild(P._4e_clone()[0]):null;for(P=P[0].nextSibling;P;){if(a._4e_equals(D[J],P)||a._4e_equals(A,P))break;F=P.nextSibling;if(j==2)M.appendChild(P.cloneNode(p));else{a._4e_remove(P);j==1&&M.appendChild(P)}P=F}if(Q)M=Q}M=y;for(R=R;R<D.length;R++){P=D[R];Q=M&&j>0&&!P._4e_equals(A)?M.appendChild(P._4e_clone()[0]):null;if(!B[R]||!P.parent()._4e_equals(B[R].parent()))for(P=P[0].previousSibling;P;){if(a._4e_equals(B[R],P)||a._4e_equals(C,P))break;F=P.previousSibling;if(j==2)M.insertBefore(P.cloneNode(p),
M.firstChild);else{a._4e_remove(P);j==1&&M.insertBefore(P,M.firstChild)}P=F}if(Q)M=Q}if(j==2){S=this.startContainer[0];if(S.nodeType==c.NODE_TEXT&&S.nextSibling&&S.nextSibling.nodeType==c.NODE_TEXT){S.data+=S.nextSibling.data;S.parentNode.removeChild(S.nextSibling)}S=this.endContainer[0];if(S.nodeType==c.NODE_TEXT&&S.nextSibling&&S.nextSibling.nodeType==c.NODE_TEXT){S.data+=S.nextSibling.data;S.parentNode.removeChild(S.nextSibling)}}else{if(U&&S&&(!C.parent()._4e_equals(U.parent())||!A.parent()._4e_equals(S.parent()))){U=
S._4e_index();K&&S.parent()._4e_equals(C.parent())&&U--;this.setStart(S.parent(),U)}this.collapse(p)}K&&C._4e_remove();O&&A[0].parentNode&&A._4e_remove()},collapse:function(j){if(j){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=p},clone:function(){var j=new w(this.document);j.startContainer=this.startContainer;j.startOffset=this.startOffset;j.endContainer=this.endContainer;j.endOffset=
this.endOffset;j.collapsed=this.collapsed;return j},getEnclosedNode:function(){var j=this.clone();j.optimize();if(j.startContainer[0].nodeType!=c.NODE_ELEMENT||j.endContainer[0].nodeType!=c.NODE_ELEMENT)return d;var y=new n.Walker(j),C=s(p,undefined),A=m(p);j.evaluator=function(B){return A(B)&&C(B)};j=y.next();y.reset();y=y.previous();return j&&j._4e_equals(y)?j:d},shrink:function(j,y){if(!this.collapsed){j=j||e.SHRINK_TEXT;var C=this.clone(),A=this.startContainer,B=this.endContainer,D=this.startOffset,
K=this.endOffset,M=1,O=1;if(A&&A[0].nodeType==c.NODE_TEXT)if(D)if(D>=A[0].nodeValue.length)C.setStartAfter(A);else{C.setStartBefore(A);M=0}else C.setStartBefore(A);if(B&&B[0].nodeType==c.NODE_TEXT)if(K)if(K>=B[0].nodeValue.length)C.setEndAfter(B);else{C.setEndAfter(B);O=0}else C.setEndBefore(B);C=new q(C);C.evaluator=function(U){U=U[0]||U;return U.nodeType==(j==e.SHRINK_ELEMENT?c.NODE_ELEMENT:c.NODE_TEXT)};var R;C.guard=function(U,S){U=U[0]||U;if(j==e.SHRINK_ELEMENT&&U.nodeType==c.NODE_TEXT)return l;
if(S&&U==R)return l;if(!S&&U.nodeType==c.NODE_ELEMENT)R=U;return p};if(M)(A=C[j==e.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(A,y?e.POSITION_AFTER_START:e.POSITION_BEFORE_START);if(O){C.reset();(C=C[j==e.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(C,y?e.POSITION_BEFORE_END:e.POSITION_AFTER_END)}return!!(M||O)}},createBookmark2:function(j){var y=this.startContainer,C=this.endContainer,A=this.startOffset,B=this.endOffset,D,K;if(!y||!C)return{start:0,end:0};if(j){if(y[0].nodeType==
c.NODE_ELEMENT)if((D=new o(y[0].childNodes[A]))&&D[0]&&D[0].nodeType==c.NODE_TEXT&&A>0&&D[0].previousSibling.nodeType==c.NODE_TEXT){y=D;A=0}for(;y[0].nodeType==c.NODE_TEXT&&(K=y._4e_previous())&&K[0].nodeType==c.NODE_TEXT;){y=K;A+=K[0].nodeValue.length}if(!this.collapsed){if(C[0].nodeType==c.NODE_ELEMENT)if((D=new o(C[0].childNodes[B]))&&D[0]&&D[0].nodeType==c.NODE_TEXT&&B>0&&D[0].previousSibling.nodeType==c.NODE_TEXT){C=D;B=0}for(;C[0].nodeType==c.NODE_TEXT&&(K=C._4e_previous())&&K[0].nodeType==
c.NODE_TEXT;){C=K;B+=K[0].nodeValue.length}}}return{start:y._4e_address(j),end:this.collapsed?d:C._4e_address(j),startOffset:A,endOffset:B,normalized:j,is2:p}},createBookmark:function(j){var y,C,A,B,D=this.collapsed;y=new o("<span>",d,this.document);y.attr("_ke_bookmark",1);y.css("display","none");y.html("&nbsp;");if(j){A=b.guid("ke_bm_");y.attr("id",A+"S")}if(!D){C=y._4e_clone();C.html("&nbsp;");j&&C.attr("id",A+"E");B=this.clone();B.collapse();B.insertNode(C)}B=this.clone();B.collapse(p);B.insertNode(y);
if(C){this.setStartAfter(y);this.setEndBefore(C)}else this.moveToPosition(y,e.POSITION_AFTER_END);return{startNode:j?A+"S":y,endNode:j?A+"E":C,serializable:j,collapsed:D}},moveToPosition:function(j,y){this.setStartAt(j,y);this.collapse(p)},trim:function(j,y){var C=this.startContainer,A=this.startOffset,B=this.collapsed;if((!j||B)&&C[0]&&C[0].nodeType==c.NODE_TEXT){if(A)if(A>=C[0].nodeValue.length){A=C._4e_index()+1;C=C.parent()}else{var D=C._4e_splitText(A);A=C._4e_index()+1;C=C.parent();if(a._4e_equals(this.startContainer,
this.endContainer))this.setEnd(D,this.endOffset-this.startOffset);else if(a._4e_equals(C,this.endContainer))this.endOffset+=1}else{A=C._4e_index();C=C.parent()}this.setStart(C,A);if(B){this.collapse(p);return}}C=this.endContainer;A=this.endOffset;if(!(y||B)&&C[0]&&C[0].nodeType==c.NODE_TEXT){if(A){A>=C.nodeValue.length||C._4e_splitText(A);A=C._4e_index()+1}else A=C._4e_index();C=C.parent();this.setEnd(C,A)}},insertNode:function(j){this.optimizeBookmark();this.trim(l,p);var y=this.startContainer;y[0].insertBefore(j[0]||
j,y[0].childNodes[this.startOffset]||null);a._4e_equals(j.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(j)},moveToBookmark:function(j){if(j.is2){var y=f(this.document,j.start,j.normalized),C=j.startOffset,A=j.end&&f(this.document,j.end,j.normalized);j=j.endOffset;this.setStart(y,C);A?this.setEnd(A,j):this.collapse(p)}else{y=(C=j.serializable)?b.one("#"+j.startNode,this.document):j.startNode;j=C?b.one("#"+j.endNode,this.document):j.endNode;this.setStartBefore(y);y._4e_remove();
if(j&&j[0]){this.setEndBefore(j);j._4e_remove()}else this.collapse(p)}},getCommonAncestor:function(j,y){var C=this.startContainer,A=this.endContainer;C=a._4e_equals(C,A)?j&&C[0].nodeType==c.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new o(C[0].childNodes[this.startOffset]):C:C._4e_commonAncestor(A);return y&&C[0].nodeType==c.NODE_TEXT?C.parent():C},enlarge:function(j){switch(j){case e.ENLARGE_ELEMENT:if(this.collapsed)break;j=this.getCommonAncestor();var y=new o(this.document.body),C,A,B,D,
K,M=l,O,R;O=this.startContainer;R=this.startOffset;if(O[0].nodeType==c.NODE_TEXT){if(R){O=!b.trim(O[0].nodeValue.substring(0,R)).length&&O;M=!!O}if(O)if(!(D=O[0].previousSibling))B=O.parent()}else{if(R)D=O[0].childNodes[R-1]||O[0].lastChild;D||(B=O)}for(;B||D;){if(B&&!D){if(!K&&a._4e_equals(B,j))K=p;if(!y.contains(B))break;if(!M||B.css("display")!="inline"){M=l;if(K)C=B;else this.setStartBefore(B)}D=B[0].previousSibling}for(;D;){O=l;if(D.nodeType==c.NODE_TEXT){R=D.nodeValue;if(/[^\s\ufeff]/.test(R))D=
d;O=/[\s\ufeff]$/.test(R)}else if(D.offsetWidth>0&&!D.getAttribute("_ke_bookmark"))if(M&&g.$removeEmpty[D.nodeName.toLowerCase()]){R=a.text(D);if(/[^\s\ufeff]/.test(R))D=d;else for(var U=D.all||D.getElementsByTagName("*"),S=0,P;P=U[S++];)if(!g.$removeEmpty[P.nodeName.toLowerCase()]){D=d;break}if(D)O=!!R.length}else D=d;if(O)if(M)if(K)C=B;else B&&this.setStartBefore(B);else M=p;if(D){O=D.previousSibling;if(!B&&!O){B=new o(D);D=d;break}D=O}else B=d}if(B)B=B.parent()}O=this.endContainer;R=this.endOffset;
B=D=d;K=M=l;if(O[0].nodeType==c.NODE_TEXT){O=!b.trim(O[0].nodeValue.substring(R)).length&&O;M=!(O&&O[0].nodeValue.length);if(O)if(!(D=O[0].nextSibling))B=O.parent()}else(D=O[0].childNodes[R])||(B=O);for(;B||D;){if(B&&!D){if(!K&&a._4e_equals(B,j))K=p;if(!y.contains(B))break;if(!M||B.css("display")!="inline"){M=l;if(K)A=B;else B&&this.setEndAfter(B)}D=B[0].nextSibling}for(;D;){O=l;if(D.nodeType==c.NODE_TEXT){R=D.nodeValue;if(/[^\s\ufeff]/.test(R))D=d;O=/^[\s\ufeff]/.test(R)}else if(D.offsetWidth>0&&
!D.getAttribute("_ke_bookmark"))if(M&&g.$removeEmpty[D.nodeName.toLowerCase()]){R=a.text(D);if(/[^\s\ufeff]/.test(R))D=d;else{U=D.all||D.getElementsByTagName("*");for(S=0;P=U[S++];)if(!g.$removeEmpty[P.nodeName.toLowerCase()]){D=d;break}}if(D)O=!!R.length}else D=d;if(O)if(M)if(K)A=B;else this.setEndAfter(B);if(D){O=D.nextSibling;if(!B&&!O){B=new o(D);D=d;break}D=O}else B=d}if(B)B=B.parent()}if(C&&A){j=C.contains(A)?A:C;this.setStartBefore(j);this.setEndAfter(j)}break;case e.ENLARGE_BLOCK_CONTENTS:case e.ENLARGE_LIST_ITEM_CONTENTS:B=
new w(this.document);y=new o(this.document.body);B.setStartAt(y,e.POSITION_AFTER_START);B.setEnd(this.startContainer,this.startOffset);B=new q(B);var Q,F,J=q.blockBoundary(j==e.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:d),H=function(I){var G=J(I);G||(Q=I);return G};C=function(I){var G=H(I);if(!G&&I[0]&&I._4e_name()=="br")F=I;return G};B.guard=H;B=B.lastBackward();Q=Q||y;this.setStartAt(Q,Q._4e_name()!="br"&&(!B&&this.checkStartOfBlock()||B&&Q.contains(B))?e.POSITION_AFTER_START:e.POSITION_AFTER_END);B=this.clone();
B.collapse();B.setEndAt(y,e.POSITION_BEFORE_END);B=new q(B);B.guard=j==e.ENLARGE_LIST_ITEM_CONTENTS?C:H;Q=d;B=B.lastForward();Q=Q||y;this.setEndAt(Q,!B&&this.checkEndOfBlock()||B&&Q.contains(B)?e.POSITION_BEFORE_END:e.POSITION_BEFORE_START);F&&this.setEndAfter(F)}},checkStartOfBlock:function(){var j=this.startContainer,y=this.startOffset;if(y&&j[0].nodeType==c.NODE_TEXT)if(b.trim(j[0].nodeValue.substring(0,y)).length)return l;this.trim();j=new h(this.startContainer);y=this.clone();y.collapse(p);y.setStartAt(j.block||
j.blockLimit,e.POSITION_AFTER_START);j=new q(y);j.evaluator=r(p);return j.checkBackward()},checkEndOfBlock:function(){var j=this.endContainer,y=this.endOffset;if(j[0].nodeType==c.NODE_TEXT)if(b.trim(j[0].nodeValue.substring(y)).length)return l;this.trim();j=new h(this.endContainer);y=this.clone();y.collapse(l);y.setEndAt(j.block||j.blockLimit,e.POSITION_BEFORE_END);j=new q(y);j.evaluator=r(l);return j.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var j=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,j);return j},checkBoundaryOfElement:function(j,y){var C=this.clone();C[y==e.START?"setStartAt":"setEndAt"](j,y==e.START?e.POSITION_AFTER_START:e.POSITION_BEFORE_END);C=new q(C);C.evaluator=v;return C[y==e.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var j=this.startContainer,y=this.endContainer,C=this.startOffset,A=this.endOffset,B;if(j[0].nodeType==c.NODE_ELEMENT){B=j[0].childNodes.length;if(B>
C)j=new o(j[0].childNodes[C]);else if(B<1)j=j._4e_previousSourceNode();else{for(j=j[0];j.lastChild;)j=j.lastChild;j=new o(j);j=j._4e_nextSourceNode()||j}}if(y[0].nodeType==c.NODE_ELEMENT){B=y[0].childNodes.length;if(B>A)y=(new o(y[0].childNodes[A]))._4e_previousSourceNode(p);else if(B<1)y=y._4e_previousSourceNode();else{for(y=y[0];y.lastChild;)y=y.lastChild;y=new o(y)}}if(j._4e_position(y)&t.POSITION_FOLLOWING)j=y;return{startNode:j,endNode:y}},fixBlock:function(j,y){var C=this.createBookmark(),A=
new o(this.document.createElement(y));this.collapse(j);this.enlarge(e.ENLARGE_BLOCK_CONTENTS);A[0].appendChild(this.extractContents());A._4e_trim();i.ie||A._4e_appendBogus();this.insertNode(A);this.moveToBookmark(C);return A},splitBlock:function(j){var y=new h(this.startContainer),C=new h(this.endContainer),A=y.block,B=C.block,D=d;if(!y.blockLimit._4e_equals(C.blockLimit))return d;if(j!="br"){if(!A){A=this.fixBlock(p,j);B=(new h(this.endContainer)).block}B||(B=this.fixBlock(l,j))}j=A&&this.checkStartOfBlock();
y=B&&this.checkEndOfBlock();this.deleteContents();if(A&&a._4e_equals(A,B))if(y){D=new h(this.startContainer);this.moveToPosition(B,e.POSITION_AFTER_END);B=d}else if(j){D=new h(this.startContainer);this.moveToPosition(A,e.POSITION_BEFORE_START);A=d}else{B=this.splitElement(A);!i.ie&&!b.inArray(A._4e_name(),["ul","ol"])&&A._4e_appendBogus()}return{previousBlock:A,nextBlock:B,wasStartOfBlock:j,wasEndOfBlock:y,elementPath:D}},splitElement:function(j){if(!this.collapsed)return d;this.setEndAt(j,e.POSITION_BEFORE_END);
var y=this.extractContents(),C=j._4e_clone(l);C[0].appendChild(y);C.insertAfter(j);this.moveToPosition(j,e.POSITION_AFTER_END);return C},moveToElementEditablePosition:function(j,y){var C,A=n.XHTML_DTD;if(A.$empty[j._4e_name()])return l;for(;j&&j[0].nodeType==c.NODE_ELEMENT;){if(C=j._4e_isEditable())this.moveToPosition(j,y?e.POSITION_BEFORE_END:e.POSITION_AFTER_START);else if(A.$inline[j._4e_name()]){this.moveToPosition(j,y?e.POSITION_AFTER_END:e.POSITION_BEFORE_START);return p}if((j=A.$empty[j._4e_name()]?
j[y?"_4e_previous":"_4e_next"](z):y?j._4e_last(z):j._4e_first(z))&&j[0].nodeType==c.NODE_TEXT){this.moveToPosition(j,y?e.POSITION_AFTER_END:e.POSITION_BEFORE_START);return p}}return C},selectNodeContents:function(j){this.setStart(j,0);this.setEnd(j,j[0].nodeType==c.NODE_TEXT?j[0].nodeValue.length:j[0].childNodes.length)}});var u={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},
x=new q.whitespaces,E=new q.bookmark;n.Range=w});
KISSY.Editor.add("domiterator",function(n){function w(q){if(!(arguments.length<1)){this.range=q;this.forceBrBreak=z;this.enlargeBr=v;this.enforceRealBlocks=z;this._||(this._={})}}var v=true,z=false,r=KISSY,s=r.UA,m=n.Walker,p=n.Range,l=n.RANGE,d=n.NODE,b=n.ElementPath,c=r.Node,e=r.DOM,t=/^[\r\n\t ]*$/;r.augment(w,{getNextParagraph:function(q){var a,f,i,g,h;if(!this._.lastNode){f=this.range.clone();f.shrink(l.SHRINK_ELEMENT,v);f.enlarge(this.forceBrBreak||!this.enlargeBr?l.ENLARGE_LIST_ITEM_CONTENTS:
l.ENLARGE_BLOCK_CONTENTS);var o=new m(f),k=m.bookmark(v,v);o.evaluator=k;this._.nextNode=o.next();o=new m(f);o.evaluator=k;o=o.previous();this._.lastNode=o._4e_nextSourceNode(v);if(this._.lastNode&&this._.lastNode[0].nodeType==d.NODE_TEXT&&!r.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){k=new p(f.document);k.moveToPosition(this._.lastNode,l.POSITION_AFTER_END);if(k.checkEndOfBlock()){k=new b(k.endContainer);this._.lastNode=(k.block||k.blockLimit)._4e_nextSourceNode(v)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new c(f.document.createTextNode(""));e.insertAfter(this._.lastNode[0],o[0])}f=null}k=this._.nextNode;o=this._.lastNode;for(this._.nextNode=null;k;){var u=z,x=k[0].nodeType!=d.NODE_ELEMENT,E=z;if(x){if(k[0].nodeType==d.NODE_TEXT)if(t.test(k[0].nodeValue))x=z}else{var j=k._4e_name();if(k._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(j=="br")x=v;else if(!f&&!k[0].childNodes.length&&j!="hr"){a=k;i=k._4e_equals(o);break}if(f){f.setEndAt(k,l.POSITION_BEFORE_START);if(j!="br")this._.nextNode=
k}u=v}else{if(k[0].firstChild){if(!f){f=new p(this.range.document);f.setStartAt(k,l.POSITION_BEFORE_START)}k=new c(k[0].firstChild);continue}x=v}}if(x&&!f){f=new p(this.range.document);f.setStartAt(k,l.POSITION_BEFORE_START)}i=(!u||x)&&k._4e_equals(o);if(f&&!u)for(;!k[0].nextSibling&&!i;){j=k.parent();if(j._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){u=v;i||j._4e_equals(o);break}k=j;x=v;i=k._4e_equals(o);E=v}x&&f.setEndAt(k,l.POSITION_AFTER_END);k=k._4e_nextSourceNode(E,null,o);if((i=!k)||u&&f)break}if(!a){if(!f){this._.docEndMarker&&
this._.docEndMarker._4e_remove();return this._.nextNode=null}a=new b(f.startContainer);k=a.blockLimit;u={div:1,th:1,td:1};a=a.block;if((!a||!a[0])&&!this.enforceRealBlocks&&u[k._4e_name()]&&f.checkStartOfBlock()&&f.checkEndOfBlock())a=k;else if(!a||this.enforceRealBlocks&&a._4e_name()=="li"){a=new c(this.range.document.createElement(q||"p"));a[0].appendChild(f.extractContents());a._4e_trim();f.insertNode(a);g=h=v}else if(a._4e_name()!="li"){if(!f.checkStartOfBlock()||!f.checkEndOfBlock()){a=a._4e_clone(z);
a[0].appendChild(f.extractContents());a._4e_trim();h=f.splitBlock();g=!h.wasStartOfBlock;h=!h.wasEndOfBlock;f.insertNode(a)}}else if(!i)this._.nextNode=a._4e_equals(o)?null:f.getBoundaryNodes().endNode._4e_nextSourceNode(v,null,o)}if(g){f=new c(a[0].previousSibling);if(f[0]&&f[0].nodeType==d.NODE_ELEMENT)if(f._4e_name()=="br")f._4e_remove();else f[0].lastChild&&e._4e_name(f[0].lastChild)=="br"&&e._4e_remove(f[0].lastChild)}if(h){f=m.bookmark(z,v);g=new c(a[0].lastChild);if(g[0]&&g[0].nodeType==d.NODE_ELEMENT&&
g._4e_name()=="br")if(s.ie||g._4e_previous(f)||g._4e_next(f))g._4e_remove()}if(!this._.nextNode)this._.nextNode=i||a._4e_equals(o)?null:a._4e_nextSourceNode(v,null,o);return a}});p.prototype.createIterator=function(){return new w(this)}});
KISSY.Editor.add("selection",function(n){function w(u){this.document=this.document=u;this._={cache:{}};if(a){var x=this.getNative().createRange();if(!x||x.item&&x.item(0).ownerDocument!=u||x.parentElement&&x.parentElement().ownerDocument!=u)this.isInvalid=r}}function v(u){u=new w(u);return!u||u.isInvalid?m:u}function z(u){function x(P){var Q=n.XHTML_DTD;return P._4e_isBlockBoundary()&&Q.$empty[P._4e_name()]}function E(P){return R(P)&&U(P)}var j=u.document,y=d._4e_getWin(j),C=new c(j.body),A=new c(j.documentElement);
if(l.ie){n.Utils.ieEngine<8&&A.on("click",function(P){(new c(P.target))._4e_name()==="html"&&u.getSelection().getNative().createRange().select()});(function(){function P(G,N){var L=H.createTextRange();try{L.moveToPoint(G,N)}catch(T){L=null}return L}function Q(){var G=j.selection.createRange();I&&!G.item&&G.compareEndPoints("StartToEnd",G)===0&&I.select();b.remove(j,"mouseup",Q);b.remove(j,"mousemove",F);I=J=0;M(r)}function F(G){if(G.button){if(G=P(G.pageX,G.pageY)){G.compareEndPoints("StartToStart",
I)>0?G.setEndPoint("StartToStart",I):G.setEndPoint("EndToEnd",I);G.select()}}else Q()}var J,H=C[0],I;j.documentElement.unselectable=true;b.on(j,"mousedown contextmenu",function(G){if(G.target===A[0]){J&&Q();if(!(A[0].scrollHeight>A[0].clientHeight)){p.log("fix ie cursor");J=1;if(I=P(G.pageX,G.pageY)){b.on(j,"mouseup",Q);b.on(j,"mousemove",F);y.focus();I.select()}}}})})();var B,D,K=r;A.on("mousedown",function(){K=s});A.on("mouseup",function(){K=r});C.on("focusin",function(P){if((new c(P.target))._4e_name()==
"body")if(B){try{K&&B.select()}catch(Q){}B=m}});C.on("focus",function(){D=r;M()});C.on("beforedeactivate",function(P){if(!P.relatedTarget){D=s;K=r}});u.on("blur",function(){try{var P=document.documentElement||document.body,Q=P.scrollTop,F=P.scrollLeft;j&&j.selection.empty();P.scrollTop=Q;P.scrollLeft=F}catch(J){}});C.on("mousedown",function(){D=s});C.on("mouseup",function(){D=r;setTimeout(function(){M(r)},0)});var M=function(P){if(D){var Q=u.document,F=u.getSelection(),J=F&&F.getType(),H=F&&Q.selection;
if(P&&H&&J==e.SELECTION_NONE)if(!Q.queryCommandEnabled("InsertImage")){setTimeout(function(){M(r)},50);return}var I;if(!(H&&H.type&&H.type!="Control"&&(I=H.createRange())&&(I=I.parentElement())&&(I=I.nodeName)&&I.toLowerCase()in{input:1,textarea:1})){B=H&&F.getRanges()[0];u._monitor()}}};C.on("keydown",function(){D=s});C.on("keyup",function(){D=r;setTimeout(function(){M()},0)})}else{b.on(j,"mouseup",u._monitor,u);b.on(j,"keyup",u._monitor,u)}var O=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,
R=n.Walker.whitespaces(r),U=n.Walker.bookmark(s,r),S=function(P){return R(P)&&P&&P[0].nodeType!=8};u.on("selectionChange",function(P){var Q=P.path;P=(P=P.selection)&&P.getRanges()[0];var F=Q.blockLimit;if(l.gecko){var J=Q.block||Q.blockLimit,H=J&&J._4e_last(E);J&&J._4e_isBlockBoundary()&&!(H&&H[0].nodeType==1&&H._4e_isBlockBoundary())&&J._4e_name()!="pre"&&!J._4e_getBogus()&&J._4e_appendBogus()}if(!(!P||!P.collapsed||Q.block)){if(F._4e_name()=="body"){if((Q=P.fixBlock(r,"p"))&&Q[0]!=C[0].lastChild)if(Q._4e_outerHtml().match(O))if((F=
Q._4e_next(S))&&F[0].nodeType==q.NODE_ELEMENT&&!x[F]){P.moveToElementEditablePosition(F);Q._4e_remove()}else if((F=Q._4e_previous(S))&&F[0].nodeType==q.NODE_ELEMENT&&!x[F]){P.moveToElementEditablePosition(F,F._4e_outerHtml().match(O)?s:r);Q._4e_remove()}P.select();u.notifySelectionChange()}Q=new n.Range(j);Q.moveToElementEditablePosition(C,r);if((new n.ElementPath(Q.startContainer)).blockLimit._4e_name()!=="body"){Q=(new c(j.createElement("p"))).appendTo(C);l.ie||Q._4e_appendBogus()}}})}n.SELECTION=
{SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var r=true,s=false,m=null,p=KISSY,l=p.UA,d=p.DOM,b=p.Event,c=p.Node,e=n.SELECTION,t=n.RANGE,q=n.NODE,a=l.ie,f=n.Walker,i=n.Range,g={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};p.augment(w,{getNative:!a?function(){var u=this._.cache;return u.nativeSel||(u.nativeSel=d._4e_getWin(this.document).getSelection())}:function(){var u=this._.cache;return u.nativeSel||
(u.nativeSel=this.document.selection)},getType:!a?function(){var u=this._.cache;if(u.type)return u.type;var x=e.SELECTION_TEXT,E=this.getNative();if(E){if(E.rangeCount==1){E=E.getRangeAt(0);var j=E.startContainer;if(j==E.endContainer&&j.nodeType==q.NODE_ELEMENT&&Number(E.endOffset-E.startOffset)==1&&g[j.childNodes[E.startOffset].nodeName.toLowerCase()])x=e.SELECTION_ELEMENT}}else x=e.SELECTION_NONE;return u.type=x}:function(){var u=this._.cache;if(u.type)return u.type;var x=e.SELECTION_NONE;try{var E=
this.getNative(),j=E.type;if(j=="Text")x=e.SELECTION_TEXT;if(j=="Control")x=e.SELECTION_ELEMENT;if(E.createRange().parentElement)x=e.SELECTION_TEXT}catch(y){}return u.type=x},getRanges:a?function(){var u=function(x,E){x=x.duplicate();x.collapse(E);for(var j=x.parentElement(),y=j.childNodes,C,A=0;A<y.length;A++){var B=y[A];if(B.nodeType==q.NODE_ELEMENT){C=x.duplicate();C.moveToElementText(B);B=C.compareEndPoints("StartToStart",x);var D=C.compareEndPoints("EndToStart",x);C.collapse();if(B>0)break;else if(!B||
D==1&&B==-1)return{container:j,offset:A};else if(!D)return{container:j,offset:A+1};C=m}}if(!C){C=x.duplicate();C.moveToElementText(j);C.collapse(s)}C.setEndPoint("StartToStart",x);C=String(C.text).replace(/\r\n|\r/g,"\n").length;try{for(;C>0;)C-=y[--A].nodeValue.length}catch(K){C=0}return C===0?{container:j,offset:A}:{container:y[A],offset:-C}};return function(x){var E=this._.cache;if(E.ranges&&!x)return E.ranges;var j=this.getNative();x=j&&j.createRange();var y=this.getType();if(!j)return[];if(y==
e.SELECTION_TEXT){j=new i(this.document);y=u(x,r);j.setStart(new c(y.container),y.offset);y=u(x);j.setEnd(new c(y.container),y.offset);return E.ranges=[j]}else if(y==e.SELECTION_ELEMENT){E=E.ranges=[];for(y=0;y<x.length;y++){var C=x.item(y),A=C.parentNode,B=0;for(j=new i(this.document);B<A.childNodes.length&&A.childNodes[B]!=C;B++);j.setStart(new c(A),B);j.setEnd(new c(A),B+1);E.push(j)}return E}return E.ranges=[]}}():function(u){var x=this._.cache;if(x.ranges&&!u)return x.ranges;u=[];var E=this.getNative();
if(!E)return[];for(var j=0;j<E.rangeCount;j++){var y=E.getRangeAt(j),C=new i(this.document);C.setStart(new c(y.startContainer),y.startOffset);C.setEnd(new c(y.endContainer),y.endOffset);u.push(C)}return x.ranges=u},getStartElement:function(){var u=this._.cache;if(u.startElement!==undefined)return u.startElement;var x,E=this.getNative();switch(this.getType()){case e.SELECTION_ELEMENT:return this.getSelectedElement();case e.SELECTION_TEXT:var j=this.getRanges()[0];if(j)if(!j.collapsed){for(j.optimize();r;){x=
j.startContainer;if(j.startOffset==(x[0].nodeType===q.NODE_ELEMENT?x[0].childNodes.length:x[0].nodeValue.length)&&!x._4e_isBlockBoundary())j.setStartAfter(x);else break}x=j.startContainer;if(x[0].nodeType!=q.NODE_ELEMENT)return x.parent();x=new c(x[0].childNodes[j.startOffset]);if(!x[0]||x[0].nodeType!=q.NODE_ELEMENT)return j.startContainer;for(j=x[0].firstChild;j&&j.nodeType==q.NODE_ELEMENT;){x=new c(j);j=j.firstChild}return x}if(a){j=E.createRange();j.collapse(r);x=j.parentElement()}else if((x=
E.anchorNode)&&x.nodeType!=q.NODE_ELEMENT)x=x.parentNode}return u.startElement=x?d._4e_wrap(x):m},getSelectedElement:function(){var u=this,x,E=u._.cache;if(E.selectedElement!==undefined)return E.selectedElement;if(a){x=u.getNative().createRange();x=x.item&&x.item(0)}x||(x=function(){for(var j=u.getRanges()[0],y,C,A=2;A&&!((y=j.getEnclosedNode())&&y[0].nodeType==q.NODE_ELEMENT&&g[y._4e_name()]&&(C=y));A--)j.shrink(t.SHRINK_ELEMENT);return C&&C[0]}());return E.selectedElement=d._4e_wrap(x)},reset:function(){this._.cache=
{}},selectElement:function(u){var x,E=this.document;if(a)try{x=E.body.createControlRange();x.addElement(u[0]);x.select()}catch(j){x=E.body.createTextRange();x.moveToElementText(u[0]);x.select()}finally{}else{x=E.createRange();x.selectNode(u[0]);u=this.getNative();u.removeAllRanges();u.addRange(x)}this.reset()},selectRanges:function(u){if(a){if(u.length>1){var x=u[u.length-1];u[0].setEnd(x.endContainer,x.endOffset);u.length=1}u[0]&&u[0].select()}else{x=this.getNative();if(!x)return;x.removeAllRanges();
for(var E=0;E<u.length;E++){var j=u[E],y=this.document.createRange(),C=j.startContainer;if(j.collapsed&&(l.gecko&&l.gecko<1.09||l.opera||l.webkit)&&C[0].nodeType==q.NODE_ELEMENT&&!C[0].childNodes.length){C[0].appendChild(this.document.createTextNode(l.webkit?"\u200b":""));j.startOffset++;j.endOffset++}y.setStart(C[0],j.startOffset);y.setEnd(j.endContainer[0],j.endOffset);x.addRange(y)}}this.reset()},createBookmarks2:function(u){for(var x=[],E=this.getRanges(),j=0;j<E.length;j++)x.push(E[j].createBookmark2(u));
return x},createBookmarks:function(u,x){var E=[],j=this.document,y;x=x||this.getRanges();for(var C=x.length,A=0;A<C;A++){E.push(y=x[A].createBookmark(u,r));var B=(u=y.serializable)?p.one("#"+y.startNode,j):y.startNode;y=u?p.one("#"+y.endNode,j):y.endNode;for(var D=A+1;D<C;D++){var K=x[D],M=K.startContainer,O=K.endContainer;d._4e_equals(M,B.parent())&&K.startOffset++;d._4e_equals(M,y.parent())&&K.startOffset++;d._4e_equals(O,B.parent())&&K.endOffset++;d._4e_equals(O,y.parent())&&K.endOffset++}}return E},
selectBookmarks:function(u){for(var x=[],E=0;E<u.length;E++){var j=new i(this.document);j.moveToBookmark(u[E]);x.push(j)}this.selectRanges(x);return this},getCommonAncestor:function(){var u=this.getRanges();return u[0].startContainer._4e_commonAncestor(u[u.length-1].endContainer)},scrollIntoView:function(){var u=this.getStartElement();u&&u._4e_scrollIntoView()},removeAllRanges:function(){var u=this.getNative();if(a)u&&u.clear();else u&&u.removeAllRanges()}});var h={table:1,tbody:1,tr:1},o=f.whitespaces(r),
k=/\ufeff|\u00a0/;i.prototype.select=i.prototype.select=!a?function(){var u=this.startContainer;this.collapsed&&u[0].nodeType==q.NODE_ELEMENT&&!u[0].childNodes.length&&u[0].appendChild(this.document.createTextNode(""));var x=this.document.createRange();x.setStart(u[0],this.startOffset);try{x.setEnd(this.endContainer[0],this.endOffset)}catch(E){if(E.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(r);x.setEnd(this.endContainer[0],this.endOffset)}else throw E;}u=v(this.document).getNative();
u.removeAllRanges();u.addRange(x)}:function(u){var x=this.collapsed,E,j;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var y=this.startContainer[0].childNodes[this.startOffset];if(y.nodeType==q.NODE_ELEMENT){(new w(this.document)).selectElement(new c(y));return}}if(this.startContainer[0].nodeType==q.NODE_ELEMENT&&this.startContainer._4e_name()in h||this.endContainer[0].nodeType==q.NODE_ELEMENT&&this.endContainer._4e_name()in h)this.shrink(t.SHRINK_ELEMENT,r);
var C=this.createBookmark();y=C.startNode;var A;if(!x)A=C.endNode;C=this.document.body.createTextRange();C.moveToElementText(y[0]);C.moveStart("character",1);if(A){u=this.document.body.createTextRange();u.moveToElementText(A[0]);C.setEndPoint("EndToEnd",u);C.moveEnd("character",-1)}else{for(E=y[0].nextSibling;E&&!o(E);)E=E.nextSibling;E=!(E&&E.nodeValue&&E.nodeValue.match(k))&&(u||!y[0].previousSibling||y[0].previousSibling&&d._4e_name(y[0].previousSibling)=="br");j=new c(this.document.createElement("span"));
j.html("&#65279;");j.insertBefore(y);if(E)d.insertBefore(this.document.createTextNode("\ufeff"),y[0]||y)}this.setStartBefore(y);y._4e_remove();if(x){if(E){C.moveStart("character",-1);C.select();this.document.selection.clear()}else C.select();if(j){this.moveToPosition(j,t.POSITION_BEFORE_START);j._4e_remove()}}else{this.setEndBefore(A);A._4e_remove();C.select()}};w.getSelection=v;n.Selection=w;n.on("instanceCreated",function(u){z(u.editor)})});
KISSY.Editor.add("styles",function(n){function w(F){return!F.attr("_ke_bookmark")}function v(F,J){for(var H in F)if(F.hasOwnProperty(H))if(x.isString(F[H]))F[H]=F[H].replace(Q,function(I,G){return J[G]});else v(F[H],J)}function z(F,J){if(J){F=x.clone(F);v(F,J)}var H=this.element=this.element=(F.element||"*").toLowerCase();this.type=this.type=H=="#"||U[H]?y.STYLE_BLOCK:S[H]?y.STYLE_OBJECT:y.STYLE_INLINE;this._={definition:F}}function r(F,J){var H=J?this.removeFromRange:this.applyToRange;F.body.focus();
for(var I=new A(F),G=I.getRanges(),N=0;N<G.length;N++)H.call(this,G[N]);I.selectRanges(G)}function s(F,J,H){var I=F.element;if(I=="*")I="span";J=new M(J.createElement(I));H&&H._4e_copyAttributes(J);H=F._.definition;F=H.attributes;H=z.getStyleText(H);if(F)for(var G in F)F.hasOwnProperty(G)&&J.attr(G,F[G]);if(H)J[0].style.cssText=H;return J}function m(F){var J=F.createBookmark(o),H=F.createIterator();H.enforceRealBlocks=o;H.enlargeBr=o;for(var I,G=F.document;I=H.getNextParagraph();){var N=s(this,G,
I);I=I;var L=N;N=L._4e_name=="pre";var T=I._4e_name=="pre",V=!N&&T;if(N&&!T){T=I;L=L;V=T.html();V=p(V,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");V=V.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");V=V.replace(/([ \t\n\r]+|&nbsp;)/g," ");V=V.replace(/<br\b[^>]*>/gi,"\n");if(O.ie){T=T[0].ownerDocument.createElement("div");T.appendChild(L[0]);L[0].outerHTML="<pre>"+V+"</pre>";L=new M(T.firstChild);L._4e_remove()}else L.html(V);L=L}else if(V)L=d(l(I),L);else I._4e_moveChildren(L);I[0].parentNode.replaceChild(L[0],
I[0]);if(N){I=L;N=void 0;if((N=I._4e_previousSourceNode(o,B.NODE_ELEMENT))&&N._4e_name()=="pre"){L=p(N.html(),/\n$/,"")+"\n\n"+p(I.html(),/^\n/,"");if(O.ie)I[0].outerHTML="<pre>"+L+"</pre>";else I.html(L);N._4e_remove()}}}F.moveToBookmark(J)}function p(F,J,H){var I="",G="";F=F.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(N,L,T){L&&(I=L);T&&(G=T);return""});return I+F.replace(J,H)+G}function l(F){var J=[];p(F._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(H,I,G){return I+"</pre>"+G+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(H,I){J.push(I)});return J}function d(F,J){for(var H=J[0].ownerDocument.createDocumentFragment(),I=0;I<F.length;I++){var G=F[I];G=G.replace(/(\r\n|\r)/g,"\n");G=p(G,/^[ \t]*\n/,"");G=p(G,/\n$/,"");G=p(G,/^[ \t]+|[ \t]+$/g,function(L,T){return L.length==1?"&nbsp;":T?" "+Array(L.length).join("&nbsp;"):Array(L.length).join("&nbsp;")+" "});G=G.replace(/\n/g,"<br>");G=G.replace(/[ \t]{2,}/g,function(L){return Array(L.length).join("&nbsp;")+
" "});var N=J._4e_clone();N.html(G);H.appendChild(N[0])}return H}function b(F){var J=F.document;if(F.collapsed){J=s(this,J,undefined);F.insertNode(J);F.moveToPosition(J,C.POSITION_BEFORE_END)}else{var H=this.element,I=this._.definition,G,N=n.XHTML_DTD[H];if(!N){G=o;N=n.XHTML_DTD.span}var L=F.createBookmark();F.enlarge(C.ENLARGE_ELEMENT);F.trim();var T=F.createBookmark(),V=T.startNode;T=T.endNode;for(var X=V,aa;X&&X[0];){var W=k;if(j._4e_equals(X,T)){X=u;W=o}else{var Z=X[0].nodeType,$=Z==B.NODE_ELEMENT?
X._4e_name():u;if($&&X.attr("_ke_bookmark")){X=X._4e_nextSourceNode(o);continue}if(!$||N[$]&&(X._4e_position(T)|D.POSITION_PRECEDING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)==D.POSITION_PRECEDING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED&&(!I.childRule||I.childRule(X))){var Y=X.parent();if(Y&&H=="a"&&Y._4e_name()==H){Z=s(this,J,undefined);Y._4e_moveChildren(Z);Y[0].parentNode.replaceChild(Z[0],Y[0]);Z._4e_mergeSiblings()}else if(Y&&Y[0]&&((n.XHTML_DTD[Y._4e_name()]||n.XHTML_DTD.span)[H]||
G)&&(!I.parentRule||I.parentRule(Y))){if(!aa&&(!$||!n.XHTML_DTD.$removeEmpty[$]||(X._4e_position(T)|D.POSITION_PRECEDING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)==D.POSITION_PRECEDING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED)){aa=new K(J);aa.setStartBefore(X)}if(Z==B.NODE_TEXT||Z==B.NODE_ELEMENT&&!X[0].childNodes.length){Y=X;for(Z=null;(W=!Y._4e_next(w))&&(Z=Y.parent())&&N[Z._4e_name()]&&(Z._4e_position(V)|D.POSITION_FOLLOWING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)==D.POSITION_FOLLOWING+
D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED&&(!I.childRule||I.childRule(Z));)Y=Z;aa.setEndAfter(Y)}}else W=o}else W=o;X=X._4e_nextSourceNode()}if(W&&aa&&!aa.collapsed){W=s(this,J,undefined);Y=aa.getCommonAncestor();Z={styles:{},attrs:{},blockedStyles:{},blockedAttrs:{}};var ba;$=null;for(var ca;W&&Y&&W[0]&&Y[0];){if(Y._4e_name()==H){for(ba in I.attributes)if(I.attributes.hasOwnProperty(ba))if(!(Z.blockedAttrs[ba]||!(ca=Y.attr($))))if(W.attr(ba)==ca)W.removeAttr(ba);else Z.blockedAttrs[ba]=1;for($ in I.styles)if(I.styles.hasOwnProperty($))if(!(Z.blockedStyles[$]||
!(ca=Y._4e_style($))))if(W._4e_style($)==ca)W._4e_style($,"");else Z.blockedStyles[$]=1;if(!W._4e_hasAttributes()){W=u;break}}Y=Y.parent()}if(W){W[0].appendChild(aa.extractContents());i(this,W);aa.insertNode(W);W._4e_mergeSiblings();O.ie||W[0].normalize()}else{W=new M(J.createElement("span"));W[0].appendChild(aa.extractContents());aa.insertNode(W);i(this,W);W._4e_remove(true)}aa=u}}V._4e_remove();T._4e_remove();F.moveToBookmark(L);F.shrink(C.SHRINK_TEXT)}}function c(F){F.enlarge(C.ENLARGE_ELEMENT);
var J=F.createBookmark(),H=J.startNode;if(F.collapsed){for(var I=new R(H.parent()),G,N=0,L;N<I.elements.length&&(L=I.elements[N]);N++){if(L==I.block||L==I.blockLimit)break;if(this.checkElementRemovable(L)){var T=F.checkBoundaryOfElement(L,C.END),V=!T&&F.checkBoundaryOfElement(L,C.START);if(V||T){G=L;G.match=V?"start":"end"}else{L._4e_mergeSiblings();if(L._4e_name()!=this.element){T=q(this);g(L,T[L._4e_name()]||T["*"])}else a(this,L)}}}if(G&&G[0]){L=H;for(N=0;;N++){T=I.elements[N];if(j._4e_equals(T,
G))break;else if(T.match)continue;else T=T._4e_clone();T[0].appendChild(L[0]);L=T}j[G.match=="start"?"insertBefore":"insertAfter"](j._4e_unwrap(L),j._4e_unwrap(G))}}else{var X=J.endNode,aa=this;I=function(){for(var W=new R(H.parent()),Z=new R(X.parent()),$=u,Y=u,ba=0;ba<W.elements.length;ba++){var ca=W.elements[ba];if(ca==W.block||ca==W.blockLimit)break;if(aa.checkElementRemovable(ca))$=ca}for(ba=0;ba<Z.elements.length;ba++){ca=Z.elements[ba];if(ca==Z.block||ca==Z.blockLimit)break;if(aa.checkElementRemovable(ca))Y=
ca}Y&&X._4e_breakParent(Y);$&&H._4e_breakParent($)};I();for(G=new M(H[0].nextSibling);G[0]!==X[0];){N=G._4e_nextSourceNode();if(G[0]&&G[0].nodeType==B.NODE_ELEMENT&&this.checkElementRemovable(G)){if(G._4e_name()==this.element)a(this,G);else{L=q(this);g(G,L[G._4e_name()]||L["*"])}if(N[0].nodeType==B.NODE_ELEMENT&&N.contains(H)){I();N=new M(H[0].nextSibling)}}G=N}}F.moveToBookmark(J)}function e(F){F=String(F);var J={};F.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(H,
I,G){J[I]=G});return J}function t(F,J){var H="";if(J!==k){H=document.createElement("span");H.style.cssText=F;H=H.style.cssText||""}else H=F;return H.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function q(F){if(F._.overrides)return F._.overrides;var J=F._.overrides={},H=F._.definition.overrides;if(H){x.isArray(H)||(H=[H]);for(var I=0;I<H.length;I++){var G=H[I],N,L,T;if(typeof G=="string")N=G.toLowerCase();else{N=G.element?G.element.toLowerCase():F.element;
L=G.attributes;T=G.styles}G=J[N]||(J[N]={});if(L){N=G.attributes=G.attributes||[];for(var V in L)L.hasOwnProperty(V)&&N.push([V.toLowerCase(),L[V]])}if(T){G=G.styles=G.styles||[];for(var X in T)T.hasOwnProperty(X)&&G.push([X.toLowerCase(),T[X]])}}}return J}function a(F,J){var H=F._.definition,I=q(F),G=E.mix(H.attributes,(I[J._4e_name()]||I["*"]||{}).attributes);H=E.mix(H.styles,(I[J._4e_name()]||I["*"]||{}).styles);I=x.isEmptyObject(G)&&x.isEmptyObject(H);for(var N in G)if(G.hasOwnProperty(N))if(!((N==
"class"||F._.definition.fullMatch)&&J.attr(N)!=f(N,G[N]))){I=I||!!J._4e_hasAttribute(N);J.removeAttr(N)}for(var L in H)if(H.hasOwnProperty(L))if(!(F._.definition.fullMatch&&J._4e_style(L)!=f(L,H[L],o))){I=I||!!J._4e_style(L);J._4e_style(L,"")}h(J)}function f(F,J,H){var I=new M("<span>");I[H?"_4e_style":"attr"](F,J);return I[H?"_4e_style":"attr"](F)}function i(F,J){for(var H=q(F),I=J.all(F.element),G=I.length;--G>=0;)a(F,new M(I[G]));for(var N in H)if(H.hasOwnProperty(N))if(N!=F.element){I=J.all(N);
for(G=I.length-1;G>=0;G--){var L=new M(I[G]);g(L,H[N])}}}function g(F,J){var H,I=J&&J.attributes;if(I)for(H=0;H<I.length;H++){var G=I[H][0],N;if(N=F.attr(G)){var L=I[H][1];if(L===u||L.test&&L.test(N)||typeof L=="string"&&N==L)F[0].removeAttribute(G)}}if(I=J&&J.styles)for(H=0;H<I.length;H++){G=I[H][0];if(L=F.css(G)){var T=I[H][1];if(T===u||T.test&&T.test(N)||typeof T=="string"&&L==T)F.css(G,"")}}h(F)}function h(F){if(!F._4e_hasAttributes()){var J=F[0].firstChild,H=F[0].lastChild;F._4e_remove(o);if(J){J.nodeType==
B.NODE_ELEMENT&&j._4e_mergeSiblings(J);H&&J!=H&&H.nodeType==B.NODE_ELEMENT&&j._4e_mergeSiblings(H)}}}var o=true,k=false,u=null,x=KISSY,E=n.Utils,j=x.DOM,y={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},C=n.RANGE,A=n.Selection,B=n.NODE,D=n.POSITION,K=n.Range,M=x.Node,O=x.UA,R=n.ElementPath,U={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},S={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},P=/\s*(?:;\s*|$)/g,Q=/#\((.+?)\)/g;n.STYLE=y;z.prototype={apply:function(F){r.call(this,
F,k)},remove:function(F){r.call(this,F,o)},applyToRange:function(F){return(this.applyToRange=this.type==y.STYLE_INLINE?b:this.type==y.STYLE_BLOCK?m:this.type==y.STYLE_OBJECT?u:u).call(this,F)},removeFromRange:function(F){return(this.removeFromRange=this.type==y.STYLE_INLINE?c:u).call(this,F)},checkElementRemovable:function(F,J){if(!F)return k;var H=this._.definition,I;if(F._4e_name()==this.element){if(!J&&!F._4e_hasAttributes())return o;var G=H._AC;if(G)H=G;else{G={};var N=0,L=H.attributes;if(L)for(var T in L)if(L.hasOwnProperty(T)){N++;
G[T]=L[T]}if(L=z.getStyleText(H)){G.style||N++;G.style=L}G._length=N;H=H._AC=G}if(H._length){for(var V in H)if(V!="_length")if(H.hasOwnProperty(V)){N=F.attr(V)||"";if(V=="style")a:{G=H[V];N=t(N,k);typeof G=="string"&&(G=e(G));typeof N=="string"&&(N=e(N));L=void 0;for(L in G)if(G.hasOwnProperty(L))if(!(L in N&&(N[L]==G[L]||G[L]=="inherit"||N[L]=="inherit"))){G=k;break a}G=o}else G=H[V]==N;if(G){if(!J)return o}else if(J)return k}if(J)return o}else return o}V=q(this);if(V=V[F._4e_name()]||V["*"]){if(!(H=
V.attributes)&&!(I=V.styles))return o;if(H)for(G=0;G<H.length;G++){V=H[G][0];if(V=F.attr(V)){N=H[G][1];if(N===u||typeof N=="string"&&V==N||N.test&&N.test(V))return o}}if(I)for(G=0;G<I.length;G++)if(V=F.css(I[G][0])){H=I[G][1];if(H===u||typeof H=="string"&&V==H||H.test&&H.test(V))return o}}return k},checkActive:function(F){switch(this.type){case y.STYLE_BLOCK:return this.checkElementRemovable(F.block||F.blockLimit,o);case y.STYLE_OBJECT:case y.STYLE_INLINE:for(var J=F.elements,H=0,I;H<J.length;H++){I=
J[H];if(!(this.type==y.STYLE_INLINE&&(j._4e_equals(I,F.block)||j._4e_equals(I,F.blockLimit))))if(!(this.type==y.STYLE_OBJECT&&!(I._4e_name()in S)))if(this.checkElementRemovable(I,o))return o}}return k}};z.getStyleText=function(F){var J=F._ST;if(J)return J;J=F.styles;var H=F.attributes&&F.attributes.style||"",I="";if(H.length)H=H.replace(P,";");for(var G in J)if(J.hasOwnProperty(G)){var N=J[G],L=(G+":"+N).replace(P,";");if(N=="inherit")I+=L;else H+=L}if(H.length)H=t(H);H+=I;return F._ST=H};n.Style=
z});
KISSY.Editor.add("htmlparser",function(){function n(){this._={htmlPartsRegex:RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var w=KISSY,v=function(){},z=w.Editor,r=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,s={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},m=z.XHTML_DTD;w.augment(n,{onTagOpen:v,onTagClose:v,
onText:v,onCDATA:v,onComment:v,parse:function(p){for(var l,d,b=0,c;l=this._.htmlPartsRegex.exec(p);){d=l.index;if(d>b){b=p.substring(b,d);c?c.push(b):this.onText(b)}b=this._.htmlPartsRegex.lastIndex;if(d=l[1]){d=d.toLowerCase();if(c&&m.$cdata[d]){this.onCDATA(c.join(""));c=null}if(!c){this.onTagClose(d);continue}}if(c)c.push(l[0]);else if(d=l[3]){d=d.toLowerCase();if(!/="/.test(d)){var e={},t;l=l[4];var q=!!(l&&l.charAt(l.length-1)=="/");if(l)for(;t=r.exec(l);){var a=t[1].toLowerCase();t=t[2]||t[3]||
t[4]||"";e[a]=!t&&s[a]?a:t}this.onTagOpen(d,e,q);if(!c&&m.$cdata[d])c=[]}}else if(d=l[2])this.onComment(d)}p.length>b&&this.onText(p.substring(b,p.length))}});z.HtmlParser=n;z.HtmlParser=n});
KISSY.Editor.add("htmlparser-basicwriter",function(){function n(){this._={output:[]}}var w=KISSY,v=w.Editor,z=v.Utils;w.augment(n,{openTag:function(r){this._.output.push("<",r)},openTagClose:function(r,s){s?this._.output.push(" />"):this._.output.push(">")},attribute:function(r,s){if(typeof s=="string")s=z.htmlEncodeAttr(s);this._.output.push(" ",r,'="',s,'"')},closeTag:function(r){this._.output.push("</",r,">")},text:function(r){this._.output.push(r)},comment:function(r){this._.output.push("<!--",
r,"--\>")},write:function(r){this._.output.push(r)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(r){var s=this._.output.join("");r&&this.reset();return s}});v.HtmlParser.BasicWriter=n});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function n(){n.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=s;this.sortAttributes=r;this._.indent=s;this._.indentation="";this._.rules={};var m=v.XHTML_DTD,p;for(p in z.mix({},m.$nonBodyContent,m.$block,m.$listItem,m.$tableContent))this.setRules(p,{indent:r,breakBeforeOpen:r,breakAfterOpen:r,breakBeforeClose:!m[p]["#"],breakAfterClose:r});this.setRules("br",
{breakAfterOpen:r});this.setRules("title",{indent:s,breakAfterOpen:s});this.setRules("style",{indent:s,breakBeforeClose:r});this.setRules("pre",{indent:s})}var w=KISSY,v=w.Editor,z=v.Utils,r=true,s=false;w.extend(n,v.HtmlParser.BasicWriter,{openTag:function(m){var p=this._.rules[m];if(this._.indent)this.indentation();else if(p&&p.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",m)},openTagClose:function(m,p){var l=this._.rules[m];if(p)this._.output.push(this.selfClosingEnd);
else{this._.output.push(">");if(l&&l.indent)this._.indentation+=this.indentationChars}l&&l.breakAfterOpen&&this.lineBreak()},attribute:function(m,p){if(typeof p=="string"){this.forceSimpleAmpersand&&(p=p.replace(/&amp;/g,"&"));p=z.htmlEncodeAttr(p)}this._.output.push(" ",m,'="',p,'"')},closeTag:function(m){var p=this._.rules[m];if(p&&p.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();else if(p&&p.breakBeforeClose){this.lineBreak();
this.indentation()}this._.output.push("</",m,">");p&&p.breakAfterClose&&this.lineBreak()},text:function(m){if(this._.indent){this.indentation();m=z.ltrim(m)}this._.output.push(m)},comment:function(m){this._.indent&&this.indentation();this._.output.push("<!--",m,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=r},indentation:function(){this._.output.push(this._.indentation);this._.indent=s},setRules:function(m,p){var l=this._.rules[m];if(l)z.mix(l,
p);else this._.rules[m]=p}});v.HtmlParser.HtmlWriter=n});
KISSY.Editor.add("htmlparser-fragment",function(){function n(){this.children=[];this.parent=z;this._={isBlockLike:w,hasInlineStarted:v}}var w=true,v=false,z=null,r=KISSY.Editor,s={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},m=KISSY,p=r.Utils,l=r.NODE,d=r.XHTML_DTD;p.mix({table:1,ul:1,ol:1,dl:1},d.table,d.ul,d.ol,d.dl);var b=d.$list,c=d.$listItem;n.FromHtml=function(e,t){function q(y){var C;if(h.length>0)for(var A=0;A<h.length;A++){var B=h[A],D=B.name,K=d[D],M=k.name&&d[k.name];
if((!M||M[D])&&(!y||!K||K[y]||!d[y])){if(!C){a();C=1}B=B.clone();B.parent=k;k=B;h.splice(A,1);A--}}}function a(){for(;o.length;)k.add(o.shift())}function f(y,C,A){C=C||k||g;if(t&&!C.type){var B,D;if((B=y.attributes&&(D=y.attributes._ke_real_element_type)?D:y.name)&&!(B in d.$body)&&!(B in d.$nonBodyContent)){D=k;k=C;i.onTagOpen({li:"ul",dt:"dl",dd:"dl"}[B]||t,{});C=k;if(A)k=D}}if(y._.isBlockLike&&y.name!="pre"){A=y.children.length;if((B=y.children[A-1])&&B.type==l.NODE_TEXT)if(D=p.rtrim(B.value))B.value=
D;else y.children.length=A-1}C.add(y);if(y.returnPoint){k=y.returnPoint;delete y.returnPoint}}var i=new r.HtmlParser,g=new n,h=[],o=[],k=g,u=v,x;i.onTagOpen=function(y,C,A){var B=new r.HtmlParser.Element(y,C);if(B.isUnknown&&A)B.isEmpty=w;if(d.$removeEmpty[y]&&m.isEmptyObject(C))h.push(B);else{if(String(y)==="pre")u=w;else if(String(y)==="br"&&u){k.add(new r.HtmlParser.Text("\n"));return}if(String(y)==="br")o.push(B);else{var D=k.name,K=D&&(d[D]||(k._.isBlockLike?d.div:d.span));if(K&&!B.isUnknown&&
!k.isUnknown&&!K[y]){K=v;var M;if(y in b&&D in b){D=k.children;(D=D[D.length-1])&&D.name in c||f(D=new r.HtmlParser.Element("li"),k);x=k;M=D}else if(y==D)f(k,k.parent);else{f(k,k.parent,w);!s[D]&&D in d.$inline&&h.unshift(k);K=w}k=M?M:k.returnPoint||k.parent;if(K){i.onTagOpen.apply(this,arguments);return}}q(y);a();B.parent=k;B.returnPoint=x;x=0;if(B.isEmpty)f(B);else k=B}}};i.onTagClose=function(y){for(var C=h.length-1;C>=0;C--)if(y==h[C].name){h.splice(C,1);return}for(var A=[],B=[],D=k;D.type&&D.name!=
y;){D._.isBlockLike||B.unshift(D);A.push(D);D=D.parent}if(D.type){for(C=0;C<A.length;C++){var K=A[C];f(K,K.parent)}k=D;if(k.name=="pre")u=v;D._.isBlockLike&&a();f(D,D.parent);if(D==k)k=k.parent;h=h.concat(B)}if(y=="body")t=v};i.onText=function(y){if(!k._.hasInlineStarted&&!u){y=p.ltrim(y);if(y.length===0)return}a();q();if(t&&(!k.type||k.name=="body")&&p.trim(y))this.onTagOpen(t,{});u||(y=y.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));k.add(new r.HtmlParser.Text(y))};i.onCDATA=function(y){k.add(new r.HtmlParser.cdata(y))};
i.onComment=function(y){k.add(new r.HtmlParser.Comment(y))};i.parse(e);for(a();k.type;){var E=k.parent,j=k;if(t&&(!E.type||E.name=="body")&&!d.$body[j.name]){k=E;i.onTagOpen(t,{});E=k}E.add(j);k=E}return g};m.augment(n,{add:function(e){var t=this.children.length;if(t=t>0&&this.children[t-1]||z){if(e._.isBlockLike&&t.type==l.NODE_TEXT){t.value=p.rtrim(t.value);if(t.value.length===0){this.children.pop();this.add(e);return}}t.next=e}e.previous=t;e.parent=this;this.children.push(e);this._.hasInlineStarted=
e.type==l.NODE_TEXT||e.type==l.NODE_ELEMENT&&!e._.isBlockLike},writeHtml:function(e,t){var q;this.filterChildren=this.filterChildren=function(){var a=new r.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,a,t,w);a=a.getHtml();this.children=(new n.FromHtml(a)).children;q=1};!this.name&&t&&t.onFragment(this);this.writeChildrenHtml(e,q?z:t)},writeChildrenHtml:function(e,t){for(var q=0;q<this.children.length;q++)this.children[q].writeHtml(e,t)}});r.HtmlParser.Fragment=n});
KISSY.Editor.add("htmlparser-element",function(){function n(r,s){this.name=r;this.attributes=s||(s={});this.children=[];var m=s._ke_real_element_type||r,p=w.XHTML_DTD;m=!!(p.$nonBodyContent[m]||p.$block[m]||p.$listItem[m]||p.$tableContent[m]||p.$nonEditable[m]||m=="br");var l=!!p.$empty[r];this.isEmpty=l;this.isUnknown=!p[r];this._={isBlockLike:m,hasInlineStarted:l||!m}}var w=KISSY.Editor,v=w.NODE,z=function(r,s){r=r[0];s=s[0];return r<s?-1:r>s?1:0};KISSY.augment(n,{type:v.NODE_ELEMENT,add:w.HtmlParser.Fragment.prototype.add,
clone:function(){return new n(this.name,this.attributes)},writeHtml:function(r,s){var m=this.attributes,p=this,l=p.name,d,b,c,e;p.filterChildren=function(){if(!e){var a=new w.HtmlParser.BasicWriter;w.HtmlParser.Fragment.prototype.writeChildrenHtml.call(p,a,s);p.children=(new w.HtmlParser.Fragment.FromHtml(a.getHtml())).children;e=1}};p.filterChildren=p.filterChildren;if(s){for(;;){if(!(l=s.onElementName(l)))return;p.name=l;if(!(p=s.onElement(p)))return;p.parent=this.parent;if(p.name==l)break;if(p.type!=
v.NODE_ELEMENT){p.writeHtml(r,s);return}l=p.name;if(!l){this.writeChildrenHtml.call(p,r,e?null:s);return}}m=p.attributes}r.openTag(l,m);for(var t=[],q=0;q<2;q++)for(d in m){b=d;c=m[d];if(q==1)t.push([d,c]);else if(s){for(;;)if(b=s.onAttributeName(d))if(b!=d){delete m[d];d=b}else break;else{delete m[d];break}if(b)if((c=s.onAttribute(p,b,c))===false)delete m[b];else m[b]=c}}r.sortAttributes&&t.sort(z);m=t.length;for(q=0;q<m;q++){d=t[q];r.attribute(d[0],d[1])}r.openTagClose(l,p.isEmpty);if(!p.isEmpty){this.writeChildrenHtml.call(p,
r,e?null:s);r.closeTag(l)}},writeChildrenHtml:function(){w.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});w.HtmlParser.Element=n});
KISSY.Editor.add("htmlparser-filter",function(){function n(b){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};b&&this.addRules(b,10)}function w(b,c){for(var e=0;b&&e<c.length;e++){var t=c[e];b=b.replace(t[0],t[1])}return b}function v(b,c,e){if(typeof c=="function")c=[c];var t,q;q=b.length;var a=c&&c.length;if(a){for(t=0;t<q&&b[t].pri<e;t++);for(q=a-1;q>=0;q--)if(a=c[q]){a.pri=e;b.splice(t,0,a)}}}function z(b,c,e){if(c)for(var t in c){var q=b[t];b[t]=r(q,c[t],
e);q||b.$length++}}function r(b,c,e){if(c){c.pri=e;if(b){if(b.splice)v(b,c,e);else{b=b.pri>e?[c,b]:[b,c];b.filter=s}return b}else return c.filter=c}}function s(b){for(var c=b.type||b instanceof p.HtmlParser.Fragment,e=0;e<this.length;e++){if(c)var t=b.type,q=b.name;var a=this[e].apply(window,arguments);if(a===d)return a;if(c){if(a&&(a.name!=q||a.type!=t))return a}else if(typeof a!="string")return a;a!=undefined&&(b=a)}return b}var m=KISSY,p=m.Editor,l=p.NODE,d=false;m.augment(n,{addRules:function(b,
c){if(typeof c!="number")c=10;v(this._.elementNames,b.elementNames,c);v(this._.attributeNames,b.attributeNames,c);z(this._.elements,b.elements,c);z(this._.attributes,b.attributes,c);this._.text=r(this._.text,b.text,c)||this._.text;this._.comment=r(this._.comment,b.comment,c)||this._.comment;this._.root=r(this._.root,b.root,c)||this._.root},onElementName:function(b){return w(b,this._.elementNames)},onAttributeName:function(b){return w(b,this._.attributeNames)},onText:function(b){var c=this._.text;
return c?c.filter(b):b},onComment:function(b,c){var e=this._.comment;return e?e.filter(b,c):b},onFragment:function(b){var c=this._.root;return c?c.filter(b):b},onElement:function(b){for(var c=[this._.elements["^"],this._.elements[b.name],this._.elements.$],e,t=0;t<3;t++)if(e=c[t]){e=e.filter(b,this);if(e===d)return null;if(e&&e!=b)return this.onNode(e);if(b.parent&&!b.name)break}return b},onNode:function(b){var c=b.type;return c==l.NODE_ELEMENT?this.onElement(b):c==l.NODE_TEXT?new p.HtmlParser.Text(this.onText(b.value)):
null},onAttribute:function(b,c,e){if(c=this._.attributes[c]){b=c.filter(e,b,this);if(b===d)return d;if(typeof b!="undefined")return b}return e}});p.HtmlParser.Filter=n});KISSY.Editor.add("htmlparser-text",function(){function n(r){this.value=r;this._={isBlockLike:z}}var w=KISSY,v=w.Editor,z=false;w.augment(n,{type:v.NODE.NODE_TEXT,writeHtml:function(r,s){var m=this.value;s&&!(m=s.onText(m,this))||r.text(m)}});v.HtmlParser.Text=n;v.HtmlParser.Text=n});
KISSY.Editor.add("htmlparser-cdata",function(n){n.HtmlParser.cdata=function(w){this.value=w};n.HtmlParser.cdata.prototype={type:n.NODE.NODE_TEXT,writeHtml:function(w){w.write(this.value)}}});
KISSY.Editor.add("htmlparser-comment",function(){function n(z){this.value=z;this._={isBlockLike:false}}var w=KISSY.Editor,v=w.NODE;w.HtmlParser.Comment=n;w.HtmlParser.Comment=n;n.prototype={constructor:n,type:v.NODE_COMMENT,writeHtml:function(z,r){var s=this.value;if(r){if(!(s=r.onComment(s,this)))return;if(typeof s!="string"){s.parent=this.parent;s.writeHtml(z,r);return}}z.comment(s)}}});
KISSY.Editor.add("button",function(){function n(s){if(s&&s.indexOf("<")==-1)return s;return 0}var w=KISSY,v=w.Editor,z=w.require("uibase");if(v.TripleButton)w.log("TripleButton attach twice","warn");else{var r=z.create([z.Box.Render||z.Box],{_updateHref:function(){this.get("el").attr("href","javascript:void('"+(n(this.get("text"))||n(this.get("title")))+"')")},bindUI:function(){var s=this,m=s.get("el");m.on("click",s._action,s);m.on("mousedown",function(){s.get("state")=="off"&&m.addClass("ke-triplebutton-active")});
m.on("mouseup mouseleave",function(){s.get("state")=="off"&&m.hasClass("ke-triplebutton-active")&&setTimeout(function(){m.removeClass("ke-triplebutton-active")},300)})},_uiSetTitle:function(){this.get("el").attr("title",this.get("title"));this._updateHref()},_uiSetContentCls:function(s){var m=this.get("el");if(s!==undefined){m.html("<span class='ke-toolbar-item "+s+"' />");m._4e_unselectable()}},_uiSetText:function(s){this.get("el").html(s);this._updateHref()},_uiSetState:function(s){this["_"+s]()},
disable:function(){this._savedState=this.get("state");this.set("state","disabled")},enable:function(){this.get("state")=="disabled"&&this.set("state",this._savedState)},_action:function(s){this.fire(this.get("state")+"Click",{TripleEvent:s});this.fire("click",{TripleClickType:this.get("state")+"Click"});s&&s.preventDefault()},bon:function(){this.set("state","on")},boff:function(){this.set("state","off")},_on:function(){var s=this.get("el");s.removeClass("ke-triplebutton-off ke-triplebutton-disabled");
s.addClass("ke-triplebutton-on")},_off:function(){var s=this.get("el");s.removeClass("ke-triplebutton-on ke-triplebutton-disabled");s.addClass("ke-triplebutton-off")},_disabled:function(){var s=this.get("el");s.removeClass("ke-triplebutton-off ke-triplebutton-on");s.addClass("ke-triplebutton-disabled")}},{ATTRS:{state:{value:"off"},elCls:{value:"ke-triplebutton ke-triplebutton-off"},elTagName:{value:"a"},title:{},contentCls:{},text:{}}});r.ON="on";r.OFF="off";r.DISABLED="disabled";r.ON_CLASS="ke-triplebutton-on";
r.OFF_CLASS="ke-triplebutton-off";r.DISABLED_CLASS="ke-triplebutton-disabled";v.TripleButton=r;v.prototype.addButton=function(s,m){var p=this,l=new r({render:p.toolBarDiv,autoRender:true,title:m.title,text:m.text,contentCls:m.contentCls}),d={name:s,btn:l,editor:p,cfg:m,call:function(){var b=w.makeArray(arguments),c=b.shift();return m[c].apply(d,b)},reload:function(b){w.mix(m,b);l.enable();p.on("selectionChange",function(){p.getMode()!=v.SOURCE_MODE&&m.selectionChange&&m.selectionChange.apply(d,arguments)});
l.on("click",function(c){var e=c.TripleClickType;m[e]&&m[e].apply(d,arguments);c&&c.halt()});if(m.mode==v.WYSIWYG_MODE){p.on("wysiwygmode",l.enable,l);p.on("sourcemode",l.disable,l)}m.init&&m.init.call(d)},destroy:function(){m.destroy&&m.destroy.call(d);l.destroy()}};m.loading?l.disable():d.reload(undefined);return d}}},{attach:false});
KISSY.Editor.add("select",function(){function n(b){n.superclass.constructor.call(this,b);this._init()}function w(b){if(b&&b.indexOf("<")==-1)return b;return 0}var v=KISSY,z=v.Node,r=v.Event,s=v.DOM,m=v.Editor;if(m.Select)v.log("ke select attach more");else{n.DISABLED=0;n.ENABLED=1;var p=m.XHTML_DTD;n.ATTRS={showValue:{},el:{},cls:{},container:{},doc:{},value:{},width:{},title:{},items:{},emptyText:{},align:{value:["l","b"]},menuContainer:{valueFn:function(){for(var b=this.el.parent();b;){var c=b._4e_name();
if(p[c]&&p[c].div)return b;b=b.parent()}return new z(document.body)}},state:{value:1}};n.decorate=function(b){for(var c=b.width(),e=[],t=b.all("option"),q=0;q<t.length;q++){var a=t[q];e.push({name:s.html(a),value:s.attr(a,"value")})}return new n({width:c+"px",title:b.attr("title"),el:b,items:e,cls:"ke-combox",value:b.val()})};var l=m.Utils.addRes,d=m.Utils.destroyRes;v.extend(n,v.Base,{_init:function(){var b=this.get("container"),c=this.get("el"),e=new z("<span class='ke-select-wrap'><a class='ke-select'><span class='ke-select-text'><span class='ke-select-text-inner'></span></span><span class='ke-select-drop-wrap'><span class='ke-select-drop'></span></span></a></span>"),
t=e.one("a"),q=this.get("title")||"",a=this.get("cls"),f=e.one(".ke-select-text"),i=e.one(".ke-select-text-inner");e.one(".ke-select-drop");this.get("value")!==undefined?i.html(this._findNameByV(this.get("value"))):i.html(q);f.css("width",this.get("width"));e._4e_unselectable();q&&e.attr("title",q);t.attr("href","javascript:void('"+w(q)+"')");a&&e.addClass(a);if(c)c[0].parentNode.replaceChild(e[0],c[0]);else b&&e.appendTo(b);e.on("click",this._click,this);this.el=e;this.title=i;this._focusA=e.one("a.ke-select");
m.Utils.lazyRun(this,"_prepare","_real");this.on("afterValueChange",this._valueChange,this);this.on("afterStateChange",this._stateChange,this)},_findNameByV:function(b){var c=this.get("title")||"",e=this.get("items");if(this.get("showValue"))return b||c;for(var t=0;t<e.length;t++){var q=e[t];if(q.value==b){c=q.name;break}}return c},_valueChange:function(b){this.title.html(this._findNameByV(b.newVal))},_itemsChange:function(b){var c;c=b.newVal;b=this._selectList;b.html("");if(c&&c.length)for(var e=
0;e<c.length;e++){var t=c[e];(new z("<a class='ke-select-menu-item' href='javascript:void(\""+w(t.name)+"\")' data-value='"+t.value+"'>"+t.name+"</a>",t.attrs)).appendTo(b)._4e_unselectable()}else if(c=this.get("emptyText"))(new z("<a class='ke-select-menu-item' href='javascript:void(\""+w(c)+"\")'>"+c+"</a>")).appendTo(b)._4e_unselectable();this.as=b.all("a")},val:function(b){if(b!==undefined){this.set("value",b);return this}else return this.get("value")},_resize:function(){this.menu.get("visible")&&
this._real()},_prepare:function(){function b(i){i=new z(i.target);e.contains(i)||e._4e_equals(i)||a.hide()}var c=this,e=c.el,t=c.get("popUpWidth"),q=c._focusA,a=new m.Overlay({autoRender:true,render:c.get("menuContainer"),content:"<div>",focus4e:false,elCls:"ke-menu",width:t?t:e.width(),zIndex:m.baseZIndex(m.zIndexManager.SELECT),focusMgr:false}),f=c.get("items");l.call(c,a);t=a.get("contentEl").one("div");c.menu=a;r.on(window,"resize",c._resize,c);l.call(c,function(){r.remove(window,"resize",c._resize,
c)});c.get("title")&&(new z("<div class='ke-menu-title ke-select-menu-item' style='margin-top:-6px;' >"+c.get("title")+"</div>")).appendTo(t);c._selectList=(new z("<div>")).appendTo(t);c._itemsChange({newVal:f});a.on("show",function(){q.addClass("ke-select-active")});a.on("hide",function(){q.removeClass("ke-select-active")});r.on(document,"click",b);l.call(c,function(){r.remove(document,"click",b)});c.get("doc")&&r.on(c.get("doc"),"click",b);t.on("click",c._select,c);c.as=c._selectList.all("a");r.on(t[0],
"mouseenter",function(){c.as.removeClass("ke-menu-selected")});l.call(c,t);c.on("afterItemsChange",c._itemsChange,c);c.menuNode=t},_stateChange:function(b){var c=this.el;b.newVal==1?c.removeClass("ke-select-disabled"):c.addClass("ke-select-disabled")},enable:function(){this.set("state",1)},disable:function(){this.set("state",0)},_select:function(b){b&&b.halt();var c=this.menu,e=this.menuNode;if((b=(new z(b.target))._4e_ascendant(function(a){return e.contains(a)&&a._4e_name()=="a"},true))&&b._4e_hasAttribute("data-value")){var t=
this.get("value"),q=b.attr("data-value");this.set("value",q);this.fire("click",{newVal:q,prevVal:t,name:b.html()});c.hide()}},_real:function(){var b=this.el,c=b.offset(),e=v.clone(c),t=this.menu.get("el").height(),q=this.menu.get("el").width(),a=s.scrollTop(),f=s.scrollLeft(),i=s.viewportHeight(),g=s.viewportWidth();g=f+g-60;i=a+i;var h=c.top+(b.height()-2);b=c.left+b.width()-2;var o=this.get("align"),k=o[0];if(o[1]=="b"){c.top=h;if(c.top+t>i&&e.top-a>i-h)c.top=e.top-t}else{c.top=e.top-t;if(c.top<
a&&e.top-a<i-h)c.top=h}if(k=="l"){if(c.left+q>g&&b-f>g-e.left)c.left=b-q}else{c.left=b-q;if(c.left<f&&b-f<g-e.left)c.left=e.left}this.menu.set("xy",[c.left,c.top]);this.menu.show()},_click:function(b){if(!this.loading){b&&b.preventDefault();var c=this;b=c.el;var e=c.get("value");if(!b.hasClass("ke-select-disabled"))if(c._focusA.hasClass("ke-select-active"))c.menu&&c.menu.hide();else{c.loading=true;m.use("overlay",function(){c.loading=false;c.fire("select");c._prepare();e&&c.menu&&c.as.each(function(t){t.attr("data-value")==
e?t.addClass("ke-menu-selected"):t.removeClass("ke-menu-selected")})})}}},destroy:function(){d.call(this);this.el.detach();this.el.remove()}});m.Select=n;m.prototype.addSelect=function(b,c){var e=this;c=v.mix({container:e.toolBarDiv,doc:e.document,menuContainer:new z(document.body)},c);var t=new n(c),q={name:b,btn:t,editor:e,cfg:c,call:function(){var a=v.makeArray(arguments),f=a.shift();return c[f].apply(q,a)},reload:function(a){v.mix(c,a);t.enable();e.on("selectionChange",function(){e.getMode()!=
m.SOURCE_MODE&&c.selectionChange&&c.selectionChange.apply(q,arguments)});t.on("click",function(f){var i=f.type;c[i]&&c[i].apply(q,arguments);f&&f.halt()});if(c.mode==m.WYSIWYG_MODE){e.on("wysiwygmode",t.enable,t);e.on("sourcemode",t.disable,t)}c.init&&c.init.call(q)},destroy:function(){c.destroy&&c.destroy.call(q);t.destroy()}};c.loading?t.disable():q.reload(undefined);return q}}},{attach:false});
KISSY.Editor.add("bubbleview",function(){var n=KISSY,w=n.Editor,v=n.Event,z=n.DOM;if(w.BubbleView)n.log("attach bubbleview more","warn");else{var r=n.require("uibase").create(w.Overlay,[],{renderUI:function(){this.get("el").addClass("ke-bubbleview-bubble")},show:function(){var m=this.get("el");m.css("visibility","hidden");m.stop(1);m.css("display","none");this.set("visible",true);m.fadeIn(0.3)},hide:function(){var m=this.get("el");m.css("visibility","hidden");m.stop(1);this.set("visible",false)},
destructor:function(){w.Utils.destroyRes.call(this)}},{ATTRS:{focus4e:{value:false},zIndex:{value:w.baseZIndex(w.zIndexManager.BUBBLE_VIEW)}}}),s={};r.destroy=function(m){if((m=s[m])&&m.bubble){m.bubble.destroy();m.bubble=null}};r.attach=function(m){function p(){if(a){a.hide();v.remove(f,"scroll",d)}}function l(){var g;var h=a._selectedEl;if(h){var o=q.iframe[0].contentWindow,k=q.iframe.offset();g=k.top;k=k.left;var u=k+z.width(o);o=g+z.height(o);var x=h._4e_getOffset(document),E=x.top;x=x.left;var j=
x+h.width();h=E+h.height();var y,C;if(h>o&&E<o)C=o-30;else if(h>g&&h<o)C=h;if(j>k&&x<k)y=k;else if(x>k&&x<u)y=x;g=y!==undefined&&C!==undefined?[y,C]:void 0}else g=void 0;if(g){a.set("xy",g);var A;y=a;C=null;for(A in s)if(s.hasOwnProperty(A)){h=s[A];if(h.bubble){if(k=y!=h.bubble){if(k=h.bubble.get("visible")){o=y;u=h.bubble;k=o.get("y");o=k+o.get("el")[0].offsetHeight;E=u.get("y");u=E+u.get("el")[0].offsetHeight;k=k<=u&&o>=u||k<=E&&o>=E}k=k}if(k)if(C){if(C.get("y")<h.bubble.get("y"))C=h.bubble}else C=
h.bubble}}if(A=C){g[1]=A.get("y")+A.get("el")[0].offsetHeight;a.set("xy",g)}a.get("visible")?n.log("already show by selectionChange"):a.show()}}function d(){if(a._selectedEl){if(a){a.get("el");a.hide()}i()}}function b(){v.on(f,"scroll",d);l()}var c=m.pluginName;n.mix(m,s[c].cfg,false);var e=m.pluginContext,t=m.func,q=m.editor,a=m.bubble;q.on("selectionChange",function(g){g=g.path;var h=g.elements;if(g&&h)if(g=g.lastElement)if(g=t(g)){h=s[c];if(!h.bubble){h.bubble=new r;h.bubble.render();h.cfg.init&&
h.cfg.init.call(h.bubble)}a=h.bubble;a._selectedEl=g;a._plugin=e;a.hide();n.later(b,10)}else if(a){a._selectedEl=a._plugin=null;p()}});q.on("sourcemode",p);var f=q.iframe[0].contentWindow,i=w.Utils.buffer(l,undefined,350)};r.register=function(m){var p=m.pluginName;s[p]=s[p]||{cfg:m};m.editor&&r.attach(m)};w.BubbleView=r}},{attach:false,requires:["overlay"]});
KISSY.Editor.add("clipboard",function(n){var w=KISSY,v=w.Editor,z=w.Node,r=w.UA,s=v.Range,m=v.RANGE,p=w.Event;v.Paste||function(){function l(i){this.editor=i;this._init()}function d(i){if(!(!r.ie||i.document.compatMode=="BackCompat")){var g=i.getSelection(),h;if(g.getType()==q.SELECTION_ELEMENT&&(h=g.getSelectedElement())){var o=g.getRanges()[0],k=new z(i.document.createTextNode(""));k.insertBefore(h);o.setStartBefore(k);o.setEndAfter(h);g.selectRanges([o]);setTimeout(function(){if(h.parent()){k.remove();
g.selectElement(h)}},0)}}}w.augment(l,{_init:function(){var i=this.editor;p.on(i.document.body,r.webkit?"paste":r.gecko?"paste":"beforepaste",this._paste,this);p.on(i.document.body,"contextmenu",function(){f=1;setTimeout(function(){f=0},10)});i.addCommand("copy",new t("copy"));i.addCommand("cut",new t("cut"));i.addCommand("paste",new t("paste"))},_paste:function(i){if(!f){w.log(i.type+" :  paste event happen");var g=this.editor,h=g.document;if(h.getElementById("ke_pastebin"))w.log(i.type+" : trigger more than once ...");
else{var o=g.getSelection();i=new s(h);var k=new z(r.webkit?"<body></body>":"<div></div>",null,h);k.attr("id","ke_pastebin");r.webkit&&k[0].appendChild(h.createTextNode("\u00a0"));h.body.appendChild(k[0]);k.css({position:"absolute",top:o.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});k.css("left","-1000px");var u=o.createBookmarks();i.setStartAt(k,m.POSITION_AFTER_START);i.setEndAt(k,m.POSITION_BEFORE_END);i.select(true);setTimeout(function(){k._4e_remove();var x;k=r.webkit&&
(x=k._4e_first())&&x.hasClass("Apple-style-span")?x:k;o.selectBookmarks(u);x=k.html();if(x=w.trim(x.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,""))){w.log("paster "+x);var E=g.fire("paste",{html:x,holder:k});if(E!==undefined)x=E;E=null;if(/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(x))E=g.htmlDataProcessor.wordFilter;g.insertHtml(x,E)}},0)}}}});v.Paste=l;var b=function(i,g){var h=i.document,o=new z(h.body),k=false,u=function(){k=true};o.on(g,u);(r.ie>7?h:h.selection.createRange()).execCommand(g);
o.detach(g,u);return k},c=r.ie?function(i,g){return b(i,g)}:function(i,g){try{return i.document.execCommand(g)}catch(h){return false}},e={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},t=function(i){this.type=i;this.canUndo=this.type=="cut"};t.prototype={exec:function(i){this.type=="cut"&&d(i);(i=c(i,this.type))||alert(e[this.type]);return i}};var q=v.Selection,a={copy:"\u590d\u5236",paste:"\u7c98\u8d34",
cut:"\u526a\u5207"},f;v.on("contextmenu",function(i){var g=i.contextmenu,h=g.cfg.editor,o=g.elDom,k={copy:0,cut:0,paste:0},u;for(u in k)if(k.hasOwnProperty(u)){k[u]=o.one(".ke-paste-"+u);(function(x){var E=k[x];if(!E){E=(new z("<a href='#'class='ke-paste-"+x+"'>"+a[x]+"</a>")).appendTo(o);E.on("click",function(j){j.halt();g.hide();setTimeout(function(){h.execCommand(x)},30)});k[x]=E}})(u)}})}();n.ready(function(){new v.Paste(n)})},{attach:false});
KISSY.Editor.add("color",function(n){n.addPlugin("color",function(){var w=KISSY.Editor,v=n.cfg.pluginConfig,z=[];false!==v.forecolor&&function(){var r=n.addButton("color",{styles:{element:"span",styles:{color:"#(color)"},overrides:[{element:"font",attributes:{color:null}}],childRule:function(s){return!(s._4e_name()=="a"||s.all("a").length)}},mode:w.WYSIWYG_MODE,title:"\u6587\u672c\u989c\u8272",loading:true,contentCls:"ke-toolbar-color"});w.use("colorsupport",function(){r.reload(w.ColorSupport)});z.push(function(){r.destroy()})}();
false!==v.bgcolor&&function(){var r=n.addButton("bgcolor",{styles:{element:"span",styles:{"background-color":"#(color)"},overrides:[{element:"*",styles:{"background-color":null}}],childRule:function(){return false}},title:"\u80cc\u666f\u989c\u8272",mode:w.WYSIWYG_MODE,loading:true,contentCls:"ke-toolbar-bgcolor"});w.use("colorsupport",function(){r.reload(w.ColorSupport)});z.push(function(){r.destroy()})}();this.destroy=function(){for(var r=0;r<z.length;r++)z[r]()}})},{attach:false});
KISSY.Editor.add("colorsupport",function(){function n(){if(!p){p="<div class='ke-color-panel'><a class='ke-color-remove' href=\"javascript:void('\u6e05\u9664');\">\u6e05\u9664</a>";for(var b=0;b<3;b++){p+="<div class='ke-color-palette'><table>";for(var c=m[b],e=c.length/8,t=0;t<e;t++){p+="<tr>";for(var q=0;q<8;q++){var a="#"+c[8*t+q];p+="<td>";p+="<a href='javascript:void(0);' class='ke-color-a' style='background-color:"+a+"'></a>";p+="</td>"}p+="</tr>"}p+="</table></div>"}p+="<div><a class='ke-button ke-color-others'>\u5176\u4ed6\u989c\u8272</a></div></div>"}}
var w=KISSY,v=w.Editor,z=w.Node,r=w.Event,s=w.DOM;s.addStyleSheet(".ke-color-panel a {display: block;color:black;text-decoration: none;}.ke-color-panel a:hover {color:black;text-decoration: none;}.ke-color-panel a:active {color:black;}.ke-color-palette {    margin: 5px 8px 8px;}.ke-color-palette table {    border: 1px solid #666666;    border-collapse: collapse;}.ke-color-palette td {    border-right: 1px solid #666666;    height: 18px;    width: 18px;}a.ke-color-a {    height: 18px;    width: 18px;}a.ke-color-a:hover {    border: 1px solid #ffffff;    height: 16px;    width: 16px;}a.ke-color-remove {  padding:3px 8px;  margin:2px 0 3px 0;}a.ke-color-remove:hover {    background-color: #D6E9F8;}",
"ke-color-plugin");var m=[["000","444","666","999","CCC","EEE","F3F3F3","FFF"],["F00","F90","FF0","0F0","0FF","00F","90F","F0F"],["F4CCCC","FCE5CD","FFF2CC","D9EAD3","D0E0E3","CFE2F3","D9D2E9","EAD1DC","EA9999","F9CB9C","FFE599","B6D7A8","A2C4C9","9FC5E8","B4A7D6","D5A6BD","E06666","F6B26B","FFD966","93C47D","76A5AF","6FA8DC","8E7CC3","C27BAD","CC0000","E69138","F1C232","6AA84F","45818E","3D85C6","674EA7","A64D79","990000","B45F06","BF9000","38761D","134F5C","0B5394","351C75","741B47","660000","783F04",
"7F6000","274E13","0C343D","073763","20124D","4C1130"]],p,l=v.Utils.addRes,d=v.Utils.destroyRes;v.ColorSupport={offClick:function(b){var c=this,e=c.cfg;v.use("overlay",function(){e._prepare.call(c,b)})},onClick:function(){this.colorWin&&this.colorWin.hide()},_prepare:function(){var b=this,c=b.cfg,e=document,t=b.btn,q=b.editor,a;n();b.colorWin=new v.Overlay({elCls:"ks-popup",content:p,focus4e:false,autoRender:true,width:"170px",zIndex:v.baseZIndex(v.zIndexManager.POPUP_MENU)});var f=b.colorWin;a=f.get("contentEl");
a.on("click",c._selectColor,b);r.on(e,"click",c._hidePanel,b);r.on(q.document,"click",c._hidePanel,b);f.on("show",t.bon,t);f.on("hide",t.boff,t);e=a.one(".ke-color-others");e.on("click",function(i){i.halt();f.hide();q.showDialog("color/dialog",[b])});c._prepare=c._show;c._show.call(b);l.call(b,a,f,e)},_show:function(){var b=this.btn.get("el"),c=this.colorWin,e=parseInt(c.get("width")),t=s.viewportWidth();c.align(b,["bl","tl"],[0,2]);c.get("x")+e>t-30&&c.set("x",t-30-e);c.show()},_hidePanel:function(b){var c=
this.btn.get("el");b=new z(b.target);var e=this.colorWin;c._4e_equals(b)||c.contains(b)||e.hide()},_selectColor:function(b){b.halt();var c=this.cfg;b=new z(b.target);if(b._4e_name()=="a"&&!b.hasClass("ke-button")){c._applyColor.call(this,b._4e_style("background-color"));this.colorWin.hide()}},_applyColor:function(b){var c=this.editor,e=c.document,t=this.cfg.styles;c.fire("save");b?(new v.Style(t,{color:b})).apply(e):(new v.Style(t,{color:"inherit"})).remove(e);c.fire("save")},destroy:function(){d.call(this);
var b=this.editor;r.remove(document,"click",this.cfg._hidePanel,this);b.destroyDialog("color/dialog")}}},{attach:false});
KISSY.Editor.add("contextmenu",function(){function n(d){this.cfg=d;z.Utils.lazyRun(this,"_prepareShow","_realShow")}function w(d,b){for(var c=0;c<b.length;c++){var e=b[c];if(v.isFunction(e)){if(e(new r(d)))return true}else if(s.test(d,e))return true}return false}var v=KISSY,z=v.Editor,r=v.Node,s=v.DOM,m=v.Event;if(z.ContextMenu)v.log("attach ContextMenu twice","warn");else{n.ATTRS={editor:{}};var p=[];n.register=function(d){var b=new n(d),c=d.editor,e=c.document;p.push({doc:e,rules:d.rules||[],instance:b});
if(!e.ke_contextmenu){e.ke_contextmenu=1;m.on(e,"mousedown",n.hide);c.on("sourcemode",n.hide,e);m.on(e.body,"contextmenu",function(t){n.hide.call(this);for(var q=new r(t.target);q;){var a=false;if(q._4e_name()=="body")break;for(var f=0;f<p.length;f++){var i=p[f].instance,g=p[f].rules;if(e===p[f].doc&&w(q[0],g)){t.preventDefault();a=true;var h=t.pageX,o=t.pageY;if(!h){f=q._4e_getOffset();h=f.left;o=f.top}setTimeout(function(){i.show(z.Utils.getXY(h,o,e,document))},30);break}}if(a)break;q=q.parent()}})}return b};
n.hide=function(){for(var d=0;d<p.length;d++){var b=p[d].instance;this===p[d].doc&&b.hide()}};var l=z.Overlay;v.augment(n,{_init:function(){var d=this,b=d.cfg,c=b.funcs;d.el=new l({content:"<div>",autoRender:true,width:b.width,elCls:"ke-menu"});d.elDom=d.el.get("contentEl").one("div");b=d.elDom;for(var e in c){var t=new r("<a href='#'>"+e+"</a>");b[0].appendChild(t[0]);(function(q,a){q._4e_unselectable();q.on("click",function(f){f.halt();if(!q.hasClass("ke-menuitem-disable")){d.hide();setTimeout(a,
30)}})})(t,c[e])}},destroy:function(){if(this.el){this.elDom.children().detach();this.el.destroy()}},hide:function(){this.el&&this.el.hide()},_realShow:function(d){z.fire("contextmenu",{contextmenu:this});this.el.set("xy",[d.left,d.top]);d=this.cfg;var b=d.statusChecker;if(b)for(var c=this.elDom.children("a"),e=0;e<c.length;e++){var t=new r(c[e]),q=b[v.trim(t.text())];if(q)q(d.editor)?t.removeClass("ke-menuitem-disable"):t.addClass("ke-menuitem-disable")}this.el.show()},_prepareShow:function(){this._init()},
show:function(d){this._prepareShow(d)}});z.ContextMenu=n}},{attach:false,requires:["overlay"]});KISSY.Editor.add("draft",function(n){var w=KISSY.Editor;n.addPlugin("draft",function(){var v=this;w.use("draft/support",function(){w.storeReady(function(){var z=new w.Draft(n);v.destroy=function(){z.destroy()}})})})},{attach:false});
KISSY.Editor.add("draft/support",function(){function n(b,c,e){for(b+="";b.length<c;)b=e+b;return b}function w(b){if(z.isNumber(b))b=new Date(b);return b instanceof Date?[b.getFullYear(),"-",n(b.getMonth()+1,2,"0"),"-",n(b.getDate(),2,"0")," ",n(b.getHours(),2,"0"),":",n(b.getMinutes(),2,"0"),":",n(b.getSeconds(),2,"0")].join(""):b}function v(b){this.editor=b;this._init()}var z=KISSY,r=z.Editor,s=z.Node,m=z.Event,p=z.JSON,l=r.Utils.addRes,d=r.Utils.destroyRes;z.augment(v,{_getSaveKey:function(){var b=
this.editor.cfg.pluginConfig;return b.draft&&b.draft.saveKey||"ke-draft-save20110503"},_getDrafts:function(){var b=r.localStorage;if(!this.drafts){var c=b.getItem(this._getSaveKey()),e=[];if(c)e=b==window.localStorage?p.parse(decodeURIComponent(c)):c;this.drafts=e}return this.drafts},_init:function(){var b=this,c=b.editor,e=c.statusDiv,t=c.cfg.pluginConfig;t.draft=t.draft||{};b.draftInterval=t.draft.interval=t.draft.interval||5;b.draftLimit=t.draft.limit=t.draft.limit||5;e=(new s("<div class='ke-draft'><span class='ke-draft-title'>\u5185\u5bb9\u6b63\u6587\u6bcf"+
t.draft.interval+"\u5206\u949f\u81ea\u52a8\u4fdd\u5b58\u4e00\u6b21\u3002</span></div>")).appendTo(e);b.timeTip=(new s("<span class='ke-draft-time'/>")).appendTo(e);var q=(new s("<a href='#' onclick='return false;' class='ke-button ke-draft-save-btn' style='vertical-align:middle;padding:1px 9px;'><span class='ke-draft-mansave'></span><span>\u7acb\u5373\u4fdd\u5b58</span></a>")).appendTo(e),a=new r.Select({container:e,menuContainer:document.body,doc:c.document,width:"85px",popUpWidth:"225px",align:["r","t"],emptyText:"&nbsp;&nbsp;&nbsp;\u5c1a\u65e0\u7f16\u8f91\u5668\u5386\u53f2\u5b58\u5728",title:"\u6062\u590d\u7f16\u8f91\u5386\u53f2"});
b.versions=a;a.on("select",function(){a.detach("select",arguments.callee);b.sync()});q._4e_unselectable();q.on("click",function(i){b.save(false);i.halt()});l.call(b,q);c.textarea[0].form&&function(){function i(){b.save(true)}var g=c.textarea[0].form;m.on(g,"submit",i);l.call(b,function(){m.remove(g,"submit",i)})}();var f=setInterval(function(){b.save(true)},b.draftInterval*60*1E3);l.call(b,function(){clearInterval(f)});a.on("click",b.recover,b);l.call(b,a);b.holder=e;if(t.draft.helpHtml){t=new r.TripleButton({elCls:"ke-draft-help",
title:"\u70b9\u51fb\u67e5\u770b\u5e2e\u52a9",text:"\u70b9\u51fb\u67e5\u770b\u5e2e\u52a9",render:e});t.render();t.on("click",function(i){b._help&&b._help.get("visible")?b._help.hide():b._prepareHelp();i&&i.halt()});l.call(b,t);r.Utils.lazyRun(b,"_prepareHelp","_realHelp");b.helpBtn=t.get("el")}l.call(b,e)},_prepareHelp:function(){function b(f){f&&f.halt();f=new s(f.target);f[0]==t[0]||t.contains(f)||c._help.hide()}var c=this,e=c.editor,t=c.helpBtn,q=new s(e.cfg.pluginConfig.draft.helpHtml||""),a=new s("<div style='height:0;position:absolute;font-size:0;width:0;border:8px #000 solid;border-color:#000 transparent transparent transparent;border-style:solid dashed dashed dashed;border-top-color:#CED5E0;'><div style='height:0;position:absolute;font-size:0;width:0;border:8px #000 solid;border-color:#000 transparent transparent transparent;border-style:solid dashed dashed dashed;left:-8px;top:-10px;border-top-color:white;'></div></div>");
q.append(a);q.css({border:"1px solid #ACB4BE","text-align":"left"});c._help=new (z.require("overlay"))({content:q,autoRender:true,width:q.width()+"px",mask:false});c._help.get("el").css("border","none");c._help.arrow=a;m.on([document,e.document],"click",b);l.call(c,c._help,function(){m.remove([document,e.document],"click",b)})},_realHelp:function(){var b=this._help,c=this.helpBtn,e=b.arrow;b.show();c=c.offset();b.get("el").offset({left:c.left-b.get("el").width()+17,top:c.top-b.get("el").height()-
7});e.offset({left:c.left-2,top:c.top-8})},disable:function(){this.holder.css("visibility","hidden")},enable:function(){this.holder.css("visibility","")},sync:function(){var b=r.localStorage,c=this.draftLimit,e=this.timeTip,t=this.versions,q=this._getDrafts();q.length>c&&q.splice(0,q.length-c);c=[];for(var a,f=0;f<q.length;f++){a=q[f];a=(a.auto?"\u81ea\u52a8":"\u624b\u52a8")+"\u4fdd\u5b58\u4e8e : "+w(a.date);c.push({name:a,value:f})}t.set("items",c.reverse());e.html(a);b.setItem(this._getSaveKey(),b==window.localStorage?encodeURIComponent(p.stringify(q)):
q)},save:function(b){var c=this._getDrafts(),e=this.editor.getData(true);if(e){if(c[c.length-1]&&e==c[c.length-1].content)c.length-=1;this.drafts=c.concat({content:e,date:(new Date).getTime(),auto:b});this.sync()}},recover:function(b){var c=this.editor,e=this.versions,t=this._getDrafts(),q=b.newVal;e.reset("value");if(confirm("\u786e\u8ba4\u6062\u590d "+w(t[q].date)+" \u7684\u7f16\u8f91\u5386\u53f2\uff1f")){c.fire("save");c.setData(t[q].content);c.fire("save")}b&&b.halt()},destroy:function(){d.call(this)}});r.Draft=v},{attach:false,requires:["localstorage"]});
KISSY.Editor.add("dragupload",function(n){function w(g){g=g.originalEvent.target;if(l._4e_name(g)=="img"&&g.src.match(/^file:\/\//))f[g.src]=g}function v(g,h){var o=new window.FileReader;o.onload=function(k){var u=g.name;k=k.target.result;var x=new XMLHttpRequest;x.open("POST",t,true);x.onreadystatechange=function(){if(x.readyState==4){if(x.status==200||x.status==304){if(x.responseText!=""){var y=window.JSON.parse(x.responseText);h[0].src=y.imgUrl}}else{alert("\u670d\u52a1\u5668\u7aef\u51fa\u9519\uff01");h._4e_remove();z.log(x)}x.onreadystatechange=
null}};var E="\r\n------kissy-editor-2.1\r\n";E+='Content-Disposition: form-data; name="'+b+'"; filename="'+encodeURIComponent(u)+'"\r\n';E+="Content-Type: "+(g.type||"application/octet-stream")+"\r\n\r\n";E+=k+"\r\n";e=r.Utils.normParams(e);for(var j in e)if(e.hasOwnProperty(j)){E+="------kissy-editor-2.1\r\n";E+='Content-Disposition: form-data; name="'+j+'"\r\n\r\n';E+=e[j]+"\r\n"}E+="------kissy-editor-2.1--";x.setRequestHeader("Content-Type","multipart/form-data, boundary=----kissy-editor-2.1");
x.sendAsBinary("Content-Type: multipart/form-data; boundary=----kissy-editor-2.1\r\nContent-Length: "+E.length+"\r\n"+E+"\r\n");o.onload=null};o.readAsBinaryString(g)}var z=KISSY,r=z.Editor,s=z.Node,m=z.Event,p=z.UA,l=z.DOM,d=n.cfg.pluginConfig.dragupload||{},b=d.fileInput||"Filedata",c=d.sizeLimit||Number.MAX_VALUE,e=d.serverParams||{},t=d.serverUrl||"",q=RegExp((d.suffix||"png,jpg,jpeg,gif").split(/,/).join("|")+"$","i"),a=n.document;if(!p.ie){var f={},i=false;m.on(a,"dragenter",function(){if(!i){m.on(a,
"DOMNodeInserted",w);i=true}});m.on(a,"drop",function(g){m.remove(a,"DOMNodeInserted",w);i=false;g.halt();g=g.originalEvent;z.log(g);var h,o;if(z.isEmptyObject(f)){o=a.elementFromPoint(g.clientX,g.clientY);h=o.lastChild}else{z.each(f,function(y){if(l._4e_name(y)=="img"){h=y.nextSibling;o=y.parentNode;l._4e_remove(y)}});f={}}g=g.dataTransfer;g.dropEffect="copy";if(g=g.files)for(var k=0;k<g.length;k++){var u=g[k],x=u.size;if(u.name.match(q))if(!(x/1E3>c)){x=new s("<img src='"+(r.Config.base+"../theme/loading.gif")+
"'/>");var E=x[0];o.insertBefore(E,h);var j=l._4e_name(E.parentNode);if(j=="head"||j=="html")l.insertBefore(E,a.body.firstChild);v(u,x)}}});if(window.XMLHttpRequest&&!XMLHttpRequest.prototype.sendAsBinary)XMLHttpRequest.prototype.sendAsBinary=function(g,h){for(var o=new (window.BlobBuilder||window.WebKitBlobBuilder),k=g.length,u=new window.Uint8Array(k),x=0;x<k;x++)u[x]=g.charCodeAt(x);o.append(u.buffer);this.send(o.getBlob(h))}}},{attach:false});
KISSY.Editor.add("elementpaths",function(n){var w=KISSY.Editor,v=KISSY,z=v.Node,r=v.DOM;w.ElementPaths||function(){function s(m){this.cfg=m;this._cache=[];this._init()}r.addStyleSheet(".elementpath {   padding: 0 5px;    text-decoration: none;}.elementpath:hover {    background: #CCFFFF;    text-decoration: none;}","ke-ElementPaths");v.augment(s,{_init:function(){var m=this.cfg.editor;this.holder=new z("<span>");this.holder.appendTo(m.statusDiv);m.on("selectionChange",this._selectionChange,this);
w.Utils.sourceDisable(m,this)},disable:function(){this.holder.css("visibility","hidden")},enable:function(){this.holder.css("visibility","")},_selectionChange:function(m){var p=this.cfg.editor,l=this.holder;m=m.path.elements;var d,b;d=this._cache;for(b=0;b<d.length;b++){d[b].detach("click");d[b]._4e_remove()}this._cache=[];for(b=0;b<m.length;b++){d=m[b];var c=new z("<a href='#' class='elementpath'>"+(d.attr("_ke_real_element_type")||d._4e_name())+"</a>");this._cache.push(c);(function(e){c.on("click",
function(t){t.halt();p.focus();setTimeout(function(){p.getSelection().selectElement(e)},50)})})(d);l.prepend(c)}},destroy:function(){this.holder.remove()}});w.ElementPaths=s}();n.addPlugin("elementpaths",function(){var s=new w.ElementPaths({editor:n});this.destroy=function(){s.destroy()}})},{attach:false});
KISSY.Editor.add("enterkey",function(n){var w=KISSY,v=w.Editor,z=w.UA,r=/^h[1-6]$/,s=v.XHTML_DTD,m=w.Node,p=w.Event,l=v.Walker,d=v.ElementPath;v.enterBlock||function(){function b(c){p.on(c.document,"keydown",function(e){if(e.keyCode===13)if(!e.shiftKey){c.fire("save");var t=c.execCommand("enterBlock");c.fire("save");t!==false&&e.preventDefault()}})}b.enterBlock=function(c){var e;e=c.getSelection().getRanges();for(var t=e.length-1;t>0;t--)e[t].deleteContents();e=e[0];t=e.document;if(e.checkStartOfBlock()&&
e.checkEndOfBlock()){var q=(new d(e.startContainer)).block;if(q&&(q._4e_name()=="li"||q.parent()._4e_name()=="li"))if(c.hasCommand("outdent")){c.fire("save");c.execCommand("outdent");c.fire("save");return true}else return false}var a=e.splitBlock("p");if(!a)return true;c=a.previousBlock;q=a.nextBlock;var f=a.wasStartOfBlock,i=a.wasEndOfBlock,g;if(q){g=q.parent();if(g._4e_name()=="li"){q._4e_breakParent(g);q._4e_move(q._4e_next(),true)}}else if(c&&(g=c.parent())&&g._4e_name()=="li"){c._4e_breakParent(g);
e.moveToElementEditablePosition(c._4e_next());c._4e_move(c._4e_previous())}if(!f&&!i){if(q._4e_name()=="li"&&(g=q._4e_first(l.invisible(true)))&&w.inArray(g._4e_name(),["ul","ol"]))(z.ie?new m(t.createTextNode("\u00a0")):new m(t.createElement("br"))).insertBefore(g);q&&e.moveToElementEditablePosition(q)}else{var h;if(c){if(c._4e_name()=="li"||!r.test(c._4e_name()))h=c._4e_clone()}else if(q)h=q._4e_clone();h||(h=new m("<p>",null,t));if(g=a.elementPath){a=0;for(var o=g.elements.length;a<o;a++){var k=g.elements[a];
if(k._4e_equals(g.block)||k._4e_equals(g.blockLimit))break;if(s.$removeEmpty[k._4e_name()]){k=k._4e_clone();h._4e_moveChildren(k);h.append(k)}}}z.ie||h._4e_appendBogus();e.insertNode(h);if(z.ie&&f&&(!i||!c[0].childNodes.length)){e.moveToElementEditablePosition(i?c:h);e.select()}e.moveToElementEditablePosition(f&&!i?q:h)}if(!z.ie)if(q){h=new m(t.createElement("span"));h.html("&nbsp;");e.insertNode(h);h._4e_scrollIntoView();e.deleteContents()}else h._4e_scrollIntoView();e.select();return true};v.EnterKey=
b}();n.addCommand("enterBlock",{exec:v.EnterKey.enterBlock});v.EnterKey(n)},{attach:false});
KISSY.Editor.add("fakeobjects",function(n){var w=KISSY.Editor,v=KISSY,z=v.Node,r=w.NODE,s=w.Config.base+"../theme/spacer.gif",m=w.HtmlParser;w=v.Editor;var p=n.htmlDataProcessor,l=p&&p.htmlFilter,d={elements:{$:function(b){var c=b.attributes;if((c=(c=(c=c&&c._ke_realelement)&&new m.Fragment.FromHtml(decodeURIComponent(c)))&&c.children[0])&&b.attributes._ke_resizable){var e=b.attributes.style;if(e){var t=/(?:^|\s)width\s*:\s*(\d+)/i.exec(e);b=t&&t[1];e=(t=/(?:^|\s)height\s*:\s*(\d+)/i.exec(e))&&t[1];
if(b)c.attributes.width=b;if(e)c.attributes.height=e}}return c}}};l&&l.addRules(d);p&&v.mix(p,{createFakeParserElement:function(b,c,e,t,q){var a;a=new m.BasicWriter;b.writeHtml(a);a=a.getHtml();var f=b.attributes.style||"";if(b.attributes.width)f="width:"+b.attributes.width+"px;"+f;if(b.attributes.height)f="height:"+b.attributes.height+"px;"+f;var i=v.trim(b.attributes["class"]);b={"class":c+" "+i,src:s,_ke_realelement:encodeURIComponent(a),_ke_real_node_type:b.type,style:f,align:b.attributes.align||
""};q&&delete q.width;q&&delete q.height;q&&v.mix(b,q,false);if(e)b._ke_real_element_type=e;if(t)b._ke_resizable=t;return new m.Element("img",b)}});n.createFakeElement||v.augment(w,{createFakeElement:function(b,c,e,t,q,a){var f=b.attr("style")||"";if(b.attr("width"))f="width:"+b.attr("width")+"px;"+f;if(b.attr("height"))f="height:"+b.attr("height")+"px;"+f;var i=v.trim(b.attr("class"));b={"class":c+" "+i,src:s,_ke_realelement:encodeURIComponent(q||b._4e_outerHtml()),_ke_real_node_type:b[0].nodeType,
style:f};a&&delete a.width;a&&delete a.height;a&&v.mix(b,a,false);if(e)b._ke_real_element_type=e;if(t)b._ke_resizable=t;return new z("<img/>",b,this.document)},restoreRealElement:function(b){if(b.attr("_ke_real_node_type")!=r.NODE_ELEMENT)return null;b=decodeURIComponent(b.attr("_ke_realelement"));var c=new z("<div>",null,this.document);c.html(b);return c._4e_first(function(e){return e[0].nodeType==r.NODE_ELEMENT})._4e_remove()}})},{attach:false,requires:["htmldataprocessor"]});
KISSY.Editor.add("flash",function(n){var w=KISSY.Editor,v=n.htmlDataProcessor,z=n.cfg.pluginConfig,r=v&&v.dataFilter;r&&r.addRules({elements:{object:function(s){var m=s.attributes;if(!(m.classid&&String(m.classid).toLowerCase())){for(m=0;m<s.children.length;m++)if(s.children[m].name=="embed"){if(!w.Utils.isFlashEmbed(s.children[m]))break;return v.createFakeParserElement(s,"ke_flash","flash",true)}return null}return v.createFakeParserElement(s,"ke_flash","flash",true)},embed:function(s){if(!w.Utils.isFlashEmbed(s))return null;
return v.createFakeParserElement(s,"ke_flash","flash",true)}}},5);n.addPlugin("flash",function(){var s;if(!z.flash||z.flash.btn!==false)s=n.addButton("flash",{contentCls:"ke-toolbar-flash",title:"\u63d2\u5165Flash",mode:w.WYSIWYG_MODE,loading:true});w.use("flash/support",function(){var m=new w.Flash(n);s&&s.reload({offClick:function(){m.show()},destroy:function(){m.destroy()}})});this.destroy=function(){s.destroy()}})},{attach:false,requires:["fakeobjects"]});
KISSY.Editor.add("flash/support",function(){function n(e){this.editor=e;this._init()}function w(e){return e._4e_name()==="img"&&!!e.hasClass(d)&&e}var v=KISSY,z=v.Editor,r=v.UA,s=v.Event,m=z.ContextMenu,p=v.Node,l=z.BubbleView,d="ke_flash",b=z.Utils.flash;v.augment(n,{_config:function(){this._cls=d;this._type="flash";this._contextMenu=c;this._flashRules=["img."+d]},_init:function(){this._config();var e=this,t=e.editor,q={},a=e._contextMenu;if(a)for(var f in a)(function(i){q[i]=function(){a[i](e)}})(f);
e._contextMenu=m.register({editor:t,rules:e._flashRules,width:"120px",funcs:q});l.attach({pluginName:e._type,editor:e.editor,pluginContext:e});s.on(t.document,"dblclick",e._dbclick,e)},_getFlashUrl:function(e){return b.getUrl(e)},_updateTip:function(e,t){var q=this.editor.restoreRealElement(t);if(q){q=this._getFlashUrl(q);e.attr("href",q)}},_dbclick:function(e){var t=new p(e.target);if(t._4e_name()==="img"&&t.hasClass(this._cls)){this.show(null,t);e.halt()}},show:function(e,t){this.editor.showDialog(this._type+
"/dialog",[t])},destroy:function(){var e=this.editor;this._contextMenu.destroy();l.destroy(this._type);s.remove(e.document,"dblclick",this._dbclick,this);e.destroyDialog(this._type+"/dialog")}});z.Flash=n;n.registerBubble=function(e,t,q){l.register({pluginName:e,func:q,init:function(){var a=this,f=a.get("contentEl");f.html(v.substitute(' <a class="ke-bubbleview-url" target="_blank" href="#">{label}</a>   |    <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span>   |    <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>',
{label:t}));var i=f.one(".ke-bubbleview-url"),g=f.one(".ke-bubbleview-change"),h=f.one(".ke-bubbleview-remove");z.Utils.preventFocus(f);g.on("click",function(o){a._plugin.show(null,a._selectedEl);o.halt()});h.on("click",function(o){var k=a._plugin;if(r.webkit){var u=k.editor.getSelection().getRanges();u&&u[0]&&(u[0].collapse(true)||1)&&u[0].select()}a._selectedEl._4e_remove();a.hide();k.editor.notifySelectionChange();o.halt()});z.Utils.addRes.call(a,g,h);a.on("show",function(){var o=a._selectedEl;
o&&a._plugin._updateTip(i,o)})}})};n.registerBubble("flash","\u5728\u65b0\u7a97\u53e3\u67e5\u770b",w);n.checkFlash=w;var c={"Flash\u5c5e\u6027":function(e){var t=e.editor.getSelection();t=t&&t.getStartElement();(t=w(t))&&e.show(null,t)}};n.CLS_FLASH=d;n.TYPE_FLASH="flash";n.Insert=function(e,t,q,a,f,i){t=b.createSWF(t,{attrs:q},e.document);var g=t.el;q=e.createFakeElement?e.createFakeElement(g,a||"ke_flash",f||"flash",true,t.html,q):g;e.insertElement(q,null,i)};z.Flash=n},{attach:false,requires:["bubbleview","contextmenu","flashutils"]});
KISSY.Editor.add("flashbridge",function(){function n(b){this._init(b)}function w(b){var c=z.isString(b)?b.match(/(\d)+/g):b;b=b;if(z.isArray(c))b=parseFloat(c[0]+"."+v(c[1],3)+v(c[2],5));return b||0}function v(b,c){for(var e=(b+"").length;e++<c;)b="0"+b;return b}var z=KISSY,r=z.Editor;if(r.FlashBridge)z.log("KE.FlashBridge attach more","warn");else{var s={};z.augment(n,z.EventTarget,{_init:function(b){var c=z.guid("flashbridge-");b.flashVars=b.flashVars||{};b.attrs=b.attrs||{};b.params=b.params||
{};var e=b.flashVars,t=b.params;z.mix(b.attrs,{id:c,width:"100%",height:"100%"},false);z.mix(t,{allowScriptAccess:"always",allowNetworking:"all",scale:"noScale"},false);z.mix(e,{shareData:false,useCompression:false},false);t={YUISwfId:c,YUIBridgeCallback:"KISSY.Editor.FlashBridge.EventHandler"};if(b.ajbridge)t={swfID:c,jsEntry:"KISSY.Editor.FlashBridge.EventHandler"};z.mix(e,t);s[c]=this;this.id=c;this.swf=r.Utils.flash.createSWFRuntime(b.movie,b);this._expose(b.methods)},_expose:function(b){for(var c=
this,e=0;e<b.length;e++)(function(t){c[t]=function(){return c._callSWF(t,z.makeArray(arguments))}})(b[e])},_callSWF:function(b,c){c=c||[];try{if(this.swf[b])return this.swf[b].apply(this.swf,c)}catch(e){var t="";if(c.length!==0)t="'"+c.join("', '")+"'";return(new Function("self","return self.swf."+b+"("+t+");"))(this)}},_eventHandler:function(b){var c=b.type;if(c==="log")z.log(b.message);else c&&this.fire(c,b)},_destroy:function(){delete s[this.id]}});n.EventHandler=function(b,c){z.log("flash fire event : "+
c.type);var e=s[b];e&&setTimeout(function(){e._eventHandler.call(e,c)},100)};r.FlashBridge=n;var m=z.UA,p,l,d=true;m.fpv=function(b){if(b||d){d=false;var c;if(navigator.plugins&&navigator.mimeTypes.length)c=(navigator.plugins["Shockwave Flash"]||{}).description;else if(window.ActiveXObject)try{c=(new ActiveXObject("ShockwaveFlash.ShockwaveFlash")).GetVariable("$version")}catch(e){}p=c?c.match(/(\d)+/g):void 0;l=w(p)}return p};m.fpvGEQ=function(b,c){d&&m.fpv(c);return!!l&&l>=w(b)}}},{attach:false});
KISSY.Editor.add("flashutils",function(){var n=KISSY,w=n.Editor,v=w.Utils.flash;if(v)n.log("flashUtils attach more");else{var z=n.DOM,r=n.Node,s=n.UA;v={getUrl:function(m){var p="",l=w.NODE;if(m._4e_name()=="object"){m=m[0].childNodes;for(var d=0;d<m.length;d++)if(m[d].nodeType==l.NODE_ELEMENT)if((z.attr(m[d],"name")||"").toLowerCase()=="movie")p=z.attr(m[d],"value");else if(z._4e_name(m[d])=="embed")p=z.attr(m[d],"src");else if(z._4e_name(m[d])=="object")p=z.attr(m[d],"data")}else if(m._4e_name()==
"embed")p=m.attr("src");return p},createSWF:function(m,p,l){var d=p.attrs||{},b=p.flashVars,c="",e="";p=p.params||{};var t="";l=l||document;n.mix(d,{wmode:"transparent"});for(var q in d)if(d.hasOwnProperty(q))c+=q+"='"+d[q]+"' ";n.mix(p,{quality:"high",movie:m,wmode:"transparent"});for(var a in p)if(p.hasOwnProperty(a))e+="<param name='"+a+"' value='"+p[a]+"'/>";if(b){for(var f in b)if(b.hasOwnProperty(f))t+="&"+f+"="+encodeURIComponent(b[f]);t=t.substring(1)}m="<object "+c+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" >'+
e+(t?'<param name="flashVars" value="'+t+'"/>':"")+"<embed "+c+" "+(t?'FlashVars="'+t+'"':"")+' pluginspage="http://www.macromedia.com/go/getflashplayer"  quality="high"  src="'+m+'"  type="application/x-shockwave-flash"/></object>';return{el:new r(m,null,l),html:m}},createSWFRuntime2:function(m,p,l){l=l||document;var d=(new r("<div style='width:0;height:0;overflow:hidden;'>",null,l)).appendTo(l.body);d=v.createSWF.apply(this,arguments).el.appendTo(d);s.ie||(d=d.one("object"));return d[0]},createSWFRuntime:function(m,
p,l){var d=p.attrs||{},b=p.flashVars||{},c=p.params||{},e="",t="",q="";l=l||document;d.id=d.id||n.guid("ke-runtimeflash-");for(var a in d)if(d.hasOwnProperty(a))e+=a+"='"+d[a]+"' ";for(var f in c)if(c.hasOwnProperty(f))t+="<param name='"+f+"' value='"+c[f]+"'/>";for(var i in b)if(b.hasOwnProperty(i))q+="&"+i+"="+encodeURIComponent(b[i]);q=q.substring(1);m=s.ie?"<object "+e+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" >'+t+'<param name="movie" value="'+m+'" />'+(q?'<param name="flashVars" value="'+
q+'" />':"")+"</object>":"<object type='application/x-shockwave-flash' data='"+m+"' "+e+">"+t+(q?'<param name="flashVars" value="'+q+'"/>':"")+"</object>";var g=p.holder;if(!g){g=(new r("<div style='"+(p.style?p.style:"width:1px;height:1px;position:absolute;"+ +"overflow:hidden;")+"'>",null,l)).appendTo(l.body);setTimeout(function(){g.offset({left:z.scrollLeft(),top:z.scrollTop()})},100)}g.html(m);return l.getElementById(d.id)}};w.Utils.flash=v}},{attach:false});
KISSY.Editor.add("font",function(n){n.addPlugin("font",function(){function w(h){for(var o=[],k=0;k<h.length;k++)o.push({name:h[k],value:h[k]});return o}var v=KISSY,z=v.Editor,r=z.Style,s=z.TripleButton,m=n.cfg.pluginConfig,p=m["font-size"],l,d,b,c=[];if(p!==false){p=p||{};v.mix(p,{items:w(["8px","10px","12px","14px","18px","24px","36px","48px","60px","72px","84px","96px"]),width:"55px"},false);var e={},t=[],q={element:"span",styles:{"font-size":"#(size)"},overrides:[{element:"font",attributes:{size:null}}]};
for(g=0;g<p.items.length;g++){l=p.items[g];d=l.name;b=l.attrs;l=l.value;e[l]=new r(q,{size:l});t.push({name:d,value:l,attrs:b})}m["font-size"]=p}q=m["font-family"];if(q!==false){q=q||{};v.mix(q,{items:[{name:"\u5b8b\u4f53",value:"SimSun"},{name:"\u9ed1\u4f53",value:"SimHei"},{name:"\u96b6\u4e66",value:"LiSu"},{name:"\u6977\u4f53",value:"KaiTi_GB2312"},{name:"\u5fae\u8f6f\u96c5\u9ed1",value:"Microsoft YaHei"},{name:"Georgia",value:"Georgia"},{name:"Times New Roman",value:"Times New Roman"},{name:"Impact",value:"Impact"},{name:"Courier New",value:"Courier New"},
{name:"Arial",value:"Arial"},{name:"Verdana",value:"Verdana"},{name:"Tahoma",value:"Tahoma"}],width:"130px"},false);var a={},f=[],i={element:"span",styles:{"font-family":"#(family)"},overrides:[{element:"font",attributes:{face:null}}]},g;m["font-family"]=q;for(g=0;g<q.items.length;g++){l=q.items[g];d=l.name;b=l.attrs||{};l=l.value;b.style=b.style||"";b.style+=";font-family:"+l;a[l]=new r(i,{family:l});f.push({name:d,value:l,attrs:b})}}d={click:function(h){var o=h.newVal;h=h.prevVal;var k=this.cfg.styles;
n.focus();n.fire("save");k=k[o];o==h?k.remove(n.document):k.apply(n.document);n.fire("save")},selectionChange:function(h){h=h.path.elements;for(var o=this.cfg.styles,k=0,u;k<h.length;k++){u=h[k];for(var x in o)if(o.hasOwnProperty(x))if(o[x].checkElementRemovable(u,true)){this.btn.set("value",x);return}}(x=this.cfg.defaultValue)?this.btn.set("value",x):this.btn.reset("value")}};false!==m["font-size"]&&c.push(n.addSelect("font-size",v.mix({title:"\u5927\u5c0f",width:"30px",mode:z.WYSIWYG_MODE,showValue:true,
defaultValue:p.defaultValue,popUpWidth:p.width,items:t,styles:e},d)));false!==m["font-family"]&&c.push(n.addSelect("font-family",v.mix({title:"\u5b57\u4f53",width:"110px",mode:z.WYSIWYG_MODE,defaultValue:q.defaultValue,popUpWidth:q.width,items:f,styles:a},d)));z={mode:z.WYSIWYG_MODE,offClick:function(){var h=this.editor,o=this.cfg.style;h.fire("save");o.apply(h.document);h.fire("save");h.notifySelectionChange();h.focus()},onClick:function(){var h=this.editor,o=this.cfg.style;h.fire("save");o.remove(h.document);
h.fire("save");h.notifySelectionChange();h.focus()},selectionChange:function(h){var o=this.btn;this.cfg.style.checkActive(h.path)?o.set("state",s.ON):o.set("state",s.OFF)}};false!==m["font-bold"]&&c.push(n.addButton("font-bold",v.mix({contentCls:"ke-toolbar-bold",title:"\u7c97\u4f53 ",style:new r({element:"strong",overrides:[{element:"b"},{element:"span",attributes:{style:"font-weight: bold;"}}]})},z)));false!==m["font-italic"]&&c.push(n.addButton("font-italic",v.mix({contentCls:"ke-toolbar-italic",title:"\u659c\u4f53 ",
style:new r({element:"em",overrides:[{element:"i"},{element:"span",attributes:{style:"font-style: italic;"}}]})},z)));false!==m["font-underline"]&&c.push(n.addButton("font-underline",v.mix({contentCls:"ke-toolbar-underline",title:"\u4e0b\u5212\u7ebf ",style:new r({element:"u",overrides:[{element:"span",attributes:{style:"text-decoration: underline;"}}]})},z)));if(false!==m["font-strikeThrough"])c.push(n.addButton("font-underline",v.mix({contentCls:"ke-toolbar-strikeThrough",title:"\u5220\u9664\u7ebf ",style:new r((m["font-strikeThrough"]||
{}).style||{element:"del",overrides:[{element:"span",attributes:{style:"text-decoration: line-through;"}},{element:"s"},{element:"strike"}]})},z)));this.destroy=function(){for(var h=0;h<c.length;h++)c[h].destroy()}})},{attach:false});
KISSY.Editor.add("format",function(n){n.addPlugin("format",function(){var w=KISSY.Editor,v=[],z={"\u666e\u901a\u6587\u672c":"p","\u6807\u98981":"h1","\u6807\u98982":"h2","\u6807\u98983":"h3","\u6807\u98984":"h4","\u6807\u98985":"h5","\u6807\u98986":"h6"},r={p:"1em",h1:"2em",h2:"1.5em",h3:"1.17em",h4:"1em",h5:"0.83em",h6:"0.67em"},s={},m=w.Style,p;for(p in z)if(z[p]){s[z[p]]=new m({element:z[p]});v.push({name:p,value:z[p],attrs:{style:"font-size:"+r[z[p]]}})}var l=n.addSelect("font-family",{items:v,title:"\u6807\u9898",width:"100px",mode:w.WYSIWYG_MODE,popUpWidth:"120px",click:function(d){var b=
d.newVal;d=d.prevVal;n.fire("save");if(b!=d)s[b].apply(n.document);else{s.p.apply(n.document);this.btn.set("value","p")}n.fire("save")},selectionChange:function(d){d=d.path;for(var b in s)if(s[b].checkActive(d)){this.btn.set("value",b);break}}});this.destroy=function(){l.destroy()}})},{attach:false});
KISSY.Editor.add("htmldataprocessor",function(n){function w(f){return f.replace(t,function(i,g,h){return"<"+g+h.replace(q,function(o,k){if(h.indexOf("_ke_saved_"+k)==-1)return" _ke_saved_"+o+" "+o;return o})+">"})}var v=v,z=KISSY,r=z.Editor,s=z.Node,m=z.UA,p=r.NODE,l=r.HtmlParser,d=new l.Filter,b=new l.Filter,c=new l.Filter,e=r.XHTML_DTD;if(!n.htmlDataProcessor){(function(){var f=r.HtmlParser.Fragment.prototype,i=r.HtmlParser.Element.prototype;f.onlyChild=i.onlyChild=function(){var g=this.children;
return g.length==1&&g[0]||null};i.removeAnyChildWithName=function(g){for(var h=this.children,o=[],k,u=0;u<h.length;u++){k=h[u];if(k.name){if(k.name==g){o.push(k);h.splice(u--,1)}o=o.concat(k.removeAnyChildWithName(g))}}return o};i.getAncestor=function(g){for(var h=this.parent;h&&!(h.name&&h.name.match(g));)h=h.parent;return h};f.firstChild=i.firstChild=function(g){for(var h,o=0;o<this.children.length;o++){h=this.children[o];if(g(h))return h;else if(h.name)if(h=h.firstChild(g))return h}return null};
i.addStyle=function(g,h,o){var k="";if(typeof h=="string")k+=g+":"+h+";";else{if(typeof g=="object")for(var u in g){if(g.hasOwnProperty(u))k+=u+":"+g[u]+";"}else k+=g;o=h}if(!this.attributes)this.attributes={};g=this.attributes.style||"";g=(o?[k,g]:[g,k]).join(";");this.attributes.style=g.replace(/^;|;(?=;)/,"")};e.parentOf=function(g){var h={},o;for(o in this)if(this.hasOwnProperty(o))if(o.indexOf("$")==-1&&this[o][g])h[o]=1;return h}})();(function(){function f(A){if(/mso-list\s*:\s*Ignore/i.test(A.attributes&&
A.attributes.style||""))return true;return v}function i(A,B){var D=new r.HtmlParser.Element("ke:listbullet"),K;if(A)if(A[2]){A=isNaN(A[1])?/^[a-z]+$/.test(A[1])?"lower-alpha":/^[A-Z]+$/.test(A[1])?"upper-alpha":"decimal":"decimal";K="ol"}else{A=/[l\u00B7\u2002]/.test(A[1])?"disc":/[\u006F\u00D8]/.test(A[1])?"circle":/[\u006E\u25C6]/.test(A[1])?"square":"disc";K="ul"}else{A="decimal";K="ol"}D.attributes={"ke:listtype":K,style:"list-style-type:"+A+";"};D.add(new r.HtmlParser.Text(B));return D}function g(A){var B=
A.attributes,D;if((D=A.removeAnyChildWithName("ke:listbullet"))&&D.length&&(D=D[0])){A.name="ke:li";if(B.style)B.style=h([["text-indent"],["line-height"],[/^margin(:?-left)?$/,null,function(K){K=K.split(" ");K=K[3]||K[1]||K[0];K=parseInt(K,10);if(!u&&x&&K>x)u=K-x;B["ke:margin"]=x=K}]],v)(B.style,A)||"";D=D.attributes;A.addStyle(D.style);z.mix(B,D);return true}return false}function h(A,B){return function(D,K){var M=[];String(D).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,
function(R,U,S){U=U.toLowerCase();U=="font-family"&&(S=S.replace(/["']/g,""));for(var P,Q,F,J=0;J<A.length;J++)if(A[J]){R=A[J][0];P=A[J][1];Q=A[J][2];F=A[J][3];if(U.match(R)&&(!P||S.match(P))){U=F||U;B&&(Q=Q||S);if(typeof Q=="function")Q=Q(S,K,U);if(Q&&Q.push){U=Q[0];Q=Q[1]}typeof Q=="string"&&M.push([U,Q]);return}}!B&&M.push([U,S])});for(var O=0;O<M.length;O++)M[O]=M[O].join(":");return M.length?M.join(";")+";":false}}function o(A){A=A.children;for(var B,D,K,M,O,R,U,S=0;S<A.length;S++){B=A[S];if("ke:li"==
B.name){B.name="li";B=B;D=B.attributes;K=B.attributes["ke:listtype"];M=parseInt(D["ke:indent"],10)||u&&Math.ceil(D["ke:margin"]/u)||1;D.style&&(D.style=h([["list-style-type",K=="ol"?"decimal":"disc"]],v)(D.style)||"");if(R){if(M>U){R=new r.HtmlParser.Element(K);R.add(B);O.add(R)}else{if(M<U){O=U-M;for(var P;O--&&(P=R.parent);)R=P.parent}R.add(B)}A.splice(S--,1)}else{R=new r.HtmlParser.Element(K);R.add(B);A[S]=R}O=B;U=M}else R=null}u=0}var k=h([[/mso/i],[/w:WordDocument/i],[/^-ms/i],[/^-moz/i],[/^-webkit/i]],
v),u,x=0,E=e.parentOf("ol"),j={elementNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(A){A.filterChildren();o(A)},elements:{p:function(A){A.filterChildren();if(g(A))return v},$:function(A){var B=A.name||"";if(B.indexOf(":")!=-1&&!/^ke/.test(B)){if(B=="v:imagedata"){if(A.attributes["o:href"]){A.attributes.src=A.attributes["o:href"];delete A.attributes["o:href"]}if(B=A.attributes["o:title"]){A.attributes.title=
B;delete A.attributes["o:title"]}A.name="img";return}delete A.name}if(B in E){A.filterChildren();o(A)}},span:function(A){if(!m.gecko&&f(A.parent))return false;if(!m.gecko&&f(A)){A=(A=A.firstChild(function(D){return D.value||D.name=="img"}))&&(A.value||"l.");var B=A.match(/^([^\s]+?)([.)]?)$/);return i(B,A)}}},attributes:{"class":function(A){if(!A||/(^|\s+)Mso/.test(A))return false;return A},style:function(A){A=k(A);if(!A)return false;return A}},attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]]},y={comment:!m.ie?
function(A,B){var D=A.match(/<img.*?>/),K=A.match(/^\[if !supportLists\]([\s\S]*?)\[endif\]$/);if(K){K=(D=K[1]||D&&"l.")&&D.match(/>([^\s]+?)([.)]?)</);return i(K,D)}if(m.gecko&&D){D=r.HtmlParser.Fragment.FromHtml(D[0]).children[0];(K=(K=(K=B.previous)&&K.value.match(/<v:imagedata[^>]*o:href=['"](.*?)['"]/))&&K[1])&&(D.attributes.src=K);return D}return false}:function(){return false}},C={elementNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],elements:{$:function(A){var B=A.attributes;if(B)for(var D=
["name","href","src"],K,M=0;M<D.length;M++){K="_ke_saved_"+D[M];K in B&&delete B[D[M]]}return A},embed:function(A){var B=A.parent;if(B&&B.name=="object"){var D=B.attributes.width;B=B.attributes.height;D&&(A.attributes.width=D);B&&(A.attributes.height=B)}},param:function(A){A.children=[];A.isEmpty=true;return A},a:function(A){if(!A.children.length&&z.isEmptyObject(A.attributes))return false},span:function(A){if(!A.children.length&&z.isEmptyObject(A.attributes))return false}},attributes:{style:function(A){if(!z.trim(A))return false}},
attributeNames:[[/^_ke_saved_/,""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^_ks.*/,""],[/^ke:.*$/,""]],comment:function(A){if(A.substr(0,a.length)==a){A=A.substr(a.length,3)=="{C}"?A.substr(a.length+3):A.substr(a.length);return new r.HtmlParser.cdata(decodeURIComponent(A))}return A}};if(m.ie)C.attributes.style=function(A){return A.replace(/(^|;)([^:]+)/g,function(B){return B.toLowerCase()})};d.addRules(C);b.addRules(j);c.addRules(j);c.addRules(y)})();(function(){function f(y){for(var C=y.children.length,
A=y.children[C-1];A&&A.type==p.NODE_TEXT&&!z.trim(A.value);)A=y.children[--C];return A}function i(y){var C=f(y);return!C||C.type==p.NODE_ELEMENT&&C.name=="br"||y.name=="form"&&C.name=="input"}function g(y,C){var A=y.children,B=f(y);if(B){if((C||!m.ie)&&B.type==p.NODE_ELEMENT&&B.name=="br")A.pop();B.type==p.NODE_TEXT&&k.test(B.value)&&A.pop()}}function h(y){g(y,true);if(i(y))if(m.ie)y.add(new r.HtmlParser.Text("\u00a0"));else{y.add(new r.HtmlParser.Text("&nbsp;"));y.add(new r.HtmlParser.Element("br",{}))}}
function o(y){g(y,false);i(y)&&y.add(new r.HtmlParser.Text("\u00a0"))}var k=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,u=r.XHTML_DTD,x=r.Utils.mix({},u.$block,u.$listItem,u.$tableContent),E;for(E in x)if(x.hasOwnProperty(E))"br"in u[E]||delete x[E];delete x.td;delete x.pre;u={elements:{}};var j={elements:{}};for(E in x)if(x.hasOwnProperty(E)){u.elements[E]=h;j.elements[E]=o}b.addRules(u);d.addRules(j);c.addRules(u)})();(function(){d.addRules({text:function(f){return f.replace(/\xa0/g,"&nbsp;")}})})();var t=/<(a|area|img|input)\b([^>]*)>/gi,
q=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,a="{ke_protected}";n.htmlDataProcessor={wordFilter:c,dataFilter:b,htmlFilter:d,toHtml:function(f,i){var g=new l.HtmlWriter;l.Fragment.FromHtml(f,i).writeHtml(g,d);return g.getHtml(true)},toDataFormat:function(f,i,g){g=g||b;if(m.gecko)f=f.replace(/(<!--\[if[^<]*?\])--\>([\S\s]*?)<!--(\[endif\]--\>)/gi,"$1$2$3");f=w(f);var h=new s("<div>");h.html("a"+f);f=h.html().substr(1);h=new l.BasicWriter;f=l.Fragment.FromHtml(f,i);h.reset();
f.writeHtml(h,g);return f=h.getHtml(true)},toServer:function(f,i){var g=new l.BasicWriter;l.Fragment.FromHtml(f,i).writeHtml(g,d);return g.getHtml(true)}}}},{attach:false});
KISSY.Editor.add("image",function(n){n.addPlugin("image",function(){function w(e){var t=new s(e.target);e.halt();p(t)&&c.call("show",null,t)}var v=KISSY,z=v.Editor,r=v.UA,s=v.Node,m=v.Event,p=function(e){return e._4e_name()==="img"&&!/(^|\s+)ke_/.test(e[0].className)&&e},l={},d=z.Utils.addRes,b=z.Utils.destroyRes,c=n.addButton("image",{contentCls:"ke-toolbar-image",title:"\u63d2\u5165\u56fe\u7247",mode:z.WYSIWYG_MODE,offClick:function(){this.call("show")},_updateTip:function(e,t){var q=t.attr("_ke_saved_src")||t.attr("src");
e.attr("href",q)},show:function(e,t){this.editor.showDialog("image/dialog",[t])}});d.call(l,c,function(){n.destroyDialog("image/dialog")});z.use("contextmenu",function(){var e={"\u56fe\u7247\u5c5e\u6027":function(a){a=(a=a.getSelection())&&a.getStartElement();(a=p(a))&&c.call("show",null,a)},"\u63d2\u5165\u65b0\u884c":function(a){var f=a.getSelection();if(f=f&&f.getStartElement()){var i=a.document,g=new s(i.createElement("p"));r.ie||g._4e_appendBogus();i=new z.Range(i);i.setStartAfter(f);i.select();a.insertElement(g);i.moveToElementEditablePosition(g,
1);i.select()}}},t={},q;for(q in e)e.hasOwnProperty(q)&&function(a){t[a]=function(){e[a](n)}}(q);q=z.ContextMenu.register({editor:n,rules:[p],width:"120px",funcs:t});d.call(l,q)});m.on(n.document,"dblclick",w);d.call(l,function(){m.remove(n.document,"dblclick",w)});z.use("bubbleview",function(){z.BubbleView.register({pluginName:"image",pluginContext:c,editor:n,func:p,init:function(){var e=this,t=e.get("contentEl");t.html(' <a class="ke-bubbleview-url" target="_blank" href="#">\u5728\u65b0\u7a97\u53e3\u67e5\u770b</a>  |  <a class="ke-bubbleview-link ke-bubbleview-change" href="#">\u7f16\u8f91</a>  |  <a class="ke-bubbleview-link ke-bubbleview-remove" href="#">\u5220\u9664</a>');
var q=t.one(".ke-bubbleview-url"),a=t.one(".ke-bubbleview-change"),f=t.one(".ke-bubbleview-remove");z.Utils.preventFocus(t);a.on("click",function(i){e._plugin.call("show",null,e._selectedEl);i.halt()});f.on("click",function(i){var g=e._plugin;if(r.webkit){var h=g.editor.getSelection().getRanges();h&&h[0]&&(h[0].collapse(true)||1)&&h[0].select()}e._selectedEl._4e_remove();e.hide();g.editor.notifySelectionChange();i.halt()});z.Utils.addRes.call(e,a,f);e.on("show",function(){var i=e._selectedEl;i&&e._plugin.call("_updateTip",
q,i)})}});d.call(l,function(){z.BubbleView.destroy("image")})});this.destroy=function(){b.call(l)}})},{attach:false});
KISSY.Editor.add("indent",function(n){n.addPlugin("indent",function(){var w=KISSY.Editor,v=n.addButton("outdent",{title:"\u51cf\u5c11\u7f29\u8fdb\u91cf ",mode:w.WYSIWYG_MODE,contentCls:"ke-toolbar-outdent",type:"outdent",loading:true}),z=n.addButton("indent",{title:"\u589e\u52a0\u7f29\u8fdb\u91cf ",mode:w.WYSIWYG_MODE,contentCls:"ke-toolbar-indent",type:"indent",loading:true});w.use("indent/support",function(){v.reload(w.IndentSupport);z.reload(w.IndentSupport)});n.addCommand("indent",{exec:function(){z.call("offClick")}});n.addCommand("outdent",
{exec:function(){v.call("offClick")}});this.destroy=function(){v.destroy();z.destroy()}})},{attach:false});
KISSY.Editor.add("indent/support",function(){function n(q){this.type=q;this.indentCssProperty="margin-left";this.indentOffset=40;this.indentUnit="px"}function w(q){return q[0].nodeType==c.NODE_ELEMENT&&q._4e_name()=="li"}function v(q,a){for(var f=q.startContainer,i=q.endContainer;f&&!f.parent()._4e_equals(a);)f=f.parent();for(;i&&!i.parent()._4e_equals(a);)i=i.parent();if(f&&i){var g=f;f=[];for(var h=false;!h;){if(g._4e_equals(i))h=true;f.push(g);g=g.next()}if(!(f.length<1)){g=a._4e_parents(true);
for(i=0;i<g.length;i++)if(s[g[i]._4e_name()]){a=g[i];break}g=this.type=="indent"?1:-1;i=f[0];h=f[f.length-1];f={};var o=r.ListUtils.listToArray(a,f),k=o[h.data("listarray_index")].indent;for(i=i.data("listarray_index");i<=h.data("listarray_index");i++){o[i].indent+=g;var u=o[i].parent;o[i].parent=new d(u[0].ownerDocument.createElement(u._4e_name()))}for(i=h.data("listarray_index")+1;i<o.length&&o[i].indent>k;i++)o[i].indent+=g;h=r.ListUtils.arrayToList(o,f,null,"p",0);g=[];if(this.type=="outdent"){var x;
if((x=a.parent())&&x._4e_name()=="li"){o=h.listNode.childNodes;var E;for(i=o.length-1;i>=0;i--)if((E=new d(o[i]))&&E._4e_name()=="li")g.push(E)}}if(h){l.insertBefore(h.listNode[0]||h.listNode,a[0]||a);a._4e_remove()}if(g&&g.length)for(i=0;i<g.length;i++){for(h=E=g[i];(h=h.next())&&h._4e_name()in s;){b.ie&&!E._4e_first(function(j){return e(j)&&t(j)})&&E[0].appendChild(q.document.createTextNode("\u00a0"));E[0].appendChild(h[0])}l.insertAfter(E[0],x[0])}r.Utils.clearAllMarkers(f)}}}function z(q){var a=parseInt(q._4e_style(this.indentCssProperty),
10);if(isNaN(a))a=0;a+=(this.type=="indent"?1:-1)*this.indentOffset;if(a<0)return false;a=Math.max(a,0);a=Math.ceil(a/this.indentOffset,undefined)*this.indentOffset;q.css(this.indentCssProperty,a?a+this.indentUnit:"");q[0].style.cssText===""&&q.removeAttr("style");return true}var r=KISSY.Editor,s={ol:1,ul:1},m=KISSY,p=r.Walker,l=m.DOM,d=m.Node,b=m.UA,c=r.NODE,e=p.whitespaces(true),t=p.bookmark(false,true);m.augment(n,{exec:function(q){for(var a=(q=q.getSelection())&&q.getRanges()[0],f=a.startContainer,
i=a.endContainer,g=a.getCommonAncestor();g&&!(g[0].nodeType==c.NODE_ELEMENT&&s[g._4e_name()]);)g=g.parent();if(g&&f[0].nodeType==c.NODE_ELEMENT&&f._4e_name()in s){f=new p(a);f.evaluator=w;a.startContainer=f.next()}if(g&&i[0].nodeType==c.NODE_ELEMENT&&i._4e_name()in s){f=new p(a);f.evaluator=w;a.endContainer=f.previous()}i=q.createBookmarks(true);if(g){for(f=g._4e_first();f&&f._4e_name()!="li";)f=f.next();var h=a.startContainer;(f[0]==h[0]||f.contains(h))&&z.call(this,g)||v.call(this,a,g)}else{a=a.createIterator();
a.enforceRealBlocks=true;for(a.enlargeBr=true;g=a.getNextParagraph();)z.call(this,g)}q.selectBookmarks(i)}});r.IndentSupport={init:function(){this.indentCommand=new n(this.cfg.type)},offClick:function(){var q=this,a=q.editor;a.fire("save");setTimeout(function(){q.indentCommand.exec(a);a.fire("save");a.notifySelectionChange()},10)},selectionChange:function(q){if(this.cfg.type=="outdent"){var a=q.path,f=a.blockLimit;q=this.btn;if(a.contains(s))q.boff();else(a=a.block||f)&&a._4e_style(this.indentCommand.indentCssProperty)?
q.boff():q.disable()}}}},{attach:false});
KISSY.Editor.add("justify",function(n){n.addPlugin("justify",function(){var w=KISSY,v=w.Editor,z=v.TripleButton,r=/(-moz-|-webkit-|start|auto)/gi;v={mode:v.WYSIWYG_MODE,offClick:function(){this.call("_change")},onClick:function(){this.call("_change")},_change:function(){var l=this.editor,d=l.getSelection(),b=this.btn.get("state");if(d){var c=d.createBookmarks(),e=d.getRanges(),t,q;l.fire("save");for(var a=e.length-1;a>=0;a--){t=e[a].createIterator();for(t.enlargeBr=true;q=t.getNextParagraph();){q.removeAttr("align");
b==z.OFF?q.css("text-align",this.cfg.v):q.css("text-align","")}}l.notifySelectionChange();d.selectBookmarks(c);l.fire("save")}},selectionChange:function(l){var d=this.btn;l=l.path;l=l.block||l.blockLimit;if(!l||l._4e_name()==="body")d.boff();else(l.css("text-align").replace(r,"")||"left")==this.cfg.v?d.bon():d.boff()}};var s=n.addButton("alignleft",w.mix({contentCls:"ke-toolbar-alignleft",title:"\u5de6\u5bf9\u9f50",v:"left"},v)),m=n.addButton("aligncenter",w.mix({contentCls:"ke-toolbar-aligncenter",title:"\u5c45\u4e2d\u5bf9\u9f50",
v:"center"},v)),p=n.addButton("alignright",w.mix({contentCls:"ke-toolbar-alignright",title:"\u53f3\u5bf9\u9f50",v:"right"},v));this.destroy=function(){s.destroy();m.destroy();p.destroy()}})},{attach:false});
KISSY.Editor.add("link",function(n){n.addPlugin("link",function(){function w(e){return e._4e_ascendant(function(t){return t._4e_name()==="a"},true)}var v=KISSY,z=v.UA,r=v.Editor,s=v.Node,m=r.Style,p={element:"a",attributes:{href:"#(href)",title:"#(title)",_ke_saved_href:"#(_ke_saved_href)",target:"#(target)"}},l={},d=r.Utils.addRes,b=r.Utils.destroyRes,c=n.addButton("link",{contentCls:"ke-toolbar-link",title:"\u63d2\u5165\u94fe\u63a5",mode:r.WYSIWYG_MODE,_getSelectedLink:function(){var e=this.editor.getSelection();if(e=
e&&e.getStartElement())e=w(e);return e},_getSelectionLinkUrl:function(){var e=this.cfg._getSelectedLink.call(this);if(e)return e.attr("_ke_saved_href")||e.attr("href")},_removeLink:function(e){var t=this.editor;t.fire("save");var q=t.getSelection(),a=q.getRanges()[0];if(a&&a.collapsed){a=q.createBookmarks();e._4e_remove(true);q.selectBookmarks(a)}else if(a){e=e[0];q=e.attributes;a={};for(var f=0;f<q.length;f++){var i=q[f];if(i.specified)a[i.name]=i.value}if(e.style.cssText)a.style=e.style.cssText;
(new m(p,a)).remove(t.document)}t.fire("save");t.notifySelectionChange()},_link:function(e,t){var q=this.editor;e._ke_saved_href=e.href;if(t){q.fire("save");t.attr(e)}else{var a=q.getSelection();a=a&&a.getRanges()[0];if(!a||a.collapsed){a=new s("<a>"+e.href+"</a>",e,q.document);q.insertElement(a)}else{q.fire("save");(new m(p,e)).apply(q.document);z.gecko&&q.getSelection().getStartElement()}}q.fire("save");q.notifySelectionChange()},offClick:function(){this.editor.showDialog("link/dialog",[this])},
destroy:function(){this.editor.destroyDialog("link/dialog")}});d.call(l,c);r.use("bubbleview",function(){r.BubbleView.register({pluginName:"link",editor:n,pluginContext:c,func:w,init:function(){var e=this,t=e.get("contentEl");t.html('<a href=""  target="_blank" class="ke-bubbleview-url">\u5728\u65b0\u7a97\u53e3\u67e5\u770b</a>  \u2013   <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span>   |    <span class="ke-bubbleview-link ke-bubbleview-remove">\u53bb\u9664</span>');var q=t.one(".ke-bubbleview-url"),a=t.one(".ke-bubbleview-change"),
f=t.one(".ke-bubbleview-remove");r.Utils.preventFocus(t);a.on("click",function(i){e._plugin.call("offClick");i.halt()});f.on("click",function(i){e._plugin.call("_removeLink",e._selectedEl);i.halt()});d.call(e,a,f);e.on("show",function(){var i=e._selectedEl;if(i){i=i.attr("_ke_saved_href")||i.attr("href");q.html(i);q.attr("href",i)}})}});d.call(l,function(){r.BubbleView.destroy("link")})});this.destroy=function(){b.call(l)}})},{attach:false});
KISSY.Editor.add("list",function(n){n.addPlugin("list",function(){var w=KISSY.Editor,v=n.addButton("ul",{title:"\u9879\u76ee\u5217\u8868",mode:w.WYSIWYG_MODE,contentCls:"ke-toolbar-ul",loading:true,type:"ul"}),z=n.addButton("ol",{title:"\u7f16\u53f7\u5217\u8868",mode:w.WYSIWYG_MODE,contentCls:"ke-toolbar-ol",loading:true,type:"ol"});w.use("list/support",function(){v.reload(w.ListSupport);z.reload(w.ListSupport)});this.destroy=function(){v.destroy();z.destroy()}})},{attach:false});
KISSY.Editor.add("list/support",function(){function n(q){this.type=q}var w=KISSY.Editor,v={ol:1,ul:1},z=["ol","ul"],r=KISSY,s=w.RANGE,m=w.ElementPath,p=w.Walker,l=w.NODE,d=r.UA,b=r.Node,c=r.DOM,e={listToArray:function(q,a,f,i,g){if(!v[q._4e_name()])return[];i||(i=0);f||(f=[]);for(var h=0,o=q[0].childNodes.length;h<o;h++){var k=new b(q[0].childNodes[h]);if(k._4e_name()=="li"){var u={parent:q,indent:i,element:k,contents:[]};if(g)u.grandparent=g;else{u.grandparent=q.parent();if(u.grandparent&&u.grandparent._4e_name()==
"li")u.grandparent=u.grandparent.parent()}a&&k._4e_setMarker(a,"listarray_index",f.length);f.push(u);for(var x=0,E=k[0].childNodes.length,j;x<E;x++){j=new b(k[0].childNodes[x]);j[0].nodeType==l.NODE_ELEMENT&&v[j._4e_name()]?e.listToArray(j,a,f,i+1,u.grandparent):u.contents.push(j)}}}return f},arrayToList:function(q,a,f,i){f||(f=0);if(!q||q.length<f+1)return null;for(var g=q[f].parent[0].ownerDocument,h=g.createDocumentFragment(),o=null,k=f,u=Math.max(q[f].indent,0),x=null;;){var E=q[k];if(E.indent==
u){if(!o||q[k].parent._4e_name()!=o._4e_name()){o=q[k].parent._4e_clone(false,true);h.appendChild(o[0])}x=o[0].appendChild(E.element._4e_clone(false,true)[0]);for(var j=0;j<E.contents.length;j++)x.appendChild(E.contents[j]._4e_clone(true,true)[0]);k++}else if(E.indent==Math.max(u,0)+1){k=e.arrayToList(q,null,k,i);x.appendChild(k.listNode);k=k.nextIndex}else if(E.indent==-1&&!f&&E.grandparent){if(v[E.grandparent._4e_name()])x=E.element._4e_clone(false,true)[0];else if(E.grandparent._4e_name()!="td"){x=
g.createElement(i);E.element._4e_copyAttributes(new b(x))}else x=g.createDocumentFragment();for(j=0;j<E.contents.length;j++){o=E.contents[j]._4e_clone(true,true);x.nodeType==l.NODE_DOCUMENT_FRAGMENT&&E.element._4e_copyAttributes(new b(o));x.appendChild(o[0])}if(x.nodeType==l.NODE_DOCUMENT_FRAGMENT&&k!=q.length-1){x.lastChild&&x.lastChild.nodeType==l.NODE_ELEMENT&&x.lastChild.getAttribute("type")=="_moz"&&c._4e_remove(x.lastChild);c._4e_appendBogus(x)}if(x.nodeType==l.NODE_ELEMENT&&c._4e_name(x)==
i&&x.firstChild){c._4e_trim(x);o=x.firstChild;if(o.nodeType==l.NODE_ELEMENT&&c._4e_isBlockBoundary(o)){o=g.createDocumentFragment();c._4e_moveChildren(x,o);x=o}}o=c._4e_name(x);if(!d.ie&&(o=="div"||o=="p"))c._4e_appendBogus(x);h.appendChild(x);o=null;k++}else return null;if(q.length<=k||Math.max(q[k].indent,0)<u)break}if(a)for(q=new b(h.firstChild);q&&q[0];){q[0].nodeType==l.NODE_ELEMENT&&q._4e_clearMarkers(a,true);q=q._4e_nextSourceNode()}return{listNode:h,nextIndex:k}}},t=/^h[1-6]$/;n.prototype=
{changeListType:function(q,a,f,i){var g=e.listToArray(a.root,f,undefined,undefined,undefined),h=[];for(q=0;q<a.contents.length;q++){var o=a.contents[q];o=o._4e_ascendant("li",true);if(!(!o||!o[0]||o.data("list_item_processed"))){h.push(o);o._4e_setMarker(f,"list_item_processed",true)}}o=new b(a.root[0].ownerDocument.createElement(this.type));for(q=0;q<h.length;q++){var k=h[q].data("listarray_index");g[k].parent=o}f=e.arrayToList(g,f,null,"p");var u;g=f.listNode.childNodes.length;for(q=0;q<g&&(u=new b(f.listNode.childNodes[q]));q++)u._4e_name()==
this.type&&i.push(u);c.insertBefore(c._4e_unwrap(f.listNode),c._4e_unwrap(a.root));a.root._4e_remove()},createList:function(q,a,f){var i=a.contents;q=a.root[0].ownerDocument;var g=[];if(i.length==1&&i[0][0]===a.root[0]){var h=new b(q.createElement("div"));i[0][0].nodeType!=l.NODE_TEXT&&i[0]._4e_moveChildren(h);i[0][0].appendChild(h[0]);i[0]=h}a=a.contents[0].parent();for(h=0;h<i.length;h++)a=a._4e_commonAncestor(i[h].parent());for(h=0;h<i.length;h++)for(var o=i[h],k;k=o.parent();){if(k[0]===a[0]){g.push(o);
break}o=k}if(!(g.length<1)){i=new b(g[g.length-1][0].nextSibling);h=new b(q.createElement(this.type));for(f.push(h);g.length;){f=g.shift();o=new b(q.createElement("li"));if(t.test(f._4e_name()))o[0].appendChild(f[0]);else{f._4e_copyAttributes(o);f._4e_moveChildren(o);f._4e_remove()}h[0].appendChild(o[0]);d.ie||o._4e_appendBogus()}i[0]?h.insertBefore(i):a.append(h)}},removeList:function(q,a,f){function i(j){if((x=new b(u[j?"firstChild":"lastChild"]))&&!(x[0].nodeType==l.NODE_ELEMENT&&x._4e_isBlockBoundary())&&
(E=a.root[j?"_4e_previous":"_4e_next"](p.whitespaces(true)))&&!(x[0].nodeType==l.NODE_ELEMENT&&E._4e_isBlockBoundary({br:1})))c[j?"insertBefore":"insertAfter"](q.document.createElement("br"),c._4e_unwrap(x))}for(var g=e.listToArray(a.root,f,undefined,undefined,undefined),h=[],o=0;o<a.contents.length;o++){var k=a.contents[o];k=k._4e_ascendant("li",true);if(!(!k||k.data("list_item_processed"))){h.push(k);k._4e_setMarker(f,"list_item_processed",true)}}k=null;for(o=0;o<h.length;o++){k=h[o].data("listarray_index");
g[k].indent=-1;k=k}for(o=k+1;o<g.length;o++)if(g[o].indent>Math.max(g[o-1].indent,0)){h=g[o-1].indent+1-g[o].indent;for(k=g[o].indent;g[o]&&g[o].indent>=k;){g[o].indent+=h;o++}o--}var u=e.arrayToList(g,f,null,"p").listNode,x,E;i(true);i(undefined);c.insertBefore(c._4e_unwrap(u),c._4e_unwrap(a.root));a.root._4e_remove()},exec:function(q){var a=q.getSelection(),f=a&&a.getRanges();if(!(!f||f.length<1)){for(var i=a.createBookmarks(true),g=[],h={};f.length>0;){var o=f.shift(),k=o.getBoundaryNodes(),u=
k.startNode,x=k.endNode;u[0].nodeType==l.NODE_ELEMENT&&u._4e_name()=="td"&&o.setStartAt(k.startNode,s.POSITION_AFTER_START);x[0].nodeType==l.NODE_ELEMENT&&x._4e_name()=="td"&&o.setEndAt(k.endNode,s.POSITION_BEFORE_END);o=o.createIterator();for(o.forceBrBreak=false;k=o.getNextParagraph();)if(!k.data("list_block")){k._4e_setMarker(h,"list_block",1);x=new m(k);var E=x.elements,j=null,y=false,C=x.blockLimit,A;for(u=E.length-1;u>=0&&(A=E[u]);u--)if(v[A._4e_name()]&&C.contains(A)){C.removeData("list_group_object");
if(u=A.data("list_group_object"))u.contents.push(k);else{u={root:A,contents:[k]};g.push(u);A._4e_setMarker(h,"list_group_object",u)}y=true;break}if(!y){x=C||x.block;if(x.data("list_group_object"))x.data("list_group_object").contents.push(k);else{u={root:x,contents:[k]};x._4e_setMarker(h,"list_group_object",u);g.push(u)}}}}for(f=[];g.length>0;){u=g.shift();if(this.state=="off")if(v[u.root._4e_name()])this.changeListType(q,u,h,f);else{w.Utils.clearAllMarkers(h);this.createList(q,u,f)}else this.state==
"on"&&v[u.root._4e_name()]&&this.removeList(q,u,h)}for(u=0;u<f.length;u++){j=f[u];var B=this;q=function(D){var K=j[D?"_4e_previous":"_4e_next"](p.whitespaces(true));if(K&&K[0]&&K._4e_name()==B.type){K._4e_remove();K._4e_moveChildren(j,D?true:false)}};q(undefined);q(true)}w.Utils.clearAllMarkers(h);a.selectBookmarks(i)}}};w.ListUtils=e;w.ListSupport={init:function(){this.listCommand=new n(this.cfg.type)},selectionChange:function(q){var a=this.cfg.type,f=q.path,i;q=this.btn;var g=f.blockLimit;f=f.elements;
if(g){if(f)for(var h=0;h<f.length&&(i=f[h])&&i[0]!==g[0];h++){var o=r.indexOf(f[h]._4e_name(),z);if(o!==-1)if(z[o]===a){q.bon();return}else break}q.boff()}},offClick:function(){this.call("_change")},onClick:function(){this.call("_change")},_change:function(){var q=this.editor,a=this.btn;q.fire("save");this.listCommand.state=a.get("state");this.listCommand.exec(q);q.fire("save");q.notifySelectionChange()}}},{attach:false});
KISSY.Editor.add("localstorage",function(){var n=KISSY,w=n.Editor;w.localStorage=null;if(w.storeReady)n.log("localstorage attach more","warn");else{w.storeReady=function(s){w.on("storeReady",s)};w.on("storeReady",function(){w.storeReady=function(s){s()};w.detach("storeReady")});if(!n.UA.ie&&window.localStorage){w.localStorage=window.localStorage;w.fire("storeReady")}else{var v=w.Utils.debugUrl("localstorage/swfstore.swf?t="+ +new Date),z=new w.FlashBridge({movie:v,flashVars:{useCompression:true},
methods:["setItem","removeItem","getItem","setMinDiskSpace","getValueOf"]});n.use("overlay",function(){z.swf.height=138;var s=new (n.require("overlay"))({headerContent:"\u8bf7\u70b9\u5141\u8bb8",width:"0px",elStyle:{overflow:"hidden"},content:"<h1 style='border:1px solid black;border-bottom:none;background:white;text-align:center;'>\u8bf7\u70b9\u51fb\u5141\u8bb8</h1>",zIndex:w.baseZIndex(w.zIndexManager.STORE_FLASH_SHOW)});s.render();s.get("contentEl").append(z.swf);s.center();s.show();z.on("pending",function(){s.set("width",215);s.center();
s.show();setTimeout(function(){z.retrySave()},1E3)});z.on("save",function(){s.set("width",0)})});var r=z.setItem;n.mix(z,{_ke:1,getItem:function(s){return this.getValueOf(s)},retrySave:function(){this.setItem(this.lastSave.k,this.lastSave.v)},setItem:function(s,m){this.lastSave={k:s,v:m};r.call(this,s,m)}});z.on("contentReady",function(){w.localStorage=z;w.fire("storeReady")})}}},{attach:false,requires:["flashutils","flashbridge"]});
KISSY.Editor.add("maximize",function(n){n.addPlugin("maximize",function(){var w=KISSY,v=w.Editor;if(!(w.UA.gecko<1.92)){var z=n.addButton("maximize",{title:"\u5168\u5c4f",contentCls:"ke-toolbar-maximize",loading:true});v.use("maximize/support",function(){z.reload(v.Maximize);n.addCommand("maximizeWindow",{exec:function(){z.call("offClick")}});n.addCommand("restoreWindow",{exec:function(){z.call("onClick")}})});this.destroy=function(){z.destroy()}}})},{attach:false});
KISSY.Editor.add("maximize/support",function(){window.KISSY.DOM.addStyleSheet(".ke-toolbar-padding {padding:5px;}","ke-maximize");var n=window.KISSY,w=n.Editor,v=n.UA,z=v.ie,r=n.Node,s=n.Event,m=n.DOM,p,l={};n.mix(l,{onClick:function(){var d=this,b=d.editor;if(d._resize){s.remove(window,"resize",d._resize);d._resize=0;d.call("_saveEditorStatus");d.call("_restoreState");d.btn.boff();setTimeout(function(){d.call("_restoreEditorStatus");b.notifySelectionChange();b.fire("restoreWindow")},30)}},_restoreState:function(){var d=
document,b=this.editor,c=this._savedParents;if(c){for(var e=0;e<c.length;e++){var t=c[e];t.el.css("position",t.position)}this._savedParents=null}b.wrap.css({height:this.iframeHeight});m.css(d.body,{width:"",height:"",overflow:""});d.documentElement.style.overflow="";b.editorWrap.css({position:"static",width:this.editorWrapWidth});p.css({left:"-99999px",top:"-99999px"});window.scrollTo(this.scrollLeft,this.scrollTop);this.btn.get("el").one("span").removeClass("ke-toolbar-restore").addClass("ke-toolbar-maximize").attr("title",
"\u5168\u5c4f");z<8&&this.editor.toolBarDiv.removeClass("ke-toolbar-padding")},_saveSate:function(){var d=this.editor,b=[],c=d.editorWrap;this.iframeHeight=d.wrap._4e_style("height");this.editorWrapWidth=c._4e_style("width");this.scrollLeft=m.scrollLeft();this.scrollTop=m.scrollTop();window.scrollTo(0,0);for(d=c.parent();d;){c=d.css("position");if(c!="static"){b.push({el:d,position:c});d.css("position","static")}d=d.parent()}this._savedParents=b;b=this.btn.get("el");b.one("span").removeClass("ke-toolbar-maximize").addClass("ke-toolbar-restore");
b.attr("title","\u53d6\u6d88\u5168\u5c4f");z<8&&this.editor.toolBarDiv.addClass("ke-toolbar-padding")},_saveEditorStatus:function(){var d=this.editor;this.savedRanges=null;if(v.gecko&&d.iframeFocus)this.savedRanges=(d=d.getSelection())&&d.getRanges()},_restoreEditorStatus:function(){var d=this.editor,b=d.getSelection(),c=this.savedRanges;v.gecko&&d.activateGecko();c&&b&&b.selectRanges(c);if(d.iframeFocus&&b)(d=b.getStartElement())&&d[0]&&d._4e_scrollIntoView()},_maximize:function(d){var b=document,c=this.editor,e=c.editorWrap,
t=m.viewportHeight(),q=m.viewportWidth(),a=c.statusDiv?c.statusDiv[0].offsetHeight:0,f=c.toolBarDiv[0].offsetHeight;if(z)b.body.style.overflow="hidden";else m.css(b.body,{width:0,height:0,overflow:"hidden"});b.documentElement.style.overflow="hidden";e.css({position:"absolute",zIndex:w.baseZIndex(w.zIndexManager.MAXIMIZE),width:q+"px"});p.css({zIndex:w.baseZIndex(w.zIndexManager.MAXIMIZE-5),height:t+"px",width:q+"px"});e.offset({left:0,top:0});p.css({left:0,top:0});c.wrap.css({height:t-a-f+"px"});
d!==true&&arguments.callee.call(this,true)},_real:function(){var d=this,b=d.editor;if(!d._resize){d.call("_saveEditorStatus");d.call("_saveSate");d.call("_maximize");if(!d._resize){var c=w.Utils.buffer(d.cfg._maximize,d,100);d._resize=function(){c();b.fire("maximizeWindow")}}s.on(window,"resize",d._resize);d.btn.bon();setTimeout(function(){d.call("_restoreEditorStatus");b.notifySelectionChange();b.fire("maximizeWindow")},30)}},offClick:function(){p||(p=(new r("<iframe  class='ke-maximize-shim' style='position:absolute;top:-9999px;left:-9999px;' frameborder='0'>")).prependTo(document.body));
this.call("_real")},destroy:function(){if(this._resize){s.remove(window,"resize",this._resize);this._resize=0}}});w.Maximize=l},{attach:false});
KISSY.Editor.add("music",function(n){n.addPlugin("music",function(){function w(p){p=p||"";return p.indexOf(z)!=-1}var v=KISSY.Editor,z="niftyplayer.swf",r=n.htmlDataProcessor,s=r&&r.dataFilter;s&&s.addRules({elements:{object:function(p){var l=p.attributes;if(!(l.classid&&String(l.classid).toLowerCase())){for(l=0;l<p.children.length;l++)if(p.children[l].name=="embed"){if(!v.Utils.isFlashEmbed(p.children[l]))break;if(w(p.children[l].attributes.src))return r.createFakeParserElement(p,"ke_music","music",
true)}return null}for(l=0;l<p.children.length;l++){var d=p.children[l];if(d.name=="param"&&d.attributes.name.toLowerCase()=="movie")if(w(d.attributes.value))return r.createFakeParserElement(p,"ke_music","music",true)}},embed:function(p){if(!v.Utils.isFlashEmbed(p))return null;if(w(p.attributes.src))return r.createFakeParserElement(p,"ke_music","music",true)}}},4);var m=n.addButton("music",{contentCls:"ke-toolbar-music",title:"\u63d2\u5165\u97f3\u4e50",mode:v.WYSIWYG_MODE,loading:true});v.use("music/support",function(){var p=
new v.MusicInserter(n);m.reload({offClick:function(){p.show()},destroy:function(){p.destroy()}})});this.destroy=function(){m.destroy()}})},{attach:false,requires:["fakeobjects"]});
KISSY.Editor.add("music/support",function(){function n(b){n.superclass.constructor.apply(this,arguments);b.cfg.disableObjectResizing||r.on(b.document.body,m.ie?"resizestart":"resize",function(c){(new v.Node(c.target)).hasClass(p)&&c.preventDefault()})}function w(b){return b._4e_name()==="img"&&!!b.hasClass(p)&&b}var v=KISSY,z=v.Editor,r=v.Event,s=z.Flash,m=v.UA,p="ke_music",l=["img."+p];v.extend(n,s,{_config:function(){this._cls=p;this._type="music";this._contextMenu=d;this._flashRules=l},_getFlashUrl:function(){return n.superclass._getFlashUrl.apply(this,
arguments).replace(/^.+niftyplayer\.swf\?file=/,"")}});s.registerBubble("music","\u5728\u65b0\u7a97\u53e3\u67e5\u770b",w);z.MusicInserter=n;var d={"\u97f3\u4e50\u5c5e\u6027":function(b){var c=b.editor.getSelection();(c=(c=c&&c.getStartElement())&&w(c))&&b.show(null,c)}}},{attach:false,requires:["flash/support"]});
KISSY.Editor.add("overlay/focus",function(){function n(){}var w=KISSY,v=w.UA,z=w.Editor,r=z.focusManager;z.namespace("UIBase");if(z.UIBase.Focus)w.log("ke uibase focus attach more","warn");else{n.ATTRS={focus4e:{value:true}};n.prototype={_uiSetFocus4e:function(s){if(s){this.on("show",this._show4FocusExt,this);this.on("hide",this._hide4FocusExt,this)}else{this.detach("show",this._show4FocusExt,this);this.detach("hide",this._hide4FocusExt,this)}},__syncUI:function(){},__renderUI:function(){},__bindUI:function(){this._focus4e=
(new w.Node("<a href='#' class='ke-focus' style='width:0;height:0;margin:0;padding:0;overflow:hidden;outline:none;font-size:0;'></a>")).appendTo(this.get("el"))},_show4FocusExt:function(){var s=this._focusEditor=r.currentInstance();if(v.ie&&s){window.focus();document.body.focus();this._focus4e[0].focus();var m=s.document.selection.createRange();if(m)if(m.item&&m.item(0).ownerDocument==s.document){s=document.body.createTextRange();s.moveToElementText(this.get("el")._4e_first()[0]);s.collapse(true);
s.select()}}},_hide4FocusExt:function(){var s=this._focusEditor;s&&s.focus()}};z.UIBase.Focus=n}},{attach:false});
KISSY.Editor.add("overlay",function(){var n=KISSY,w=n.require("uibase"),v=n.Editor;if(v.Overlay)n.log("ke overlay attach more");else{n.use("overlay");var z=w.create(n.require("overlay"),[v.UIBase.Focus],{syncUI:function(){v.Utils.preventFocus(this.get("contentEl"))}},{ATTRS:{zIndex:{value:v.baseZIndex(v.zIndexManager.OVERLAY)}}}),r=w.create(n.require("overlay").Dialog,[v.UIBase.Focus],{show:function(){this.center();var m=this.get("y");if(m-n.DOM.scrollTop()>200){m=n.DOM.scrollTop()+200;this.set("y",
m)}r.superclass.show.call(this)}},{ATTRS:{constrain:{value:true},zIndex:{value:v.baseZIndex(v.zIndexManager.OVERLAY)}}});v.Overlay=z;v.Dialog=r;var s;v.Overlay.loading=function(){s||(s=new v.Overlay({x:0,focus4e:false,width:n.UA.ie==6?n.DOM.docWidth():"100%",y:0,zIndex:v.baseZIndex(v.zIndexManager.LOADING),elCls:"ke-global-loading"}));s.set("height",n.DOM.docHeight());s.show();s.loading()};v.Overlay.unloading=function(){s&&s.hide()}}},{requires:["overlay/focus"]});
KISSY.Editor.add("pagebreak",function(n){n.addPlugin("pagebreak",function(){var w=KISSY,v=w.Editor,z=w.Node,r=n.htmlDataProcessor;(w=r&&r.dataFilter)&&w.addRules({elements:{div:function(m){var p=m.attributes;var l=(p=p&&p.style)&&m.children.length==1&&m.children[0];if((l=l&&l.name=="span"&&l.attributes.style)&&/page-break-after\s*:\s*always/i.test(p)&&/display\s*:\s*none/i.test(l))return r.createFakeParserElement(m,"ke_pagebreak","div")}}});var s=n.addButton("page-break",{title:"\u5206\u9875",mode:v.WYSIWYG_MODE,
contentCls:"ke-toolbar-pagebreak",offClick:function(){var m=this.editor,p=new z('<div style="page-break-after: always; "><span style="DISPLAY:none">&nbsp;</span></div>',null,m.document);p=m.createFakeElement?m.createFakeElement(p,"ke_pagebreak","div",false,'<div style="page-break-after: always; "><span style="DISPLAY:none">&nbsp;</span></div>'):p;var l=m.getSelection();if(l=l&&l.getRanges()[0]){m.fire("save");for(var d=l.startContainer,b=d;d._4e_name()!=="body";){b=d;d=d.parent()}l.collapse(true);
l.splitElement(b);p.insertAfter(b);m.fire("save")}}});this.destroy=function(){s.destroy()}})},{attach:false,requires:["fakeobjects"]});
KISSY.Editor.add("preview",function(n){n.addPlugin("preview",function(){var w=n.addButton("preview",{title:"\u9884\u89c8",contentCls:"ke-toolbar-preview",offClick:function(){var v=this.editor,z=640,r=420,s=80;try{var m=window.screen;z=Math.round(m.width*0.8);r=Math.round(m.height*0.7);s=Math.round(m.width*0.1)}catch(p){}v=v._prepareIFrameHtml().replace(/<body[^>]+>.+<\/body>/,"<body>\n"+v.getData(true)+"\n</body>").replace(/\${title}/,"\u9884\u89c8");z=window.open("","","toolbar=yes,location=no,status=yes,menubar=yes,scrollbars=yes,resizable=yes,width="+
z+",height="+r+",left="+s);r=z.document;r.open();r.write(v);r.close();z.focus()}});this.destroy=function(){w.destroy()}})},{attach:false});
KISSY.Editor.add("progressbar",function(){function n(){n.superclass.constructor.apply(this,arguments);this._init()}var w=KISSY,v=w.Editor;if(!v.ProgressBar){var z=w.Node;w.DOM.addStyleSheet(".ke-progressbar {border:1px solid #D6DEE6;position:relative;margin-left:auto;margin-right:auto;background-color: #EAEFF4;background: -webkit-gradient(linear, left top, left bottom, from(#EAEFF4), .to(#EBF0F3)); background: -moz-linear-gradient(top, #EAEFF4, #EBF0F3);filter: progid:DXImageTransform.Microsoft.gradient(startColorstr = '#EAEFF4', endColorstr = '#EBF0F3');}.ke-progressbar-inner {border:1px solid #3571B4;background-color:#6FA5DB;padding:1px;}.ke-progressbar-inner-bg {height:100%;background-color: #73B1E9;background: -webkit-gradient(linear, left top, left bottom, from(#73B1E9), .to(#3F81C8)); background: -moz-linear-gradient(top, #73B1E9, #3F81C8);filter: progid:DXImageTransform.Microsoft.gradient(startColorstr = '#73B1E9', endColorstr = '#3F81C8');}.ke-progressbar-title {width:30px;top:0;left:40%;line-height:1.2;position:absolute;}","ke_progressbar");
n.ATTRS={container:{},width:{},height:{},progress:{value:0}};w.extend(n,w.Base,{destroy:function(){this.detach();this.el.remove()},_init:function(){var r=this.get("height"),s=new z("<div class='ke-progressbar'  style='width:"+this.get("width")+";height:"+r+";'></div>"),m=this.get("container");r=(new z("<div style='overflow:hidden;'><div class='ke-progressbar-inner' style='height:"+(parseInt(r)-4)+"px'><div class='ke-progressbar-inner-bg'></div></div></div>")).appendTo(s);var p=(new z("<span class='ke-progressbar-title'></span>")).appendTo(s);
m&&s.appendTo(m);this.el=s;this._title=p;this._p=r;this.on("afterProgressChange",this._progressChange,this);this._progressChange({newVal:this.get("progress")})},_progressChange:function(r){r=r.newVal;this._p.css("width",r+"%");this._title.html(r+"%")}});v.ProgressBar=n}},{attach:false});
KISSY.Editor.add("removeformat",function(n){n.addPlugin("removeformat",function(){function w(d,b){for(var c=0;c<b.length;c++)d.removeAttr(b[c])}var v=KISSY.Editor,z=v.RANGE,r=v.ElementPath,s=v.NODE,m="class,style,lang,width,height,align,hspace,valign".split(/,/),p=RegExp("^(?:"+"b,big,code,del,dfn,em,font,i,ins,kbd,q,samp,small,span,strike,strong,sub,sup,tt,u,var,s".replace(/,/g,"|")+")$","i"),l=n.addButton("removeformat",{title:"\u6e05\u9664\u683c\u5f0f",mode:v.WYSIWYG_MODE,contentCls:"ke-toolbar-removeformat",offClick:function(){var d=
this.editor;d.focus();p.lastIndex=0;var b=d.getSelection().getRanges();d.fire("save");for(var c=0,e;e=b[c];c++)if(!e.collapsed){e.enlarge(z.ENLARGE_ELEMENT);var t=e.createBookmark(),q=t.startNode,a=t.endNode,f=function(i){for(var g=new r(i),h=g.elements,o=1,k;k=h[o];o++){if(k._4e_equals(g.block)||k._4e_equals(g.blockLimit))break;p.test(k._4e_name())&&i._4e_breakParent(k)}};f(q);f(a);for(q=q._4e_nextSourceNode(true,s.NODE_ELEMENT);q;){if(q._4e_equals(a))break;f=q._4e_nextSourceNode(false,s.NODE_ELEMENT);
q._4e_name()=="img"&&q.attr("_ke_realelement")||(p.test(q._4e_name())?q._4e_remove(true):w(q,m));q=f}e.moveToBookmark(t)}d.getSelection().selectRanges(b);d.fire("save")}});this.destroy=function(){l.destroy()}})},{attach:false});
KISSY.Editor.add("resize",function(n){var w=KISSY,v=w.Node;w.use("dd",function(z,r){var s=z.Draggable||r.Draggable,m=n.statusDiv,p=n.textarea,l=new v("<div class='ke-resizer'>"),d=n.cfg.pluginConfig.resize||{};d=d.direction||["x","y"];l.appendTo(m);n.on("maximizeWindow",function(){l.css("display","none")});n.on("restoreWindow",function(){l.css("display","")});l._4e_unselectable();var b=new s({node:l,cursor:"se-resize"}),c=0,e=0,t=0,q=0,a=n.wrap,f=n.editorWrap;b.on("dragstart",function(){c=a.height();
e=f.width();t=p.height();q=p.width()});b.on("drag",function(i){var g=i.left-this.startNodePos.left;i=i.top-this.startNodePos.top;if(z.inArray("y",d)){a.height(c+i);p.height(t+i)}if(z.inArray("x",d)){f.width(e+g);p.width(q+g)}});n.on("destroy",function(){b.destroy();l.remove()})})},{attach:false});
KISSY.Editor.add("separator",function(n){n.addPlugin("separator",function(){var w=(new KISSY.Node('<span class="ke-toolbar-separator">&nbsp;</span>')).appendTo(n.toolBarDiv);n.on("destroy",function(){w.remove()})},{duplicate:true})},{attach:false});
KISSY.Editor.add("smiley",function(n){n.addPlugin("smiley",function(){var w=KISSY.Editor,v=n.addButton("smiley",{contentCls:"ke-toolbar-smiley",title:"\u63d2\u5165\u8868\u60c5",mode:w.WYSIWYG_MODE,loading:true});w.use("smiley/support",function(){v.reload(w.SmileySupport)});this.destroy=function(){v.destroy()}})},{attach:false});
KISSY.Editor.add("smiley/support",function(){function n(){if(s)return s;s="<div class='ke-smiley-sprite'>";for(var l=0;l<=98;l++)s+="<a href='#' data-icon='http://a.tbcdn.cn/sys/wangwang/smiley/48x48/"+l+".gif'></a>";s+="</div>";return s}var w=KISSY,v=w.Event,z=w.Editor,r=w.DOM;r.addStyleSheet('.ke-smiley-sprite { background: url("http://a.tbcdn.cn/sys/wangwang/smiley/sprite.png") no-repeat scroll -1px 0 transparent; height: 235px; width: 288px; margin: 5px;zoom: 1; overflow: hidden;}.ke-smiley-sprite a {   width: 24px;height: 24px; border: 1px solid white; float: left;}.ke-smiley-sprite a:hover { border: 1px solid #808080;}',
"smiley");var s,m=z.Utils.addRes,p=z.Utils.destroyRes;z.SmileySupport={_selectSmiley:function(l){l.halt();var d=this.editor;l=new w.Node(l.target);var b;if(l._4e_name()=="a"&&(b=l.attr("data-icon"))){b=new w.Node("<img alt='' src='"+b+"'/>",null,d.document);d.insertElement(b);this.smileyWin.hide()}},_hidePanel:function(l){var d=this.btn.get("el");l=new w.Node(l.target);var b=this.smileyWin;d._4e_equals(l)||d.contains(l)||b.hide()},_prepare:function(){var l=this,d=l.cfg,b=l.btn,c=l.editor,e=n();l.smileyWin=
new z.Overlay({content:e,focus4e:false,width:"297px",autoRender:true,elCls:"ks-popup",zIndex:z.baseZIndex(z.zIndexManager.POPUP_MENU),mask:false});e=l.smileyWin;l.smileyPanel=e.get("contentEl");e.on("show",b.bon,b);e.on("hide",b.boff,b);l.smileyPanel.on("click",d._selectSmiley,l);v.on(document,"click",d._hidePanel,l);v.on(c.document,"click",d._hidePanel,l);l.cfg._prepare=l.cfg._real;m.call(l,l.smileyWin,l.smileyPanel,function(){v.remove(document,"click",d._hidePanel,l);v.remove(c.document,"click",
d._hidePanel,l)});l.call("_real")},_real:function(){var l=this.btn.get("el"),d=l.offset();d.top+=l.height()+5;if(d.left+this.smileyPanel.width()>r.viewportWidth()-60)d.left=r.viewportWidth()-this.smileyPanel.width()-60;this.smileyWin.set("xy",[d.left,d.top]);this.smileyWin.show()},offClick:function(){var l=this;z.use("overlay",function(){l.call("_prepare")})},onClick:function(){this.smileyWin&&this.smileyWin.hide()},destroy:function(){p.call(this)}}},{attach:false});
KISSY.Editor.add("sourcearea",function(n){n.addPlugin("sourcearea",function(){function w(){var l=n.textarea;l.on("keydown",function(d){if(d.ctrlKey&&d.keyCode==87){d.halt();d=l.attr("wrap")=="off"?"soft":"off";if(r.ie)l.attr("wrap",d);else{l.detach();var b=l._4e_clone();n.textarea=b;b.attr("wrap",d);b.val(l.val());l[0].parentNode.replaceChild(b[0],l[0]);w();l=null}}})}var v=KISSY,z=v.Editor,r=v.UA;if(!(r.gecko<1.92)){var s=z.SOURCE_MODE,m=z.WYSIWYG_MODE,p=n.addButton("sourcearea",{title:"\u6e90\u7801",contentCls:"ke-toolbar-source",
loading:true});z.use("sourcearea/support",function(){p.reload({init:function(){var l=this.btn,d=this.editor;d.on("wysiwygmode",l.boff,l);d.on("sourcemode",l.bon,l)},offClick:function(){this.editor.execCommand("sourceAreaSupport",s)},onClick:function(){this.editor.execCommand("sourceAreaSupport",m)}});n.addCommand("sourceAreaSupport",z.SourceAreaSupport)});this.destroy=function(){p.destroy()};w()}})},{attach:false});
KISSY.Editor.add("sourcearea/support",function(){function n(){var m=this.mapper={};m[r]=this._show;m[s]=this._hide}var w=KISSY,v=w.Editor,z=w.UA,r=v.SOURCE_MODE,s=v.WYSIWYG_MODE;w.augment(n,{exec:function(m,p){var l=this.mapper;l[p]&&l[p].call(this,m)},_show:function(m){m.textarea.val(m.getData(true));this._showSource(m);m.fire("sourcemode")},_showSource:function(m){var p=m.textarea,l=m.iframe;p.css("display","");l.css("display","none");p.css({height:m.wrap.css("height"),width:"100%"});p[0].focus()},
_hideSource:function(m){var p=m.textarea;m.iframe.css("display","");p.css("display","none")},_hide:function(m){var p=m.textarea;this._hideSource(m);m.fire("save");m.setData(p.val());m.fire("wysiwygmode");m.fire("save");z.gecko&&m.activateGecko()}});v.SourceAreaSupport=new n},{attach:false});
KISSY.Editor.add("table",function(n){n.addPlugin("table",function(){var w=KISSY,v=w.Editor,z=w.trim;w=(w.UA.ie===6?["table.%2,","table.%2 td, table.%2 th,","{","border : #d3d3d3 1px dotted","}"]:[" table.%2,"," table.%2 > tr > td,  table.%2 > tr > th,"," table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,"," table.%2 > thead > tr > td,  table.%2 > thead > tr > th,"," table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th","{","border : #d3d3d3 1px dotted","}"]).join("").replace(/%2/g,"ke_show_border");
var r=n.htmlDataProcessor,s=r&&r.dataFilter;r=r&&r.htmlFilter;s&&s.addRules({elements:{table:function(p){p=p.attributes;var l=p["class"],d=parseInt(p.border,10);if(!d||d<=0)p["class"]=(l||"")+" ke_show_border"}}});r&&r.addRules({elements:{table:function(p){p=p.attributes;var l=p["class"];if(l)p["class"]=z(l.replace("ke_show_border","").replace(/\s{2}/," "))}}});var m=n.addButton("table",{contentCls:"ke-toolbar-table",mode:v.WYSIWYG_MODE,title:"\u63d2\u5165\u8868\u683c",loading:true});v.use("table/support",function(){var p=
new v.TableUI(n);m.reload({offClick:function(){p._tableShow()},destroy:function(){p.destroy()}})});this.destroy=function(){m.destroy()};n.addCustomStyle(w)})},{attach:false});
KISSY.Editor.add("table/support",function(){function n(k){var u=this,x={},E;for(E in o)(function(j){x[j]=function(){k.fire("save");o[j](u);k.fire("save")}})(E);E=t.ContextMenu.register({editor:k,statusChecker:h,rules:a,width:"120px",funcs:x});f.call(u,E);u.editor=k}function w(k){function u(D){if(!(j.length>0))if(D[0].nodeType==q.NODE_ELEMENT&&g.test(D._4e_name())&&!D.data("selected_cell")){D._4e_setMarker(y,"selected_cell",true);j.push(D)}}for(var x=k.createBookmarks(),E=k.getRanges(),j=[],y={},C=
0;C<E.length;C++){var A=E[C];if(A.collapsed){A=A.getCommonAncestor();(A=A._4e_ascendant("td",true)||A._4e_ascendant("th",true))&&j.push(A)}else{A=new Walker(A);var B;for(A.guard=u;B=A.next();)if((B=B.parent())&&g.test(B._4e_name())&&!B.data("selected_cell")){B._4e_setMarker(y,"selected_cell",true);j.push(B)}}}t.Utils.clearAllMarkers(y);k.selectBookmarks(x);return j}function v(k,u){var x=k.getStartElement()._4e_ascendant("tr");if(x){var E=x._4e_clone(true);E.insertBefore(x);x=(u?E[0]:x[0]).cells;for(E=
0;E<x.length;E++){x[E].innerHTML="";c.ie||(new e(x[E]))._4e_appendBogus()}}}function z(k){if(k instanceof t.Selection){var u=w(k),x=u.length;k=[];for(var E,j,y=0;y<x;y++){var C=u[y].parent(),A=C[0].rowIndex;!y&&(E=A-1);k[A]=C;y==x-1&&(j=A+1)}y=C._4e_ascendant("table");E=new e(j<y[0].rows.length&&y[0].rows[j]||E>0&&y[0].rows[E]||y[0].parentNode);for(y=k.length;y>=0;y--)k[y]&&z(k[y]);return E}else if(k instanceof e){y=k._4e_ascendant("table");y[0].rows.length==1?y._4e_remove():k._4e_remove()}return 0}
function r(k,u){var x=k.getStartElement();if(x=x._4e_ascendant("td",true)||x._4e_ascendant("th",true))for(var E=x._4e_ascendant("table"),j=x[0].cellIndex,y=0;y<E[0].rows.length;y++){var C=E[0].rows[y];if(!(C.cells.length<j+1)){x=new e(C.cells[j].cloneNode(false));c.ie||x._4e_appendBogus();C=new e(C.cells[j]);u?x.insertBefore(C):x.insertAfter(C)}}}function s(k){if(k instanceof t.Selection){var u=w(k),x,E=[];k=u[0]&&u[0]._4e_ascendant("table");var j,y,C;j=0;for(y=u.length;j<y;j++)E.push(u[j][0].cellIndex);
E.sort();j=1;for(y=E.length;j<y;j++)if(E[j]-E[j-1]>1){C=E[j-1]+1;break}C||(C=E[0]>0?E[0]-1:E[E.length-1]+1);E=k[0].rows;j=0;for(y=E.length;j<y;j++)if(x=E[j].cells[C])break;x=x?new e(x):k._4e_previous();for(C=u.length-1;C>=0;C--)u[C]&&s(u[C]);return x}else if(k instanceof e){u=k._4e_ascendant("table");if(!u)return null;x=k[0].cellIndex;for(C=u[0].rows.length-1;C>=0;C--){k=new e(u[0].rows[C]);if(!x&&k[0].cells.length==1)z(k);else k[0].cells[x]&&k[0].removeChild(k[0].cells[x])}}return null}function m(k,
u){var x=new t.Range(k[0].ownerDocument);if(!x.moveToElementEditablePosition(k,u?true:undefined)){x.selectNodeContents(k);x.collapse(u?false:true)}x.select(true)}function p(k){var u=(k=k.getSelection())&&k.getStartElement(),x=u&&u._4e_ascendant("table",true);if(x){k=u._4e_ascendant(function(E){var j=E._4e_name();return x.contains(E)&&(j=="td"||j=="th")},true);u=u._4e_ascendant(function(E){var j=E._4e_name();return x.contains(E)&&j=="tr"},true);return{table:x,td:k,tr:u}}}function l(k){return(k=p(k))&&
k.td}function d(k){return(k=p(k))&&k.tr}var b=KISSY,c=b.UA,e=b.Node,t=b.Editor,q=t.NODE,a=["tr","th","td","tbody","table"],f=t.Utils.addRes,i=t.Utils.destroyRes;b.augment(n,{_tableShow:function(k,u,x){this.editor.showDialog("table/dialog",[u,x])},destroy:function(){i.call(this);this.editor.destroyDialog("table/dialog")}});var g=/^(?:td|th)$/,h={"\u8868\u683c\u5c5e\u6027":p,"\u5220\u9664\u8868\u683c":l,"\u5220\u9664\u5217":l,"\u5220\u9664\u884c":d,"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":d,"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":d,"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":l,"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":l},o={"\u8868\u683c\u5c5e\u6027":function(k){var u=p(k.editor);u&&k._tableShow(null,u.table,u.td)},
"\u5220\u9664\u8868\u683c":function(k){var u=(k=k.editor.getSelection())&&k.getStartElement();if(u=u&&u._4e_ascendant("table",true)){k.selectElement(u);var x=k.getRanges()[0];x.collapse();k.selectRanges([x]);k=u.parent();k[0].childNodes.length==1&&k._4e_name()!="body"&&k._4e_name()!="td"?k._4e_remove():u._4e_remove()}},"\u5220\u9664\u884c ":function(k){k=k.editor.getSelection();m(z(k),undefined)},"\u5220\u9664\u5217 ":function(k){k=k.editor.getSelection();(k=s(k))&&m(k,true)},"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":function(k){k=k.editor.getSelection();v(k,true)},"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":function(k){k=
k.editor.getSelection();v(k,undefined)},"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":function(k){k=k.editor.getSelection();r(k,true)},"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":function(k){k=k.editor.getSelection();r(k,undefined)}};t.TableUI=n},{attach:false,requires:["contextmenu"]});
KISSY.Editor.add("tabs",function(){function n(r){this.cfg=r;this._init()}var w=KISSY,v=w.Editor,z=w.Node;if(v.Tabs)w.log("ke tabs attach more","warn");else{w.augment(n,w.EventTarget,{_init:function(){var r=this,s=r.cfg,m=s.tabs,p=s.contents.children("div"),l=m.children("li");m.on("click",function(d){d&&d.preventDefault();d=new z(d.target);if(d=d._4e_ascendant(function(c){return c._4e_name()==="li"&&m.contains(c)},true)){l.removeClass("ke-tab-selected");var b=d.attr("rel");d.addClass("ke-tab-selected");
p.hide();p.item(w.indexOf(d[0],l)).show();r.fire(b)}})},getTab:function(r){var s=this.cfg,m=s.tabs;s=s.contents.children("div");m=m.children("li");for(var p=0;p<m.length;p++){var l=new z(m[p]),d=new z(s[p]);if(w.isNumber(r)&&r==p||w.isString(r)&&r==l.attr("rel"))return{tab:l,content:d}}},remove:function(r){r=this.getTab(r);r.tab.remove();r.content.remove()},_getActivate:function(){for(var r=this.cfg.tabs.children("li"),s=0;s<r.length;s++){var m=new z(r[s]);if(m.hasClass("ke-tab-selected"))return m.attr("rel")}},
activate:function(r){if(arguments.length==0)return this._getActivate();var s=this.cfg,m=s.tabs;s=s.contents.children("div");m.children("li").removeClass("ke-tab-selected");s.hide();m=this.getTab(r);m.tab.addClass("ke-tab-selected");m.content.show()},destroy:function(){var r=this.cfg.tabs;r.detach();r.remove()}});v.Tabs=n}},{attach:false});
KISSY.Editor.add("templates",function(n){n.addPlugin("templates",function(){var w=KISSY,v=w.Editor,z=w.Node;w.DOM.addStyleSheet(".ke-tpl {    border: 2px solid #EEEEEE;    width: 95%;    margin: 20px auto;}.ke-tpl-list {    border: 1px solid #EEEEEE;    margin: 5px;    padding: 7px;    display: block;    text-decoration: none;    zoom: 1;}.ke-tpl-list:hover, .ke-tpl-selected {    background-color: #FFFACD;    text-decoration: none;    border: 1px solid #FF9933;}","ke-templates");var r=n.addButton("templates",
{contentCls:"ke-toolbar-template",title:"\u6a21\u677f",mode:v.WYSIWYG_MODE,offClick:function(){var s=this;v.use("overlay",function(){s.cfg._prepare.call(s)})},_prepare:function(){for(var s=this.editor,m=s.cfg.pluginConfig.templates||[],p="<div class='ke-tpl'>",l=0;l<m.length;l++)p+="<a href='javascript:void(0)' class='ke-tpl-list' tabIndex='-1'>"+m[l].demo+"</a>";p+="</div>";var d=new v.Dialog({width:500,mask:true,autoRender:true,headerContent:"\u5185\u5bb9\u6a21\u677f",bodyContent:p});d.get("el").all(".ke-tpl-list").on("click",
function(b){b.halt();b=(new z(b.target))._4e_index();b!=-1&&s.insertHtml(m[b].html);d.hide()});this.ui=d;this.cfg.show.call(this);this.cfg._prepare=this.cfg.show},show:function(){this.ui.show()}});this.destroy=function(){r.destroy()}})},{attach:false});
KISSY.Editor.add("undo",function(n){var w=KISSY,v=w.Editor,z={redo:1,undo:-1},r={mode:v.WYSIWYG_MODE,init:function(){this.editor.on("afterSave afterRestore",this.cfg._respond,this);this.btn.disable()},offClick:function(){this.editor.fire("restore",{d:z[this.cfg.flag]})}},s=w.mix({flag:"undo",_respond:function(p){var l=this.btn;p.index>0?l.boff():l.disable()}},r,false),m=w.mix({flag:"redo",_respond:function(p){var l=this.btn;p.index<p.history.length-1?l.boff():l.disable()}},r,false);n.addPlugin("undo",
function(){var p=n.addButton("undo",{title:"\u64a4\u9500",loading:true,contentCls:"ke-toolbar-undo"}),l=n.addButton("undo",{title:"\u91cd\u505a",loading:true,contentCls:"ke-toolbar-redo"});v.use("undo/support",function(){new v.UndoManager(n);p.reload(s);l.reload(m)});this.destroy=function(){p.destroy();l.destroy()}})},{attach:false});
KISSY.Editor.add("undo/support",function(){function n(d){var b=d._getRawData(),c;if(b)c=d.getSelection();this.contents=b;this.bookmarks=c&&c.createBookmarks2(true)}function w(d){this.history=[];this.index=-1;this.editor=d;this.bufferRunner=z.Utils.buffer(this.save,this,500);this._init()}var v=KISSY,z=v.Editor,r=z.Utils.arrayCompare,s=v.UA,m=v.Event;v.augment(n,{equals:function(d){if(this.contents!=d.contents)return false;var b=this.bookmarks;d=d.bookmarks;if(b||d){if(!b||!d||b.length!=d.length)return false;
for(var c=0;c<b.length;c++){var e=b[c],t=d[c];if(e.startOffset!=t.startOffset||e.endOffset!=t.endOffset||!r(e.start,t.start)||!r(e.end,t.end))return false}}return true}});var p={16:1,17:1,18:1},l={37:1,38:1,39:1,40:1,33:1,34:1};v.augment(w,{_keyMonitor:function(){var d=this.editor;m.on([d.document,d.textarea],"keydown",function(b){var c=b.keyCode;if(!(c in l||c in p))if(c===90&&(b.ctrlKey||b.metaKey)){d.fire("restore",{d:-1});b.halt()}else if(c===89&&(b.ctrlKey||b.metaKey)){d.fire("restore",{d:1});
b.halt()}else d.fire("save",{buffer:1})})},_init:function(){var d=this,b=d.editor;b.on("save",function(c){if(b.getMode()==z.WYSIWYG_MODE)c.buffer?d.bufferRunner():d.save()});b.on("restore",function(c){b.getMode()==z.WYSIWYG_MODE&&d.restore(c)});d._keyMonitor();setTimeout(function(){d.save()},0)},save:function(){var d=this.history,b=this.index;d.length>b+1&&d.splice(b+1,d.length-b-1);var c=this.editor;b=d[d.length-1];var e=new n(c);if(!b||!b.equals(e)){d.length===30&&d.shift();d.push(e);this.index=
b=d.length-1;c.fire("afterSave",{history:d,index:b})}},restore:function(d){d=d.d;var b=this.history,c=this.editor,e=b[this.index+d];if(e){c._setRawData(e.contents);if(e.bookmarks)c.getSelection().selectBookmarks(e.bookmarks);else if(s.ie){e=c.document.body.createTextRange();e.collapse(true);e.select()}(e=c.getSelection())&&e.scrollIntoView();this.index+=d;c.fire("afterRestore",{history:b,index:this.index});c.notifySelectionChange()}}});z.UndoManager=w},{attach:false});
